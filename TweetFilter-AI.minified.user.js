// ==UserScript==
// @name         TweetFilter AI
// @namespace    http://tampermonkey.net/
// @version      Version 1.4.5
// @description  A highly customizable AI rates tweets 1-10 and removes all the slop, saving your braincells!
// @author       Obsxrver(3than)
// @match        *://twitter.com/*
// @match        *://x.com/*
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        GM_getResourceText
// @connect      openrouter.ai
// @run-at       document-idle
// @license      MIT
// ==/UserScript==
!function(){"use strict";let t=`<div id="tweetfilter-root-container"><button id="filter-toggle" class="toggle-button" style="display: none;">Filter Slider</button><div id="tweet-filter-container"><button class="close-button" data-action="close-filter">\xd7</button><label for="tweet-filter-slider">SlopScore:</label><div class="filter-controls"><input type="range" id="tweet-filter-slider" min="0" max="10" step="1"><input type="number" id="tweet-filter-value" min="0" max="10" step="1" value="5"></div></div><button id="settings-toggle" class="toggle-button" data-action="toggle-settings"><span style="font-size: 14px;">‚öôÔ∏è</span> Settings</button><div id="settings-container" class="hidden"><div class="settings-header"><div class="settings-title">Twitter De-Sloppifier</div><button class="close-button" data-action="toggle-settings">\xd7</button></div><div class="settings-content"><div class="tab-navigation"><button class="tab-button active" data-tab="general">General</button><button class="tab-button" data-tab="models">Models</button><button class="tab-button" data-tab="instructions">Instructions</button></div><div id="general-tab" class="tab-content active"><div class="section-title"><span style="font-size: 14px;">üîë</span> OpenRouter API Key <a href="https://openrouter.ai/settings/keys" target="_blank">Get one here</a></div><input id="openrouter-api-key" placeholder="Enter your OpenRouter API key"><button class="settings-button" data-action="save-api-key">Save API Key</button><div class="section-title" style="margin-top: 20px;"><span style="font-size: 14px;">üóÑÔ∏è</span> Cache Statistics</div><div class="stats-container"><div class="stats-row"><div class="stats-label">Cached Tweet Ratings</div><div class="stats-value" id="cached-ratings-count">0</div></div><div class="stats-row"><div class="stats-label">Whitelisted Handles</div><div class="stats-value" id="whitelisted-handles-count">0</div></div></div><button id="clear-cache" class="settings-button danger" data-action="clear-cache">Clear Rating Cache</button><div class="section-title" style="margin-top: 20px;"><span style="font-size: 14px;">üíæ</span> Backup &amp; Restore</div><div class="section-description">Export your settings and cached ratings to a file for backup, or import previously saved settings.</div><button class="settings-button" data-action="export-cache">Export Cache</button><button class="settings-button danger" style="margin-top: 15px;" data-action="reset-settings">Reset to Defaults</button><div id="version-info" style="margin-top: 20px; font-size: 11px; opacity: 0.6; text-align: center;">Twitter De-Sloppifier v?.?</div></div><div id="models-tab" class="tab-content"><div class="section-title"><span style="font-size: 14px;">üß†</span> Tweet Rating Model</div><div class="section-description">The rating model is responsible for reviewing each tweet. <br>It will process images directly if you select an <strong>image-capable (üñºÔ∏è)</strong> model.</div><div class="select-container" id="model-select-container"></div><div class="advanced-options"><div class="advanced-toggle" data-toggle="model-options-content"><div class="advanced-toggle-title">Options</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="model-options-content"><div class="sort-container"><label for="model-sort-order">Sort models by: </label><div class="controls-group"><select id="model-sort-order" data-setting="modelSortOrder"><option value="pricing-low-to-high">Price</option><option value="latency-low-to-high">Latency</option><option value="throughput-high-to-low">Throughput</option><option value="top-weekly">Popularity</option><option value="">Age</option></select><button id="sort-direction" class="sort-toggle" data-setting="sortDirection" data-value="default">High-Low</button></div></div><div class="sort-container"><label for="provider-sort">API Endpoint Priority: </label><select id="provider-sort" data-setting="providerSort"><option value="">Default (load-balanced)</option><option value="throughput">Throughput</option><option value="latency">Latency</option><option value="price">Price</option></select></div><div class="sort-container"><label><input type="checkbox" id="show-free-models" data-setting="showFreeModels" checked>Show Free Models</label></div><div class="parameter-row" data-param-name="modelTemperature"><div class="parameter-label" title="How random the model responses should be (0.0-1.0)">Temperature</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2" step="0.1"><input type="number" class="parameter-value" min="0" max="2" step="0.01" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="modelTopP"><div class="parameter-label" title="Nucleus sampling parameter (0.0-1.0)">Top-p</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="1" step="0.1"><input type="number" class="parameter-value" min="0" max="1" step="0.01" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="maxTokens"><div class="parameter-label" title="Maximum number of tokens for the response (0 means no limit)">Max Tokens</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2000" step="100"><input type="number" class="parameter-value" min="0" max="2000" step="100" style="width: 60px;"></div></div><div class="toggle-row"><div class="toggle-label" title="Stream API responses as they're generated for live updates">Enable Live Streaming</div><label class="toggle-switch"><input type="checkbox" data-setting="enableStreaming"><span class="toggle-slider"></span></label></div></div></div><div class="section-title" style="margin-top: 25px;"><span style="font-size: 14px;">üñºÔ∏è</span> Image Processing Model</div><div class="section-description">This model generates <strong>text descriptions</strong> of images for the rating model.<br> Hint: If you selected an image-capable model (üñºÔ∏è) as your <strong>main rating model</strong>, it will process images directly.</div><div class="toggle-row"><div class="toggle-label">Enable Image Descriptions</div><label class="toggle-switch"><input type="checkbox" data-setting="enableImageDescriptions"><span class="toggle-slider"></span></label></div><div id="image-model-container" style="display: none;"><div class="select-container" id="image-model-select-container"></div><div class="advanced-options" id="image-advanced-options"><div class="advanced-toggle" data-toggle="image-advanced-content"><div class="advanced-toggle-title">Options</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="image-advanced-content"><div class="parameter-row" data-param-name="imageModelTemperature"><div class="parameter-label" title="Randomness for image descriptions (0.0-1.0)">Temperature</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2" step="0.1"><input type="number" class="parameter-value" min="0" max="2" step="0.1" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="imageModelTopP"><div class="parameter-label" title="Nucleus sampling for image model (0.0-1.0)">Top-p</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="1" step="0.1"><input type="number" class="parameter-value" min="0" max="1" step="0.1" style="width: 60px;"></div></div></div></div></div></div><div id="instructions-tab" class="tab-content"><div class="section-title">Custom Instructions</div><div class="section-description">Add custom instructions for how the model should score tweets:</div><textarea id="user-instructions" placeholder="Examples:- Give high scores to tweets about technology- Penalize clickbait-style tweets- Rate educational content higher" data-setting="userDefinedInstructions" value=""></textarea><button class="settings-button" data-action="save-instructions">Save Instructions</button><div class="advanced-options" id="instructions-history"><div class="advanced-toggle" data-toggle="instructions-history-content"><div class="advanced-toggle-title">Custom Instructions History</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="instructions-history-content"><div class="instructions-list" id="instructions-list"><!-- Instructions entries will be added here dynamically --></div><button class="settings-button danger" style="margin-top: 10px;" data-action="clear-instructions-history">Clear All History</button></div></div><div class="section-title" style="margin-top: 20px;">Auto-Rate Handles as 10/10</div><div class="section-description">Add Twitter handles to automatically rate as 10/10:</div><div class="handle-input-container"><input id="handle-input" type="text" placeholder="Twitter handle (without @)"><button class="add-handle-btn" data-action="add-handle">Add</button></div><div class="handle-list" id="handle-list"></div></div></div><div id="status-indicator" class=""></div></div><div id="tweet-filter-stats-badge" class="tweet-filter-stats-badge"></div></div>`;function e(t,e=null){try{return GM_getValue(t,e)}catch(i){return e}}function i(t,e){try{GM_setValue(t,e)}catch(i){}}function o(){let t=document.getElementById("cached-ratings-count"),e=document.getElementById("whitelisted-handles-count"),i=a.size,o=C.length;t&&(t.textContent=i),e&&(e.textContent=o);let n=document.getElementById("tweet-filter-stats-badge");n&&(n.innerHTML=`
            <span style="margin-right: 5px;">üß†</span>
            <span data-cached-count>${i} rated</span>
            <span data-pending-count> | ${v} pending</span>
            ${o>0?`<span style="margin-left: 5px;"> | ${o} whitelisted</span>`:""}
        `)}GM_addStyle('.refreshing {animation: spin 1s infinite linear;}@keyframes spin {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}.score-highlight {display: inline-block;background-color: #1d9bf0;/* Twitter blue */color: white;padding: 3px 10px;border-radius: 9999px;margin: 8px 0;font-weight: bold;font-size: 0.9em;}.mobile-tooltip {/* Add specific mobile tooltip styles if needed */max-width: 90vw;/* Example */}.score-description.streaming-tooltip {scroll-behavior: smooth;border-left: 3px solid #1d9bf0;background-color: rgba(25, 30, 35, 0.98);}.score-description.streaming-tooltip::before {content: \'Live\';position: absolute;top: 10px;right: 10px;background-color: #1d9bf0;color: white;font-size: 11px;padding: 2px 6px;border-radius: 10px;font-weight: bold;}.score-description::-webkit-scrollbar {width: 6px;}.score-description::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);border-radius: 3px;}.score-description::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.score-description::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}.score-description.streaming-tooltip p::after {content: \'|\';display: inline-block;color: #1d9bf0;animation: blink 0.7s infinite;font-weight: bold;margin-left: 2px;}@keyframes blink {0%,100% {opacity: 0;}50% {opacity: 1;}}.streaming-rating {background-color: rgba(33, 150, 243, 0.9) !important;color: white !important;animation: pulse 1.5s infinite alternate;position: relative;}.streaming-rating::after {content: \'\';position: absolute;top: -2px;right: -2px;width: 6px;height: 6px;background-color: #1d9bf0;border-radius: 50%;animation: blink 0.7s infinite;box-shadow: 0 0 4px #1d9bf0;}.cached-rating {background-color: rgba(76, 175, 80, 0.9) !important;color: white !important;}.rated-rating {background-color: rgba(33, 33, 33, 0.9) !important;color: white !important;}.blacklisted-rating {background-color: rgba(255, 193, 7, 0.9) !important;color: black !important;}.pending-rating {background-color: rgba(255, 152, 0, 0.9) !important;color: white !important;}@keyframes pulse {0% {opacity: 0.8;}100% {opacity: 1;}}.error-rating {background-color: rgba(244, 67, 54, 0.9) !important;color: white !important;}#status-indicator {position: fixed;bottom: 20px;right: 20px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 10px 15px;border-radius: 8px;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;z-index: 9999;display: none;border: 1px solid rgba(255, 255, 255, 0.1);box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);transform: translateY(100px);transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);}#status-indicator.active {display: block;transform: translateY(0);}.toggle-switch {position: relative;display: inline-block;width: 36px;height: 20px;}.toggle-switch input {opacity: 0;width: 0;height: 0;}.toggle-slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;background-color: rgba(255, 255, 255, 0.2);transition: .3s;border-radius: 34px;}.toggle-slider:before {position: absolute;content: "";height: 16px;width: 16px;left: 2px;bottom: 2px;background-color: white;transition: .3s;border-radius: 50%;}input:checked+.toggle-slider {background-color: #1d9bf0;}input:checked+.toggle-slider:before {transform: translateX(16px);}.toggle-row {display: flex;align-items: center;justify-content: space-between;padding: 8px 10px;margin-bottom: 12px;background-color: rgba(255, 255, 255, 0.05);border-radius: 8px;transition: background-color 0.2s;}.toggle-row:hover {background-color: rgba(255, 255, 255, 0.08);}.toggle-label {font-size: 13px;color: #e7e9ea;}#tweet-filter-container {position: fixed;top: 70px;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 10px 12px;border-radius: 12px;z-index: 9999;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);display: flex;align-items: center;gap: 10px;border: 1px solid rgba(255, 255, 255, 0.1);transform-origin: top right;transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.5s ease-in-out;opacity: 1;transform: scale(1) translateX(0);visibility: visible;}#tweet-filter-container.hidden {opacity: 0;transform: scale(0.8) translateX(50px);visibility: hidden;}.close-button {background: none;border: none;color: #e7e9ea;font-size: 16px;cursor: pointer;padding: 0;width: 28px;height: 28px;display: flex;align-items: center;justify-content: center;opacity: 0.8;transition: opacity 0.2s;border-radius: 50%;min-width: 28px;min-height: 28px;-webkit-tap-highlight-color: transparent;touch-action: manipulation;user-select: none;z-index: 30;}.close-button:hover {opacity: 1;background-color: rgba(255, 255, 255, 0.1);}.hidden {display: none !important;}/* Only override hidden for our specific containers */#tweet-filter-container.hidden,#settings-container.hidden {display: flex !important;}.toggle-button {position: fixed;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 8px 12px;border-radius: 8px;cursor: pointer;font-size: 12px;z-index: 9999;border: 1px solid rgba(255, 255, 255, 0.1);box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;display: flex;align-items: center;gap: 6px;transition: all 0.2s ease;}.toggle-button:hover {background-color: rgba(29, 155, 240, 0.2);}#filter-toggle {top: 70px;}#settings-toggle {top: 120px;}#tweet-filter-container label {margin: 0;font-weight: bold;}.tweet-filter-stats-badge {position: fixed;bottom: 50px;right: 20px;background-color: rgba(29, 155, 240, 0.9);color: white;padding: 5px 10px;border-radius: 15px;font-size: 12px;z-index: 9999;box-shadow: 0 2px 5px rgba(0,0,0,0.2);transition: opacity 0.3s;cursor: pointer;display: flex;align-items: center;}#tweet-filter-slider {cursor: pointer;width: 120px;vertical-align: middle;-webkit-appearance: none;appearance: none;height: 6px;border-radius: 3px;background: linear-gradient(to right,#FF0000 0%,#FF8800 calc(var(--slider-percent, 50%) * 0.166),#FFFF00 calc(var(--slider-percent, 50%) * 0.333),#00FF00 calc(var(--slider-percent, 50%) * 0.5),#00FFFF calc(var(--slider-percent, 50%) * 0.666),#0000FF calc(var(--slider-percent, 50%) * 0.833),#800080 var(--slider-percent, 50%),#DEE2E6 var(--slider-percent, 50%),#DEE2E6 100%);}#tweet-filter-slider::-webkit-slider-thumb {-webkit-appearance: none;appearance: none;width: 16px;height: 16px;border-radius: 50%;background: #1d9bf0;cursor: pointer;border: 2px solid white;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);transition: transform 0.1s;}#tweet-filter-slider::-webkit-slider-thumb:hover {transform: scale(1.2);}#tweet-filter-slider::-moz-range-thumb {width: 16px;height: 16px;border-radius: 50%;background: #1d9bf0;cursor: pointer;border: 2px solid white;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);transition: transform 0.1s;}#tweet-filter-slider::-moz-range-thumb:hover {transform: scale(1.2);}#tweet-filter-value {min-width: 20px;text-align: center;font-weight: bold;background-color: rgba(255, 255, 255, 0.1);padding: 2px 5px;border-radius: 4px;}#settings-container {position: fixed;top: 70px;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 0;border-radius: 16px;z-index: 9999;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;box-shadow: 0 2px 18px rgba(0, 0, 0, 0.6);display: flex;flex-direction: column;width: 90vw;max-width: 380px;max-height: 85vh;overflow: hidden;border: 1px solid rgba(255, 255, 255, 0.1);line-height: 1.3;transform-origin: top right;transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55),opacity 0.5s ease-in-out;opacity: 1;transform: scale(1) translateX(0);visibility: visible;}#settings-container.hidden {opacity: 0;transform: scale(0.8) translateX(50px);visibility: hidden;}.settings-header {padding: 12px 15px;border-bottom: 1px solid rgba(255, 255, 255, 0.1);display: flex;justify-content: space-between;align-items: center;position: sticky;top: 0;background-color: rgba(22, 24, 28, 0.98);z-index: 20;border-radius: 16px 16px 0 0;}.settings-title {font-weight: bold;font-size: 16px;}.settings-content {overflow-y: auto;max-height: calc(85vh - 110px);padding: 0;}.settings-content::-webkit-scrollbar {width: 6px;}.settings-content::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);border-radius: 3px;}.settings-content::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.settings-content::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}.tab-navigation {display: flex;border-bottom: 1px solid rgba(255, 255, 255, 0.1);position: sticky;top: 0;background-color: rgba(22, 24, 28, 0.98);z-index: 10;padding: 10px 15px;gap: 8px;}.tab-button {padding: 6px 10px;background: none;border: none;color: #e7e9ea;font-weight: bold;cursor: pointer;border-radius: 8px;transition: all 0.2s ease;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;flex: 1;text-align: center;}.tab-button:hover {background-color: rgba(255, 255, 255, 0.1);}.tab-button.active {color: #1d9bf0;background-color: rgba(29, 155, 240, 0.1);border-bottom: 2px solid #1d9bf0;}.tab-content {display: none;animation: fadeIn 0.3s ease;padding: 15px;}@keyframes fadeIn {from {opacity: 0;}to {opacity: 1;}}.tab-content.active {display: block;}.select-container {position: relative;margin-bottom: 15px;}.select-container .search-field {position: sticky;top: 0;background-color: rgba(39, 44, 48, 0.95);padding: 8px;border-bottom: 1px solid rgba(255, 255, 255, 0.1);z-index: 1;}.select-container .search-input {width: 100%;padding: 8px 10px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.9);color: #e7e9ea;font-size: 12px;transition: border-color 0.2s;}.select-container .search-input:focus {border-color: #1d9bf0;outline: none;}.custom-select {position: relative;display: inline-block;width: 100%;}.select-selected {background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;padding: 10px 12px;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 8px;cursor: pointer;user-select: none;display: flex;justify-content: space-between;align-items: center;font-size: 13px;transition: border-color 0.2s;}.select-selected:hover {border-color: rgba(255, 255, 255, 0.4);}.select-selected:after {content: "";width: 8px;height: 8px;border: 2px solid #e7e9ea;border-width: 0 2px 2px 0;display: inline-block;transform: rotate(45deg);margin-left: 10px;transition: transform 0.2s;}.select-selected.select-arrow-active:after {transform: rotate(-135deg);}.select-items {position: absolute;background-color: rgba(39, 44, 48, 0.98);top: 100%;left: 0;right: 0;z-index: 99;max-height: 300px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 8px;margin-top: 5px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);display: none;}.select-items div {color: #e7e9ea;padding: 10px 12px;cursor: pointer;user-select: none;transition: background-color 0.2s;border-bottom: 1px solid rgba(255, 255, 255, 0.05);}.select-items div:hover {background-color: rgba(29, 155, 240, 0.1);}.select-items div.same-as-selected {background-color: rgba(29, 155, 240, 0.2);}.select-items::-webkit-scrollbar {width: 6px;}.select-items::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);}.select-items::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.select-items::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}#openrouter-api-key,#user-instructions {width: 100%;padding: 10px 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);margin-bottom: 12px;background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;transition: border-color 0.2s;}#openrouter-api-key:focus,#user-instructions:focus {border-color: #1d9bf0;outline: none;}#user-instructions {height: 120px;resize: vertical;}.parameter-row {display: flex;align-items: center;margin-bottom: 12px;gap: 8px;padding: 6px;border-radius: 8px;transition: background-color 0.2s;}.parameter-row:hover {background-color: rgba(255, 255, 255, 0.05);}.parameter-label {flex: 1;font-size: 13px;color: #e7e9ea;}.parameter-control {flex: 1.5;display: flex;align-items: center;gap: 8px;}.parameter-value {min-width: 28px;text-align: center;background-color: rgba(255, 255, 255, 0.1);padding: 3px 5px;border-radius: 4px;font-size: 12px;}.parameter-slider {flex: 1;-webkit-appearance: none;height: 4px;border-radius: 4px;background: rgba(255, 255, 255, 0.2);outline: none;cursor: pointer;}.parameter-slider::-webkit-slider-thumb {-webkit-appearance: none;appearance: none;width: 14px;height: 14px;border-radius: 50%;background: #1d9bf0;cursor: pointer;transition: transform 0.1s;}.parameter-slider::-webkit-slider-thumb:hover {transform: scale(1.2);}.section-title {font-weight: bold;margin-top: 20px;margin-bottom: 8px;color: #e7e9ea;display: flex;align-items: center;gap: 6px;font-size: 14px;}.section-title:first-child {margin-top: 0;}.section-description {font-size: 12px;margin-bottom: 8px;opacity: 0.8;line-height: 1.4;}.section-title a {color: #1d9bf0;text-decoration: none;background-color: rgba(255, 255, 255, 0.1);padding: 3px 6px;border-radius: 6px;transition: all 0.2s ease;}.section-title a:hover {background-color: rgba(29, 155, 240, 0.2);text-decoration: underline;}.advanced-options {margin-top: 5px;margin-bottom: 15px;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 12px;background-color: rgba(255, 255, 255, 0.03);overflow: hidden;}.advanced-toggle {display: flex;justify-content: space-between;align-items: center;cursor: pointer;margin-bottom: 5px;}.advanced-toggle-title {font-weight: bold;font-size: 13px;color: #e7e9ea;}.advanced-toggle-icon {transition: transform 0.3s;}.advanced-toggle-icon.expanded {transform: rotate(180deg);}.advanced-content {max-height: 0;overflow: hidden;transition: max-height 0.3s ease-in-out;}.advanced-content.expanded {max-height: none;}#instructions-history-content.expanded {max-height: none !important;}#instructions-history .instructions-list {max-height: 400px;overflow-y: auto;margin-bottom: 10px;}.handle-list {margin-top: 10px;max-height: 120px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 5px;}.handle-item {display: flex;align-items: center;justify-content: space-between;padding: 6px 10px;border-bottom: 1px solid rgba(255, 255, 255, 0.05);border-radius: 4px;transition: background-color 0.2s;}.handle-item:hover {background-color: rgba(255, 255, 255, 0.05);}.handle-item:last-child {border-bottom: none;}.handle-text {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;}.remove-handle {background: none;border: none;color: #ff5c5c;cursor: pointer;font-size: 14px;padding: 0 3px;opacity: 0.7;transition: opacity 0.2s;}.remove-handle:hover {opacity: 1;}.add-handle-btn {background-color: #1d9bf0;color: white;border: none;border-radius: 6px;padding: 7px 10px;cursor: pointer;font-weight: bold;font-size: 12px;margin-left: 5px;transition: background-color 0.2s;}.add-handle-btn:hover {background-color: #1a8cd8;}.settings-button {background-color: #1d9bf0;color: white;border: none;border-radius: 8px;padding: 10px 14px;cursor: pointer;font-weight: bold;transition: background-color 0.2s;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;margin-top: 8px;width: 100%;font-size: 13px;}.settings-button:hover {background-color: #1a8cd8;}.settings-button.secondary {background-color: rgba(255, 255, 255, 0.1);}.settings-button.secondary:hover {background-color: rgba(255, 255, 255, 0.15);}.settings-button.danger {background-color: #ff5c5c;}.settings-button.danger:hover {background-color: #e53935;}.button-row {display: flex;gap: 8px;margin-top: 10px;}.button-row .settings-button {margin-top: 0;}.stats-container {background-color: rgba(255, 255, 255, 0.05);padding: 10px;border-radius: 8px;margin-bottom: 15px;}.stats-row {display: flex;justify-content: space-between;padding: 5px 0;border-bottom: 1px solid rgba(255, 255, 255, 0.1);}.stats-row:last-child {border-bottom: none;}.stats-label {font-size: 12px;opacity: 0.8;}.stats-value {font-weight: bold;}.score-indicator {position: absolute;top: 10px;right: 10.5%;background-color: rgba(22, 24, 28, 0.9);color: #e7e9ea;padding: 4px 10px;border-radius: 8px;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 14px;font-weight: bold;z-index: 100;cursor: pointer;border: 1px solid rgba(255, 255, 255, 0.1);min-width: 20px;text-align: center;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);transition: transform 0.15s ease;}.score-indicator:hover {transform: scale(1.05);}.score-indicator.mobile-indicator {position: absolute !important;bottom: 3% !important;right: 10px !important;top: auto !important;}.score-description {display: none;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 0 20px 16px 20px;border-radius: 12px;box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 16px;line-height: 1.5;z-index: 99999999;position: absolute;width: 550px !important;max-width: 80vw !important;max-height: 60vh;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);word-wrap: break-word;box-sizing: border-box !important;max-width: 500px;padding-bottom: 35px;}.score-description.pinned {border: 2px solid #1d9bf0 !important;}.tooltip-controls {display: flex !important;justify-content: flex-end !important;position: relative !important;margin: 0 -20px 15px -20px !important;top: 0 !important;background-color: rgba(39, 44, 48, 0.95) !important;padding: 12px 15px !important;z-index: 2 !important;border-top-left-radius: 12px !important;border-top-right-radius: 12px !important;border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;backdrop-filter: blur(5px) !important;}.tooltip-pin-button,.tooltip-copy-button {background: none !important;border: none !important;color: #8899a6 !important;cursor: pointer !important;font-size: 16px !important;padding: 4px 8px !important;margin-left: 8px !important;border-radius: 4px !important;transition: all 0.2s !important;}.tooltip-pin-button:hover,.tooltip-copy-button:hover {background-color: rgba(29, 155, 240, 0.1) !important;color: #1d9bf0 !important;}.tooltip-pin-button:active,.tooltip-copy-button:active {transform: scale(0.95) !important;}.description-text {margin: 0 0 25px 0 !important;font-size: 15px !important;line-height: 1.6 !important;max-width: 100% !important;overflow-wrap: break-word !important;padding: 5px 0 !important;color: #e1e8ed !important;letter-spacing: 0.2px !important;}/* Style different elements within description text */.description-text p {margin: 0 0 12px 0 !important;}.description-text p:last-child {margin-bottom: 0 !important;}.description-text strong {color: #fff !important;font-weight: 600 !important;}.description-text em {color: #8899a6 !important;font-style: italic !important;}.description-text code {background: rgba(255, 255, 255, 0.1) !important;padding: 2px 6px !important;border-radius: 4px !important;font-family: \'SFMono-Regular\', Consolas, \'Liberation Mono\', Menlo, monospace !important;font-size: 0.9em !important;color: #1d9bf0 !important;}.description-text a {color: #1d9bf0 !important;text-decoration: none !important;transition: color 0.2s ease !important;border-bottom: 1px solid rgba(29, 155, 240, 0.3) !important;}.description-text a:hover {color: #ffffff !important;border-bottom-color: #ffffff !important;}/* Add subtle highlight for important sections */.description-text blockquote {margin: 12px 0 !important;padding: 8px 16px !important;border-left: 3px solid #1d9bf0 !important;background: rgba(29, 155, 240, 0.1) !important;border-radius: 0 4px 4px 0 !important;}/* Style lists within description */.description-text ul, .description-text ol {margin: 8px 0 12px 20px !important;padding: 0 !important;}.description-text li {margin: 4px 0 !important;line-height: 1.5 !important;}/* Style headings if present */.description-text h1,.description-text h2,.description-text h3,.description-text h4 {color: #ffffff !important;margin: 16px 0 8px 0 !important;font-weight: 600 !important;line-height: 1.3 !important;}.description-text h1 { font-size: 1.4em !important; }.description-text h2 { font-size: 1.3em !important; }.description-text h3 { font-size: 1.2em !important; }.description-text h4 { font-size: 1.1em !important; }/* Add subtle animation for content changes */.description-text {transition: opacity 0.2s ease !important;}/* Style tables if present */.description-text table {width: 100% !important;border-collapse: collapse !important;margin: 12px 0 !important;background: rgba(255, 255, 255, 0.03) !important;border-radius: 4px !important;}.description-text th,.description-text td {padding: 8px 12px !important;border: 1px solid rgba(255, 255, 255, 0.1) !important;text-align: left !important;}.description-text th {background: rgba(255, 255, 255, 0.05) !important;font-weight: 600 !important;color: #ffffff !important;}/* Add a subtle separator between major sections */.description-text hr {border: none !important;border-top: 1px solid rgba(255, 255, 255, 0.1) !important;margin: 20px 0 !important;}/* Style pre blocks for code snippets */.description-text pre {background: rgba(0, 0, 0, 0.2) !important;padding: 12px !important;border-radius: 4px !important;overflow-x: auto !important;border: 1px solid rgba(255, 255, 255, 0.1) !important;margin: 12px 0 !important;}.description-text pre code {background: none !important;padding: 0 !important;border-radius: 0 !important;font-size: 0.9em !important;color: #e1e8ed !important;}/* Add a subtle hover effect for interactive elements */.description-text *[role="button"],.description-text .interactive {transition: all 0.2s ease !important;}.description-text *[role="button"]:hover,.description-text .interactive:hover {background-color: rgba(255, 255, 255, 0.1) !important;}/* Style keyboard shortcuts or commands */.description-text kbd {background: rgba(255, 255, 255, 0.1) !important;border: 1px solid rgba(255, 255, 255, 0.2) !important;border-radius: 3px !important;padding: 2px 6px !important;font-size: 0.9em !important;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;box-shadow: 0 1px 1px rgba(0,0,0,0.2) !important;}.tooltip-bottom-spacer {height: 10px;}.reasoning-dropdown {margin-top: 15px !important;border-top: 1px solid rgba(255, 255, 255, 0.1) !important;padding-top: 10px !important;}.reasoning-toggle {display: flex !important;align-items: center !important;color: #1d9bf0 !important;cursor: pointer !important;font-weight: bold !important;padding: 5px !important;user-select: none !important;}.reasoning-toggle:hover {background-color: rgba(29, 155, 240, 0.1) !important;border-radius: 4px !important;}.reasoning-arrow {display: inline-block !important;margin-right: 5px !important;transition: transform 0.2s ease !important;}.reasoning-content {max-height: 0 !important;overflow: hidden !important;transition: max-height 0.3s ease-out, padding 0.3s ease-out !important;background-color: rgba(0, 0, 0, 0.15) !important;border-radius: 5px !important;margin-top: 5px !important;padding: 0 !important;}.reasoning-dropdown.expanded .reasoning-content {max-height: 350px !important;overflow-y: auto !important;padding: 10px !important;}.reasoning-dropdown.expanded .reasoning-arrow {transform: rotate(90deg) !important;}.reasoning-text {font-size: 14px !important;line-height: 1.4 !important;color: #ccc !important;margin: 0 !important;padding: 5px !important;}.scroll-to-bottom-button {position: sticky;bottom: 0;width: 100%;background-color: rgba(29, 155, 240, 0.9);color: white;text-align: center;padding: 8px 0;cursor: pointer;font-weight: bold;border-top: 1px solid rgba(255, 255, 255, 0.2);margin-top: 10px;z-index: 100;transition: background-color 0.2s;}.scroll-to-bottom-button:hover {background-color: rgba(29, 155, 240, 1);}@media (max-width: 600px) {.score-indicator {position: absolute !important;bottom: 3% !important;right: 10px !important;top: auto !important;}.score-description {position: fixed !important;width: 100% !important;max-width: 100% !important;top: 5vh !important;bottom: 5vh !important;left: 0 !important;right: 0 !important;margin: 0 !important;padding: 12px !important;box-sizing: border-box !important;overflow-y: auto !important;overflow-x: hidden !important;-webkit-overflow-scrolling: touch !important;overscroll-behavior: contain !important;transform: translateZ(0) !important;border-radius: 16px 16px 0 0 !important;}.reasoning-dropdown.expanded .reasoning-content {max-height: 200px !important;}.close-button {width: 32px;height: 32px;min-width: 32px;min-height: 32px;font-size: 18px;padding: 8px;margin: -4px;}.settings-header .close-button {position: relative;right: 0;}.tooltip-close-button {font-size: 22px !important;width: 32px !important;height: 32px !important;}.tooltip-controls {padding-right: 40px !important;}}.sort-container {margin: 10px 0;display: flex;align-items: center;gap: 10px;justify-content: space-between;}.sort-container label {font-size: 14px;color: var(--text-color);white-space: nowrap;}.sort-container .controls-group {display: flex;gap: 8px;align-items: center;}.sort-container select {padding: 5px 10px;border-radius: 4px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-size: 14px;cursor: pointer;min-width: 120px;}.sort-container select:hover {border-color: #1d9bf0;}.sort-container select:focus {outline: none;border-color: #1d9bf0;box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.2);}.sort-toggle {padding: 5px 10px;border-radius: 4px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-size: 14px;cursor: pointer;transition: all 0.2s ease;}.sort-toggle:hover {border-color: #1d9bf0;background-color: rgba(29, 155, 240, 0.1);}.sort-toggle.active {background-color: rgba(29, 155, 240, 0.2);border-color: #1d9bf0;}.sort-container select option {background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;}@media (min-width: 601px) {#settings-container {width: 480px;max-width: 480px;}}#handle-input {flex: 1;padding: 8px 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 14px;transition: border-color 0.2s;min-width: 200px;}#handle-input:focus {outline: none;border-color: #1d9bf0;box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.2);}#handle-input::placeholder {color: rgba(231, 233, 234, 0.5);}.handle-input-container {display: flex;gap: 8px;align-items: center;margin-bottom: 10px;padding: 5px;border-radius: 8px;background-color: rgba(255, 255, 255, 0.03);}.add-handle-btn {background-color: #1d9bf0;color: white;border: none;border-radius: 8px;padding: 8px 16px;cursor: pointer;font-weight: bold;font-size: 14px;transition: background-color 0.2s;white-space: nowrap;}.add-handle-btn:hover {background-color: #1a8cd8;}.instructions-list {margin-top: 10px;max-height: 200px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 5px;}.instruction-item {display: flex;align-items: center;justify-content: space-between;padding: 8px 10px;border-bottom: 1px solid rgba(255, 255, 255, 0.05);border-radius: 4px;transition: background-color 0.2s;}.instruction-item:hover {background-color: rgba(255, 255, 255, 0.05);}.instruction-item:last-child {border-bottom: none;}.instruction-text {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;flex: 1;margin-right: 10px;}.instruction-buttons {display: flex;gap: 5px;}.use-instruction {background: none;border: none;color: #1d9bf0;cursor: pointer;font-size: 12px;padding: 3px 8px;border-radius: 4px;transition: all 0.2s;}.use-instruction:hover {background-color: rgba(29, 155, 240, 0.1);}.remove-instruction {background: none;border: none;color: #ff5c5c;cursor: pointer;font-size: 14px;padding: 0 3px;opacity: 0.7;transition: opacity 0.2s;border-radius: 4px;}.remove-instruction:hover {opacity: 1;background-color: rgba(255, 92, 92, 0.1);}.tweet-filtered {display: none !important;visibility: hidden !important;opacity: 0 !important;pointer-events: none !important;/* Ensure it stays hidden even if Twitter tries to show it */position: absolute !important;z-index: -9999 !important;height: 0 !important;width: 0 !important;margin: 0 !important;padding: 0 !important;overflow: hidden !important;}.filter-controls {display: flex;align-items: center;gap: 10px;margin: 5px 0;}.filter-controls input[type="range"] {flex: 1;min-width: 100px;}.filter-controls input[type="number"] {width: 50px;padding: 2px 5px;border: 1px solid #ccc;border-radius: 4px;text-align: center;}/* Hide number input spinners */.filter-controls input[type="number"]::-webkit-inner-spin-button,.filter-controls input[type="number"]::-webkit-outer-spin-button {-webkit-appearance: none;margin: 0;}.filter-controls input[type="number"] {-moz-appearance: textfield;}/* --- Metadata Specific Styling --- */.tooltip-metadata {font-size: 0.8em;opacity: 0.7;margin-top: 8px;padding-top: 8px;border-top: 1px solid rgba(255, 255, 255, 0.2);display: block;line-height: 1.5;}.metadata-line {white-space: nowrap;overflow: hidden;text-overflow: ellipsis;margin-bottom: 2px;}.metadata-separator {display: none;}/* --- Specific Indicator Styles --- */.score-indicator.pending-rating {}/* --- Tooltip Styles --- */.score-description {/* ... existing styles ... */max-width: 500px;padding-bottom: 35px; /* Add padding for scroll button *//* ... existing styles ... */}.score-description.streaming-tooltip {border-color: #ffa500; /* Orange border for streaming */}/* ... existing .tooltip-controls, .tooltip-pin-button, .tooltip-copy-button styles ... *//* --- Reasoning Dropdown --- */.reasoning-dropdown {/* ... existing styles ... */}.reasoning-toggle {/* ... existing styles ... */}.reasoning-arrow {/* ... existing styles ... */}.reasoning-content {/* ... existing styles ... */}.reasoning-text {/* ... existing styles ... */}.description-text {/* ... existing styles ... */}/* --- Last Answer Area --- */.tooltip-last-answer {margin-top: 10px;padding: 10px;background-color: rgba(255, 255, 255, 0.05); /* Slightly different background */border-radius: 4px;font-size: 0.9em;line-height: 1.4;}.answer-separator {border: none;border-top: 1px dashed rgba(255, 255, 255, 0.2);margin: 10px 0;}/* --- Follow-Up Questions Area --- */.tooltip-follow-up-questions {margin-top: 10px;display: flex;flex-direction: column;gap: 6px; /* Spacing between buttons */}.follow-up-question-button {background-color: rgba(60, 160, 240, 0.2); /* Light blue background */border: 1px solid rgba(60, 160, 240, 0.5);color: #e1e8ed; /* Light text */padding: 8px 12px;border-radius: 15px; /* Pill shape */cursor: pointer;font-size: 0.85em;text-align: left;transition: background-color 0.2s ease, border-color 0.2s ease;white-space: normal; /* Allow wrapping */line-height: 1.3;}.follow-up-question-button:hover {background-color: rgba(60, 160, 240, 0.35);border-color: rgba(60, 160, 240, 0.8);}.follow-up-question-button:active {background-color: rgba(60, 160, 240, 0.5);}/* --- Metadata Area --- */.tooltip-metadata {margin-top: 12px;padding-top: 8px;font-size: 0.8em;color: #8899a6; /* Muted color */border-top: 1px solid rgba(255, 255, 255, 0.1);}.metadata-separator {border: none;border-top: 1px dashed rgba(255, 255, 255, 0.2);margin: 8px 0;}.metadata-line {margin-bottom: 4px;}.metadata-line:last-child {margin-bottom: 0;}/* --- Score Highlight --- */.score-highlight {/* ... existing styles ... */}/* --- Scroll Button --- */.scroll-to-bottom-button {/* ... existing styles ... */}.tooltip-bottom-spacer {/* ... existing styles ... */}/* --- Custom Question Input Area --- */.tooltip-custom-question-container {margin-top: 15px;display: flex;gap: 8px;padding-top: 10px;border-top: 1px solid rgba(255, 255, 255, 0.1); /* Separator */}.tooltip-custom-question-input {flex-grow: 1; /* Take available space */padding: 8px 10px;border-radius: 6px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.9);color: #e7e9ea;font-size: 0.9em;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; /* Ensure font consistency */line-height: 1.4; /* Adjust line height for better text readability */resize: none; /* Prevent manual resizing by the user */overflow-y: hidden; /* Hide scrollbar initially, height adjustment will manage overflow */min-height: calc(0.9em * 1.4 + 16px + 2px); /* Approx height for 1 row: (font-size * line-height) + padding + border */box-sizing: border-box; /* Ensure padding and border are included in height calculation */}.tooltip-custom-question-input:focus {border-color: #1d9bf0;outline: none;}.tooltip-custom-question-button {background-color: #1d9bf0;color: white;border: none;border-radius: 6px;padding: 8px 12px;cursor: pointer;font-weight: bold;font-size: 0.9em;transition: background-color 0.2s;}.tooltip-custom-question-button:hover {background-color: #1a8cd8;}.tooltip-custom-question-button:disabled,.tooltip-custom-question-input:disabled {opacity: 0.6;cursor: not-allowed;}/* --- Conversation History Styling --- */.tooltip-conversation-history {margin-top: 15px;padding-top: 10px;border-top: 1px solid rgba(255, 255, 255, 0.1);display: flex;flex-direction: column;gap: 12px; /* Space between conversation turns */}.conversation-turn {background-color: rgba(255, 255, 255, 0.04);padding: 10px;border-radius: 6px;line-height: 1.4;}.conversation-question {font-size: 0.9em;color: #b0bec5; /* Lighter grey for user question */margin-bottom: 6px;}.conversation-question strong {color: #cfd8dc; /* Slightly brighter for "You:" */}.conversation-answer {font-size: 0.95em;color: #e1e8ed; /* Main text color for AI answer */}.conversation-answer strong {color: #1d9bf0; /* Twitter blue for "AI:" */}.conversation-separator {border: none;border-top: 1px dashed rgba(255, 255, 255, 0.15);margin: 0; /* Reset margin, gap handles spacing */}.pending-answer {color: #ffa726; /* Orange for pending state */font-style: italic;}/* Blinking cursor for streaming answers */.pending-cursor {display: inline-block;color: #1d9bf0; /* Twitter blue */animation: blink 0.7s infinite;font-weight: bold;margin-left: 2px;font-style: normal; /* Override italic from pending-answer if nested */}@keyframes blink {0%, 100% { opacity: 0; }50% { opacity: 1; }}/* Styling for links generated from markdown in AI answers */.ai-generated-link {color: #1d9bf0; /* Twitter blue */text-decoration: underline;transition: color 0.2s ease;}.ai-generated-link:hover {color: #1a8cd8; /* Slightly darker blue on hover */text-decoration: underline;}/* Style for the new tooltip close button */.tooltip-close-button {/* Reuse general close button styles */background: none !important;border: none !important;color: #8899a6 !important; /* Match other control button colors */cursor: pointer !important;font-size: 20px !important; /* Slightly larger for easier tapping */line-height: 1 !important;padding: 4px 8px !important;margin-left: 8px !important; /* Space from other buttons */border-radius: 50% !important; /* Make it round */width: 28px !important; /* Explicit size */height: 28px !important; /* Explicit size */display: flex !important;align-items: center !important;justify-content: center !important;transition: all 0.2s !important;order: 3; /* Ensure it comes after pin and copy */}.tooltip-close-button:hover {background-color: rgba(255, 92, 92, 0.1) !important; /* Reddish background on hover */color: #ff5c5c !important; /* Red color on hover */}.tooltip-close-button:active {transform: scale(0.95) !important;}/* Adjust mobile close button specifically if needed */@media (max-width: 600px) {.tooltip-close-button {font-size: 22px !important; /* Even larger on mobile */width: 32px !important;height: 32px !important;}/* Ensure controls container accommodates button */.tooltip-controls {padding-right: 40px !important; /* Add padding to prevent overlap if button was absolute */}}/* --- Styling for Reasoning Dropdown within Conversation Turn --- */.conversation-turn .reasoning-dropdown {margin-top: 8px; /* Space above the dropdown */margin-bottom: 8px; /* Space below the dropdown, before the answer */border-radius: 4px;background-color: rgba(255, 255, 255, 0.02); /* Slightly different background from turn itself */border: 1px solid rgba(255, 255, 255, 0.08);}.conversation-turn .reasoning-toggle {display: flex;align-items: center;color: #b0bec5; /* Muted color for toggle text */cursor: pointer;font-weight: normal; /* Less prominent than main reasoning toggle */font-size: 0.85em;padding: 6px 8px;user-select: none;transition: background-color 0.2s;}.conversation-turn .reasoning-toggle:hover {background-color: rgba(255, 255, 255, 0.05);}.conversation-turn .reasoning-arrow {display: inline-block;margin-right: 4px;font-size: 0.9em;transition: transform 0.2s ease;}.conversation-turn .reasoning-content {max-height: 0;overflow: hidden;transition: max-height 0.3s ease-out, padding 0.3s ease-out;background-color: rgba(0, 0, 0, 0.1);border-radius: 0 0 4px 4px;padding: 0 8px; /* Horizontal padding only when collapsed */}.conversation-turn .reasoning-dropdown.expanded .reasoning-content {max-height: 200px; /* Adjust as needed */overflow-y: auto;padding: 8px; /* Full padding when expanded */}.conversation-turn .reasoning-dropdown.expanded .reasoning-arrow {transform: rotate(90deg);}.conversation-turn .reasoning-text {font-size: 0.85em; /* Smaller text for reasoning */line-height: 1.4;color: #ccc; /* Similar to main reasoning text */margin: 0;padding: 0; /* Padding is on the content container */}/* Ensure scrollbars look consistent */.conversation-turn .reasoning-content::-webkit-scrollbar {width: 5px;}.conversation-turn .reasoning-content::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);border-radius: 3px;}.conversation-turn .reasoning-content::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.conversation-turn .reasoning-content::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}/* --- Styling for Image Upload in Follow-up --- */.tooltip-attach-image-button {background: none;border: none;color: #8899a6; /* Muted color, similar to other controls */font-size: 1.2em; /* Slightly larger for icon visibility */cursor: pointer;padding: 6px 8px; /* Adjust padding to align with input/button height */margin: 0 4px; /* Space around the icon */border-radius: 4px;transition: all 0.2s ease;align-self: center; /* Vertically align with input and Ask button */}.tooltip-attach-image-button:hover {background-color: rgba(29, 155, 240, 0.1);color: #1d9bf0;}.tooltip-follow-up-image-preview-container {margin-top: 10px;padding-top: 10px;border-top: 1px solid rgba(255, 255, 255, 0.1);display: flex; /* Changed to flex for easier alignment of preview and button */flex-direction: row; /* Lay out previews in a row */flex-wrap: wrap; /* Allow previews to wrap to the next line */gap: 10px; /* Spacing between preview items */align-items: flex-start;}.follow-up-image-preview-item {position: relative; /* For positioning the remove button */display: flex;flex-direction: column;align-items: center;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 6px;padding: 5px;background-color: rgba(255, 255, 255, 0.05);}.follow-up-image-preview-thumbnail {max-width: 80px; /* Smaller thumbnails for multiple previews */max-height: 80px;border-radius: 4px;object-fit: cover; /* Or contain, depending on desired look */margin-bottom: 5px; /* Space between image and potential future captions */}.follow-up-image-remove-btn {position: absolute;top: -5px;right: -5px;background-color: rgba(40, 40, 40, 0.8);color: white;border: 1px solid rgba(255,255,255,0.3);border-radius: 50%; /* Circular button */width: 20px;height: 20px;font-size: 12px;font-weight: bold;line-height: 18px; /* Adjust for vertical centering of X */text-align: center;cursor: pointer;padding: 0;transition: background-color 0.2s ease, transform 0.2s ease;}.follow-up-image-remove-btn:hover {background-color: rgba(255, 92, 92, 0.9);transform: scale(1.1);}/* Adjust custom question container to be flex for alignment */.tooltip-custom-question-container {/* ... existing styles ... */display: flex; /* Ensures items are in a row */align-items: center; /* Vertically aligns items in the middle */}.tooltip-custom-question-input {/* ... existing styles ... */margin-right: 0; /* Remove right margin if any, gap handles spacing */}/* --- Styling for Uploaded Image in Conversation History --- */.conversation-image-container {margin-top: 8px; /* Space above the image */margin-bottom: 8px; /* Space below the image, before reasoning/answer */display: flex; /* Use flex for multiple images */flex-wrap: wrap; /* Allow images to wrap */gap: 8px; /* Space between images */}.conversation-uploaded-image {max-width: 80%; /* Limit width to not dominate the tooltip */max-height: 120px; /* Slightly larger than preview, but still constrained */border-radius: 6px;border: 1px solid rgba(255, 255, 255, 0.2);object-fit: contain; /* Maintain aspect ratio */display: block; /* Ensure it takes its own line if needed */cursor: pointer; /* Indicate it can be clicked (e.g., for lightbox in future) */transition: transform 0.2s ease;}.conversation-uploaded-image:hover {transform: scale(1.02); /* Slight zoom on hover */}'),GM_setValue("menuHTML",t);class n{static DEBOUNCE_DELAY=1500;constructor(){var t,e;this.cache={},this.loadFromStorage();let i;this.debouncedSaveToStorage=(t=this.#a.bind(this),e=n.DEBOUNCE_DELAY,function o(...n){let r=()=>{clearTimeout(i),t.apply(this,n)};clearTimeout(i),i=setTimeout(r,e)})}loadFromStorage(){try{let t=e("tweetRatings","{}");for(let i in this.cache=JSON.parse(t),this.cache)this.cache[i].fromStorage=!0}catch(o){this.cache={}}}#a(){try{i("tweetRatings",JSON.stringify(this.cache)),o()}catch(r){}}get(t){return this.cache[t]||null}set(t,e,i=!0){this.cache[t]={score:e.score,fullContext:e.fullContext||"",description:e.description||"",reasoning:e.reasoning||"",questions:e.questions||[],lastAnswer:e.lastAnswer||"",mediaUrls:e.mediaUrls||[],timestamp:e.timestamp||Date.now(),streaming:e.streaming||!1,blacklisted:e.blacklisted||!1,fromStorage:e.fromStorage||!1,metadata:{model:e.metadata?.model||null,promptTokens:e.metadata?.promptTokens||null,completionTokens:e.metadata?.completionTokens||null,latency:e.metadata?.latency||null,mediaInputs:e.metadata?.mediaInputs||null,price:e.metadata?.price||null},qaConversationHistory:e.qaConversationHistory||[]},i?this.#a():this.debouncedSaveToStorage()}has(t){return void 0!==this.cache[t]}delete(t,e=!0){this.has(t)&&(delete this.cache[t],this.debouncedSaveToStorage())}clear(t=!1){this.cache={},t?this.#a():this.debouncedSaveToStorage()}get size(){return Object.keys(this.cache).length}cleanup(t=!0){let e=this.size,i=0,o=0,n=0,r=0;for(let a in this.cache){let s=this.cache[a],l=!1;(void 0===s.score||null===s.score)&&(!0===s.streaming?o++:n++,l=!0),s.streaming||void 0===s.score||null===s.score||s.blacklisted||s.qaConversationHistory&&Array.isArray(s.qaConversationHistory)&&!(s.qaConversationHistory.length<3)||(r++,l=!0),l&&(delete this.cache[a],i++)}return i>0&&this.debouncedSaveToStorage(),{beforeCount:e,afterCount:this.size,deletedCount:i,streamingDeletedCount:o,undefinedScoreCount:n,missingQaHistoryCount:r}}}let a=new n;class s{constructor(){if(s.instance)return s.instance;s.instance=this,this.history=[],this.maxEntries=10,this.loadFromStorage()}#b(l){let d=0;for(let c=0;c<l.length;c++){let p=l.charCodeAt(c);d=(d<<5)-d+p,d&=d}return d.toString(36)}loadFromStorage(){try{let t=e("instructionsHistory","[]");if(this.history=JSON.parse(t),!Array.isArray(this.history))throw Error("Stored history is not an array");this.history=this.history.map(t=>({...t,hash:t.hash||this.#b(t.instructions)}))}catch(i){this.history=[]}}#c(){try{i("instructionsHistory",JSON.stringify(this.history))}catch(u){throw Error("Failed to save instructions history")}}async add(t,e){try{if(!t?.trim()||!e?.trim())throw Error("Invalid instructions or summary");let i=this.#b(t.trim()),o=this.history.findIndex(t=>t.hash===i);if(-1!==o){this.history[o].timestamp=Date.now(),this.history[o].summary=e;let n=this.history.splice(o,1)[0];this.history.unshift(n)}else this.history.unshift({instructions:t.trim(),summary:e.trim(),timestamp:Date.now(),hash:i}),this.history.length>this.maxEntries&&(this.history=this.history.slice(0,this.maxEntries));return this.#c(),!0}catch(r){return!1}}remove(t){try{if(t<0||t>=this.history.length)throw Error("Invalid history index");return this.history.splice(t,1),this.#c(),!0}catch(e){return!1}}getAll(){return[...this.history]}get(t){try{if(t<0||t>=this.history.length)return null;return{...this.history[t]}}catch(e){return null}}clear(){try{this.history=[],this.#c()}catch(t){throw Error("Failed to clear instructions history")}}get size(){return this.history.length}}class h{constructor(){if(h.instance)return h.instance;h.instance=this,this.history=new s,this.currentInstructions=e("userDefinedInstructions","")}async saveInstructions(t){if(!t?.trim())return{success:!1,message:"Instructions cannot be empty"};t=t.trim(),this.currentInstructions=t,i("userDefinedInstructions",t),void 0!==$&&($=t);let e=await tU(t);return e.error||await this.history.add(t,e.content),{success:!0,message:"Scoring instructions saved! New tweets will use these instructions.",shouldClearCache:!0}}getCurrentInstructions(){return this.currentInstructions}getHistory(){return this.history.getAll()}removeFromHistory(t){return this.history.remove(t)}clearHistory(){this.history.clear()}}let g=new h,m=new Set,f=new Set,$=g.getCurrentInstructions()||"Rate the tweet on a scale from 1 to 10 based on its clarity, insight, creativity, and overall quality.",b=parseInt(e("filterThreshold","5")),y=null,x=0,v=0,w=[],_=[],E=e("selectedModel","openai/gpt-4.1-nano"),S=e("selectedImageModel","openai/gpt-4.1-nano"),k=e("showFreeModels",!0),I=e("providerSort",""),C=e("blacklistedHandles","").split("\n").filter(t=>""!==t.trim());e("tweetRatings","{}");let T="",A=e("enableImageDescriptions",!1);e("enableStreaming",!0);let q=`
    You are **TweetFilter-AI**.
    When given a tweet, do these three steps **in order**:
    1. **ANALYZE** - Judge how closely the tweet matches the user's instructions.  
    2. **SCORE** - Assign an integer from 0'10 (inclusive) based *only* on that alignment.  
    3. **ASK** - Write **exactly three** open-ended follow-up questions the user might ask next.  
       ‚Ä¢ Questions must be answerable from the tweet itself or general knowledge.  
       ‚Ä¢ Do **not** ask for information that requires unavailable context (e.g., the author's other tweets).
    **Important constraints**
    ‚Ä¢ You do **not** have up-to-the-minute knowledge of current events.  
      ‚Üí If a tweet makes a factual claim you cannot verify, **do not down-score it** for "fake news"; instead, evaluate it solely on the user's criteria and note any uncertainty in your analysis.  
      ‚Üí Only down-score when the tweet contradicts widely-known, stable facts or directly violates the user's instructions.
    ‚ö†Ô∏è Output must match **exactly** the EXPECTED_RESPONSE_FORMAT" - no extra text, no missing tags - or the pipeline crashes.
  EXPECTED_RESPONSE_FORMAT: (begin with <ANALYSIS> and end with </FOLLOW_UP_QUESTIONS>)
    <ANALYSIS>
      (Your analysis goes here.)
    </ANALYSIS>
    <SCORE>
      SCORE_X
    </SCORE>
    <FOLLOW_UP_QUESTIONS>
      Q_1. ‚Ä¶
      Q_2. ‚Ä¶
      Q_3. ‚Ä¶
    </FOLLOW_UP_QUESTIONS>
  End of EXPECTED_RESPONSE_FORMAT
`,L=`
You are TweetFilter-AI, continuing a conversation about a tweet.
The user has asked a follow-up question.
Your entire conversation history up to this point is provided in the message list.
Please provide an answer and then generate 3 new, relevant follow-up questions.
Adhere strictly to the following response format:
<ANSWER>
(Your answer here)
</ANSWER>
<FOLLOW_UP_QUESTIONS>
Q_1. (New Question 1 here)
Q_2. (New Question 2 here)
Q_3. (New Question 3 here)
</FOLLOW_UP_QUESTIONS>
`,R=parseFloat(e("modelTemperature","0.5")),U=parseFloat(e("modelTopP","0.9")),H=parseFloat(e("imageModelTemperature","0.5")),N=parseFloat(e("imageModelTopP","0.9")),O=parseInt(e("maxTokens","0")),M='article[data-testid="tweet"]',B='div[role="link"][tabindex="0"]',P='div[data-testid="tweetText"]';function Q(t){if(!w||0===w.length)return!1;let e=w.find(e=>e.slug===t);return!!e&&e.input_modalities&&e.input_modalities.includes("image")}function z(t){if(!t)return"";let e=t instanceof NodeList?Array.from(t):[t];for(let i of e){let o=i?.textContent?.trim();if(o)return o}return""}function F(t){let e=t.querySelector('a[href*="/status/"] time'),i=e?.parentElement?.href;if(i&&i.includes("/status/")){let o=i.match(/\/status\/(\d+)/);return o&&o[1]?o[1]:i.substring(i.indexOf("/status/")+1)}return`tweet-${Math.random().toString(36).substring(2,15)}-${Date.now()}`}function D(t){let e=[],i=t.querySelector('div[data-testid="User-Name"] a[role="link"]');if(i){let o=i.getAttribute("href");o&&o.startsWith("/")&&e.push(o.slice(1))}if(e.length>0){let n=t.querySelector('div[role="link"][tabindex="0"]');if(n){let r=n.querySelector('div[data-testid^="UserAvatar-Container-"]');if(r){let a=r.getAttribute("data-testid"),s=a.lastIndexOf("-");if(s>=0&&s<a.length-1){let l=a.substring(s+1);l&&l!==e[0]&&e.push(l)}let d=n.querySelector('a[href*="/status/"]');if(d){let c=d.getAttribute("href"),p=c.match(/^\/([^/]+)\/status\/\d+/);p&&p[1]&&p[1]!==e[0]&&e.push(p[1])}}}}return e.length>0?e:[""]}async function W(t){if(!t)return[];let e=new Set,i='div[data-testid="tweetPhoto"] img, img[src*="pbs.twimg.com/media"], [data-testid="tweetPhoto"] img, img[src*="pbs.twimg.com/media"]',o='video[poster*="pbs.twimg.com"], video, video[poster*="pbs.twimg.com"], video',n=`${i}, ${o}`,r=t.querySelectorAll(n),a=0;for(;0===r.length&&a<5;)a++,await new Promise(t=>setTimeout(t,100)),r=t.querySelectorAll(n);return 0===r.length&&t.matches(B)&&(r=t.querySelectorAll('img[src*="pbs.twimg.com"], video[poster*="pbs.twimg.com"]')),r.forEach(t=>{let i="IMG"===t.tagName?t.src:t.poster;if(!(!i||!i.includes("pbs.twimg.com/")||i.includes("profile_images")))try{let o=new URL(i),n=o.searchParams.get("name"),r=i;n&&"orig"!==n&&(r=i.replace(`name=${n}`,"name=small")),e.add(r)}catch(a){e.add(i)}}),Array.from(e)}function Y(t){let e=t.nextElementSibling;for(;e;){if(e.matches&&e.matches('div[data-testid="inline_reply_offscreen"]'))return!0;e=e.nextElementSibling}return!1}function j(t){let e=!1,i=!1,o=t=>{if(!t||t.dataset?.filtered==="true"||t.dataset?.isAd==="true")return!0;let e=t.closest('div[data-testid="cellInnerDiv"]');if(e?.dataset?.filtered==="true"||e?.dataset?.isAd==="true")return!0;if(G(t))return e&&(e.dataset.isAd="true",e.classList.add("tweet-filtered")),t.dataset.isAd="true",!0;let i=F(t);if(m.has(i)){let o=tt.get(i);if(o&&"error"!==o.status)return!0}return!1};for(let n of t)"childList"===n.type&&(n.addedNodes.length>0&&n.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){let i=null;if(t.matches&&t.matches('div[aria-label^="Timeline: Conversation"]')?i=t:t.querySelector&&(i=t.querySelector('div[aria-label^="Timeline: Conversation"]')),i&&setTimeout(t0,50),t.matches&&t.matches(M))o(t)||(tx(t),e=!0);else if(t.querySelector){let n=t.querySelectorAll(M);n.forEach(t=>{o(t)||(tx(t),e=!0)})}}}),n.removedNodes.length>0&&n.removedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE&&t.dataset?.filtered!=="true"&&t.dataset?.isAd!=="true"){if(t.matches&&t.matches(M)){let e=F(t);e&&(tt.get(e)?.destroy(),i=!0)}else if(t.querySelectorAll){let o=t.querySelectorAll(M);o.forEach(t=>{if(t.dataset?.filtered==="true"||t.dataset?.isAd==="true")return;let e=F(t);e&&(tt.get(e)?.destroy(),i=!0)})}}}));e&&setTimeout(()=>{tE()},100),i&&tt.cleanupOrphaned()}function G(t){if(!t)return!1;let e=t.querySelectorAll('div[dir="ltr"] span');for(let i of e)if("Ad"===i.textContent.trim()&&!i.children.length)return!0;return!1}function X(){return window.innerWidth<=600||/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function V(t,e="info"){let i=document.getElementById("status-indicator");i&&(i.textContent=t,i.className="active "+e,setTimeout(()=>{i.classList.remove("active",e)},3e3))}async function K(){let t=document.getElementById("user-instructions"),e=await g.saveInstructions(t.value);V(e.message),e.success&&e.shouldClearCache&&(X()||confirm("Do you want to clear the rating cache to apply these instructions to all tweets?"))&&to(),e.success&&Z()}function Z(){let t=document.getElementById("instructions-list");if(!t)return;let e=g.getHistory();if(t.innerHTML="",0===e.length){let i=document.createElement("div");i.style.cssText="padding: 8px; opacity: 0.7; font-style: italic;",i.textContent="No saved instructions yet",t.appendChild(i);return}e.forEach((e,i)=>{let o=function t(e,i){let o=document.createElement("div");o.className="instruction-item",o.dataset.index=i;let n=document.createElement("div");n.className="instruction-text",n.textContent=e.summary,n.title=e.instructions,o.appendChild(n);let r=document.createElement("div");r.className="instruction-buttons";let a=document.createElement("button");a.className="use-instruction",a.textContent="Use",a.title="Use these instructions",a.onclick=()=>(function t(e){let i=document.getElementById("user-instructions");i&&(i.value=e,K())})(e.instructions),r.appendChild(a);let s=document.createElement("button");return s.className="remove-instruction",s.textContent="\xd7",s.title="Remove from history",s.onclick=()=>{var t;return t=i,void(g.removeFromHistory(t)?(Z(),V("Instructions removed from history")):V("Error removing instructions"))},r.appendChild(s),o.appendChild(r),o}(e,i);t.appendChild(o)})}class J{constructor(t){if(!t||!t.nodeType||t.nodeType!==Node.ELEMENT_NODE)throw Error("ScoreIndicator requires a valid tweet article DOM element.");this.tweetArticle=t,this.tweetId=F(this.tweetArticle),this.indicatorElement=null,this.tooltipElement=null,this.tooltipControls=null,this.pinButton=null,this.copyButton=null,this.tooltipCloseButton=null,this.reasoningDropdown=null,this.reasoningToggle=null,this.reasoningArrow=null,this.reasoningContent=null,this.reasoningTextElement=null,this.descriptionElement=null,this.scoreTextElement=null,this.followUpQuestionsTextElement=null,this.scrollButton=null,this.metadataElement=null,this.conversationContainerElement=null,this.followUpQuestionsElement=null,this.customQuestionContainer=null,this.customQuestionInput=null,this.customQuestionButton=null,this.attachImageButton=null,this.followUpImageContainer=null,this.followUpImageInput=null,this.followUpImagePreview=null,this.followUpRemoveImageButton=null,this.uploadedImageDataUrls=[],this.status="pending",this.score=null,this.description="",this.reasoning="",this.metadata=null,this.conversationHistory=[],this.questions=[],this.isPinned=!1,this.isVisible=!1,this.autoScroll=!0,this.userInitiatedScroll=!1,this.uploadedImageDataUrls=[],this.qaConversationHistory=[];try{this._createElements(t),this._addEventListeners(),tt.add(this.tweetId,this),this.updateDatasetAttributes(t)}catch(e){throw this.destroy(),e}}_createElements(t){this.indicatorElement=document.createElement("div"),this.indicatorElement.className="score-indicator",this.indicatorElement.dataset.tweetId=this.tweetId;let i=window.getComputedStyle(t).position;"relative"!==i&&"absolute"!==i&&"fixed"!==i&&"sticky"!==i&&(t.style.position="relative"),t.appendChild(this.indicatorElement),this.tooltipElement=document.createElement("div"),this.tooltipElement.className="score-description",this.tooltipElement.style.display="none",this.tooltipElement.dataset.tweetId=this.tweetId,this.tooltipElement.dataset.autoScroll=this.autoScroll?"true":"false",this.tooltipControls=document.createElement("div"),this.tooltipControls.className="tooltip-controls",this.tooltipCloseButton=document.createElement("button"),this.tooltipCloseButton.className="close-button tooltip-close-button",this.tooltipCloseButton.innerHTML="\xd7",this.tooltipCloseButton.title="Close tooltip",this.pinButton=document.createElement("button"),this.pinButton.className="tooltip-pin-button",this.pinButton.innerHTML="\uD83D\uDCCC",this.pinButton.title="Pin tooltip (prevents auto-closing)",this.copyButton=document.createElement("button"),this.copyButton.className="tooltip-copy-button",this.copyButton.innerHTML="\uD83D\uDCCB",this.copyButton.title="Copy content to clipboard",this.tooltipControls.appendChild(this.pinButton),this.tooltipControls.appendChild(this.copyButton),this.tooltipControls.appendChild(this.tooltipCloseButton),this.tooltipElement.appendChild(this.tooltipControls),this.reasoningDropdown=document.createElement("div"),this.reasoningDropdown.className="reasoning-dropdown",this.reasoningDropdown.style.display="none",this.reasoningToggle=document.createElement("div"),this.reasoningToggle.className="reasoning-toggle",this.reasoningArrow=document.createElement("span"),this.reasoningArrow.className="reasoning-arrow",this.reasoningArrow.textContent="‚ñ∂",this.reasoningToggle.appendChild(this.reasoningArrow),this.reasoningToggle.appendChild(document.createTextNode(" Show Reasoning Trace")),this.reasoningContent=document.createElement("div"),this.reasoningContent.className="reasoning-content",this.reasoningTextElement=document.createElement("p"),this.reasoningTextElement.className="reasoning-text",this.reasoningContent.appendChild(this.reasoningTextElement),this.reasoningDropdown.appendChild(this.reasoningToggle),this.reasoningDropdown.appendChild(this.reasoningContent),this.tooltipElement.appendChild(this.reasoningDropdown),this.descriptionElement=document.createElement("div"),this.descriptionElement.className="description-text",this.tooltipElement.appendChild(this.descriptionElement),this.scoreTextElement=document.createElement("div"),this.scoreTextElement.className="score-text-from-description",this.scoreTextElement.style.display="none",this.tooltipElement.appendChild(this.scoreTextElement),this.followUpQuestionsTextElement=document.createElement("div"),this.followUpQuestionsTextElement.className="follow-up-questions-text-from-description",this.followUpQuestionsTextElement.style.display="none",this.tooltipElement.appendChild(this.followUpQuestionsTextElement),this.conversationContainerElement=document.createElement("div"),this.conversationContainerElement.className="tooltip-conversation-history",this.tooltipElement.appendChild(this.conversationContainerElement),this.followUpQuestionsElement=document.createElement("div"),this.followUpQuestionsElement.className="tooltip-follow-up-questions",this.followUpQuestionsElement.style.display="none",this.tooltipElement.appendChild(this.followUpQuestionsElement),this.customQuestionContainer=document.createElement("div"),this.customQuestionContainer.className="tooltip-custom-question-container",this.customQuestionInput=document.createElement("textarea"),this.customQuestionInput.placeholder="Ask your own question...",this.customQuestionInput.className="tooltip-custom-question-input",this.customQuestionInput.rows=1,this.customQuestionInput.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"});let o=e("selectedModel","openai/gpt-4.1-nano"),n=Q(o);n&&(this.attachImageButton=document.createElement("button"),this.attachImageButton.textContent="\uD83D\uDCCE",this.attachImageButton.className="tooltip-attach-image-button",this.attachImageButton.title="Attach image(s)",this.followUpImageInput=document.createElement("input"),this.followUpImageInput.type="file",this.followUpImageInput.accept="image/*",this.followUpImageInput.multiple=!0,this.followUpImageInput.style.display="none"),this.customQuestionButton=document.createElement("button"),this.customQuestionButton.textContent="Ask",this.customQuestionButton.className="tooltip-custom-question-button",this.customQuestionContainer.appendChild(this.customQuestionInput),this.attachImageButton&&(this.customQuestionContainer.appendChild(this.attachImageButton),this.followUpImageInput&&this.customQuestionContainer.appendChild(this.followUpImageInput)),this.customQuestionContainer.appendChild(this.customQuestionButton),this.tooltipElement.appendChild(this.customQuestionContainer),n&&(this.followUpImageContainer=document.createElement("div"),this.followUpImageContainer.className="tooltip-follow-up-image-preview-container",this.tooltipElement.insertBefore(this.followUpImageContainer,this.metadataElement)),this.metadataElement=document.createElement("div"),this.metadataElement.className="tooltip-metadata",this.metadataElement.style.display="none",this.tooltipElement.appendChild(this.metadataElement),this.scrollButton=document.createElement("div"),this.scrollButton.className="scroll-to-bottom-button",this.scrollButton.innerHTML="‚¨á Scroll to bottom",this.scrollButton.style.display="none",this.tooltipElement.appendChild(this.scrollButton);let r=document.createElement("div");r.className="tooltip-bottom-spacer",this.tooltipElement.appendChild(r),document.body.appendChild(this.tooltipElement),X()&&(this.indicatorElement?.classList.add("mobile-indicator"),this.tooltipElement?.classList.add("mobile-tooltip")),this._updateIndicatorUI(),this._updateTooltipUI()}_addEventListeners(){this.indicatorElement&&this.tooltipElement&&(this.indicatorElement.addEventListener("mouseenter",this._handleMouseEnter.bind(this)),this.indicatorElement.addEventListener("mouseleave",this._handleMouseLeave.bind(this)),this.indicatorElement.addEventListener("click",this._handleIndicatorClick.bind(this)),this.tooltipElement.addEventListener("mouseenter",this._handleTooltipMouseEnter.bind(this)),this.tooltipElement.addEventListener("mouseleave",this._handleTooltipMouseLeave.bind(this)),this.tooltipElement.addEventListener("scroll",this._handleTooltipScroll.bind(this)),this.pinButton?.addEventListener("click",this._handlePinClick.bind(this)),this.copyButton?.addEventListener("click",this._handleCopyClick.bind(this)),this.tooltipCloseButton?.addEventListener("click",this._handleCloseClick.bind(this)),this.reasoningToggle?.addEventListener("click",this._handleReasoningToggleClick.bind(this)),this.scrollButton?.addEventListener("click",this._handleScrollButtonClick.bind(this)),this.followUpQuestionsElement?.addEventListener("click",this._handleFollowUpQuestionClick.bind(this)),this.customQuestionButton?.addEventListener("click",this._handleCustomQuestionClick.bind(this)),this.customQuestionInput?.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),this._handleCustomQuestionClick())}),this.attachImageButton&&this.followUpImageInput&&(this.attachImageButton.addEventListener("click",()=>this.followUpImageInput.click()),this.followUpImageInput.addEventListener("change",this._handleFollowUpImageSelect.bind(this))))}updateDatasetAttributes(t){let e=t||this.findCurrentArticleElement();e&&(e.dataset.ratingStatus=this.status,e.dataset.sloppinessScore=null!==this.score?String(this.score):"",e.dataset.ratingDescription=this.description,e.dataset.ratingReasoning=this.reasoning,e.dataset.blacklisted=String("blacklisted"===this.status),e.dataset.cachedRating=String("cached"===this.status))}_updateIndicatorUI(){if(!this.indicatorElement)return;let t=this.indicatorElement.classList;t.remove("pending-rating","rated-rating","error-rating","cached-rating","blacklisted-rating","streaming-rating");let e="",i="";switch(this.status){case"pending":i="pending-rating",e="‚è≥";break;case"streaming":i="streaming-rating",e=null!==this.score&&void 0!==this.score?String(this.score):"\uD83D\uDD04";break;case"error":i="error-rating",e="‚ö†Ô∏è";break;case"cached":i="cached-rating",e=String(this.score);break;case"blacklisted":i="blacklisted-rating",e=String(this.score);break;default:i="rated-rating",e=String(this.score)}i&&t.add(i),this.indicatorElement.textContent=e}_updateTooltipUI(){if(!this.tooltipElement||!this.descriptionElement||!this.scoreTextElement||!this.followUpQuestionsTextElement||!this.reasoningTextElement||!this.reasoningDropdown||!this.conversationContainerElement||!this.followUpQuestionsElement||!this.metadataElement)return;let t=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<(X()?40:55),e=this.tooltipElement.scrollTop,i=this.tooltipElement.scrollHeight,o=this.description||"",n=o.match(/<ANALYSIS>([^<]+)<\/ANALYSIS>/),r=o.match(/<SCORE>([^<]+)<\/SCORE>/),a=o.match(/<FOLLOW_UP_QUESTIONS>([^<]+)<\/FOLLOW_UP_QUESTIONS>/),s="",l="",d="";s=n&&void 0!==n[1]?n[1].trim():r||a?"*Waiting for analysis...*":o,r&&void 0!==r[1]&&(l=r[1].trim()),a&&void 0!==a[1]&&(d=a[1].trim());let c=!1,p=te(s).description;if(this.descriptionElement.innerHTML!==p&&(this.descriptionElement.innerHTML=p,c=!0),l){let u=l.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/SCORE_(\d+)/g,'<span class="score-highlight">SCORE: $1</span>').replace(/\n/g,"<br>");this.scoreTextElement.innerHTML!==u&&(this.scoreTextElement.innerHTML=u,c=!0),this.scoreTextElement.style.display="block"}else"none"!==this.scoreTextElement.style.display&&(this.scoreTextElement.style.display="none",this.scoreTextElement.innerHTML="",c=!0);if(d){let h=d.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");this.followUpQuestionsTextElement.innerHTML!==h&&(this.followUpQuestionsTextElement.innerHTML=h)}else""!==this.followUpQuestionsTextElement.innerHTML&&(this.followUpQuestionsTextElement.innerHTML="");this.followUpQuestionsTextElement.style.display="none";let g=te("",this.reasoning).reasoning;this.reasoningTextElement.innerHTML!==g&&(this.reasoningTextElement.innerHTML=g,c=!0);let m=!!g;"none"===this.reasoningDropdown.style.display===m&&(this.reasoningDropdown.style.display=m?"block":"none",c=!0);let f=this._renderConversationHistory();this.conversationContainerElement.innerHTML!==f&&(this.conversationContainerElement.innerHTML=f,this.conversationContainerElement.style.display=this.conversationHistory.length>0?"block":"none",c=!0);let $=!1;this.followUpQuestionsElement.children.length!==(this.questions?.length||0)?$=!0:this.questions?.forEach((t,e)=>{let i=this.followUpQuestionsElement.children[e];i&&i.dataset.questionText===t||($=!0)}),$&&(this.followUpQuestionsElement.innerHTML="",this.questions&&this.questions.length>0?(this.questions.forEach((t,e)=>{let i=document.createElement("button");i.className="follow-up-question-button",i.textContent=`ü§î ${t}`,i.dataset.questionIndex=e,i.dataset.questionText=t,this.followUpQuestionsElement.appendChild(i)}),this.followUpQuestionsElement.style.display="block"):this.followUpQuestionsElement.style.display="none",c=!0);let b="",y=!1,x=this.metadata&&Object.keys(this.metadata).length>1&&this.metadata.model,v=this.metadata&&this.metadata.generationId&&1===Object.keys(this.metadata).length;x?(b+='<hr class="metadata-separator">',b+=`<div class="metadata-line">Model: ${this.metadata.model}</div>`,b+=`<div class="metadata-line">Tokens: prompt: ${this.metadata.promptTokens} / completion: ${this.metadata.completionTokens}</div>`,this.metadata.reasoningTokens>0&&(b+=`<div class="metadata-line">Reasoning Tokens: ${this.metadata.reasoningTokens}</div>`),b+=`<div class="metadata-line">Latency: ${this.metadata.latency}</div>`,this.metadata.mediaInputs>0&&(b+=`<div class="metadata-line">Media: ${this.metadata.mediaInputs}</div>`),b+=`<div class="metadata-line">Price: ${this.metadata.price}</div>`,y=!0):v&&(b+='<hr class="metadata-separator">',b+=`<div class="metadata-line">Generation ID: ${this.metadata.generationId} (fetching details...)</div>`,y=!0),this.metadataElement.innerHTML!==b&&(this.metadataElement.innerHTML=b,c=!0),"none"===this.metadataElement.style.display===y&&(this.metadataElement.style.display=y?"block":"none",c=!0);let w="streaming"===this.status;this.tooltipElement.classList.contains("streaming-tooltip")!==w&&(this.tooltipElement.classList.toggle("streaming-tooltip",w),c=!0),c?requestAnimationFrame(()=>{if(this.autoScroll&&(t||!i))this._performAutoScroll();else if(!this.autoScroll&&i>0){let o=this.tooltipElement.scrollHeight;this.tooltipElement.scrollTop=e+(o-i)}this._updateScrollButtonVisibility()}):this._updateScrollButtonVisibility()}_renderConversationHistory(){if(!this.conversationHistory||0===this.conversationHistory.length)return"";let t=new Map;this.conversationContainerElement&&this.conversationContainerElement.querySelectorAll(".conversation-reasoning").forEach((e,i)=>{t.set(i,e.classList.contains("expanded"))});let e="";return this.conversationHistory.forEach((i,o)=>{let n=i.question.replace(/</g,"&lt;").replace(/>/g,"&gt;"),r="";i.uploadedImages&&i.uploadedImages.length>0&&(r=`
                    <div class="conversation-image-container">
                        ${i.uploadedImages.map(t=>`
                            <img src="${t}" alt="User uploaded image" class="conversation-uploaded-image">
                        `).join("")}
                    </div>
                `);let a;a="pending"===i.answer?'<em class="pending-answer">Answering...</em>':i.answer.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="ai-generated-link">$1</a>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>"),o>0&&(e+='<hr class="conversation-separator">');let s="";if(i.reasoning&&""!==i.reasoning.trim()){let l=te("",i.reasoning).reasoning,d=t.get(o);s=`
                    <div class="reasoning-dropdown conversation-reasoning${d?" expanded":""}" data-index="${o}">
                        <div class="reasoning-toggle" role="button" tabindex="0" aria-expanded="${d?"true":"false"}">
                            <span class="reasoning-arrow">${d?"‚ñº":"‚ñ∂"}</span> Show Reasoning Trace
                        </div>
                        <div class="reasoning-content" ${d?'style="max-height: 200px; padding: 8px;"':'style="max-height: 0; padding: 0 8px;"'}>
                            <p class="reasoning-text">${l}</p>
                        </div>
                    </div>
                `}e+=`
                <div class="conversation-turn">
                    <div class="conversation-question"><strong>You:</strong> ${n}</div>
                    ${r}
                    ${s}
                    <div class="conversation-answer"><strong>AI:</strong> ${a}</div>
                </div>
            `}),this.conversationContainerElement&&(this.conversationContainerElement.innerHTML=e,this._attachConversationReasoningListeners()),e}_attachConversationReasoningListeners(){this.conversationContainerElement&&(this.conversationContainerElement.removeEventListener("click",this._handleConversationReasoningToggle),this.conversationContainerElement.addEventListener("click",t=>{let e=t.target.closest(".conversation-reasoning .reasoning-toggle");if(!e)return;t.stopPropagation();let i=e.closest(".reasoning-dropdown"),o=i?.querySelector(".reasoning-content"),n=i?.querySelector(".reasoning-arrow");if(!i||!o||!n)return;let r=i.classList.toggle("expanded");n.textContent=r?"‚ñº":"‚ñ∂",e.setAttribute("aria-expanded",r),o.style.maxHeight=r?"200px":"0",o.style.padding=r?"8px":"0 8px"}))}_performAutoScroll(){this.tooltipElement&&this.autoScroll&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(this.tooltipElement&&this.autoScroll&&this.isVisible){let t=this.tooltipElement.scrollHeight;this.tooltipElement.scrollTo({top:t,behavior:"instant"}),setTimeout(()=>{if(this.tooltipElement&&this.autoScroll&&this.isVisible){let t=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<5;t||(this.tooltipElement.scrollTop=this.tooltipElement.scrollHeight)}},50)}})})}_setPosition(){if(!this.isVisible||!this.indicatorElement||!this.tooltipElement)return;let t=this.indicatorElement.getBoundingClientRect(),e=this.tooltipElement,i=X(),o=window.innerHeight,n=window.innerWidth,r=o-10,a=n-10;e.style.maxHeight="",e.style.overflowY="",e.style.visibility="hidden",e.style.display="block";let s=window.getComputedStyle(e),l=parseFloat(s.width),d=parseFloat(s.height),c,p,u="",h="";if(i){(c=Math.max(10,(n-l)/2))+l>a&&(c=a-l);let g=.8*o;d>g&&(u=`${g}px`,h="scroll",d=g),(p=Math.max(10,(o-d)/2))+d>r&&(p=r-d)}else c=t.right+10,p=t.top+t.height/2-d/2,c+l>a&&(c=t.left-l-10)<10&&(c=Math.max(10,(n-l)/2),t.bottom+d+10<=r?p=t.bottom+10:t.top-d-10>=10?p=t.top-d-10:(p=10,u=`${r-10}px`,h="scroll",d=r-10)),p<10&&(p=10),p+d>r&&(d>r-10?(p=10,u=`${r-10}px`,h="scroll"):p=r-d);e.style.position="fixed",e.style.left=`${c}px`,e.style.top=`${p}px`,e.style.zIndex="99999999",e.style.maxHeight=u,e.style.overflowY=h,"scroll"===h&&(e.style.webkitOverflowScrolling="touch"),e.style.visibility="visible"}_updateScrollButtonVisibility(){if(!this.tooltipElement||!this.scrollButton)return;let t="streaming"===this.status;if(!t){this.scrollButton.style.display="none";return}let e=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<(X()?40:55);this.scrollButton.style.display=e?"none":"block"}_handleMouseEnter(t){X()||this.show()}_handleMouseLeave(t){X()||setTimeout(()=>{this.tooltipElement&&!this.tooltipElement.matches(":hover")&&this.indicatorElement&&!this.indicatorElement.matches(":hover")&&this.hide()},100)}_handleIndicatorClick(t){t.stopPropagation(),t.preventDefault(),this.toggle()}_handleTooltipMouseEnter(){this.isPinned||this.show()}_handleTooltipMouseLeave(){this.isPinned||this.hide()}_handleTooltipClick(t){}_handleTooltipScroll(){if(!this.tooltipElement)return;let t=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<(X()?40:55);t?this.userInitiatedScroll&&(this.autoScroll=!0,this.tooltipElement.dataset.autoScroll="true",this.userInitiatedScroll=!1):this.autoScroll&&(this.autoScroll=!1,this.tooltipElement.dataset.autoScroll="false",this.userInitiatedScroll=!0),this._updateScrollButtonVisibility()}_handlePinClick(t){t.stopPropagation(),this.isPinned?this.unpin():this.pin()}_handleCopyClick(t){if(t.stopPropagation(),!this.descriptionElement||!this.reasoningTextElement||!this.copyButton)return;let e=this.descriptionElement.textContent||"",i=this.reasoningTextElement.textContent||"";i&&(e+="\n\nReasoning:\n"+i),navigator.clipboard.writeText(e).then(()=>{let t=this.copyButton.innerHTML;this.copyButton.innerHTML="‚úì",this.copyButton.disabled=!0,setTimeout(()=>{this.copyButton.innerHTML=t,this.copyButton.disabled=!1},1500)}).catch(t=>{})}_handleReasoningToggleClick(t){if(t.stopPropagation(),!this.reasoningDropdown||!this.reasoningContent||!this.reasoningArrow)return;let e=this.reasoningDropdown.classList.toggle("expanded");this.reasoningArrow.textContent=e?"‚ñº":"‚ñ∂",e?(this.reasoningContent.style.maxHeight="300px",this.reasoningContent.style.padding="10px"):(this.reasoningContent.style.maxHeight="0",this.reasoningContent.style.padding="0 10px")}_handleScrollButtonClick(t){t.stopPropagation(),this.tooltipElement&&(this.autoScroll=!0,this.tooltipElement.dataset.autoScroll="true",this._performAutoScroll(),this._updateScrollButtonVisibility())}_handleFollowUpQuestionClick(t){let i=t.target&&t.target.dataset&&t.target.dataset.questionText&&"function"!=typeof t.target.closest,o=i?t.target:t.target.closest(".follow-up-question-button");if(!o)return;t.stopPropagation();let n=o.dataset.questionText,r=e("openrouter-api-key","");i?(this.customQuestionInput&&(this.customQuestionInput.disabled=!0),this.customQuestionButton&&(this.customQuestionButton.disabled=!0,this.customQuestionButton.textContent="Asking...")):(o.disabled=!0,o.textContent=`ü§î Asking: ${n}...`,this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!0)),this.conversationHistory.push({question:n,answer:"pending",uploadedImages:[...this.uploadedImageDataUrls],reasoning:""}),this._updateTooltipUI(),this.questions=[],this._updateTooltipUI();let a=[{type:"text",text:n}];this.uploadedImageDataUrls&&this.uploadedImageDataUrls.length>0&&this.uploadedImageDataUrls.forEach(t=>{a.push({type:"image_url",image_url:{url:t}})});let s=[...this.qaConversationHistory,{role:"user",content:a}];if(!r){V("API key missing. Cannot answer question.","error"),this._updateConversationHistory(n,"Error: API Key missing.",""),i||(o.disabled=!1,this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!1)),this.customQuestionInput&&(this.customQuestionInput.disabled=!1),this.customQuestionButton&&(this.customQuestionButton.disabled=!1,this.customQuestionButton.textContent="Ask"),this._clearFollowUpImage();return}if(!n){this._updateConversationHistory(n||"Error: Empty Question","Error: Could not identify question.",""),i||(o.disabled=!1,this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!1)),this.customQuestionInput&&(this.customQuestionInput.disabled=!1),this.customQuestionButton&&(this.customQuestionButton.disabled=!1,this.customQuestionButton.textContent="Ask"),this._clearFollowUpImage();return}let l=this.findCurrentArticleElement();try{tO(this.tweetId,s,r,l,this)}finally{setTimeout(()=>{this.followUpQuestionsElement&&this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>{t.disabled=!1}),this.customQuestionInput&&(this.customQuestionInput.disabled=!1),this.customQuestionButton&&(this.customQuestionButton.disabled=!1,this.customQuestionButton.textContent="Ask"),this._clearFollowUpImage()},100)}}_handleCustomQuestionClick(){if(!this.customQuestionInput||!this.customQuestionButton)return;let t=this.customQuestionInput.value.trim();if(!t){V("Please enter a question.","warning"),this.customQuestionInput.focus();return}this.followUpQuestionsElement?.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!0),this._handleFollowUpQuestionClick({target:{dataset:{questionText:t},disabled:!1,textContent:""},stopPropagation(){}}),this.customQuestionInput&&(this.customQuestionInput.value="")}_handleFollowUpImageSelect(t){let e=t.target.files;e&&0!==e.length&&(this.followUpImageContainer&&e.length>0&&(this.followUpImageContainer.style.display="flex"),Array.from(e).forEach(t=>{if(t&&t.type.startsWith("image/")){var e;(e=t,new Promise((t,i)=>{let o=new FileReader;o.onload=e=>{let o=new Image;o.onload=()=>{let{width:e,height:i}=o,n,r;e>i?e>512?(n=512,r=i*(512/e)):(n=e,r=i):i>512?(r=512,n=e*(512/i)):(n=e,r=i);let a=document.createElement("canvas");a.width=n,a.height=r;let s=a.getContext("2d");s.drawImage(o,0,0,n,r);let l=a.toDataURL("image/jpeg",.9);t(l)},o.onerror=t=>{i(Error("Could not load image for resizing."))},o.src=e.target.result},o.onerror=t=>{i(Error("Could not read file."))},o.readAsDataURL(e)})).then(t=>{this.uploadedImageDataUrls.push(t),this._addPreviewToContainer(t)}).catch(e=>{V(`Could not process image ${t.name}: ${e.message}`,"error")})}else t&&V(`Skipping non-image file: ${t.name}`,"warning")}),t.target.value=null)}_addPreviewToContainer(t){if(!this.followUpImageContainer)return;let e=document.createElement("div");e.className="follow-up-image-preview-item",e.dataset.imageDataUrl=t;let i=document.createElement("img");i.src=t,i.className="follow-up-image-preview-thumbnail";let o=document.createElement("button");o.textContent="\xd7",o.className="follow-up-image-remove-btn",o.title="Remove this image",o.addEventListener("click",e=>{e.stopPropagation(),this._removeSpecificUploadedImage(t)}),e.appendChild(i),e.appendChild(o),this.followUpImageContainer.appendChild(e)}_removeSpecificUploadedImage(t){if(this.uploadedImageDataUrls=this.uploadedImageDataUrls.filter(e=>e!==t),this.followUpImageContainer){let e=this.followUpImageContainer.querySelector(`div.follow-up-image-preview-item[data-image-data-url="${CSS.escape(t)}"]`);e&&e.remove(),0===this.uploadedImageDataUrls.length&&(this.followUpImageContainer.style.display="none")}}_clearFollowUpImage(){this.uploadedImageDataUrls=[],this.followUpImageContainer&&(this.followUpImageContainer.innerHTML="",this.followUpImageContainer.style.display="none"),this.followUpImageInput&&(this.followUpImageInput.value=null)}_updateConversationHistory(t,e,i=""){let o=this.conversationHistory.findIndex(e=>e.question===t&&"pending"===e.answer);-1!==o&&(this.conversationHistory[o].answer=e,this.conversationHistory[o].reasoning=i,this._updateTooltipUI())}_renderStreamingAnswer(t,e=""){if(!this.conversationContainerElement)return;let i=this.conversationContainerElement.querySelectorAll(".conversation-turn"),o=i.length>0?i[i.length-1]:null;if(!o)return;let n=this.conversationHistory.length>0?this.conversationHistory[this.conversationHistory.length-1]:null;if(!(n&&"pending"===n.answer))return;let r=o.querySelector(".reasoning-dropdown"),a=e&&""!==e.trim();if(a&&!r){(r=document.createElement("div")).className="reasoning-dropdown conversation-reasoning";let s=document.createElement("div");s.className="reasoning-toggle";let l=document.createElement("span");l.className="reasoning-arrow",l.textContent="‚ñ∂",s.appendChild(l),s.appendChild(document.createTextNode(" Show Reasoning Trace"));let d=document.createElement("div");d.className="reasoning-content";let c=document.createElement("p");c.className="reasoning-text",d.appendChild(c),r.appendChild(s),r.appendChild(d);let p=o.querySelector(".conversation-answer");p?o.insertBefore(r,p):o.appendChild(r),s.addEventListener("click",t=>{t.stopPropagation();let e=t.target.closest(".reasoning-dropdown"),i=e?.querySelector(".reasoning-content"),o=e?.querySelector(".reasoning-arrow");if(!e||!i||!o)return;let n=e.classList.toggle("expanded");o.textContent=n?"‚ñº":"‚ñ∂",i.style.maxHeight=n?"200px":"0",i.style.padding=n?"8px":"0 8px"})}if(r&&a){let u=r.querySelector(".reasoning-text");if(u){let h=te("",e).reasoning;u.innerHTML!==h&&(u.innerHTML=h)}r.style.display="block"}else r&&(r.style.display="none");let g=o.querySelector(".conversation-answer");if(g){let m=t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="ai-generated-link">$1</a>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>");g.innerHTML=`<strong>AI:</strong> ${m}<em class="pending-cursor">|</em>`}this.autoScroll&&this._performAutoScroll()}update({status:t,score:e=null,description:i="",reasoning:o="",metadata:n=null,questions:r}){let a=void 0!==t&&this.status!==t,s=null!==e&&this.score!==e,l=""!==i&&this.description!==i,d=""!==o&&this.reasoning!==o,c=null!==n&&JSON.stringify(this.metadata)!==JSON.stringify(n),p=void 0!==r&&JSON.stringify(this.questions)!==JSON.stringify(r);if(a||s||l||d||c||p){if(a&&(this.status=t),(s||a)&&(this.score="pending"===this.status||"error"===this.status?e:"streaming"===this.status&&null===e?this.score:e),l&&(this.description=i),d&&(this.reasoning=o),c&&(this.metadata=n),p&&(this.questions=r),a){let u="pending"===this.status||"streaming"===this.status;this.autoScroll!==u&&(this.autoScroll=u,this.tooltipElement&&(this.tooltipElement.dataset.autoScroll=this.autoScroll?"true":"false"))}(a||s)&&this._updateIndicatorUI(),l||d||a||c||p?this._updateTooltipUI():this._updateScrollButtonVisibility(),this.updateDatasetAttributes()}}show(){this.tooltipElement&&(this.isVisible=!0,this.tooltipElement.style.display="block",this._setPosition(),this.autoScroll&&("streaming"===this.status||"pending"===this.status)&&this._performAutoScroll(),this._updateScrollButtonVisibility())}hide(){!this.isPinned&&this.tooltipElement?(this.isVisible=!1,this.tooltipElement.style.display="none"):this.isPinned}toggle(){this.isVisible&&!this.isPinned?this.hide():this.show()}pin(){this.tooltipElement&&this.pinButton&&(this.isPinned=!0,this.tooltipElement.classList.add("pinned"),this.pinButton.innerHTML="\uD83D\uDCCD",this.pinButton.title="Unpin tooltip")}unpin(){this.tooltipElement&&this.pinButton&&(this.isPinned=!1,this.tooltipElement.classList.remove("pinned"),this.pinButton.innerHTML="\uD83D\uDCCC",this.pinButton.title="Pin tooltip (prevents auto-closing)",setTimeout(()=>{this.tooltipElement&&!this.tooltipElement.matches(":hover")&&this.indicatorElement&&!this.indicatorElement.matches(":hover")&&this.hide()},0))}_handleCloseClick(t){t.stopPropagation(),this.hide()}destroy(){window.activeStreamingRequests&&window.activeStreamingRequests[this.tweetId]&&(window.activeStreamingRequests[this.tweetId].abort(),delete window.activeStreamingRequests[this.tweetId]),this.indicatorElement?.removeEventListener("mouseenter",this._handleMouseEnter),this.indicatorElement?.removeEventListener("mouseleave",this._handleMouseLeave),this.indicatorElement?.removeEventListener("click",this._handleIndicatorClick),this.tooltipElement?.removeEventListener("mouseenter",this._handleTooltipMouseEnter),this.tooltipElement?.removeEventListener("mouseleave",this._handleTooltipMouseLeave),this.tooltipElement?.removeEventListener("scroll",this._handleTooltipScroll),this.pinButton?.removeEventListener("click",this._handlePinClick),this.copyButton?.removeEventListener("click",this._handleCopyClick),this.tooltipCloseButton?.removeEventListener("click",this._handleCloseClick),this.reasoningToggle?.removeEventListener("click",this._handleReasoningToggleClick),this.scrollButton?.removeEventListener("click",this._handleScrollButtonClick),this.followUpQuestionsElement?.removeEventListener("click",this._handleFollowUpQuestionClick),this.customQuestionButton?.removeEventListener("click",this._handleCustomQuestionClick),this.customQuestionInput?.removeEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),this._handleCustomQuestionClick())}),this.indicatorElement?.remove(),this.tooltipElement?.remove(),tt.remove(this.tweetId);let t=this.findCurrentArticleElement();t&&delete t.dataset.hasScoreIndicator,this.tweetArticle=null,this.indicatorElement=null,this.tooltipElement=null,this.pinButton=null,this.copyButton=null,this.tooltipCloseButton=null,this.reasoningToggle=null,this.scrollButton=null,this.conversationContainerElement=null,this.followUpQuestionsElement=null,this.customQuestionContainer=null,this.customQuestionInput=null,this.customQuestionButton=null,this.followUpImageContainer=null,this.followUpImageInput=null,this.followUpImagePreview=null,this.followUpRemoveImageButton=null,this.attachImageButton=null,this.uploadedImageDataUrls=[]}ensureIndicatorAttached(){if(!this.indicatorElement)return;let t=this.findCurrentArticleElement();if(t){if(this.indicatorElement.parentElement!==t){let e=window.getComputedStyle(t).position;"relative"!==e&&"absolute"!==e&&"fixed"!==e&&"sticky"!==e&&(t.style.position="relative"),t.appendChild(this.indicatorElement)}this.updateDatasetAttributes(t)}}findCurrentArticleElement(){let t=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(!t)return null;let e=`a[href*="/status/${this.tweetId}"]`,i=t.querySelector(e),o=i?.closest('article[data-testid="tweet"]');if(o&&F(o)===this.tweetId)return o;let n=t.querySelectorAll('article[data-testid="tweet"]');for(let r of n)if(F(r)===this.tweetId)return r;return null}updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:e,apiResponseContent:i,reviewSystemPrompt:o,followUpSystemPrompt:n}){let r=i.match(/<ANALYSIS>([\s\S]*?)<\/ANALYSIS>/),a=i.match(/<SCORE>\s*SCORE_(\d+)\s*<\/SCORE>/),s=tL(i);this.score=a?parseInt(a[1],10):null,this.description=r?r[1].trim():i,this.questions=s,this.status=null!==this.score?"rated":"error";let l=[{type:"text",text:t}];e.forEach(t=>{l.push({type:"image_url",image_url:{url:t}})}),this.qaConversationHistory=[{role:"system",content:[{type:"text",text:o}]},{role:"user",content:l},{role:"assistant",content:[{type:"text",text:i}]},{role:"system",content:[{type:"text",text:n}]}],this._updateIndicatorUI(),this._updateTooltipUI(),this.updateDatasetAttributes()}updateAfterFollowUp({assistantResponseContent:t,updatedQaHistory:e}){this.qaConversationHistory=e;let i=t.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/),o=tL(t),n=i?i[1].trim():t;if(this.questions=o,this.conversationHistory.length>0){let r=this.conversationHistory[this.conversationHistory.length-1];"pending"===r.answer&&(r.answer=n)}this._updateTooltipUI(),this.updateDatasetAttributes()}rehydrateFromCache(t){if(this.score=t.score,this.description=t.description,this.reasoning=t.reasoning,this.questions=t.questions||[],this.status=t.status||(null!==t.score?t.fromStorage?"cached":"rated":"error"),this.metadata=t.metadata||null,this.qaConversationHistory=t.qaConversationHistory||[],this.isPinned=t.isPinned||!1,this.conversationHistory=[],this.qaConversationHistory.length>0){let e=null,i=[],o=0;for(let n=0;n<this.qaConversationHistory.length;n++){if("system"===this.qaConversationHistory[n].role&&this.qaConversationHistory[n].content[0].text.includes("FOLLOW_UP_SYSTEM_PROMPT")){o=n+1;break}3===n&&"system"===this.qaConversationHistory[n].role&&(o=n+1)}for(let r=o;r<this.qaConversationHistory.length;r++){let a=this.qaConversationHistory[r];if("user"===a.role){let s=a.content.find(t=>"text"===t.type);e=s?s.text:"[Question not found]",i=a.content.filter(t=>"image_url"===t.type&&t.image_url&&t.image_url.url.startsWith("data:image")).map(t=>t.image_url.url)}else if("assistant"===a.role&&e){let l=a.content.find(t=>"text"===t.type),d=l?l.text:"[Answer not found]",c=d.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/),p=c?c[1].trim():d;this.conversationHistory.push({question:e,answer:p,uploadedImages:i,reasoning:""}),e=null,i=[]}}}this.isPinned?(this.pinButton.innerHTML="\uD83D\uDCCD",this.tooltipElement?.classList.add("pinned")):(this.pinButton.innerHTML="\uD83D\uDCCC",this.tooltipElement?.classList.remove("pinned")),this._updateIndicatorUI(),this._updateTooltipUI(),this.updateDatasetAttributes()}}let tt={managers:new Map,get(t,e=null){if(!t)return null;if(this.managers.has(t)){let i=this.managers.get(t);return e&&i.tweetArticle,i}if(e)try{let o=e.querySelector(`.score-indicator[data-tweet-id="${t}"]`),n=document.querySelector(`.score-description[data-tweet-id="${t}"]`);return(o||n)&&(o?.remove(),n?.remove()),new J(e)}catch(r){}return null},add(t,e){this.managers.has(t),this.managers.set(t,e)},remove(t){this.managers.has(t)&&this.managers.delete(t)},cleanupOrphaned(){let t=0,e=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(!e)return;let i=new Set;for(let[o,n]of(e.querySelectorAll('article[data-testid="tweet"]').forEach(t=>{let e=F(t);e&&i.add(e)}),this.managers.entries())){let r=n.indicatorElement?.isConnected,a=i.has(o);(!r||!a)&&(n.destroy(),t++)}},destroyAll(){[...this.managers.values()].forEach(t=>t.destroy()),this.managers.clear()}};function te(t="",e=""){let i="*Waiting for analysis...*"===t?t:(t||"*waiting for content...*").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^#### (.*$)/gm,"<h4>$1</h4>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/SCORE_(\d+)/g,'<span class="score-highlight">SCORE: $1</span>').replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>"),o="";return e&&e.trim()&&(o=e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>")),{description:i,reasoning:o}}function ti(t,e,i,o){if(!t||!e)return;let n=t.classList.contains("hidden");if(e.innerHTML=n?i:o,n?(t.style.display="flex",t.offsetHeight,t.classList.remove("hidden")):(t.classList.add("hidden"),setTimeout(()=>{t.classList.contains("hidden")&&(t.style.display="none")},500)),"tweet-filter-container"===t.id){let r=document.getElementById("filter-toggle");r&&(n?r.style.display="none":setTimeout(()=>{r.style.display="block"},500))}}function to(){(X()||confirm("Are you sure you want to clear all cached tweet ratings?"))&&(a.clear(!0),v=0,window.threadRelationships&&(window.threadRelationships={},i("threadRelationships","{}")),V("All cached ratings and thread relationships cleared!"),y&&y.querySelectorAll('article[data-testid="tweet"]').forEach(t=>{t.removeAttribute("data-sloppiness-score"),t.removeAttribute("data-rating-status"),t.removeAttribute("data-rating-description"),t.removeAttribute("data-cached-rating");let e=t.querySelector(".score-indicator");e&&e.remove();let i=F(t);if(i){m.delete(i);let o=tt.get(i);o&&o.destroy(),tx(t)}}),document.querySelectorAll('div[aria-label="Timeline: Conversation"], div[aria-label^="Timeline: Conversation"]').forEach(t=>{delete t.dataset.threadMapping,delete t.dataset.threadMappedAt,delete t.dataset.threadMappingInProgress,delete t.dataset.threadHist,delete t.dataset.threadMediaUrls}))}function tn(t,e){let o;if(o="checkbox"===t.type?t.checked:t.value,void 0!==window[e]&&(window[e]=o),i(e,o),"enableImageDescriptions"===e){let n=document.getElementById("image-model-container");n&&(n.style.display=o?"block":"none"),V("Image descriptions "+(o?"enabled":"disabled"))}}function tr(){document.querySelectorAll("[data-setting]").forEach(t=>{let i=t.dataset.setting,o=e(i,window[i]);"checkbox"===t.type?(t.checked=o,tn(t,i)):t.value=o}),document.querySelectorAll(".parameter-row[data-param-name]").forEach(t=>{let i=t.dataset.paramName,o=t.querySelector(".parameter-slider"),n=t.querySelector(".parameter-value"),r=e(i,window[i]);o&&(o.value=r),n&&(n.value=r)});let t=document.getElementById("tweet-filter-slider"),i=document.getElementById("tweet-filter-value"),o=e("filterThreshold","5");if(t&&i){t.value=o,i.value=o;let n=parseInt(o,10)/10*100;t.style.setProperty("--slider-percent",`${n}%`)}ta(document.getElementById("handle-list")),ts(),document.querySelectorAll(".advanced-content").forEach(t=>{t.classList.contains("expanded")||(t.style.maxHeight="0")}),document.querySelectorAll(".advanced-toggle-icon.expanded").forEach(t=>{t.closest(".advanced-toggle")?.nextElementSibling?.classList.contains("expanded")||t.classList.remove("expanded")}),Z()}function ta(t){if(t){if(t.innerHTML="",0===C.length){let e=document.createElement("div");e.style.cssText="padding: 8px; opacity: 0.7; font-style: italic;",e.textContent="No handles added yet",t.appendChild(e);return}C.forEach(e=>{let i=document.createElement("div");i.className="handle-item";let o=document.createElement("div");o.className="handle-text",o.textContent="@"+e,i.appendChild(o);let n=document.createElement("button");n.className="remove-handle",n.textContent="\xd7",n.title="Remove from list",i.appendChild(n),t.appendChild(i)})}}function ts(){let t=document.getElementById("model-select-container"),o=document.getElementById("image-model-select-container");_=[...w],k||(_=_.filter(t=>!t.slug.endsWith(":free")));let n=e("sortDirection","default"),r=e("modelSortOrder","throughput-high-to-low"),a=document.getElementById("sort-direction");if(a)switch(r){case"latency-low-to-high":default:a.textContent="default"===n?"High-Low":"Low-High","reverse"===n&&_.reverse();break;case"":a.textContent="default"===n?"New-Old":"Old-New","reverse"===n&&_.reverse();break;case"top-weekly":a.textContent="default"===n?"Most Popular":"Least Popular","reverse"===n&&_.reverse()}if(t&&(t.innerHTML="",td(t,"model-selector",_.map(t=>({value:t.slug||t.id,label:tl(t)})),E,t=>{i("selectedModel",E=t),V("Rating model updated")},"Search rating models...")),o){let s=_.filter(t=>t.input_modalities?.includes("image")||t.architecture?.input_modalities?.includes("image")||t.architecture?.modality?.includes("image"));o.innerHTML="",td(o,"image-model-selector",s.map(t=>({value:t.slug||t.id,label:tl(t)})),S,t=>{i("selectedImageModel",S=t),V("Image model updated")},"Search vision models...")}}function tl(t){let e=t.slug||t.id||t.name||"Unknown Model",i="",o=t.endpoint?.pricing||t.pricing;if(o){let n=parseFloat(o.prompt),r=parseFloat(o.completion);isNaN(n)?isNaN(r)||(i+=` - $${(1e6*r).toFixed(4)}/mil. tok.-out`):(i+=` - $${(1e6*n).toFixed(4)}/mil. tok.-in`,isNaN(r)||r===n||(i+=` $${(1e6*r).toFixed(4)}/mil. tok.-out`))}let a=t.input_modalities?.includes("image")||t.architecture?.input_modalities?.includes("image")||t.architecture?.modality?.includes("image");return a&&(e="\uD83D\uDDBCÔ∏è "+e),e+i}function td(t,e,i,o,n,r){let a=o,s=document.createElement("div");s.className="custom-select",s.id=e;let l=document.createElement("div");l.className="select-selected";let d=document.createElement("div");d.className="select-items",d.style.display="none";let c=document.createElement("div");c.className="search-field";let p=document.createElement("input");function u(t=""){for(;d.childNodes.length>1;)d.removeChild(d.lastChild);let e=i.filter(e=>e.label.toLowerCase().includes(t.toLowerCase()));if(0===e.length){let o=document.createElement("div");o.textContent="No matches found",o.style.cssText="opacity: 0.7; font-style: italic; padding: 10px; text-align: center; cursor: default;",d.appendChild(o)}e.forEach(t=>{let e=document.createElement("div");e.textContent=t.label,e.dataset.value=t.value,t.value===a&&e.classList.add("same-as-selected"),e.addEventListener("click",e=>{e.stopPropagation(),a=t.value,l.textContent=t.label,d.style.display="none",l.classList.remove("select-arrow-active"),d.querySelectorAll("div[data-value]").forEach(t=>{t.classList.toggle("same-as-selected",t.dataset.value===a)}),n(a)}),d.appendChild(e)})}p.type="text",p.className="search-input",p.placeholder=r||"Search...",c.appendChild(p),d.appendChild(c);let h=i.find(t=>t.value===a);l.textContent=h?h.label:"Select an option",s.appendChild(l),s.appendChild(d),t.appendChild(s),u(),p.addEventListener("input",()=>u(p.value)),p.addEventListener("click",t=>t.stopPropagation()),l.addEventListener("click",t=>{t.stopPropagation(),tc(s);let e="none"===d.style.display;d.style.display=e?"block":"none",l.classList.toggle("select-arrow-active",e),e&&(p.focus(),p.select(),u())})}function tc(t=null){document.querySelectorAll(".custom-select").forEach(e=>{if(e===t)return;let i=e.querySelector(".select-items"),o=e.querySelector(".select-selected");i&&(i.style.display="none"),o&&o.classList.remove("select-arrow-active")})}function tp(t=!1){if(t||confirm("Are you sure you want to reset all settings to their default values? This will not clear your cached ratings, blacklisted handles, or instruction history.")){a.clear();let e={selectedModel:"openai/gpt-4.1-nano",selectedImageModel:"openai/gpt-4.1-nano",enableImageDescriptions:!1,enableStreaming:!0,modelTemperature:.5,modelTopP:.9,imageModelTemperature:.5,imageModelTopP:.9,maxTokens:0,filterThreshold:5,userDefinedInstructions:"Rate the tweet on a scale from 1 to 10 based on its clarity, insight, creativity, and overall quality.",modelSortOrder:"throughput-high-to-low"};for(let o in e)void 0!==window[o]&&(window[o]=e[o]),i(o,e[o]);tr(),tT(),V("Settings reset to defaults")}}function tu(t){let i=t.closest('div[data-testid="cellInnerDiv"]');if(!i)return;let o=D(t),n=o.length>0?o[0]:"";if(n&&f.has(n)){let r=F(t);r&&tt.get(r)?.destroy(),i.innerHTML="",i.dataset.filtered="true",i.dataset.isAd="true";return}let a=parseInt(t.dataset.sloppinessScore||"9",10),s=F(t),l=tt.get(s);l?.ensureIndicatorAttached();let d=parseInt(e("filterThreshold","1")),c=t.dataset.ratingStatus;"pending"===c||"streaming"===c?delete i.dataset.filtered:(isNaN(a)||a<d)&&(s&&tt.get(s)?.destroy(),i.innerHTML="",i.dataset.filtered="true")}async function th(t){let e=F(t),i=D(t),o=i.length>0?i[0]:"";if(o&&tg(o)){let n=tt.get(e,t);if(n){let r=z(t.querySelector(P))||"[Tweet text not found]",s=await W(t),l=`<ANALYSIS>
            This user is on the blacklist. Tweets from this user are not rated by the AI and are always shown.
            </ANALYSIS>
            <SCORE>
            SCORE_10
            </SCORE>
            <FOLLOW_UP_QUESTIONS>
            Q_1. Rate this tweet anyway.
            Q_2. N/A
            Q_3. N/A
            </FOLLOW_UP_QUESTIONS>`;n.updateInitialReviewAndBuildHistory({fullContext:r,mediaUrls:s,apiResponseContent:l,reviewSystemPrompt:q,followUpSystemPrompt:L}),a.set(e,{score:10,description:n.description,reasoning:"",questions:n.questions,lastAnswer:"",tweetContent:r,mediaUrls:s,streaming:!1,blacklisted:!0,timestamp:Date.now(),qaConversationHistory:n.qaConversationHistory})}else t.dataset.sloppinessScore="10",t.dataset.blacklisted="true",t.dataset.ratingStatus="blacklisted",t.dataset.ratingDescription="User is blacklisted";return tu(t),!0}let d=a.get(e);if(d){if(!0===d.streaming&&(void 0===d.score||null===d.score))return!1;if(void 0!==d.score&&null!==d.score){let c=tt.get(e,t);return!!c&&(c.rehydrateFromCache(d),tu(t),!0)}d.streaming||a.delete(e)}return!1}function tg(t){return!!t&&(t=t.toLowerCase().trim(),C.some(e=>e.toLowerCase().trim()===t))}let tm=["rated","cached","blacklisted"],tf=["pending","streaming"];function t$(t){return tm.includes(t)}function tb(t){return tf.includes(t)}async function ty(t,i,o){let n=!1;try{let r=e("openrouter-api-key","");if(!r){t.dataset.ratingStatus="error",t.dataset.ratingDescription="No API key",tt.get(i,t)?.update({status:"error",score:9,description:"No API key",questions:[],lastAnswer:""}),tu(t);return}if(o&&f.has(o)){t.dataset.ratingStatus="rated",t.dataset.ratingDescription="Advertisement",t.dataset.sloppinessScore="0",tt.get(i,t)?.update({status:"rated",score:0,description:"Advertisement from known ad author",questions:[],lastAnswer:""}),tu(t),n=!0;return}if(G(t)){o&&f.add(o),t.dataset.ratingStatus="rated",t.dataset.ratingDescription="Advertisement",t.dataset.sloppinessScore="0",tt.get(i,t)?.update({status:"rated",score:0,description:"Advertisement",questions:[],lastAnswer:""}),tu(t),n=!0;return}let s=5,l="",d="",c=[],p="";try{let u=a.get(i);u&&(!0!==u.streaming||void 0!==u.score&&null!==u.score)&&(u.streaming||void 0!==u.score&&null!==u.score||a.delete(i));let h=await t_(t,i,r);if(!h)throw Error("Failed to get tweet context");let g=[];if(document.querySelector('div[aria-label="Timeline: Conversation"]')){let $=tk(i);$&&$.replyTo&&(a.has(i)||a.set(i,{}),a.get(i).threadContext||(a.get(i).threadContext={replyTo:$.to,replyToId:$.replyTo,isRoot:!1}))}let b=h.matchAll(/(?:\[MEDIA_URLS\]:\s*\n)(.*?)(?:\n|$)/g),y=h.matchAll(/(?:\[QUOTED_TWEET_MEDIA_URLS\]:\s*\n)(.*?)(?:\n|$)/g);for(let x of b)x[1]&&g.push(...x[1].split(", ").filter(t=>t.trim()));for(let v of y)v[1]&&g.push(...v[1].split(", ").filter(t=>t.trim()));if(g=[...new Set(g.filter(t=>t.trim()))],h)try{let w=a.get(i),_=w&&!w.streaming&&void 0!==w.score&&null!==w.score;if(_){s=w.score,l=w.description||"",d=w.reasoning||"",c=w.questions||[],p=w.lastAnswer||"";let E=w.mediaUrls||[];n=!0,tt.get(i,t)?.update({status:w.fromStorage?"cached":"rated",score:s,description:l,reasoning:d,questions:c,lastAnswer:p,metadata:w.metadata||null,mediaUrls:E}),tu(t);return}let S=await tR(h,i,r,g,3,t,o);s=S.score,l=S.content,d=S.reasoning||"",c=S.questions||[],p="";let k=S.error?"error":"rated";if(!S.error){let I=a.get(i);I&&I.fromStorage?k="cached":S.cached&&(k="cached")}t.dataset.ratingStatus=k,t.dataset.ratingDescription=l||"not available",t.dataset.sloppinessScore=s?.toString()||"",t.dataset.ratingReasoning=d,tt.get(i,t)?.update({status:k,score:s,description:l,reasoning:d,questions:c,lastAnswer:p,metadata:S.data?.id?{generationId:S.data.id}:null,mediaUrls:g}),n=!S.error,tu(t);return}catch(C){s=5,l=`API Error: ${C.message}`,d="",c=[],p="",n=!1,tt.get(i,t)?.update({status:"error",score:s,description:l,questions:[],lastAnswer:""});let T=a.get(i)||{};T.score=s,T.description=l,T.reasoning=d,T.questions=c,T.lastAnswer=p,T.error=!0,T.streaming=!1,a.set(i,T),tu(t);return}tu(t)}catch(A){tt.get(i,t)?.update({status:"error",score:5,description:"Error during processing: "+A.message,questions:[],lastAnswer:""}),tu(t),n=!1}finally{n||m.delete(i)}}catch(q){let L=tt.get(i);L&&L.update({status:"error",score:5,description:"Error during processing: "+q.message,questions:[],lastAnswer:""}),tu(t),n=!1}finally{if(!n){m.delete(i);let R=tt.get(i);R&&!t$(R.status)&&setTimeout(()=>{t$(tt.get(i)?.status)||tx(t)},300)}}}async function tx(t){let e=F(t);if(!e||window.activeStreamingRequests&&window.activeStreamingRequests[e])return;let i=D(t),o=i.length>0?i[0]:"";if(o&&f.has(o)){tu(t);return}if(G(t)){o&&f.add(o),tu(t);return}let n=tt.get(e);if(n){if(n.ensureIndicatorAttached(),t$(n.status)||tb(n.status)&&m.has(e)){tu(t);return}m.delete(e)}if(o&&tg(o)){let r=tt.get(e,t);if(r){let s=z(t.querySelector(P))||"[Tweet text not found]",l=await W(t),d=`<ANALYSIS>
            This user is on the blacklist. Tweets from this user are not rated by the AI and are always shown.
            </ANALYSIS>
            <SCORE>
            SCORE_10
            </SCORE>
            <FOLLOW_UP_QUESTIONS>
            Q_1. Rate this tweet anyway.
            Q_2. N/A
            Q_3. N/A
            </FOLLOW_UP_QUESTIONS>`;r.updateInitialReviewAndBuildHistory({fullContext:s,mediaUrls:l,apiResponseContent:d,reviewSystemPrompt:q,followUpSystemPrompt:L}),a.set(e,{score:10,description:r.description,reasoning:"",questions:r.questions,lastAnswer:"",tweetContent:s,mediaUrls:l,streaming:!1,blacklisted:!0,timestamp:Date.now(),qaConversationHistory:r.qaConversationHistory})}else t.dataset.sloppinessScore="10",t.dataset.blacklisted="true",t.dataset.ratingStatus="blacklisted",t.dataset.ratingDescription="User is blacklisted";tu(t);return}if(a.has(e)){let c=!0===a.get(e).streaming&&(void 0===a.get(e).score||null===a.get(e).score);if(!c){let p=await th(t);if(p)return}}if(m.has(e)){let u=tt.get(e);if(u&&(u.ensureIndicatorAttached(),"pending"===u.status||"streaming"===u.status)){tu(t);return}m.delete(e)}let h=tt.get(e,t);if(h){if("blacklisted"!==h.status&&"cached"!==h.status&&"rated"!==h.status)h.update({status:"pending",score:null,description:"Rating scheduled...",questions:[],lastAnswer:""});else{h.ensureIndicatorAttached(),tu(t);return}}m.has(e)||m.add(e),setTimeout(()=>{try{ty(t,e,o)}catch(i){m.delete(e)}},150)}let tv={},tw=!1;async function t3(t,e=5){if(!t||e<=0)return[];let i=[],o=t,n=0;for(;o&&n<e;){let r=tv[o];if(!r||!r.replyTo)break;i.push({fromId:o,toId:r.replyTo,from:r.from,to:r.to}),o=r.replyTo,n++}return i}async function t_(t,i,o){let n=D(t),r=n.length>0?n[0]:"",s=n.length>1?n[1]:"",l=z(t.querySelector(P)),d=await W(t),c="",p=[],u=null,h=t.querySelector(B);if(h){let g=h.querySelector('a[href*="/status/"]');if(g){let m=g.getAttribute("href"),f=m.match(/\/status\/(\d+)/);f&&f[1]&&(u=f[1])}c=z(h.querySelector(P))||"",p=await W(h)}let $=document.querySelector('div[aria-label="Timeline: Conversation"]')||document.querySelector('div[aria-label^="Timeline: Conversation"]'),b=[];if($&&$.dataset.threadMapping&&a.has(i)&&a.get(i).threadContext?.threadMediaUrls)b=a.get(i).threadContext.threadMediaUrls||[];else if($&&$.dataset.threadMediaUrls)try{let y=JSON.parse($.dataset.threadMediaUrls);b=Array.isArray(y)?y:[]}catch(x){}let v=[...d].filter(t=>!p.includes(t)),w="",_=t.querySelector('div[role="group"][aria-label$=" views"]');_&&(w=_.getAttribute("aria-label")?.trim()||"");let E=`[TWEET ${i}]
 Author:@${r}:
`+l;if(v.length>0){if(A=e("enableImageDescriptions",!1)){let S=await tA(v,o,i,r);E+=`
[MEDIA_DESCRIPTION]:
${S}`}E+=`
[MEDIA_URLS]:
${v.join(", ")}`}if(w&&(E+=`
[ENGAGEMENT_STATS]:
${w}`),!Y(t)&&b.length>0){let k=b.filter(t=>!v.includes(t)&&!p.includes(t));k.length>0&&(E+=`
[THREAD_MEDIA_URLS]:
${k.join(", ")}`)}if((c||p.length>0)&&(E+=`
[QUOTED_TWEET${u?" "+u:""}]:
 Author:@${s}:
${c}`,p.length>0)){if(A){let I=await tA(p,o,i,r);E+=`
[QUOTED_TWEET_MEDIA_DESCRIPTION]:
${I}`}E+=`
[QUOTED_TWEET_MEDIA_URLS]:
${p.join(", ")}`}if(document.querySelector('div[aria-label="Timeline: Conversation"]','div[aria-label^="Timeline: Conversation"]')){let C=await t3(i),T=!1;if($&&$.dataset.threadHist&&!Y(t)&&(E=$.dataset.threadHist+`
[REPLY]
`+E,T=!0),C.length>0&&!T){let q="";for(let L=C.length-1;L>=0;L--){let R=C[L],U=R.toId,H=a.get(U),N=H?.tweetContent;q=N?N+"\n[REPLY]\n"+q:`[CONTEXT UNAVAILABLE FOR TWEET ${U} @${R.to||"unknown"}]
[REPLY]
`+q}E=q+E}let O=tk(i);O&&O.replyTo&&!T&&0===C.length&&(E=`[REPLY TO TWEET ${O.replyTo}]
`+E)}return t.dataset.fullContext=E,E}function tE(){if(!y)return;let t=y.querySelectorAll(M);t.forEach(tu)}async function t0(){try{let t=document.querySelector('div[aria-label="Timeline: Conversation"]');if(t||(t=document.querySelector('div[aria-label^="Timeline: Conversation"]')),!t||tw||"pending"===t.dataset.threadHist)return;if(t.dataset.threadMappedAt){let i=parseInt(t.dataset.threadMappedAt,10);if(Date.now()-i<1e4)return}let o=location.pathname.match(/status\/(\d+)/),n=o?o[1]:null;if(!n)return;let r=n;for(;tv[r]&&tv[r].replyTo;)r=tv[r].replyTo;if(void 0===t.dataset.threadHist){T="";let s=Array.from(t.querySelectorAll('article[data-testid="tweet"]')).find(t=>F(t)===r)||document.querySelector('article[data-testid="tweet"]');if(s){t.dataset.threadHist="pending",tw=!0;try{let l=F(s);if(!l)throw Error("Failed to get tweet ID from first article");let d=e("openrouter-api-key",""),c=await t_(s,l,d);if(!c)throw Error("Failed to get full context for root tweet");T=c,t.dataset.threadHist=T,t.firstChild&&(t.firstChild.dataset.canary="true"),m.has(l)||tx(s),setTimeout(()=>{tS(t,r)},10)}catch(p){tw=!1,delete t.dataset.threadHist}return}}else if("pending"!==t.dataset.threadHist&&t.firstChild&&void 0===t.firstChild.dataset.canary){t.firstChild&&(t.firstChild.dataset.canary="pending"),tw=!0;try{let u=document.querySelector('article[data-testid="tweet"]:has(~ div[data-testid="inline_reply_offscreen"])');if(u){let h=F(u);if(!h)throw Error("Failed to get tweet ID from next article");if(a.has(h)&&a.get(h).tweetContent)T=T+"\n[REPLY]\n"+a.get(h).tweetContent;else{let g=e("openrouter-api-key","");await new Promise(t=>setTimeout(t,10));let f=await t_(u,h,g);if(!f)throw Error("Failed to get context for next article");T=T+"\n[REPLY]\n"+f}t.dataset.threadHist=T}setTimeout(()=>{tS(t,r)},500)}catch($){tw=!1,t.firstChild&&delete t.firstChild.dataset.canary}}else tw||t.dataset.threadMappingInProgress||(tw=!0,setTimeout(()=>{tS(t,r)},250))}catch(b){tw=!1}}async function tS(t,o){t.dataset.threadMappingInProgress="true",t.dataset.threadMappedAt=Date.now().toString(),tw=!0;try{let n=new Promise((t,e)=>setTimeout(()=>e(Error("Thread mapping timed out")),5e3)),r=async()=>{let n=Array.from(document.querySelectorAll('div[data-testid="cellInnerDiv"]'));if(!n.length){delete t.dataset.threadMappingInProgress,tw=!1;return}let r=[],l=0;for(let d=0;d<n.length;d++){let c=n[d],p=c.querySelector('article[data-testid="tweet"]');if(p)try{let u=F(p);if(!u){let h=p.querySelector('a[href*="/status/"]');if(h){let g=h.href.match(/status\/(\d+)/);g&&(u=g[1])}}if(!u)continue;let f=D(p),$=f.length>0?f[0]:null;if(!$)continue;let b=p.querySelector('[data-testid="tweetText"]'),y=b?b.innerText.trim().replace(/\n+/g," ‚èé "):"",x=await W(p),v=[],w=p.querySelector(B);w&&(v=await W(w));let _=n[d-1]||null,E=!1;if(_&&1===_.childElementCount){let S=_.children[0];S&&0===S.children.length&&""===S.innerHTML.trim()&&(E=!0)}r.push({tweetNode:p,username:$,tweetId:u,text:y,mediaLinks:x,quotedMediaLinks:v,cellIndex:d,isReplyToRoot:E,cellDiv:c,index:l++}),m.has(u)||tx(p)}catch(k){continue}}if(0===r.length){delete t.dataset.threadMappingInProgress,tw=!1;return}for(let I=0;I<r.length;++I){let C=r[I],T=tv[C.tweetId];if(C.tweetId===o)C.replyTo=null,C.replyToId=null,C.isRoot=!0;else if(T&&T.replyTo)C.replyTo=T.to,C.replyToId=T.replyTo,C.isRoot=!1;else if(C.isReplyToRoot){let A=r.find(t=>t.tweetId===o);C.replyTo=A?A.username:null,C.replyToId=A?A.tweetId:null,C.isRoot=!1}else I>0?(C.replyTo=r[I-1].username,C.replyToId=r[I-1].tweetId,C.isRoot=!1):(C.replyTo=null,C.replyToId=null,C.isRoot=!1)}let q=r.map(t=>({from:t.username,tweetId:t.tweetId,to:t.replyTo,toId:t.replyToId,isRoot:!0===t.isRoot,text:t.text,mediaLinks:t.mediaLinks||[],quotedMediaLinks:t.quotedMediaLinks||[]}));for(let L of r)if(!L.replyToId&&!L.isRoot&&tv[L.tweetId]?.replyTo){L.replyToId=tv[L.tweetId].replyTo,L.replyTo=tv[L.tweetId].to;let R=q.find(t=>t.tweetId===L.tweetId);R&&(R.toId=L.replyToId,R.to=L.replyTo)}t.dataset.threadMapping=JSON.stringify(q);let U=Date.now();q.forEach(t=>{t.tweetId&&t.toId?tv[t.tweetId]={replyTo:t.toId,from:t.from,to:t.to,isRoot:!1,timestamp:U}:t.tweetId&&t.isRoot&&(tv[t.tweetId]={replyTo:null,from:t.from,isRoot:!0,timestamp:U})}),function t(){try{let e=Object.keys(tv).length;if(e>1e3){let o=Object.entries(tv);o.sort((t,e)=>(e[1].timestamp||0)-(t[1].timestamp||0));let n=o.slice(0,500);tv=Object.fromEntries(n)}i("threadRelationships",JSON.stringify(tv))}catch(r){}}();let H="",N=q.find(t=>!0===t.isRoot);if(N&&N.tweetId){let O=r.find(t=>t.tweetId===N.tweetId)?.tweetNode;if(O)try{let M=e("openrouter-api-key",""),P=await t_(O,N.tweetId,M);if(P){H=P,t.dataset.threadHist=H;let Q=[];q.forEach(t=>{t.mediaLinks&&t.mediaLinks.length&&Q.push(...t.mediaLinks),t.quotedMediaLinks&&t.quotedMediaLinks.length&&Q.push(...t.quotedMediaLinks)}),Q.length>0&&(t.dataset.threadMediaUrls=JSON.stringify(Q))}}catch(z){}}for(let Y=0;Y<q.length;Y+=10){let j=q.slice(Y,Y+10);j.forEach(t=>{if(t.tweetId&&a.has(t.tweetId)&&(a.get(t.tweetId).threadContext={replyTo:t.to,replyToId:t.toId,isRoot:t.isRoot,threadMediaUrls:t.isRoot?[]:s(t.tweetId,q)},t.tweetId&&m.has(t.tweetId))){let e=r.find(e=>e.tweetId===t.tweetId);if(e&&e.tweetNode){let i="streaming"===e.tweetNode.dataset.ratingStatus||a.has(t.tweetId)&&!0===a.get(t.tweetId).streaming;i||(m.delete(t.tweetId),tx(e.tweetNode))}}}),Y+10<q.length&&await new Promise(t=>setTimeout(t,0))}delete t.dataset.threadMappingInProgress,tw=!1};function s(t,e){let i=[],o=e.findIndex(e=>e.tweetId===t);if(o>0)for(let n=0;n<o;n++)e[n].mediaLinks&&e[n].mediaLinks.length&&i.push(...e[n].mediaLinks),e[n].quotedMediaLinks&&e[n].quotedMediaLinks.length&&i.push(...e[n].quotedMediaLinks);return i}await Promise.race([r(),n])}catch(l){delete t.dataset.threadMappedAt,delete t.dataset.threadMappingInProgress,tw=!1}}function tk(t){return tv[t]?tv[t]:null}async function tI(t,e,i=3e4){return new Promise(o=>{GM_xmlhttpRequest({method:"POST",url:"https://openrouter.ai/api/v1/chat/completions",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},data:JSON.stringify(t),timeout:i,onload:function(t){if(t.status>=200&&t.status<300)try{let e=JSON.parse(t.responseText);""===e.content&&o({error:!0,message:`No content returned${"SAFETY"==e.choices[0].native_finish_reason?" (SAFETY FILTER)":""}`,data:e}),o({error:!1,message:"Request successful",data:e})}catch(i){o({error:!0,message:`Failed to parse response: ${i.message}`,data:null})}else o({error:!0,message:`Request failed with status ${t.status}: ${t.responseText}`,data:null})},onerror:function(t){o({error:!0,message:`Request error: ${t.toString()}`,data:null})},ontimeout:function(){o({error:!0,message:`Request timed out after ${i}ms`,data:null})}})})}function tC(t,e,i,o,n,r=9e4,s=null){let l={...t,stream:!0},d="",c="",p="",u=null,h=!1,g=GM_xmlhttpRequest({method:"POST",url:"https://openrouter.ai/api/v1/chat/completions",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},data:JSON.stringify(l),timeout:r,responseType:"stream",onloadstart:function(t){let e=t.response.getReader(),r=()=>{a&&clearTimeout(a),a=setTimeout(()=>{h||(h=!0,o({content:c,reasoning:p,fullResponse:d,data:u,timedOut:!0}))},3e4)},a=null,l=async()=>{try{r();let t=!1,l=0;for(;!t&&!h;){let{done:g,value:m}=await e.read();if(g){t=!0;break}let f=new TextDecoder().decode(m);if(clearTimeout(a),r(),""===f.trim()){if(++l>=3){t=!0;break}continue}l=0,d+=f;let $=f.split("\n");for(let b of $)if(b.startsWith("data: ")){let y=b.substring(6);if("[DONE]"===y){t=!0;break}try{let x=JSON.parse(y);if(u=x,x.choices&&x.choices[0]){if(x.choices[0].delta&&void 0!==x.choices[0].delta.content){let v=x.choices[0].delta.content||"";c+=v}if(x.choices[0].delta&&void 0!==x.choices[0].delta.reasoning){let w=x.choices[0].delta.reasoning||"";p+=w}i({chunk:x.choices[0].delta?.content||"",reasoningChunk:x.choices[0].delta?.reasoning||"",content:c,reasoning:p,data:x})}}catch(_){}}}h||(h=!0,a&&clearTimeout(a),s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],o({content:c,reasoning:p,fullResponse:d,data:u}))}catch(E){a&&clearTimeout(a),h||(h=!0,s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Stream processing error: ${E.toString()}`,data:null}))}};l().catch(t=>{a&&clearTimeout(a),h||(h=!0,s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Unhandled stream error: ${t.toString()}`,data:null}))})},onerror:function(t){s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Request error: ${t.toString()}`,data:null})},ontimeout:function(){s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Request timed out after ${r}ms`,data:null})}}),m={abort:function(){h=!0,v--;try{g.abort()}catch(t){}if(s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],s&&a.has(s)){let e=a.get(s);e.streaming&&(void 0===e.score||null===e.score)&&a.delete(s)}}};return s&&window.activeStreamingRequests&&(window.activeStreamingRequests[s]=m),m}function tT(){let t=e("openrouter-api-key","");if(!t){V("Please enter your OpenRouter API key");return}V("Fetching available models...");let i=e("modelSortOrder","throughput-high-to-low");GM_xmlhttpRequest({method:"GET",url:`https://openrouter.ai/api/frontend/models/find?order=${i}`,headers:{Authorization:`Bearer ${t}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532182-twitter-x-ai-tweet-filter","X-Title":"Tweet Rating Tool"},onload:function(t){try{let e=JSON.parse(t.responseText);if(e.data&&e.data.models){let o=e.data.models.filter(t=>t.endpoint&&null!==t.endpoint);o.forEach(t=>{let e=t.endpoint?.pricing,i=!e||(null==e.completion||0===parseFloat(e.completion))&&(null==e.prompt||0===parseFloat(e.prompt));i&&t.slug&&!t.slug.endsWith(":free")&&(t.slug+=":free")}),("latency-low-to-high"===i||"pricing-low-to-high"===i)&&o.reverse(),_=[...w=o||[]],ts(),V("Models updated!")}}catch(n){V("Error parsing models list")}},onerror:function(t){V("Error fetching models!")}})}async function tA(t,e,i,o){if(!t?.length||!A)return A?"":"[Image descriptions disabled]";let n=[];for(let r of t){let a={model:S,messages:[{role:"user",content:[{type:"text",text:"Describe what you see in this image in a concise way, focusing on the main elements and any text visible. Keep the description under 100 words."},{type:"image_url",image_url:{url:r}}]}],temperature:H,top_p:N,max_tokens:O};S.includes("gemini")&&(a.config={safetySettings:tq}),I&&(a.provider={sort:I,allow_fallbacks:!0});let s=await tI(a,e);!s.error&&s.data?.choices?.[0]?.message?.content?n.push(s.data.choices[0].message.content):n.push("[Error getting image description]")}return n.map((t,e)=>`[IMAGE ${e+1}]: ${t}`).join("\n")}async function t8(t,e,i=1e4){return new Promise(o=>{GM_xmlhttpRequest({method:"GET",url:`https://openrouter.ai/api/v1/generation?id=${t}`,headers:{Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},timeout:i,onload:function(t){if(t.status>=200&&t.status<300)try{let e=JSON.parse(t.responseText);o({error:!1,message:"Metadata fetched successfully",data:e})}catch(i){o({error:!0,message:`Failed to parse metadata response: ${i.message}`,data:null})}else 404===t.status?o({error:!0,status:404,message:`Generation metadata not found (404): ${t.responseText}`,data:null}):o({error:!0,status:t.status,message:`Metadata request failed with status ${t.status}: ${t.responseText}`,data:null})},onerror:function(t){o({error:!0,message:`Metadata request error: ${t.toString()}`,data:null})},ontimeout:function(){o({error:!0,message:`Metadata request timed out after ${i}ms`,data:null})}})})}!function t(){try{let i=e("threadRelationships","{}");tv=JSON.parse(i)}catch(o){tv={}}}(),setInterval(t0,2500),setInterval(function t(){if(!y)return;let e=y.querySelectorAll(M);e.length>0&&e.forEach(t=>{let e=F(t);if(!e)return;let i=tt.get(e),o=!i||!i.status||"error"===i.status||!t$(i.status)&&!tb(i.status)||m.has(e)&&!t$(i.status)&&!tb(i.status);o?(m.has(e)&&m.delete(e),tx(t)):i&&!tb(i.status)&&tu(t)})},1e3),setInterval(tE,1e3);let tq=[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_CIVIC_INTEGRITY",threshold:"BLOCK_NONE"},];function tL(t){if(!t)return[];let e=[],i="Q_1.",o="Q_2.",n="Q_3.",r=t.indexOf(i),a=t.indexOf(o),s=t.indexOf(n);if(-1!==r&&a>r&&s>a){let l=t.substring(r+i.length,a).trim();e.push(l);let d=t.substring(a+o.length,s).trim();e.push(d);let c=t.substring(s+n.length).trim(),p="</FOLLOW_UP_QUESTIONS>";if(c.endsWith(p)&&(c=c.substring(0,c.length-p.length).trim()),e.push(c),e.every(t=>t.length>0))return e}return[]}async function tR(t,i,o,n,r=3,s=null,l=""){let d=()=>{V(`Rating tweet... (${v=Math.max(0,v-1)} pending)`)},c=tt.get(i,s);if(!c)return{score:5,content:"Failed to initialize UI components for rating.",reasoning:"",questions:[],lastAnswer:"",error:!0,cached:!1,data:null,qaConversationHistory:[]};if(f.has(l))return c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:[],apiResponseContent:"<ANALYSIS>This tweet is from an ad author.</ANALYSIS><SCORE>SCORE_0</SCORE><FOLLOW_UP_QUESTIONS>Q_1. N/A\\nQ_2. N/A\\nQ_3. N/A</FOLLOW_UP_QUESTIONS>",reviewSystemPrompt:q,followUpSystemPrompt:L}),{score:0,content:c.description,reasoning:"",error:!1,cached:!1,questions:c.questions,qaConversationHistory:c.qaConversationHistory};let p=g.getCurrentInstructions(),u={model:E,messages:[{role:"system",content:[{type:"text",text:q}]},{role:"user",content:[{type:"text",text:`<TARGET_TWEET_ID>[${i}]</TARGET_TWEET_ID>
<USER_INSTRUCTIONS>[${p}]</USER_INSTRUCTIONS>
<TWEET>[${t}]</TWEET>
Follow this expected response format exactly, or you break the UI:
<EXPECTED_RESPONSE_FORMAT>
  <ANALYSIS>
    (Your analysis according to the user instructions.)
  </ANALYSIS>
  <SCORE>
    SCORE_X (Where X is a number between 0 and 10)
  </SCORE>
  <FOLLOW_UP_QUESTIONS>
    Q_1. ‚Ä¶
    Q_2. ‚Ä¶
    Q_3. ‚Ä¶
  </FOLLOW_UP_QUESTIONS>
</EXPECTED_RESPONSE_FORMAT>
`}]}],temperature:R,top_p:U,max_tokens:O};E.includes("gemini")&&(u.config={safetySettings:tq}),n?.length>0&&Q(E)&&n.forEach(t=>{u.messages[1].content.push({type:"image_url",image_url:{url:t}})}),I&&(u.provider={sort:I,allow_fallbacks:!0});let h=e("enableStreaming",!1);a.set(i,{streaming:!0,timestamp:Date.now(),tweetContent:t,mediaUrls:n});let m=0;for(;m<r;){m++;let $=Date.now(),b=$-x;b<25&&await new Promise(t=>setTimeout(t,25-b)),x=$,V(`Rating tweet... (${++v} pending)`);try{let y;if(y=h?await tH(u,o,i,t,s):await t7(u,o),d(),!y.error&&y.content){c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:n,apiResponseContent:y.content,reviewSystemPrompt:q,followUpSystemPrompt:L});let w=c.score,_=c.questions,S=c.description,k=c.qaConversationHistory;return a.set(i,{score:w,description:S,reasoning:y.reasoning||"",questions:_,lastAnswer:"",tweetContent:t,mediaUrls:n,streaming:!1,timestamp:Date.now(),metadata:y.data?.id?{generationId:y.data.id}:null,qaConversationHistory:k}),{score:w,content:y.content,reasoning:y.reasoning||"",questions:_,error:!1,cached:!1,data:y.data,qaConversationHistory:k}}if(m<r&&(y.error||!y.content)){let C=1e3*Math.pow(m,2);await new Promise(t=>setTimeout(t,C))}else if(y.error||!y.content)throw Error(y.content||"Failed to get valid rating content after multiple attempts")}catch(T){if(d(),m<r){let A=1e3*Math.pow(m,2);await new Promise(t=>setTimeout(t,A))}else{let H=`Failed to get valid rating after multiple attempts: ${T.message}`;return c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:n,apiResponseContent:`<ANALYSIS>${H}</ANALYSIS><SCORE>SCORE_5</SCORE><FOLLOW_UP_QUESTIONS>Q_1. N/A\\nQ_2. N/A\\nQ_3. N/A</FOLLOW_UP_QUESTIONS>`,reviewSystemPrompt:q,followUpSystemPrompt:L}),a.set(i,{score:5,description:H,reasoning:"",questions:[],lastAnswer:"",error:!0,tweetContent:t,mediaUrls:n,streaming:!1,timestamp:Date.now(),qaConversationHistory:c.qaConversationHistory}),{score:5,content:H,reasoning:"",questions:[],lastAnswer:"",error:!0,data:null,qaConversationHistory:c.qaConversationHistory}}}}d();let N="Unexpected failure in rating process.";return c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:n,apiResponseContent:`<ANALYSIS>${N}</ANALYSIS><SCORE>SCORE_5</SCORE><FOLLOW_UP_QUESTIONS>Q_1. N/A\\nQ_2. N/A\\nQ_3. N/A</FOLLOW_UP_QUESTIONS>`,reviewSystemPrompt:q,followUpSystemPrompt:L}),{score:5,content:N,reasoning:"",questions:[],lastAnswer:"",error:!0,data:null,qaConversationHistory:c.qaConversationHistory}}async function tU(t){let i={model:"google/gemini-2.5-flash-preview",messages:[{role:"system",content:[{type:"text",text:`
                Please come up with a 5-word summary of the following instructions.
                `}]},{role:"user",content:[{type:"text",text:`Please come up with a 5-word summary of the following instructions:
            ${t}
            `}]}]},o=e("openrouter-api-key"),n=await tI(i,o);if(!n.error&&n.data?.choices?.[0]?.message){let r=n.data.choices[0].message.content||"";return{content:r,error:!1}}return{error:!0,content:n.error||"Unknown error"}}async function t7(t,e){let i=t.tweetId,o=a.get(i)?.score,n=await tI(t,e);if(!n.error&&n.data?.choices?.[0]?.message){let r=n.data.choices[0].message.content||"",s=n.data.choices[0].message.reasoning||"",l=r.match(/SCORE_(\d+)/g),d=o||(l&&l.length>0?parseInt(l[l.length-1].match(/SCORE_(\d+)/)[1],10):null);return a.set(i,{score:d,description:r,tweetContent:t.tweetText,streaming:!1}),{content:r,reasoning:s}}return{error:!0,content:n.error||"Unknown error",reasoning:"",data:null}}async function tH(t,e,i,o,n){window.activeStreamingRequests&&window.activeStreamingRequests[i]&&(window.activeStreamingRequests[i].abort(),delete window.activeStreamingRequests[i]);let r=a.get(i);return r&&void 0!==r.score&&null!==r.score||a.set(i,{streaming:!0,timestamp:Date.now(),tweetContent:o,description:"",reasoning:"",questions:[],lastAnswer:"",score:null}),new Promise((s,l)=>{let d=tt.get(i,n);if(!d)return a.has(i)&&(a.get(i).streaming=!1,a.get(i).error="Indicator initialization failed"),l(Error(`ScoreIndicator instance could not be initialized for tweet ${i}`));let c=r?.description||"",p=r?.reasoning||"";r?.questions;let u=null,h=r?.score||null;tC(t,e,t=>{c=t.content||c,p=t.reasoning||p;let e=c.match(/SCORE_(\d+)/g);if(e&&e.length>0){let o=e[e.length-1];h=parseInt(o.match(/SCORE_(\d+)/)[1],10)}if(d.update({status:"streaming",score:h,description:c||"Rating in progress...",reasoning:p,questions:[],lastAnswer:""}),a.has(i)){let n=a.get(i);n.description=c,n.reasoning=p,n.score=h,n.streaming=!0}},t=>{c=t.content||c,p=t.reasoning||p,u=t.data;let r=c.match(/SCORE_(\d+)/g);if(r&&r.length>0){let l=r[r.length-1];h=parseInt(l.match(/SCORE_(\d+)/)[1],10)}let g="rated";null==h&&(g="error",h=5,c+="\n[No score detected - Error]");let m={tweetContent:o,score:h,description:c,reasoning:p,streaming:!1,timestamp:Date.now(),error:"error"===g?"No score detected":void 0,metadata:u?.id?{generationId:u.id}:null};a.set(i,m),d.update({status:g,score:h,description:c,reasoning:p,questions:tL(c),lastAnswer:"",metadata:u?.id?{generationId:u.id}:null}),n&&tu(n);let f=u?.id;f&&e&&tN(i,f,e,d),s({score:h,content:c,reasoning:p,error:"error"===g,cached:!1,data:u})},t=>{if(d.update({status:"error",score:5,description:`Stream Error: ${t.message}`,reasoning:"",questions:[],lastAnswer:""}),a.has(i)){let e=a.get(i);e.streaming=!1,e.error=t.message,e.score=5,e.description=`Stream Error: ${t.message}`}l(Error(t.message))},3e4,i)})}async function tN(t,e,i,o,n=0,r=[1e3,500,2e3,4e3,8e3]){if(n>=r.length)return;let s=r[n];await new Promise(t=>setTimeout(t,s));try{let l=await t8(e,i);if(!l.error&&l.data?.data){let d=l.data.data,c={model:d.model||"N/A",promptTokens:d.tokens_prompt||0,completionTokens:d.tokens_completion||0,reasoningTokens:d.native_tokens_reasoning||0,latency:void 0!==d.latency?(d.latency/1e3).toFixed(2)+"s":"N/A",mediaInputs:d.num_media_prompt||0,price:void 0!==d.total_cost?`$${d.total_cost.toFixed(6)}`:"N/A"},p=a.get(t);p&&(p.metadata=c,a.set(t,p),o.update({metadata:c}));return}l.status,tN(t,e,i,o,n+1,r)}catch(u){tN(t,e,i,o,n+1,r)}}async function tO(t,i,o,n,r){let s=i.find(t=>"user"===t.role&&t===i[i.length-1])?.content.find(t=>"text"===t.type)?.text||"User's question",l=e("enableStreaming",!1),d={model:E,messages:i,temperature:R,top_p:U,max_tokens:O,stream:l};E.includes("gemini")&&(d.config={safetySettings:tq}),I&&(d.provider={sort:I,allow_fallbacks:!0});try{let c="*Processing...*",p=[...i];if(l)await new Promise((e,i)=>{let n="";tC(d,o,t=>{n=t.content||n,r._renderStreamingAnswer(n,"")},i=>{c=i.content||n;let o={role:"assistant",content:[{type:"text",text:c}]};p.push(o),r.updateAfterFollowUp({assistantResponseContent:c,updatedQaHistory:p});let s=a.get(t)||{};s.qaConversationHistory=p;let l=c.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/);s.lastAnswer=l?l[1].trim():c,s.questions=tL(c),s.timestamp=Date.now(),a.set(t,s),e()},e=>{let o=`Error generating answer: ${e.message}`;r._updateConversationHistory(s,o),r.questions=a.get(t)?.questions||[],r._updateTooltipUI();let n=a.get(t)||{};n.lastAnswer=o,n.timestamp=Date.now(),a.set(t,n),i(Error(e.message))},6e4,`followup-${t}`)});else{let u=await tI(d,o,6e4);if(u.error||!u.data?.choices?.[0]?.message?.content)throw Error(u.message||"Failed to get follow-up answer.");c=u.data.choices[0].message.content;let h={role:"assistant",content:[{type:"text",text:c}]};p.push(h),r.updateAfterFollowUp({assistantResponseContent:c,updatedQaHistory:p});let g=a.get(t)||{};g.qaConversationHistory=p;let m=c.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/);g.lastAnswer=m?m[1].trim():c,g.questions=tL(c),g.timestamp=Date.now(),a.set(t,g)}}catch(f){let $=`Error answering question: ${f.message}`;r._updateConversationHistory(s,$),r.questions=a.get(t)?.questions||[],r._updateTooltipUI();let b=a.get(t)||{};b.lastAnswer=$,b.timestamp=Date.now(),a.set(t,b)}}let tM;i("menuHTML",GM_getResourceText("MENU_HTML")),tM=e("firstRun",!0),function n(){let r=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(r){y=r,function n(){let r=function i(){let o;if(!(o=t||e("menuHTML")))return V("Error: Could not load UI components."),null;let n="tweetfilter-root-container",r=document.getElementById(n);if(r)return r;(r=document.createElement("div")).id=n,r.innerHTML=o,document.body.appendChild(r);let a=r.querySelector("#version-info");return a&&(a.textContent="Twitter De-Sloppifier v1.4.5"),r}();r&&(function t(o){if(!o)return;let n=o.querySelector("#settings-container"),r=o.querySelector("#tweet-filter-container"),s=o.querySelector("#settings-toggle"),l=o.querySelector("#filter-toggle");o.addEventListener("click",t=>{let o=t.target,d=o.closest("[data-action]"),c=d?.dataset.action;o.dataset.setting,o.closest(".parameter-row")?.dataset.paramName;let p=o.dataset.tab,u=o.closest("[data-toggle]")?.dataset.toggle;if(c)switch(c){case"close-filter":ti(r,l,"Filter Slider","Filter Slider");break;case"toggle-settings":case"close-settings":ti(n,s,'<span style="font-size: 14px;">‚úï</span> Close','<span style="font-size: 14px;">‚öôÔ∏è</span> Settings');break;case"save-api-key":(function t(){let o=document.getElementById("openrouter-api-key"),n=o.value.trim(),r=e("openrouter-api-key","").length>0;n?(r||tp(!0),i("openrouter-api-key",n),V("API key saved successfully!"),tT(),location.reload()):V("Please enter a valid API key")})();break;case"clear-cache":to();break;case"reset-settings":tp(X());break;case"save-instructions":K();break;case"add-handle":(function t(){let e=document.getElementById("handle-input"),o=e.value.trim();o&&(function t(e){if(""===(e=e.trim().replace(/^@/,""))||C.includes(e)){V(""===e?"Handle cannot be empty.":`@${e} is already on the list.`);return}C.push(e),i("blacklistedHandles",C.join("\n")),ta(document.getElementById("handle-list")),V(`Added @${e} to auto-rate list.`)}(o),e.value="")})();break;case"clear-instructions-history":(X()||confirm("Are you sure you want to clear all instruction history?"))&&(g.clearHistory(),Z(),V("Instructions history cleared"));break;case"export-cache":(function t(){if(!a){V("Error: Tweet cache not found.","error");return}try{let e=a.cache;if(!e||0===Object.keys(e).length){V("Cache is empty. Nothing to export.","warning");return}let i=JSON.stringify(e,null,2),o=new Blob([i],{type:"application/json;charset=utf-8;"}),n=URL.createObjectURL(o),r=document.createElement("a");r.setAttribute("href",n);let s=new Date().toISOString().replace(/[:.]/g,"-");r.setAttribute("download",`tweet-filter-cache-${s}.json`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),V(`Cache exported successfully (${Object.keys(e).length} items).`)}catch(l){V("Error exporting cache. Check console for details.","error")}})()}if(o.classList.contains("remove-handle")){let h=o.closest(".handle-item"),m=h?.querySelector(".handle-text");if(m){let f=m.textContent.substring(1);(function t(e){let o=C.indexOf(e);o>-1?(C.splice(o,1),i("blacklistedHandles",C.join("\n")),ta(document.getElementById("handle-list")),V(`Removed @${e} from auto-rate list.`)):console.warn(`Attempted to remove non-existent handle: ${e}`)})(f)}}p&&function t(e){let i=document.querySelector("#settings-container .settings-content");if(!i)return;let o=i.querySelectorAll(".tab-content"),n=i.querySelectorAll(".tab-navigation .tab-button");o.forEach(t=>t.classList.remove("active")),n.forEach(t=>t.classList.remove("active"));let r=i.querySelector(`#${e}-tab`),a=i.querySelector(`.tab-navigation .tab-button[data-tab="${e}"]`);r&&r.classList.add("active"),a&&a.classList.add("active")}(p),u&&function t(e){let i=document.getElementById(e),o=document.querySelector(`[data-toggle="${e}"]`);if(!i||!o)return;let n=o.querySelector(".advanced-toggle-icon"),r=i.classList.toggle("expanded");n&&n.classList.toggle("expanded",r),r?i.style.maxHeight=i.scrollHeight+"px":i.style.maxHeight="0"}(u)}),o.addEventListener("input",t=>{let e=t.target,o=e.dataset.setting,n=e.closest(".parameter-row")?.dataset.paramName;o&&tn(e,o),n&&function t(e,o){let n=e.closest(".parameter-row");if(!n)return;let r=n.querySelector(".parameter-slider"),a=n.querySelector(".parameter-value"),s=parseFloat(r.min),l=parseFloat(r.max),d=parseFloat(e.value);"number"!==e.type||isNaN(d)||(d=Math.max(s,Math.min(l,d))),r&&a&&(r.value=d,a.value=d),void 0!==window[o]&&(window[o]=d),i(o,d)}(e,n),"tweet-filter-slider"===e.id&&function t(e){let o=document.getElementById("tweet-filter-value");b=parseInt(e.value,10),o&&(o.value=b.toString());let n=b/10*100;e.style.setProperty("--slider-percent",`${n}%`),i("filterThreshold",b),tE()}(e),"tweet-filter-value"===e.id&&function t(e){let o=parseInt(e.value,10);o=Math.max(0,Math.min(10,o)),e.value=o.toString();let n=document.getElementById("tweet-filter-slider");if(n){n.value=o.toString();let r=o/10*100;n.style.setProperty("--slider-percent",`${r}%`)}b=o,i("filterThreshold",b),tE()}(e)}),o.addEventListener("change",t=>{let e=t.target,i=e.dataset.setting;"modelSortOrder"===i&&(tn(e,i),tT()),"enableImageDescriptions"===i&&tn(e,i)}),l&&(l.onclick=()=>{r&&(r.style.display="flex",r.offsetHeight,r.classList.remove("hidden")),l.style.display="none"}),document.addEventListener("click",tc);let d=o.querySelector("#show-free-models");d&&d.addEventListener("change",function(){i("showFreeModels",k=this.checked),ts()});let c=o.querySelector("#sort-direction");c&&c.addEventListener("click",function(){let t=e("sortDirection","default"),o="default"===t?"reverse":"default";i("sortDirection",o),this.dataset.value=o,ts()});let p=o.querySelector("#model-sort-order");p&&p.addEventListener("change",function(){i("modelSortOrder",this.value),"latency-low-to-high"===this.value?i("sortDirection","default"):""===this.value&&i("sortDirection","default"),ts()});let u=o.querySelector("#provider-sort");u&&u.addEventListener("change",function(){i("providerSort",I=this.value)})}(r),tr(),tT(),function t(){let e=document.getElementById("tweet-filter-stats-badge");if(!e)return;e.title="Click to open settings",e.addEventListener("click",()=>{let t=document.getElementById("settings-toggle");t&&t.click()});let i,n=()=>{clearTimeout(i),e.style.opacity="1",i=setTimeout(()=>{e.style.opacity="0.3"},5e3)};e.addEventListener("mouseenter",()=>{e.style.opacity="1",clearTimeout(i)}),e.addEventListener("mouseleave",n),n(),o()}(),setInterval(o,3e3),window.activeStreamingRequests||(window.activeStreamingRequests={}))}(),tM&&(tp(!0),i("firstRun",!1));let s=e("openrouter-api-key","");s||alert("No API Key found. Please enter your API Key in Settings > General."),s&&(i("openrouter-api-key",s),V(`Loaded ${a.size} cached ratings. Starting to rate visible tweets...`),tT()),y.querySelectorAll(M).forEach(tx),tE();let l=new MutationObserver(j);l.observe(y,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{l.disconnect();let t=document.getElementById("tweet-filter-container");t&&t.remove();let e=document.getElementById("settings-container");e&&e.remove();let i=document.getElementById("status-indicator");i&&i.remove(),tt.destroyAll()})}else setTimeout(n,1e3)}()}();