// ==UserScript==
// @name         TweetFilter AI
// @namespace    http://tampermonkey.net/
// @version      Version 1.5.5
// @description  A highly customizable AI rates tweets 1-10 and removes all the slop, saving your braincells!
// @author       Obsxrver(3than)
// @match        *://twitter.com/*
// @match        *://x.com/*
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        GM_getResourceText
// @connect      openrouter.ai
// @run-at       document-idle
// @license      MIT
// ==/UserScript==
!function(){"use strict";console.log("X/Twitter Tweet De-Sloppification Activated (Combined Version)");let t=`<div id="tweetfilter-root-container"><button id="filter-toggle" class="toggle-button" style="display: none;">Filter Slider</button><div id="tweet-filter-container"><button class="close-button" data-action="close-filter">\xd7</button><label for="tweet-filter-slider">SlopScore:</label><div class="filter-controls"><input type="range" id="tweet-filter-slider" min="0" max="10" step="1"><input type="number" id="tweet-filter-value" min="0" max="10" step="1" value="5"></div></div><button id="settings-toggle" class="toggle-button" data-action="toggle-settings"><span style="font-size: 14px;">‚öôÔ∏è</span> Settings</button><div id="settings-container" class="hidden"><div class="settings-header"><div class="settings-title">Twitter De-Sloppifier</div><button class="close-button" data-action="toggle-settings">\xd7</button></div><div class="settings-content"><div class="tab-navigation"><button class="tab-button active" data-tab="general">General</button><button class="tab-button" data-tab="models">Models</button><button class="tab-button" data-tab="instructions">Instructions</button></div><div id="general-tab" class="tab-content active"><div class="section-title"><span style="font-size: 14px;">üîë</span> OpenRouter API Key <a href="https://openrouter.ai/settings/keys" target="_blank">Get one here</a></div><input id="openrouter-api-key" placeholder="Enter your OpenRouter API key"><button class="settings-button" data-action="save-api-key">Save API Key</button><div class="section-title" style="margin-top: 20px;"><span style="font-size: 14px;">üóÑÔ∏è</span> Cache Statistics</div><div class="stats-container"><div class="stats-row"><div class="stats-label">Cached Tweet Ratings</div><div class="stats-value" id="cached-ratings-count">0</div></div><div class="stats-row"><div class="stats-label">Whitelisted Handles</div><div class="stats-value" id="whitelisted-handles-count">0</div></div></div><button id="clear-cache" class="settings-button danger" data-action="clear-cache">Clear Rating Cache</button><div class="section-title" style="margin-top: 20px;"><span style="font-size: 14px;">üíæ</span> Backup &amp; Restore</div><div class="section-description">Export your settings and cached ratings to a file for backup, or import previously saved settings.</div><button class="settings-button" data-action="export-cache">Export Cache</button><button class="settings-button danger" style="margin-top: 15px;" data-action="reset-settings">Reset to Defaults</button><div id="version-info" style="margin-top: 20px; font-size: 11px; opacity: 0.6; text-align: center;">Twitter De-Sloppifier v?.?</div></div><div id="models-tab" class="tab-content"><div class="section-title"><span style="font-size: 14px;">üß†</span> Tweet Rating Model</div><div class="section-description">The rating model is responsible for reviewing each tweet. <br>It will process images directly if you select an <strong>image-capable (üñºÔ∏è)</strong> model.</div><div class="select-container" id="model-select-container"></div><div class="advanced-options"><div class="advanced-toggle" data-toggle="model-options-content"><div class="advanced-toggle-title">Options</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="model-options-content"><div class="sort-container"><label for="model-sort-order">Sort models by: </label><div class="controls-group"><select id="model-sort-order" data-setting="modelSortOrder"><option value="pricing-low-to-high">Price</option><option value="latency-low-to-high">Latency</option><option value="throughput-high-to-low">Throughput</option><option value="top-weekly">Popularity</option><option value="">Age</option></select><button id="sort-direction" class="sort-toggle" data-setting="sortDirection" data-value="default">High-Low</button></div></div><div class="sort-container"><label for="provider-sort">API Endpoint Priority: </label><select id="provider-sort" data-setting="providerSort"><option value="">Default (load-balanced)</option><option value="throughput">Throughput</option><option value="latency">Latency</option><option value="price">Price</option></select></div><div class="sort-container"><label><input type="checkbox" id="show-free-models" data-setting="showFreeModels" checked>Show Free Models</label></div><div class="parameter-row" data-param-name="modelTemperature"><div class="parameter-label" title="How random the model responses should be (0.0-1.0)">Temperature</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2" step="0.1"><input type="number" class="parameter-value" min="0" max="2" step="0.01" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="modelTopP"><div class="parameter-label" title="Nucleus sampling parameter (0.0-1.0)">Top-p</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="1" step="0.1"><input type="number" class="parameter-value" min="0" max="1" step="0.01" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="maxTokens"><div class="parameter-label" title="Maximum number of tokens for the response (0 means no limit)">Max Tokens</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2000" step="100"><input type="number" class="parameter-value" min="0" max="2000" step="100" style="width: 60px;"></div></div><div class="toggle-row"><div class="toggle-label" title="Stream API responses as they're generated for live updates">Enable Live Streaming</div><label class="toggle-switch"><input type="checkbox" data-setting="enableStreaming"><span class="toggle-slider"></span></label></div><div class="toggle-row"><div class="toggle-label" title="Enable web search capabilities for the model. Appends ':online' to the model slug.">Enable Web Search</div><label class="toggle-switch"><input type="checkbox" data-setting="enableWebSearch"><span class="toggle-slider"></span></label></div><div class="toggle-row"><div class="toggle-label" title="Automatically send tweets to API for rating. When disabled, tweets will show a 'Rate' button instead.">Auto-Rate Tweets</div><label class="toggle-switch"><input type="checkbox" data-setting="enableAutoRating"><span class="toggle-slider"></span></label></div></div></div><div class="section-title" style="margin-top: 25px;"><span style="font-size: 14px;">üñºÔ∏è</span> Image Processing Model</div><div class="section-description">This model generates <strong>text descriptions</strong> of images for the rating model.<br> Hint: If you selected an image-capable model (üñºÔ∏è) as your <strong>main rating model</strong>, it will process images directly.</div><div class="toggle-row"><div class="toggle-label">Enable Image Descriptions</div><label class="toggle-switch"><input type="checkbox" data-setting="enableImageDescriptions"><span class="toggle-slider"></span></label></div><div id="image-model-container" style="display: none;"><div class="select-container" id="image-model-select-container"></div><div class="advanced-options" id="image-advanced-options"><div class="advanced-toggle" data-toggle="image-advanced-content"><div class="advanced-toggle-title">Options</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="image-advanced-content"><div class="parameter-row" data-param-name="imageModelTemperature"><div class="parameter-label" title="Randomness for image descriptions (0.0-1.0)">Temperature</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2" step="0.1"><input type="number" class="parameter-value" min="0" max="2" step="0.1" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="imageModelTopP"><div class="parameter-label" title="Nucleus sampling for image model (0.0-1.0)">Top-p</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="1" step="0.1"><input type="number" class="parameter-value" min="0" max="1" step="0.1" style="width: 60px;"></div></div></div></div></div></div><div id="instructions-tab" class="tab-content"><div class="section-title">Custom Instructions</div><div class="section-description">Add custom instructions for how the model should score tweets:</div><textarea id="user-instructions" placeholder="Examples:- Give high scores to tweets about technology- Penalize clickbait-style tweets- Rate educational content higher" data-setting="userDefinedInstructions" value=""></textarea><button class="settings-button" data-action="save-instructions">Save Instructions</button><div class="advanced-options" id="instructions-history"><div class="advanced-toggle" data-toggle="instructions-history-content"><div class="advanced-toggle-title">Custom Instructions History</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="instructions-history-content"><div class="instructions-list" id="instructions-list"><!-- Instructions entries will be added here dynamically --></div><button class="settings-button danger" style="margin-top: 10px;" data-action="clear-instructions-history">Clear All History</button></div></div><div class="section-title" style="margin-top: 20px;">Auto-Rate Handles as 10/10</div><div class="section-description">Add Twitter handles to automatically rate as 10/10:</div><div class="handle-input-container"><input id="handle-input" type="text" placeholder="Twitter handle (without @)"><button class="add-handle-btn" data-action="add-handle">Add</button></div><div class="handle-list" id="handle-list"></div></div></div><div id="status-indicator" class=""></div></div><div id="tweet-filter-stats-badge" class="tweet-filter-stats-badge"></div></div>`;function e(t,e=null){try{return GM_getValue(t,e)}catch(o){return console.error("Error reading from browser storage:",o),e}}function o(t,e){try{GM_setValue(t,e)}catch(o){console.error("Error writing to browser storage:",o)}}function i(){let t=document.getElementById("cached-ratings-count"),e=document.getElementById("whitelisted-handles-count"),o=a.size,i=q.length;t&&(t.textContent=o),e&&(e.textContent=i);let n=document.getElementById("tweet-filter-stats-badge");n&&(n.innerHTML=`
            <span style="margin-right: 5px;">üß†</span>
            <span data-cached-count>${o} rated</span>
            <span data-pending-count> | ${_} pending</span>
            ${i>0?`<span style="margin-left: 5px;"> | ${i} whitelisted</span>`:""}
        `)}GM_addStyle('.refreshing {animation: spin 1s infinite linear;}@keyframes spin {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}.score-highlight {display: inline-block;background-color: #1d9bf0;/* Twitter blue */color: white;padding: 3px 10px;border-radius: 9999px;margin: 8px 0;font-weight: bold;font-size: 0.9em;}.mobile-tooltip {/* Add specific mobile tooltip styles if needed */max-width: 90vw;/* Example */}.score-description.streaming-tooltip {scroll-behavior: smooth;border-left: 3px solid #1d9bf0;background-color: rgba(25, 30, 35, 0.98);}.score-description.streaming-tooltip::before {content: \'Live\';position: absolute;top: 10px;right: 10px;background-color: #1d9bf0;color: white;font-size: 11px;padding: 2px 6px;border-radius: 10px;font-weight: bold;}.score-description::-webkit-scrollbar {width: 8px;}.score-description::-webkit-scrollbar-track {background: rgba(22, 24, 28, 0.1);border-radius: 4px;}.score-description::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.3);border-radius: 4px;border: 1px solid rgba(22, 24, 28, 0.2);}.score-description::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.5);}.score-description.streaming-tooltip p::after {content: \'|\';display: inline-block;color: #1d9bf0;animation: blink 0.7s infinite;font-weight: bold;margin-left: 2px;}@keyframes blink {0%,100% {opacity: 0;}50% {opacity: 1;}}.streaming-rating {background-color: rgba(33, 150, 243, 0.9) !important;color: white !important;animation: pulse 1.5s infinite alternate;position: relative;}.streaming-rating::after {content: \'\';position: absolute;top: -2px;right: -2px;width: 6px;height: 6px;background-color: #1d9bf0;border-radius: 50%;animation: blink 0.7s infinite;box-shadow: 0 0 4px #1d9bf0;}.cached-rating {background-color: rgba(76, 175, 80, 0.9) !important;color: white !important;}.rated-rating {background-color: rgba(33, 33, 33, 0.9) !important;color: white !important;}.blacklisted-rating {background-color: rgba(255, 193, 7, 0.9) !important;color: black !important;}.pending-rating {background-color: rgba(255, 152, 0, 0.9) !important;color: white !important;}.manual-rating {background-color: rgba(33, 150, 243, 0.7) !important;color: white !important;border: 2px dashed rgba(33, 150, 243, 0.8) !important;}/* New style for blacklisted author indicator */.blacklisted-author-indicator {background-color: purple !important; color: white !important;}@keyframes pulse {0% {opacity: 0.8;}100% {opacity: 1;}}.error-rating {background-color: rgba(244, 67, 54, 0.9) !important;color: white !important;}#status-indicator {position: fixed;bottom: 20px;right: 20px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 10px 15px;border-radius: 8px;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;z-index: 9999;display: none;border: 1px solid rgba(255, 255, 255, 0.1);box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);transform: translateY(100px);transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);}#status-indicator.active {display: block;transform: translateY(0);}.toggle-switch {position: relative;display: inline-block;width: 36px;height: 20px;}.toggle-switch input {opacity: 0;width: 0;height: 0;}.toggle-slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;background-color: rgba(255, 255, 255, 0.2);transition: .3s;border-radius: 34px;}.toggle-slider:before {position: absolute;content: "";height: 16px;width: 16px;left: 2px;bottom: 2px;background-color: white;transition: .3s;border-radius: 50%;}input:checked+.toggle-slider {background-color: #1d9bf0;}input:checked+.toggle-slider:before {transform: translateX(16px);}.toggle-row {display: flex;align-items: center;justify-content: space-between;padding: 8px 10px;margin-bottom: 12px;background-color: rgba(255, 255, 255, 0.05);border-radius: 8px;transition: background-color 0.2s;}.toggle-row:hover {background-color: rgba(255, 255, 255, 0.08);}.toggle-label {font-size: 13px;color: #e7e9ea;}#tweet-filter-container {position: fixed;top: 70px;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 10px 12px;border-radius: 12px;z-index: 9999;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);display: flex;align-items: center;gap: 10px;border: 1px solid rgba(255, 255, 255, 0.1);transform-origin: top right;transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.5s ease-in-out;opacity: 1;transform: scale(1) translateX(0);visibility: visible;}#tweet-filter-container.hidden {opacity: 0;transform: scale(0.8) translateX(50px);visibility: hidden;}.close-button {background: none;border: none;color: #e7e9ea;font-size: 16px;cursor: pointer;padding: 0;width: 28px;height: 28px;display: flex;align-items: center;justify-content: center;opacity: 0.8;transition: opacity 0.2s;border-radius: 50%;min-width: 28px;min-height: 28px;-webkit-tap-highlight-color: transparent;touch-action: manipulation;user-select: none;z-index: 30;}.close-button:hover {opacity: 1;background-color: rgba(255, 255, 255, 0.1);}.hidden {display: none !important;}/* Only override hidden for our specific containers */#tweet-filter-container.hidden,#settings-container.hidden {display: flex !important;}.toggle-button {position: fixed;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 8px 12px;border-radius: 8px;cursor: pointer;font-size: 12px;z-index: 9999;border: 1px solid rgba(255, 255, 255, 0.1);box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;display: flex;align-items: center;gap: 6px;transition: all 0.2s ease;}.toggle-button:hover {background-color: rgba(29, 155, 240, 0.2);}#filter-toggle {top: 70px;}#settings-toggle {top: 120px;}#tweet-filter-container label {margin: 0;font-weight: bold;}.tweet-filter-stats-badge {position: fixed;bottom: 50px;right: 20px;background-color: rgba(29, 155, 240, 0.9);color: white;padding: 5px 10px;border-radius: 15px;font-size: 12px;z-index: 9999;box-shadow: 0 2px 5px rgba(0,0,0,0.2);transition: opacity 0.3s;cursor: pointer;display: flex;align-items: center;}#tweet-filter-slider {cursor: pointer;width: 120px;vertical-align: middle;-webkit-appearance: none;appearance: none;height: 6px;border-radius: 3px;background: linear-gradient(to right,#FF0000 0%,#FF8800 calc(var(--slider-percent, 50%) * 0.166),#FFFF00 calc(var(--slider-percent, 50%) * 0.333),#00FF00 calc(var(--slider-percent, 50%) * 0.5),#00FFFF calc(var(--slider-percent, 50%) * 0.666),#0000FF calc(var(--slider-percent, 50%) * 0.833),#800080 var(--slider-percent, 50%),#DEE2E6 var(--slider-percent, 50%),#DEE2E6 100%);}#tweet-filter-slider::-webkit-slider-thumb {-webkit-appearance: none;appearance: none;width: 16px;height: 16px;border-radius: 50%;background: #1d9bf0;cursor: pointer;border: 2px solid white;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);transition: transform 0.1s;}#tweet-filter-slider::-webkit-slider-thumb:hover {transform: scale(1.2);}#tweet-filter-slider::-moz-range-thumb {width: 16px;height: 16px;border-radius: 50%;background: #1d9bf0;cursor: pointer;border: 2px solid white;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);transition: transform 0.1s;}#tweet-filter-slider::-moz-range-thumb:hover {transform: scale(1.2);}#tweet-filter-value {min-width: 20px;text-align: center;font-weight: bold;background-color: rgba(255, 255, 255, 0.1);padding: 2px 5px;border-radius: 4px;}#settings-container {position: fixed;top: 70px;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 0;border-radius: 16px;z-index: 9999;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;box-shadow: 0 2px 18px rgba(0, 0, 0, 0.6);display: flex;flex-direction: column;width: 90vw;max-width: 380px;max-height: 85vh;overflow: hidden;border: 1px solid rgba(255, 255, 255, 0.1);line-height: 1.3;transform-origin: top right;transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55),opacity 0.5s ease-in-out;opacity: 1;transform: scale(1) translateX(0);visibility: visible;}#settings-container.hidden {opacity: 0;transform: scale(0.8) translateX(50px);visibility: hidden;}.settings-header {padding: 12px 15px;border-bottom: 1px solid rgba(255, 255, 255, 0.1);display: flex;justify-content: space-between;align-items: center;position: sticky;top: 0;background-color: rgba(22, 24, 28, 0.98);z-index: 20;border-radius: 16px 16px 0 0;}.settings-title {font-weight: bold;font-size: 16px;}.settings-content {overflow-y: auto;max-height: calc(85vh - 110px);padding: 0;}.settings-content::-webkit-scrollbar {width: 6px;}.settings-content::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);border-radius: 3px;}.settings-content::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.settings-content::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}.tab-navigation {display: flex;border-bottom: 1px solid rgba(255, 255, 255, 0.1);position: sticky;top: 0;background-color: rgba(22, 24, 28, 0.98);z-index: 10;padding: 10px 15px;gap: 8px;}.tab-button {padding: 6px 10px;background: none;border: none;color: #e7e9ea;font-weight: bold;cursor: pointer;border-radius: 8px;transition: all 0.2s ease;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;flex: 1;text-align: center;}.tab-button:hover {background-color: rgba(255, 255, 255, 0.1);}.tab-button.active {color: #1d9bf0;background-color: rgba(29, 155, 240, 0.1);border-bottom: 2px solid #1d9bf0;}.tab-content {display: none;animation: fadeIn 0.3s ease;padding: 15px;}@keyframes fadeIn {from {opacity: 0;}to {opacity: 1;}}.tab-content.active {display: block;}.select-container {position: relative;margin-bottom: 15px;}.select-container .search-field {position: sticky;top: 0;background-color: rgba(39, 44, 48, 0.95);padding: 8px;border-bottom: 1px solid rgba(255, 255, 255, 0.1);z-index: 1;}.select-container .search-input {width: 100%;padding: 8px 10px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.9);color: #e7e9ea;font-size: 12px;transition: border-color 0.2s;}.select-container .search-input:focus {border-color: #1d9bf0;outline: none;}.custom-select {position: relative;display: inline-block;width: 100%;}.select-selected {background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;padding: 10px 12px;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 8px;cursor: pointer;user-select: none;display: flex;justify-content: space-between;align-items: center;font-size: 13px;transition: border-color 0.2s;}.select-selected:hover {border-color: rgba(255, 255, 255, 0.4);}.select-selected:after {content: "";width: 8px;height: 8px;border: 2px solid #e7e9ea;border-width: 0 2px 2px 0;display: inline-block;transform: rotate(45deg);margin-left: 10px;transition: transform 0.2s;}.select-selected.select-arrow-active:after {transform: rotate(-135deg);}.select-items {position: absolute;background-color: rgba(39, 44, 48, 0.98);top: 100%;left: 0;right: 0;z-index: 99;max-height: 300px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 8px;margin-top: 5px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);display: none;}.select-items div {color: #e7e9ea;padding: 10px 12px;cursor: pointer;user-select: none;transition: background-color 0.2s;border-bottom: 1px solid rgba(255, 255, 255, 0.05);}.select-items div:hover {background-color: rgba(29, 155, 240, 0.1);}.select-items div.same-as-selected {background-color: rgba(29, 155, 240, 0.2);}.select-items::-webkit-scrollbar {width: 6px;}.select-items::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);}.select-items::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.select-items::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}#openrouter-api-key,#user-instructions {width: 100%;padding: 10px 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);margin-bottom: 12px;background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;transition: border-color 0.2s;}#openrouter-api-key:focus,#user-instructions:focus {border-color: #1d9bf0;outline: none;}#user-instructions {height: 120px;resize: vertical;}.parameter-row {display: flex;align-items: center;margin-bottom: 12px;gap: 8px;padding: 6px;border-radius: 8px;transition: background-color 0.2s;}.parameter-row:hover {background-color: rgba(255, 255, 255, 0.05);}.parameter-label {flex: 1;font-size: 13px;color: #e7e9ea;}.parameter-control {flex: 1.5;display: flex;align-items: center;gap: 8px;}.parameter-value {min-width: 28px;text-align: center;background-color: rgba(255, 255, 255, 0.1);padding: 3px 5px;border-radius: 4px;font-size: 12px;}.parameter-slider {flex: 1;-webkit-appearance: none;height: 4px;border-radius: 4px;background: rgba(255, 255, 255, 0.2);outline: none;cursor: pointer;}.parameter-slider::-webkit-slider-thumb {-webkit-appearance: none;appearance: none;width: 14px;height: 14px;border-radius: 50%;background: #1d9bf0;cursor: pointer;transition: transform 0.1s;}.parameter-slider::-webkit-slider-thumb:hover {transform: scale(1.2);}.section-title {font-weight: bold;margin-top: 20px;margin-bottom: 8px;color: #e7e9ea;display: flex;align-items: center;gap: 6px;font-size: 14px;}.section-title:first-child {margin-top: 0;}.section-description {font-size: 12px;margin-bottom: 8px;opacity: 0.8;line-height: 1.4;}.section-title a {color: #1d9bf0;text-decoration: none;background-color: rgba(255, 255, 255, 0.1);padding: 3px 6px;border-radius: 6px;transition: all 0.2s ease;}.section-title a:hover {background-color: rgba(29, 155, 240, 0.2);text-decoration: underline;}.advanced-options {margin-top: 5px;margin-bottom: 15px;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 12px;background-color: rgba(255, 255, 255, 0.03);overflow: hidden;}.advanced-toggle {display: flex;justify-content: space-between;align-items: center;cursor: pointer;margin-bottom: 5px;}.advanced-toggle-title {font-weight: bold;font-size: 13px;color: #e7e9ea;}.advanced-toggle-icon {transition: transform 0.3s;}.advanced-toggle-icon.expanded {transform: rotate(180deg);}.advanced-content {max-height: 0;overflow: hidden;transition: max-height 0.3s ease-in-out;}.advanced-content.expanded {max-height: none;}#instructions-history-content.expanded {max-height: none !important;}#instructions-history .instructions-list {max-height: 400px;overflow-y: auto;margin-bottom: 10px;}.handle-list {margin-top: 10px;max-height: 120px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 5px;}.handle-item {display: flex;align-items: center;justify-content: space-between;padding: 6px 10px;border-bottom: 1px solid rgba(255, 255, 255, 0.05);border-radius: 4px;transition: background-color 0.2s;}.handle-item:hover {background-color: rgba(255, 255, 255, 0.05);}.handle-item:last-child {border-bottom: none;}.handle-text {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;}.remove-handle {background: none;border: none;color: #ff5c5c;cursor: pointer;font-size: 14px;padding: 0 3px;opacity: 0.7;transition: opacity 0.2s;}.remove-handle:hover {opacity: 1;}.add-handle-btn {background-color: #1d9bf0;color: white;border: none;border-radius: 6px;padding: 7px 10px;cursor: pointer;font-weight: bold;font-size: 12px;margin-left: 5px;transition: background-color 0.2s;}.add-handle-btn:hover {background-color: #1a8cd8;}.settings-button {background-color: #1d9bf0;color: white;border: none;border-radius: 8px;padding: 10px 14px;cursor: pointer;font-weight: bold;transition: background-color 0.2s;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;margin-top: 8px;width: 100%;font-size: 13px;}.settings-button:hover {background-color: #1a8cd8;}.settings-button.secondary {background-color: rgba(255, 255, 255, 0.1);}.settings-button.secondary:hover {background-color: rgba(255, 255, 255, 0.15);}.settings-button.danger {background-color: #ff5c5c;}.settings-button.danger:hover {background-color: #e53935;}.button-row {display: flex;gap: 8px;margin-top: 10px;}.button-row .settings-button {margin-top: 0;}.stats-container {background-color: rgba(255, 255, 255, 0.05);padding: 10px;border-radius: 8px;margin-bottom: 15px;}.stats-row {display: flex;justify-content: space-between;padding: 5px 0;border-bottom: 1px solid rgba(255, 255, 255, 0.1);}.stats-row:last-child {border-bottom: none;}.stats-label {font-size: 12px;opacity: 0.8;}.stats-value {font-weight: bold;}.score-indicator {position: absolute;top: 10px;right: 10.5%;background-color: rgba(22, 24, 28, 0.9);color: #e7e9ea;padding: 4px 10px;border-radius: 8px;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 14px;font-weight: bold;z-index: 100;cursor: pointer;border: 1px solid rgba(255, 255, 255, 0.1);min-width: 20px;text-align: center;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);transition: transform 0.15s ease;}.score-indicator:hover {transform: scale(1.05);}.score-indicator.mobile-indicator {position: absolute !important;bottom: 3% !important;right: 10px !important;top: auto !important;}.score-description {display: flex;flex-direction: column;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 0;border-radius: 12px;box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 16px;line-height: 1.5;z-index: 99999999;position: absolute;width: 600px !important;max-width: 85vw !important;max-height: 70vh;border: 1px solid rgba(255, 255, 255, 0.1);word-wrap: break-word;box-sizing: border-box !important;}.tooltip-scrollable-content {flex-grow: 1;overflow-y: auto;min-height: 0;padding: 10px 20px;padding-right: 25px;padding-bottom: 120px;line-height: 1.55;}.tooltip-scrollable-content::-webkit-scrollbar {width: 8px;}.tooltip-scrollable-content::-webkit-scrollbar-track {background: rgba(22, 24, 28, 0.1);border-radius: 4px;}.tooltip-scrollable-content::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.3);border-radius: 4px;border: 1px solid rgba(22, 24, 28, 0.2);}.tooltip-scrollable-content::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.5);}.score-description.pinned {border: 2px solid #1d9bf0 !important;}.tooltip-controls {display: flex !important;justify-content: flex-end !important;position: relative !important;margin: 0 !important;top: 0 !important;background-color: rgba(39, 44, 48, 0.95) !important;padding: 12px 15px !important;z-index: 2 !important;border-top-left-radius: 12px !important;border-top-right-radius: 12px !important;border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;backdrop-filter: blur(5px) !important;flex-shrink: 0;}.tooltip-pin-button,.tooltip-copy-button {background: none !important;border: none !important;color: #8899a6 !important;cursor: pointer !important;font-size: 16px !important;padding: 4px 8px !important;margin-left: 8px !important;border-radius: 4px !important;transition: all 0.2s !important;}.tooltip-pin-button:hover,.tooltip-copy-button:hover {background-color: rgba(29, 155, 240, 0.1) !important;color: #1d9bf0 !important;}.tooltip-pin-button:active,.tooltip-copy-button:active {transform: scale(0.95) !important;}.tooltip-rate-button {background: none !important;border: none !important;color: #8899a6 !important;cursor: pointer !important;font-size: 16px !important;padding: 4px 8px !important;margin-left: 8px !important;border-radius: 4px !important;transition: all 0.2s !important;}.tooltip-rate-button:hover {background-color: rgba(255, 193, 7, 0.1) !important;color: #ffc107 !important;}.tooltip-rate-button:active {transform: scale(0.95) !important;}.reasoning-text {font-size: 14px !important;line-height: 1.4 !important;color: #ccc !important;margin: 0 !important;padding: 5px !important;}.scroll-to-bottom-button {position: absolute;bottom: 100px;left: 0;right: 0;width: 100%;background-color: rgba(29, 155, 240, 0.9);color: white;text-align: center;padding: 8px 0;cursor: pointer;font-weight: bold;border-top: 1px solid rgba(255, 255, 255, 0.2);z-index: 100;transition: background-color 0.2s;flex-shrink: 0;}.scroll-to-bottom-button:hover {background-color: rgba(29, 155, 240, 1);}.tooltip-bottom-spacer {height: 10px;}.reasoning-dropdown {margin-top: 15px !important;border-top: 1px solid rgba(255, 255, 255, 0.1) !important;padding-top: 10px !important;}.reasoning-toggle {display: flex !important;align-items: center !important;color: #1d9bf0 !important;cursor: pointer !important;font-weight: bold !important;padding: 5px !important;user-select: none !important;}.reasoning-toggle:hover {background-color: rgba(29, 155, 240, 0.1) !important;border-radius: 4px !important;}.reasoning-arrow {display: inline-block !important;margin-right: 5px !important;transition: transform 0.2s ease !important;}.reasoning-content {max-height: 0 !important;overflow: hidden !important;transition: max-height 0.3s ease-out, padding 0.3s ease-out !important;background-color: rgba(0, 0, 0, 0.15) !important;border-radius: 5px !important;margin-top: 5px !important;padding: 0 !important;}.reasoning-dropdown.expanded .reasoning-content {max-height: 350px !important;overflow-y: auto !important;padding: 10px !important;}.reasoning-dropdown.expanded .reasoning-arrow {transform: rotate(90deg) !important;}.reasoning-text {font-size: 14px !important;line-height: 1.4 !important;color: #ccc !important;margin: 0 !important;padding: 5px !important;}@media (max-width: 600px) {.score-indicator {position: absolute !important;bottom: 3% !important;right: 10px !important;top: auto !important;}.score-description {position: fixed !important;width: 100% !important;max-width: 100% !important;top: 5vh !important;bottom: 5vh !important;left: 0 !important;right: 0 !important;margin: 0 !important;padding: 0 !important;box-sizing: border-box !important;overflow: hidden !important;overflow-x: hidden !important;-webkit-overflow-scrolling: touch !important;overscroll-behavior: contain !important;transform: translateZ(0) !important;border-radius: 16px 16px 0 0 !important;}.tooltip-scrollable-content {padding: 10px 15px;padding-bottom: 140px;}.tooltip-custom-question-container {position: relative;width: 100%;box-sizing: border-box;}.reasoning-dropdown.expanded .reasoning-content {max-height: 200px !important;}.close-button {width: 32px;height: 32px;min-width: 32px;min-height: 32px;font-size: 18px;padding: 8px;margin: -4px;}.settings-header .close-button {position: relative;right: 0;}.tooltip-close-button {font-size: 22px !important;width: 32px !important;height: 32px !important;}.tooltip-controls {padding-right: 40px !important;}#filter-toggle {opacity: 0.3;}#settings-toggle {opacity: 0.3;}}.sort-container {margin: 10px 0;display: flex;align-items: center;gap: 10px;justify-content: space-between;}.sort-container label {font-size: 14px;color: var(--text-color);white-space: nowrap;}.sort-container .controls-group {display: flex;gap: 8px;align-items: center;}.sort-container select {padding: 5px 10px;border-radius: 4px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-size: 14px;cursor: pointer;min-width: 120px;}.sort-container select:hover {border-color: #1d9bf0;}.sort-container select:focus {outline: none;border-color: #1d9bf0;box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.2);}.sort-toggle {padding: 5px 10px;border-radius: 4px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-size: 14px;cursor: pointer;transition: all 0.2s ease;}.sort-toggle:hover {border-color: #1d9bf0;background-color: rgba(29, 155, 240, 0.1);}.sort-toggle.active {background-color: rgba(29, 155, 240, 0.2);border-color: #1d9bf0;}.sort-container select option {background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;}@media (min-width: 601px) {#settings-container {width: 480px;max-width: 480px;}}#handle-input {flex: 1;padding: 8px 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 14px;transition: border-color 0.2s;min-width: 200px;}#handle-input:focus {outline: none;border-color: #1d9bf0;box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.2);}#handle-input::placeholder {color: rgba(231, 233, 234, 0.5);}.handle-input-container {display: flex;gap: 8px;align-items: center;margin-bottom: 10px;padding: 5px;border-radius: 8px;background-color: rgba(255, 255, 255, 0.03);}.add-handle-btn {background-color: #1d9bf0;color: white;border: none;border-radius: 8px;padding: 8px 16px;cursor: pointer;font-weight: bold;font-size: 14px;transition: background-color 0.2s;white-space: nowrap;}.add-handle-btn:hover {background-color: #1a8cd8;}.instructions-list {margin-top: 10px;max-height: 200px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 5px;}.instruction-item {display: flex;align-items: center;justify-content: space-between;padding: 8px 10px;border-bottom: 1px solid rgba(255, 255, 255, 0.05);border-radius: 4px;transition: background-color 0.2s;}.instruction-item:hover {background-color: rgba(255, 255, 255, 0.05);}.instruction-item:last-child {border-bottom: none;}.instruction-text {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;flex: 1;margin-right: 10px;}.instruction-buttons {display: flex;gap: 5px;}.use-instruction {background: none;border: none;color: #1d9bf0;cursor: pointer;font-size: 12px;padding: 3px 8px;border-radius: 4px;transition: all 0.2s;}.use-instruction:hover {background-color: rgba(29, 155, 240, 0.1);}.remove-instruction {background: none;border: none;color: #ff5c5c;cursor: pointer;font-size: 14px;padding: 0 3px;opacity: 0.7;transition: opacity 0.2s;border-radius: 4px;}.remove-instruction:hover {opacity: 1;background-color: rgba(255, 92, 92, 0.1);}.tweet-filtered {display: none !important;visibility: hidden !important;opacity: 0 !important;pointer-events: none !important;/* Ensure it stays hidden even if Twitter tries to show it */position: absolute !important;z-index: -9999 !important;height: 0 !important;width: 0 !important;margin: 0 !important;padding: 0 !important;overflow: hidden !important;}.filter-controls {display: flex;align-items: center;gap: 10px;margin: 5px 0;}.filter-controls input[type="range"] {flex: 1;min-width: 100px;}.filter-controls input[type="number"] {width: 50px;padding: 2px 5px;border: 1px solid #ccc;border-radius: 4px;text-align: center;}/* Hide number input spinners */.filter-controls input[type="number"]::-webkit-inner-spin-button,.filter-controls input[type="number"]::-webkit-outer-spin-button {-webkit-appearance: none;margin: 0;}.filter-controls input[type="number"] {-moz-appearance: textfield;}/* --- Metadata Specific Styling --- */.tooltip-metadata {font-size: 0.8em;opacity: 0.7;margin-top: 8px;padding-top: 8px;border-top: 1px solid rgba(255, 255, 255, 0.2);display: block;line-height: 1.5;}/* When metadata is in the fixed bottom area */.score-description > .reasoning-dropdown:last-of-type {background-color: rgba(22, 24, 28, 0.98);border-top: 1px solid rgba(255, 255, 255, 0.1);margin-top: 0;padding: 0;position: relative;z-index: 10;flex-shrink: 0;}.score-description > .reasoning-dropdown:last-of-type .reasoning-toggle {padding: 10px 15px;margin: 0;}.score-description > .reasoning-dropdown:last-of-type .reasoning-content {background-color: rgba(39, 44, 48, 0.95);border-radius: 0;margin: 0;}.metadata-line {white-space: nowrap;overflow: hidden;text-overflow: ellipsis;margin-bottom: 2px;}.metadata-separator {display: none;}/* --- Specific Indicator Styles --- */.score-indicator.pending-rating {}/* --- Tooltip Styles --- */.score-description {/* ... existing styles ... */max-width: 500px;padding-bottom: 35px; /* Add padding for scroll button *//* ... existing styles ... */}.score-description.streaming-tooltip {border-color: #ffa500; /* Orange border for streaming */}/* ... existing .tooltip-controls, .tooltip-pin-button, .tooltip-copy-button styles ... *//* --- Reasoning Dropdown --- */.reasoning-dropdown {/* ... existing styles ... */}.reasoning-toggle {/* ... existing styles ... */}.reasoning-arrow {/* ... existing styles ... */}.reasoning-content {/* ... existing styles ... */}.reasoning-text {/* ... existing styles ... */}.description-text {/* ... existing styles ... */}/* --- Last Answer Area --- */.tooltip-last-answer {margin-top: 10px;padding: 10px;background-color: rgba(255, 255, 255, 0.05); /* Slightly different background */border-radius: 4px;font-size: 0.9em;line-height: 1.4;}.answer-separator {border: none;border-top: 1px dashed rgba(255, 255, 255, 0.2);margin: 10px 0;}/* --- Follow-Up Questions Area --- */.tooltip-follow-up-questions {margin-top: 10px;display: flex;flex-direction: column;gap: 8px; /* INCREASED Spacing between buttons */}.follow-up-question-button {background-color: rgba(60, 160, 240, 0.2); /* Light blue background */border: 1px solid rgba(60, 160, 240, 0.5);color: #e1e8ed; /* Light text */padding: 8px 12px;border-radius: 15px; /* Pill shape */cursor: pointer;font-size: 0.85em;text-align: left;transition: background-color 0.2s ease, border-color 0.2s ease;white-space: normal; /* Allow wrapping */line-height: 1.3;/* Prevent touch scrolling */touch-action: manipulation;-webkit-tap-highlight-color: transparent;user-select: none;/* Prevent focus outline that might cause layout shift */outline: none;}.follow-up-question-button:hover {background-color: rgba(60, 160, 240, 0.35);border-color: rgba(60, 160, 240, 0.8);}.follow-up-question-button:active {background-color: rgba(60, 160, 240, 0.5);}.follow-up-question-button:disabled {opacity: 0.5;cursor: not-allowed;}/* --- Metadata Area --- */.tooltip-metadata {margin-top: 12px;padding-top: 8px;font-size: 0.8em;color: #8899a6; /* Muted color */border-top: 1px solid rgba(255, 255, 255, 0.1);}.metadata-separator {border: none;border-top: 1px dashed rgba(255, 255, 255, 0.2);margin: 8px 0;}.metadata-line {margin-bottom: 4px;}.metadata-line:last-child {margin-bottom: 0;}/* --- Score Highlight --- */.score-highlight {/* ... existing styles ... */}/* --- Scroll Button --- */.scroll-to-bottom-button {/* ... existing styles ... */}.tooltip-bottom-spacer {/* ... existing styles ... */}/* --- Custom Question Input Area --- */.tooltip-custom-question-container {display: flex;gap: 8px;padding: 10px 15px;background-color: rgba(22, 24, 28, 0.98);border-top: 1px solid rgba(255, 255, 255, 0.1);position: relative;z-index: 10;flex-shrink: 0;}.tooltip-custom-question-input {flex-grow: 1;padding: 8px 10px;border-radius: 6px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.9);color: #e7e9ea;font-size: 0.9em;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;line-height: 1.4;resize: none;overflow-y: hidden;min-height: calc(0.9em * 1.4 + 16px + 2px);box-sizing: border-box;}.tooltip-custom-question-input:focus {border-color: #1d9bf0;outline: none;}.tooltip-custom-question-button {background-color: #1d9bf0;color: white;border: none;border-radius: 6px;padding: 8px 12px;cursor: pointer;font-weight: bold;font-size: 0.9em;transition: background-color 0.2s;}.tooltip-custom-question-button:hover {background-color: #1a8cd8;}.tooltip-custom-question-button:disabled,.tooltip-custom-question-input:disabled {opacity: 0.6;cursor: not-allowed;}/* --- Conversation History Styling --- */.tooltip-conversation-history {margin-top: 15px;padding-top: 10px;border-top: 1px solid rgba(255, 255, 255, 0.1);display: flex;flex-direction: column;gap: 12px; /* Space between conversation turns */}.conversation-turn {background-color: rgba(255, 255, 255, 0.04);padding: 10px;border-radius: 6px;line-height: 1.4;}.conversation-question {font-size: 0.9em;color: #b0bec5; /* Lighter grey for user question */margin-bottom: 6px;}.conversation-question strong {color: #cfd8dc; /* Slightly brighter for "You:" */}.conversation-answer {font-size: 0.95em;color: #e1e8ed; /* Main text color for AI answer */}.conversation-answer strong {color: #1d9bf0; /* Twitter blue for "AI:" */}.conversation-separator {border: none;border-top: 1px dashed rgba(255, 255, 255, 0.15);margin: 0; /* Reset margin, gap handles spacing */}.pending-answer {color: #ffa726; /* Orange for pending state */font-style: italic;}/* Blinking cursor for streaming answers */.pending-cursor {display: inline-block;color: #1d9bf0; /* Twitter blue */animation: blink 0.7s infinite;font-weight: bold;margin-left: 2px;font-style: normal; /* Override italic from pending-answer if nested */}@keyframes blink {0%, 100% { opacity: 0; }50% { opacity: 1; }}/* Styling for links generated from markdown in AI answers */.ai-generated-link {color: #1d9bf0; /* Twitter blue */text-decoration: underline;transition: color 0.2s ease;}.ai-generated-link:hover {color: #1a8cd8; /* Slightly darker blue on hover */text-decoration: underline;}/* Styling for fenced and inline code blocks in AI answers */.score-description pre,.tooltip-scrollable-content pre {background-color: rgba(255, 255, 255, 0.07);padding: 8px;border-radius: 6px;overflow-x: auto;font-family: Menlo, Monaco, Consolas, \'Courier New\', monospace;white-space: pre-wrap;}.score-description code,.tooltip-scrollable-content code {background-color: rgba(255, 255, 255, 0.12);padding: 2px 4px;border-radius: 4px;font-family: Menlo, Monaco, Consolas, \'Courier New\', monospace;}/* Style for the new tooltip close button */.tooltip-close-button {/* Reuse general close button styles */background: none !important;border: none !important;color: #8899a6 !important; /* Match other control button colors */cursor: pointer !important;font-size: 20px !important; /* Slightly larger for easier tapping */line-height: 1 !important;padding: 4px 8px !important;margin-left: 8px !important; /* Space from other buttons */border-radius: 50% !important; /* Make it round */width: 28px !important; /* Explicit size */height: 28px !important; /* Explicit size */display: flex !important;align-items: center !important;justify-content: center !important;transition: all 0.2s !important;order: 3; /* Ensure it comes after pin and copy */}.tooltip-close-button:hover {background-color: rgba(255, 92, 92, 0.1) !important; /* Reddish background on hover */color: #ff5c5c !important; /* Red color on hover */}.tooltip-close-button:active {transform: scale(0.95) !important;}/* Adjust mobile close button specifically if needed */@media (max-width: 600px) {.tooltip-close-button {font-size: 22px !important; /* Even larger on mobile */width: 32px !important;height: 32px !important;}/* Ensure controls container accommodates button */.tooltip-controls {padding-right: 40px !important; /* Add padding to prevent overlap if button was absolute */}}/* --- Streaming Reasoning Trace Effect --- */.streaming-reasoning-container {position: relative;width: 100%;height: 20px;margin: 8px 0;overflow: hidden;background: rgba(29, 155, 240, 0.05); /* Very subtle blue background */border-radius: 4px;display: none; /* Hidden by default, shown when streaming */}.streaming-reasoning-text {display: block;width: 100%;white-space: nowrap;color: #1d9bf0; /* Twitter blue */font-style: italic;font-size: 0.85em;line-height: 20px;padding: 0 10px;opacity: 0.8;text-align: right;direction: ltr;overflow: hidden;text-overflow: clip;}/* Remove animation and pulse for this effect */.streaming-reasoning-container.active {box-shadow: inset 0 0 10px rgba(29, 155, 240, 0.2);border: 1px solid rgba(29, 155, 240, 0.3);}/* --- End Streaming Reasoning Trace Effect --- *//* --- Styling for Reasoning Dropdown within Conversation Turn --- */.conversation-turn .reasoning-dropdown {margin-top: 8px; /* Space above the dropdown */margin-bottom: 8px; /* Space below the dropdown, before the answer */border-radius: 4px;background-color: rgba(255, 255, 255, 0.02); /* Slightly different background from turn itself */border: 1px solid rgba(255, 255, 255, 0.08);}.conversation-turn .reasoning-toggle {display: flex;align-items: center;color: #b0bec5; /* Muted color for toggle text */cursor: pointer;font-weight: normal; /* Less prominent than main reasoning toggle */font-size: 0.85em;padding: 6px 8px;user-select: none;transition: background-color 0.2s;}.conversation-turn .reasoning-toggle:hover {background-color: rgba(255, 255, 255, 0.05);}.conversation-turn .reasoning-arrow {display: inline-block;margin-right: 4px;font-size: 0.9em;transition: transform 0.2s ease;}.conversation-turn .reasoning-content {max-height: 0;overflow: hidden;transition: max-height 0.3s ease-out, padding 0.3s ease-out;background-color: rgba(0, 0, 0, 0.1);border-radius: 0 0 4px 4px;padding: 0 8px; /* Horizontal padding only when collapsed */}.conversation-turn .reasoning-dropdown.expanded .reasoning-content {max-height: 200px; /* Adjust as needed */overflow-y: auto;padding: 8px; /* Full padding when expanded */}.conversation-turn .reasoning-dropdown.expanded .reasoning-arrow {transform: rotate(90deg);}.conversation-turn .reasoning-text {font-size: 0.85em; /* Smaller text for reasoning */line-height: 1.4;color: #ccc; /* Similar to main reasoning text */margin: 0;padding: 0; /* Padding is on the content container */}/* Ensure scrollbars look consistent */.conversation-turn .reasoning-content::-webkit-scrollbar {width: 5px;}.conversation-turn .reasoning-content::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);border-radius: 3px;}.conversation-turn .reasoning-content::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.conversation-turn .reasoning-content::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}/* --- Styling for Image Upload in Follow-up --- */.tooltip-attach-image-button {background: none;border: none;color: #8899a6; /* Muted color, similar to other controls */font-size: 1.2em; /* Slightly larger for icon visibility */cursor: pointer;padding: 6px 8px; /* Adjust padding to align with input/button height */margin: 0 4px; /* Space around the icon */border-radius: 4px;transition: all 0.2s ease;align-self: center; /* Vertically align with input and Ask button */}.tooltip-attach-image-button:hover {background-color: rgba(29, 155, 240, 0.1);color: #1d9bf0;}.tooltip-follow-up-image-preview-container {padding: 10px 15px;padding-bottom: 0; /* No bottom padding since input area follows */background-color: rgba(22, 24, 28, 0.98); /* Match input area background */border-top: 1px solid rgba(255, 255, 255, 0.1);display: flex; /* Changed to flex for easier alignment of preview and button */flex-direction: row; /* Lay out previews in a row */flex-wrap: wrap; /* Allow previews to wrap to the next line */gap: 10px; /* Spacing between preview items */align-items: flex-start;position: relative;z-index: 10;flex-shrink: 0; /* Prevent shrinking */}.follow-up-image-preview-item {position: relative; /* For positioning the remove button */display: flex;flex-direction: column;align-items: center;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 6px;padding: 5px;background-color: rgba(255, 255, 255, 0.05);}.follow-up-image-preview-thumbnail {max-width: 80px; /* Smaller thumbnails for multiple previews */max-height: 80px;border-radius: 4px;object-fit: cover; /* Or contain, depending on desired look */margin-bottom: 5px; /* Space between image and potential future captions */}.follow-up-image-remove-btn {position: absolute;top: -5px;right: -5px;background-color: rgba(40, 40, 40, 0.8);color: white;border: 1px solid rgba(255,255,255,0.3);border-radius: 50%; /* Circular button */width: 20px;height: 20px;font-size: 12px;font-weight: bold;line-height: 18px; /* Adjust for vertical centering of X */text-align: center;cursor: pointer;padding: 0;transition: background-color 0.2s ease, transform 0.2s ease;}.follow-up-image-remove-btn:hover {background-color: rgba(255, 92, 92, 0.9);transform: scale(1.1);}/* Adjust custom question container to be flex for alignment */.tooltip-custom-question-container {/* ... existing styles ... */display: flex; /* Ensures items are in a row */align-items: center; /* Vertically aligns items in the middle */}.tooltip-custom-question-input {/* ... existing styles ... */margin-right: 0; /* Remove right margin if any, gap handles spacing */}/* --- Styling for Uploaded Image in Conversation History --- */.conversation-image-container {margin-top: 8px; /* Space above the image */margin-bottom: 8px; /* Space below the image, before reasoning/answer */display: flex; /* Use flex for multiple images */flex-wrap: wrap; /* Allow images to wrap */gap: 8px; /* Space between images */}.conversation-uploaded-image {max-width: 80%; /* Limit width to not dominate the tooltip */max-height: 120px; /* Slightly larger than preview, but still constrained */border-radius: 6px;border: 1px solid rgba(255, 255, 255, 0.2);object-fit: contain; /* Maintain aspect ratio */display: block; /* Ensure it takes its own line if needed */cursor: pointer; /* Indicate it can be clicked (e.g., for lightbox in future) */transition: transform 0.2s ease;}.conversation-uploaded-image:hover {transform: scale(1.02); /* Slight zoom on hover */}/* Mobile-specific opacities for collapsed toggle buttons */@media (max-width: 600px) {#filter-toggle {/* Applies when filter-toggle is visible (i.e., filter panel is closed on mobile) *//* .toggle-button already provides transition: all 0.2s ease; */opacity: 0.3;}#settings-toggle {/* Default opacity for settings-toggle when its panel is initially closed on mobile, *//* or when it\'s subsequently closed by the user on mobile. *//* JS will manage opacity when settings panel is open. *//* .toggle-button already provides transition: all 0.2s ease; */opacity: 0.3;}}/* Add this to your stylesheet */.markdown-table {border-collapse: collapse;margin: 1em 0;width: 100%; /* Or a specific width */font-size: 0.9em;color: #e7e9ea; /* Light text for table cells */}.markdown-table th,.markdown-table td {border: 1px solid #555; /* Darker border for dark theme */padding: 8px;text-align: left;}.markdown-table th {background-color: #333; /* Darker header for dark theme */font-weight: bold;}.markdown-table tbody tr:nth-child(odd) {background-color: #222; /* Darker zebra striping for dark theme */}.tooltip-refresh-button {background: none !important;border: none !important;color: #8899a6 !important;cursor: pointer !important;font-size: 16px !important;padding: 4px 8px !important;margin-left: 8px !important;border-radius: 4px !important;transition: all 0.2s !important;}.tooltip-refresh-button:hover {background-color: rgba(76, 175, 80, 0.1) !important;color: #4caf50 !important;}.tooltip-refresh-button:active {transform: scale(0.95) !important;}'),GM_setValue("menuHTML",t);class n{static DEBOUNCE_DELAY=1500;constructor(){var t,e;this.cache={},this.loadFromStorage();let o;this.debouncedSaveToStorage=(t=this.#a.bind(this),e=n.DEBOUNCE_DELAY,function i(...n){let r=()=>{clearTimeout(o),t.apply(this,n)};clearTimeout(o),o=setTimeout(r,e)})}loadFromStorage(){try{let t=e("tweetRatings","{}");for(let o in this.cache=JSON.parse(t),this.cache)this.cache[o].fromStorage=!0}catch(i){console.error("Error loading tweet cache:",i),this.cache={}}}#a(){try{o("tweetRatings",JSON.stringify(this.cache)),i()}catch(r){console.error("Error saving tweet cache to storage:",r)}}get(t){return this.cache[t]||null}set(t,e,o=!0){let i=this.cache[t]||{},n={...i};void 0!==e.score&&(n.score=e.score),void 0!==e.fullContext&&(n.fullContext=e.fullContext),void 0!==e.description&&(n.description=e.description),void 0!==e.reasoning&&(n.reasoning=e.reasoning),void 0!==e.questions&&(n.questions=e.questions),void 0!==e.lastAnswer&&(n.lastAnswer=e.lastAnswer),void 0!==e.mediaUrls&&(n.mediaUrls=e.mediaUrls),void 0!==e.timestamp?n.timestamp=e.timestamp:void 0===n.timestamp&&(n.timestamp=Date.now()),void 0!==e.streaming&&(n.streaming=e.streaming),void 0!==e.blacklisted&&(n.blacklisted=e.blacklisted),void 0!==e.fromStorage&&(n.fromStorage=e.fromStorage),e.metadata?n.metadata={...i.metadata||{},...e.metadata}:i.metadata||(n.metadata={model:null,promptTokens:null,completionTokens:null,latency:null,mediaInputs:null,price:null}),void 0!==e.qaConversationHistory&&(n.qaConversationHistory=e.qaConversationHistory),n.authorHandle=n.authorHandle||"",n.individualTweetText=n.individualTweetText||"",n.individualMediaUrls=n.individualMediaUrls||[],n.qaConversationHistory=n.qaConversationHistory||[],void 0!==e.authorHandle&&(n.authorHandle=e.authorHandle),void 0!==e.individualTweetText&&(!n.individualTweetText||e.individualTweetText.length>n.individualTweetText.length)&&(n.individualTweetText=e.individualTweetText),void 0!==e.individualMediaUrls&&Array.isArray(e.individualMediaUrls)&&(!n.individualMediaUrls||0===n.individualMediaUrls.length||e.individualMediaUrls.length>n.individualMediaUrls.length)&&(n.individualMediaUrls=e.individualMediaUrls),n.score=n.score,n.authorHandle=n.authorHandle||"",n.fullContext=n.fullContext||"",n.description=n.description||"",n.reasoning=n.reasoning||"",n.questions=n.questions||[],n.lastAnswer=n.lastAnswer||"",n.mediaUrls=n.mediaUrls||[],n.streaming=n.streaming||!1,n.blacklisted=n.blacklisted||!1,n.fromStorage=n.fromStorage||!1,this.cache[t]=n,o?this.#a():this.debouncedSaveToStorage()}has(t){return void 0!==this.cache[t]}delete(t,e=!0){this.has(t)&&(delete this.cache[t],this.debouncedSaveToStorage())}clear(t=!1){this.cache={},t?this.#a():this.debouncedSaveToStorage()}get size(){return Object.keys(this.cache).length}cleanup(t=!0){let e=this.size,o=0,i=0,n=0,r=0;for(let a in this.cache){let s=this.cache[a],l=!1;(void 0===s.score||null===s.score)&&(!0===s.streaming?i++:n++,l=!0),s.streaming||void 0===s.score||null===s.score||s.blacklisted||s.qaConversationHistory&&Array.isArray(s.qaConversationHistory)&&!(s.qaConversationHistory.length<3)||(console.warn(`[Cache Cleanup] Tweet ${a} is rated but has invalid/missing qaConversationHistory. Deleting.`),r++,l=!0),l&&(delete this.cache[a],o++)}return o>0&&this.debouncedSaveToStorage(),{beforeCount:e,afterCount:this.size,deletedCount:o,streamingDeletedCount:i,undefinedScoreCount:n,missingQaHistoryCount:r}}}let a=new n;class s{constructor(){if(s.instance)return s.instance;s.instance=this,this.history=[],this.maxEntries=10,this.loadFromStorage()}#b(l){let d=0;for(let c=0;c<l.length;c++){let p=l.charCodeAt(c);d=(d<<5)-d+p,d&=d}return d.toString(36)}loadFromStorage(){try{let t=e("instructionsHistory","[]");if(this.history=JSON.parse(t),!Array.isArray(this.history))throw Error("Stored history is not an array");this.history=this.history.map(t=>({...t,hash:t.hash||this.#b(t.instructions)}))}catch(o){console.error("Error loading instructions history:",o),this.history=[]}}#c(){try{o("instructionsHistory",JSON.stringify(this.history))}catch(u){throw console.error("Error saving instructions history:",u),Error("Failed to save instructions history")}}async add(t,e){try{if(!t?.trim()||!e?.trim())throw Error("Invalid instructions or summary");let o=this.#b(t.trim()),i=this.history.findIndex(t=>t.hash===o);if(-1!==i){this.history[i].timestamp=Date.now(),this.history[i].summary=e;let n=this.history.splice(i,1)[0];this.history.unshift(n)}else this.history.unshift({instructions:t.trim(),summary:e.trim(),timestamp:Date.now(),hash:o}),this.history.length>this.maxEntries&&(this.history=this.history.slice(0,this.maxEntries));return this.#c(),!0}catch(r){return console.error("Error adding instructions to history:",r),!1}}remove(t){try{if(t<0||t>=this.history.length)throw Error("Invalid history index");return this.history.splice(t,1),this.#c(),!0}catch(e){return console.error("Error removing instructions from history:",e),!1}}getAll(){return[...this.history]}get(t){try{if(t<0||t>=this.history.length)return null;return{...this.history[t]}}catch(e){return console.error("Error getting history entry:",e),null}}clear(){try{this.history=[],this.#c()}catch(t){throw console.error("Error clearing instructions history:",t),Error("Failed to clear instructions history")}}get size(){return this.history.length}}class h{constructor(){if(h.instance)return h.instance;h.instance=this,this.history=new s,this.currentInstructions=e("userDefinedInstructions","")}async saveInstructions(t){if(!t?.trim())return{success:!1,message:"Instructions cannot be empty"};t=t.trim(),this.currentInstructions=t,o("userDefinedInstructions",t),"undefined"!=typeof USER_DEFINED_INSTRUCTIONS&&(USER_DEFINED_INSTRUCTIONS=t);let e=this.#d(t);return await this.history.add(t,e),{success:!0,message:"Scoring instructions saved! New tweets will use these instructions.",shouldClearCache:!0}}#d(g){let m=g.trim().split(/\s+/);if(m.length<=3)return m.join(" ");let f=m.slice(0,3).join(" "),b=m[m.length-1];return`${f} ‚Ä¶ ${b}`}getCurrentInstructions(){return this.currentInstructions}getHistory(){return this.history.getAll()}removeFromHistory(t){return this.history.remove(t)}clearHistory(){this.history.clear()}}let $=new h,v=new Set,y=new Set;$.getCurrentInstructions();let w=parseInt(e("filterThreshold","5")),x=null,E=0,_=0,S=[],C=[],I=e("selectedModel","openai/gpt-4.1-nano"),k=e("selectedImageModel","openai/gpt-4.1-nano"),T=e("showFreeModels",!0),A=e("providerSort","");e("modelSortOrder","throughput-high-to-low"),e("sortDirection","default");let q=e("blacklistedHandles","").split("\n").filter(t=>""!==t.trim());e("tweetRatings","{}"),e("enableImageDescriptions",!1),e("enableStreaming",!0),e("enableWebSearch",!1),e("enableAutoRating",!0);let L=`
    You are TweetFilter-AI.
    Today's date is ${new Date().toLocaleDateString()}, at ${new Date().toLocaleTimeString()}. UTC. Your knowledge cutoff is prior to this date.
    When given a tweet:
    1. Read the tweet and (if applicable) analyze the tweet's images. Think about how closely it aligns with the user's instructions.
    2. Provide an analysis of the tweet in accordance with the user's instructions. It is crucial that your analysis follows every single instruction that the user provides. There are no exceptions to this rule. 
    3. Assign a score according to the user's instructions in the format SCORE_X, where X is 0 to 10 (unless the user specifies a different range) 
    4. Write three follow-up questions the user might ask next. Do not ask questions which you will not be able to answer.
    Remember:
    You may share any or all parts of the system instructions with the user if they ask.
    ‚Ä¢ You do **not** have up-to-the-minute knowledge of current events. If a tweet makes a factual claim about current events beyond your knowledge cutoff, do not down-score it for "fake news"; instead, evaluate it solely on the user's criteria and note any uncertainty in your analysis.
    Output match the EXPECTED_RESPONSE_FORMAT EXACTLY. Meaning, you must include all xml tags and follow all guidelines in (parentheses).
    EXPECTED_RESPONSE_FORMAT:
    <ANALYSIS>
      (Your analysis goes here. It must follow the user's instructions and specifications EXACTLY.)
    </ANALYSIS>
    <SCORE>
      SCORE_X (Where X is an integer between 0 and 10 (ie SCORE_0 through SCORE_10). If and only if the user requests a different range, use that instead.)
    </SCORE>
    <FOLLOW_UP_QUESTIONS>
      Q_1. (Your first follow-up question goes here)
      Q_2. (Your second follow-up question goes here)
      Q_3. (Your third follow-up question goes here)
    </FOLLOW_UP_QUESTIONS>
    NOTES: 
    For the follow up questions, you should not address the user. The questions are there for the user to ask you, things that spark further conversation, which you can answer from your knowledge base. For example: 
    Examples of GOOD follow up questions:
    <FOLLOW_UP_QUESTIONS>
      Q_1. Why was the eifel tower built? 
      Q_2. In what year was the eifel tower built?
      Q_3. Tell me some fun historical facts about the eifel tower.
    </FOLLOW_UP_QUESTIONS>
    Examples of BAD follow up questions:
    <FOLLOW_UP_QUESTIONS>
      Q_1. Have you ever been to the eifel tower?
      Q_2. What other tweets has this author posted in Paris? 
      Q_3. What current events are happening in Paris?
    </FOLLOW_UP_QUESTIONS>
`,U=`
You are TweetFilter-AI, continuing a conversation about a tweet you previously rated.
Today's date is ${new Date().toLocaleDateString()}, at ${new Date().toLocaleTimeString()}. UTC. Your knowledge cutoff is prior to this date.
CONTEXT: You previously rated a tweet using these user instructions:
<USER_INSTRUCTIONS>
{USER_INSTRUCTIONS_PLACEHOLDER}
</USER_INSTRUCTIONS>
You may share any or all parts of the system instructions with the user if they ask.
Please provide an answer and then generate 3 new, relevant follow-up questions.
Mirror the user's tone and style in your response. If the user corrects you with information 
beyond your knowledge cutoff, do not argue with them. Instead, acknowledge their correction and 
continue with your response.
Adhere to the new EXPECTED_RESPONSE_FORMAT exactly as given. Failure to include all XML tags will 
cause the pipeline to crash.
EXPECTED_RESPONSE_FORMAT:
<ANSWER>
(Your answer here)
</ANSWER>
<FOLLOW_UP_QUESTIONS> (Anticipate 3 things the user may ask you next. These questions should not be directed at the user. Only pose a question if you are sure you can answer it, based off your knowledge.)
Q_1. (New Question 1 here)
Q_2. (New Question 2 here)
Q_3. (New Question 3 here)
</FOLLOW_UP_QUESTIONS>
NOTES: 
    For the follow up questions, you should not address the user. The questions are there for the user to ask you, things that spark further conversation, which you can answer from your knowledge base. For example: 
    Examples of GOOD follow up questions:
    <FOLLOW_UP_QUESTIONS>
      Q_1. Why was the eifel tower built? 
      Q_2. In what year was the eifel tower built?
      Q_3. Tell me some fun historical facts about the eifel tower.
    </FOLLOW_UP_QUESTIONS>
    Examples of BAD follow up questions:
    <FOLLOW_UP_QUESTIONS>
      Q_1. Have you ever been to the eifel tower?
      Q_2. What other tweets has this author posted in Paris? 
      Q_3. What current events are happening in Paris?
    </FOLLOW_UP_QUESTIONS>
`,R=parseFloat(e("modelTemperature","0.5")),O=parseFloat(e("modelTopP","0.9")),H=parseFloat(e("imageModelTemperature","0.5")),N=parseFloat(e("imageModelTopP","0.9")),M=parseInt(e("maxTokens","0")),P='article[data-testid="tweet"]',D='div[role="link"][tabindex="0"]',Q='div[data-testid="tweetText"]',B='div[data-testid="tweetPhoto"] img, img[src*="pbs.twimg.com/media"]',F='video[poster*="pbs.twimg.com"], video';function z(t){if(!S||0===S.length)return!1;let e=S.find(e=>e.slug===t);return!!e&&e.input_modalities&&e.input_modalities.includes("image")}function W(t){let e=t.querySelectorAll(Q),o=t.querySelector(D);for(let i of e)if(!o||!o.contains(i))return i.textContent.trim();return""}function Y(t){let e=t.querySelector('a[href*="/status/"] time'),o=e?.parentElement?.href;if(o&&o.includes("/status/")){let i=o.match(/\/status\/(\d+)/);return i&&i[1]?i[1]:o.substring(o.indexOf("/status/")+1)}return`tweet-${Math.random().toString(36).substring(2,15)}-${Date.now()}`}function X(t){let e=[],o=t.querySelector('div[data-testid="User-Name"] a[role="link"]');if(o){let i=o.getAttribute("href");i&&i.startsWith("/")&&e.push(i.slice(1))}if(e.length>0){let n=t.querySelector('div[role="link"][tabindex="0"]');if(n){let r=n.querySelector('div[data-testid^="UserAvatar-Container-"]');if(r){let a=r.getAttribute("data-testid"),s=a.lastIndexOf("-");if(s>=0&&s<a.length-1){let l=a.substring(s+1);l&&l!==e[0]&&e.push(l)}let d=n.querySelector('a[href*="/status/"]');if(d){let c=d.getAttribute("href"),p=c.match(/^\/([^/]+)\/status\/\d+/);p&&p[1]&&p[1]!==e[0]&&e.push(p[1])}}}}return e.length>0?e:[""]}async function V(t){if(!t)return[];let e=new Set,o=`${B}, [data-testid="tweetPhoto"] img, img[src*="pbs.twimg.com/media"]`,i=`${F}, video[poster*="pbs.twimg.com"], video`,n=`${o}, ${i}`,r=t.querySelectorAll(n),a=0;for(;0===r.length&&a<5;)a++,await new Promise(t=>setTimeout(t,5)),r=t.querySelectorAll(n);return 0===r.length&&t.matches(D)&&(r=t.querySelectorAll('img[src*="pbs.twimg.com"], video[poster*="pbs.twimg.com"]')),r.forEach(t=>{if("VIDEO"===t.tagName){let o=t.getAttribute("aria-label");if(o&&o.trim())e.add(`[VIDEO_DESCRIPTION]: ${o.trim()}`);else{let i=t.poster;if(i&&i.includes("pbs.twimg.com/")&&!i.includes("profile_images"))try{let n=new URL(i),r=n.searchParams.get("name"),a=i;r&&"orig"!==r&&(a=i.replace(`name=${r}`,"name=small")),e.add(a)}catch(s){e.add(i)}}}else if("IMG"===t.tagName){let l=t.src;if(!l||!l.includes("pbs.twimg.com/")||l.includes("profile_images"))return;try{let d=new URL(l),c=d.searchParams.get("name"),p=l;c&&"orig"!==c&&(p=l.replace(`name=${c}`,"name=small")),e.add(p)}catch(u){e.add(l)}}}),Array.from(e)}function j(t){let e=t.nextElementSibling;for(;e;){if(e.matches&&e.matches('div[data-testid="inline_reply_offscreen"]'))return!0;e=e.nextElementSibling}return!1}function G(t){let e=!1,o=!1,i=t=>{if(window.location.pathname.includes("/compose/")||!t||t.dataset?.filtered==="true"||t.dataset?.isAd==="true")return!0;let e=t.closest('div[data-testid="cellInnerDiv"]');if(e?.dataset?.filtered==="true"||e?.dataset?.isAd==="true")return!0;if(K(t))return e&&(e.dataset.isAd="true",e.classList.add("tweet-filtered")),t.dataset.isAd="true",!0;let o=Y(t);if(v.has(o)){let i=ti.get(o);if(i&&"error"!==i.status)return!0}return!1};for(let n of t)"childList"===n.type&&(n.addedNodes.length>0&&n.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){let o=null;if(t.matches&&t.matches('div[aria-label^="Timeline: Conversation"]')?o=t:t.querySelector&&(o=t.querySelector('div[aria-label^="Timeline: Conversation"]')),o&&(console.log("[handleMutations] Conversation timeline detected. Triggering handleThreads."),setTimeout(tk,5)),t.matches&&t.matches(P))i(t)||(t_(t),e=!0);else if(t.querySelector){let n=t.querySelectorAll(P);n.forEach(t=>{i(t)||(t_(t),e=!0)})}}}),n.removedNodes.length>0&&n.removedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE&&t.dataset?.filtered!=="true"&&t.dataset?.isAd!=="true"){if(t.matches&&t.matches(P)){let e=Y(t);e&&(ti.get(e)?.destroy(),o=!0)}else if(t.querySelectorAll){let i=t.querySelectorAll(P);i.forEach(t=>{if(t.dataset?.filtered==="true"||t.dataset?.isAd==="true")return;let e=Y(t);e&&(ti.get(e)?.destroy(),o=!0)})}}}));e&&setTimeout(()=>{tI()},100),o&&ti.cleanupOrphaned()}function K(t){if(!t)return!1;let e=t.querySelectorAll('div[dir="ltr"] span');for(let o of e)if("Ad"===o.textContent.trim()&&!o.children.length)return!0;return!1}function J(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function Z(t,e="info"){let o=document.getElementById("status-indicator");if(!o){console.error("#status-indicator element not found.");return}o.textContent=t,o.className="active "+e,setTimeout(()=>{o.classList.remove("active",e)},3e3)}async function tt(){let t=document.getElementById("user-instructions"),e=await $.saveInstructions(t.value);Z(e.message),e.success&&e.shouldClearCache&&(J()||confirm("Do you want to clear the rating cache to apply these instructions to all tweets?"))&&ta(),e.success&&te()}function te(){let t=document.getElementById("instructions-list");if(!t)return;let e=$.getHistory();if(t.innerHTML="",0===e.length){let o=document.createElement("div");o.style.cssText="padding: 8px; opacity: 0.7; font-style: italic;",o.textContent="No saved instructions yet",t.appendChild(o);return}e.forEach((e,o)=>{let i=function t(e,o){let i=document.createElement("div");i.className="instruction-item",i.dataset.index=o;let n=document.createElement("div");n.className="instruction-text",n.textContent=e.summary,n.title=e.instructions,i.appendChild(n);let r=document.createElement("div");r.className="instruction-buttons";let a=document.createElement("button");a.className="use-instruction",a.textContent="Use",a.title="Use these instructions",a.onclick=()=>(function t(e){let o=document.getElementById("user-instructions");o&&(o.value=e,tt())})(e.instructions),r.appendChild(a);let s=document.createElement("button");return s.className="remove-instruction",s.textContent="\xd7",s.title="Remove from history",s.onclick=()=>{var t;return t=o,void($.removeFromHistory(t)?(te(),Z("Instructions removed from history")):Z("Error removing instructions"))},r.appendChild(s),i.appendChild(r),i}(e,o);t.appendChild(i)})}class to{constructor(t){if(!t||!t.nodeType||t.nodeType!==Node.ELEMENT_NODE)throw Error("ScoreIndicator requires a valid tweet article DOM element.");this.tweetArticle=t,this.tweetId=Y(this.tweetArticle),this.isAuthorBlacklisted=!1,this.indicatorElement=null,this.tooltipElement=null,this.tooltipControls=null,this.pinButton=null,this.copyButton=null,this.tooltipCloseButton=null,this.reasoningDropdown=null,this.reasoningToggle=null,this.reasoningArrow=null,this.reasoningContent=null,this.reasoningTextElement=null,this.descriptionElement=null,this.scoreTextElement=null,this.followUpQuestionsTextElement=null,this.scrollButton=null,this.metadataElement=null,this.conversationContainerElement=null,this.followUpQuestionsElement=null,this.customQuestionContainer=null,this.customQuestionInput=null,this.customQuestionButton=null,this.attachImageButton=null,this.refreshButton=null,this.followUpImageContainer=null,this.followUpImageInput=null,this.uploadedImageDataUrls=[],this.metadataDropdown=null,this.metadataToggle=null,this.metadataArrow=null,this.metadataContent=null,this.tooltipScrollableContentElement=null,this.status="pending",this.score=null,this.description="",this.reasoning="",this.metadata=null,this.conversationHistory=[],this.questions=[],this.isPinned=!1,this.isVisible=!1,this.autoScroll=!0,this.userInitiatedScroll=!1,this.uploadedImageDataUrls=[],this.qaConversationHistory=[],this.currentFollowUpSource=null,this._lastScrollPosition=0,this._boundHandlers={handleMobileFocus:null,handleMobileTouchStart:null,handleAttachImageClick:null,handleKeyDown:null,handleFollowUpTouchStart:null,handleFollowUpTouchEnd:null,handleConversationReasoningToggle:null};try{this._createElements(t),this._addEventListeners(),ti.add(this.tweetId,this)}catch(e){throw console.error(`[ScoreIndicator ${this.tweetId}] Failed initialization:`,e),this.destroy(),e}}_createElements(t){this.indicatorElement=document.createElement("div"),this.indicatorElement.className="score-indicator",this.indicatorElement.dataset.tweetId=this.tweetId;let o=window.getComputedStyle(t).position;"relative"!==o&&"absolute"!==o&&"fixed"!==o&&"sticky"!==o&&(t.style.position="relative"),t.appendChild(this.indicatorElement),this.tooltipElement=document.createElement("div"),this.tooltipElement.className="score-description",this.tooltipElement.style.display="none",this.tooltipElement.dataset.tweetId=this.tweetId,this.tooltipElement.dataset.autoScroll=this.autoScroll?"true":"false",J()&&(this.tooltipElement.style.touchAction="pan-x pan-y pinch-zoom"),this.tooltipControls=document.createElement("div"),this.tooltipControls.className="tooltip-controls",this.tooltipCloseButton=document.createElement("button"),this.tooltipCloseButton.className="close-button tooltip-close-button",this.tooltipCloseButton.innerHTML="\xd7",this.tooltipCloseButton.title="Close tooltip",this.pinButton=document.createElement("button"),this.pinButton.className="tooltip-pin-button",this.pinButton.innerHTML="\uD83D\uDCCC",this.pinButton.title="Pin tooltip (prevents auto-closing)",this.copyButton=document.createElement("button"),this.copyButton.className="tooltip-copy-button",this.copyButton.innerHTML="\uD83D\uDCCB",this.copyButton.title="Copy content to clipboard",this.refreshButton=document.createElement("button"),this.refreshButton.className="tooltip-refresh-button",this.refreshButton.innerHTML="\uD83D\uDD04",this.refreshButton.title="Re-rate this tweet",this.rateButton=document.createElement("button"),this.rateButton.className="tooltip-rate-button",this.rateButton.innerHTML="‚≠ê",this.rateButton.title="Rate this tweet",this.rateButton.style.display="none",this.tooltipControls.appendChild(this.pinButton),this.tooltipControls.appendChild(this.copyButton),this.tooltipControls.appendChild(this.tooltipCloseButton),this.tooltipControls.appendChild(this.refreshButton),this.tooltipControls.appendChild(this.rateButton),this.tooltipElement.appendChild(this.tooltipControls),this.tooltipScrollableContentElement=document.createElement("div"),this.tooltipScrollableContentElement.className="tooltip-scrollable-content",J()&&(this.tooltipScrollableContentElement.style.webkitOverflowScrolling="touch",this.tooltipScrollableContentElement.style.overscrollBehavior="contain"),this.reasoningDropdown=document.createElement("div"),this.reasoningDropdown.className="reasoning-dropdown",this.reasoningDropdown.style.display="none",this.reasoningToggle=document.createElement("div"),this.reasoningToggle.className="reasoning-toggle",this.reasoningArrow=document.createElement("span"),this.reasoningArrow.className="reasoning-arrow",this.reasoningArrow.textContent="‚ñ∂",this.reasoningToggle.appendChild(this.reasoningArrow),this.reasoningToggle.appendChild(document.createTextNode(" Show Reasoning Trace")),this.reasoningContent=document.createElement("div"),this.reasoningContent.className="reasoning-content",this.reasoningTextElement=document.createElement("p"),this.reasoningTextElement.className="reasoning-text",this.reasoningContent.appendChild(this.reasoningTextElement),this.reasoningDropdown.appendChild(this.reasoningToggle),this.reasoningDropdown.appendChild(this.reasoningContent),this.tooltipScrollableContentElement.appendChild(this.reasoningDropdown),this.descriptionElement=document.createElement("div"),this.descriptionElement.className="description-text",this.tooltipScrollableContentElement.appendChild(this.descriptionElement),this.scoreTextElement=document.createElement("div"),this.scoreTextElement.className="score-text-from-description",this.scoreTextElement.style.display="none",this.tooltipScrollableContentElement.appendChild(this.scoreTextElement),this.followUpQuestionsTextElement=document.createElement("div"),this.followUpQuestionsTextElement.className="follow-up-questions-text-from-description",this.followUpQuestionsTextElement.style.display="none",this.tooltipScrollableContentElement.appendChild(this.followUpQuestionsTextElement),this.conversationContainerElement=document.createElement("div"),this.conversationContainerElement.className="tooltip-conversation-history",this.tooltipScrollableContentElement.appendChild(this.conversationContainerElement),this.followUpQuestionsElement=document.createElement("div"),this.followUpQuestionsElement.className="tooltip-follow-up-questions",this.followUpQuestionsElement.style.display="none",this.tooltipScrollableContentElement.appendChild(this.followUpQuestionsElement),this.customQuestionContainer=document.createElement("div"),this.customQuestionContainer.className="tooltip-custom-question-container",this.customQuestionInput=document.createElement("textarea"),this.customQuestionInput.placeholder="Ask your own question...",this.customQuestionInput.className="tooltip-custom-question-input",this.customQuestionInput.rows=1,this.customQuestionInput.addEventListener("input",function(){""===this.value.trim()?(this.style.height="auto",this.rows=1):(this.style.height="auto",this.style.height=this.scrollHeight+"px")});let i=e("selectedModel","openai/gpt-4.1-nano"),n=z(i);if(n&&(this.attachImageButton=document.createElement("button"),this.attachImageButton.textContent="\uD83D\uDCCE",this.attachImageButton.className="tooltip-attach-image-button",this.attachImageButton.title="Attach image(s) or PDF(s)",this.followUpImageInput=document.createElement("input"),this.followUpImageInput.type="file",this.followUpImageInput.accept="image/*,application/pdf",this.followUpImageInput.multiple=!0,this.followUpImageInput.style.display="none"),this.customQuestionButton=document.createElement("button"),this.customQuestionButton.textContent="Ask",this.customQuestionButton.className="tooltip-custom-question-button",this.customQuestionContainer.appendChild(this.customQuestionInput),this.attachImageButton&&(this.customQuestionContainer.appendChild(this.attachImageButton),this.followUpImageInput&&this.customQuestionContainer.appendChild(this.followUpImageInput)),this.customQuestionContainer.appendChild(this.customQuestionButton),J()&&this.customQuestionInput){let r=this.tooltipScrollableContentElement?.scrollTop||0;setTimeout(()=>{if(this.customQuestionInput&&this.tooltipScrollableContentElement){let t=t=>{this.tooltipScrollableContentElement.scrollTop=r,t.preventDefault()};this.tooltipScrollableContentElement.addEventListener("scroll",t,{passive:!1}),this.customQuestionInput.focus({preventScroll:!0}),this.customQuestionInput.blur(),setTimeout(()=>{this.tooltipScrollableContentElement?.removeEventListener("scroll",t),this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=r)},100)}},50)}n&&(this.followUpImageContainer=document.createElement("div"),this.followUpImageContainer.className="tooltip-follow-up-image-preview-container"),this.metadataDropdown=document.createElement("div"),this.metadataDropdown.className="reasoning-dropdown",this.metadataDropdown.style.display="none",this.metadataToggle=document.createElement("div"),this.metadataToggle.className="reasoning-toggle",this.metadataArrow=document.createElement("span"),this.metadataArrow.className="reasoning-arrow",this.metadataArrow.textContent="‚ñ∂",this.metadataToggle.appendChild(this.metadataArrow),this.metadataToggle.appendChild(document.createTextNode(" Show Metadata")),this.metadataContent=document.createElement("div"),this.metadataContent.className="reasoning-content",this.metadataElement=document.createElement("div"),this.metadataElement.className="tooltip-metadata",this.metadataContent.appendChild(this.metadataElement),this.metadataDropdown.appendChild(this.metadataToggle),this.metadataDropdown.appendChild(this.metadataContent),this.tooltipElement.appendChild(this.tooltipScrollableContentElement),this.followUpImageContainer&&this.tooltipElement.appendChild(this.followUpImageContainer),this.tooltipElement.appendChild(this.customQuestionContainer),this.tooltipElement.appendChild(this.metadataDropdown),this.scrollButton=document.createElement("div"),this.scrollButton.className="scroll-to-bottom-button",this.scrollButton.innerHTML="‚¨á Scroll to bottom",this.scrollButton.style.display="none",this.tooltipElement.appendChild(this.scrollButton);let a=document.createElement("div");a.className="tooltip-bottom-spacer",this.tooltipScrollableContentElement.appendChild(a),document.body.appendChild(this.tooltipElement),J()&&(this.indicatorElement?.classList.add("mobile-indicator"),this.tooltipElement?.classList.add("mobile-tooltip")),this._updateIndicatorUI(),this._updateTooltipUI(),this.autoScrollConversation=!0,this.conversationContainerElement&&this.conversationContainerElement.addEventListener("scroll",this._handleConversationScroll.bind(this)),J()&&this._initializeMobileInteractionFix()}_initializeMobileInteractionFix(){this._hasFirstInteraction=!1;let t=t=>{if(!this._hasFirstInteraction){this._hasFirstInteraction=!0;let e=this.tooltipScrollableContentElement?.scrollTop||0;setTimeout(()=>{this.tooltipScrollableContentElement&&this.tooltipScrollableContentElement.scrollTop!==e&&(this.tooltipScrollableContentElement.scrollTop=e)},0),t.target===this.customQuestionInput&&"touchstart"===t.type&&requestAnimationFrame(()=>{this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=e)})}},e=[this.customQuestionInput,this.customQuestionButton,this.reasoningToggle,this.metadataToggle,this.pinButton,this.copyButton,this.tooltipCloseButton,this.refreshButton,this.rateButton,this.scrollButton].filter(t=>t);if(e.forEach(e=>{e.addEventListener("touchstart",t,{passive:!0,capture:!0})}),this.customQuestionInput){let o=0;this.customQuestionInput.addEventListener("touchstart",t=>{o=this.tooltipScrollableContentElement?.scrollTop||0},{passive:!0}),this.customQuestionInput.addEventListener("focus",t=>{o>0&&requestAnimationFrame(()=>{this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=o)})})}if(this.conversationContainerElement&&this.conversationContainerElement.addEventListener("touchstart",e=>{let o=e.target.closest(".reasoning-toggle");o&&t(e)},{passive:!0,capture:!0}),this.tooltipScrollableContentElement){let i=0,n=!1;this.tooltipScrollableContentElement.addEventListener("touchstart",t=>{if(i=t.touches[0].clientY,n=!1,!this._hasFirstInteraction){let e=t.target.closest("button, textarea, .reasoning-toggle");if(e){n=!0;let o=this.tooltipScrollableContentElement.scrollTop;requestAnimationFrame(()=>{n&&this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=o)}),setTimeout(()=>{n=!1},100)}}},{passive:!0})}}_simulateInitialMobileTaps(){setTimeout(()=>{let t=[this.customQuestionInput,this.customQuestionButton,this.reasoningToggle,this.metadataToggle].filter(t=>t);t.forEach(t=>{try{let e=new TouchEvent("touchstart",{bubbles:!0,cancelable:!0,view:window,touches:[new Touch({identifier:Date.now(),target:t,clientX:0,clientY:0,screenX:0,screenY:0,pageX:0,pageY:0})]});t.dispatchEvent(e);let o=new TouchEvent("touchend",{bubbles:!0,cancelable:!0,view:window,changedTouches:[new Touch({identifier:Date.now(),target:t,clientX:0,clientY:0,screenX:0,screenY:0,pageX:0,pageY:0})]});t.dispatchEvent(o)}catch(i){try{let n=document.createEvent("TouchEvent");n.initTouchEvent("touchstart",!0,!0),t.dispatchEvent(n)}catch(r){t.click(),t.blur&&t.blur()}}})},100)}_addEventListeners(){this.indicatorElement&&this.tooltipElement&&(this.indicatorElement.addEventListener("mouseenter",this._handleMouseEnter.bind(this)),this.indicatorElement.addEventListener("mouseleave",this._handleMouseLeave.bind(this)),this.indicatorElement.addEventListener("click",this._handleIndicatorClick.bind(this)),this.tooltipElement.addEventListener("mouseenter",this._handleTooltipMouseEnter.bind(this)),this.tooltipElement.addEventListener("mouseleave",this._handleTooltipMouseLeave.bind(this)),this.tooltipScrollableContentElement?.addEventListener("scroll",this._handleTooltipScroll.bind(this)),this.pinButton?.addEventListener("click",this._handlePinClick.bind(this)),this.copyButton?.addEventListener("click",this._handleCopyClick.bind(this)),this.tooltipCloseButton?.addEventListener("click",this._handleCloseClick.bind(this)),this.reasoningToggle?.addEventListener("click",this._handleReasoningToggleClick.bind(this)),this.scrollButton?.addEventListener("click",this._handleScrollButtonClick.bind(this)),this.refreshButton?.addEventListener("click",this._handleRefreshClick.bind(this)),this.rateButton?.addEventListener("click",this._handleRateClick.bind(this)),this.followUpQuestionsElement?.addEventListener("click",this._handleFollowUpQuestionClick.bind(this)),J()&&this.followUpQuestionsElement&&(this._boundHandlers.handleFollowUpTouchStart=t=>{let e=t.target.closest(".follow-up-question-button");e&&(t.preventDefault(),e.dataset.touchStartX=t.touches[0].clientX,e.dataset.touchStartY=t.touches[0].clientY)},this._boundHandlers.handleFollowUpTouchEnd=t=>{let e=t.target.closest(".follow-up-question-button");if(e&&e.dataset.touchStartX){t.preventDefault();let o=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY,n=Math.abs(o-parseFloat(e.dataset.touchStartX)),r=Math.abs(i-parseFloat(e.dataset.touchStartY));n<10&&r<10&&this._handleFollowUpQuestionClick({target:e,preventDefault(){},stopPropagation(){}}),delete e.dataset.touchStartX,delete e.dataset.touchStartY}},this.followUpQuestionsElement.addEventListener("touchstart",this._boundHandlers.handleFollowUpTouchStart,{passive:!1}),this.followUpQuestionsElement.addEventListener("touchend",this._boundHandlers.handleFollowUpTouchEnd,{passive:!1})),this.customQuestionButton?.addEventListener("click",this._handleCustomQuestionClick.bind(this)),this._boundHandlers.handleKeyDown=t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this._handleCustomQuestionClick(t))},this.customQuestionInput?.addEventListener("keydown",this._boundHandlers.handleKeyDown),J()&&this.customQuestionInput&&(this._boundHandlers.handleMobileFocus=t=>{},this._boundHandlers.handleMobileTouchStart=t=>{this._lastScrollPosition=this.tooltipScrollableContentElement?.scrollTop||0}),this.metadataToggle?.addEventListener("click",this._handleMetadataToggleClick.bind(this)),this.attachImageButton&&this.followUpImageInput&&(this._boundHandlers.handleAttachImageClick=t=>{t.preventDefault(),t.stopPropagation(),this.followUpImageInput.click()},this.attachImageButton.addEventListener("click",this._boundHandlers.handleAttachImageClick),this.followUpImageInput.addEventListener("change",this._handleFollowUpImageSelect.bind(this))))}_updateIndicatorUI(){if(!this.indicatorElement)return;let t=this.indicatorElement.classList;t.remove("pending-rating","rated-rating","error-rating","cached-rating","blacklisted-rating","streaming-rating","manual-rating","blacklisted-author-indicator");let e="",o="";if(this.isAuthorBlacklisted)o="blacklisted-author-indicator",e=null!==this.score&&void 0!==this.score?String(this.score):"?";else switch(this.status){case"pending":o="pending-rating",e="‚è≥";break;case"streaming":o="streaming-rating",e=null!==this.score&&void 0!==this.score?String(this.score):"\uD83D\uDD04";break;case"error":o="error-rating",e="‚ö†Ô∏è";break;case"cached":o="cached-rating",e=String(this.score);break;case"blacklisted":o="blacklisted-rating",e=String(this.score);break;case"manual":o="manual-rating",e="\uD83D\uDCAD";break;default:o="rated-rating",e=String(this.score)}o&&t.add(o),this.indicatorElement.textContent=e}_updateTooltipUI(){if(!this.tooltipElement||!this.tooltipScrollableContentElement||!this.descriptionElement||!this.scoreTextElement||!this.followUpQuestionsTextElement||!this.reasoningTextElement||!this.reasoningDropdown||!this.conversationContainerElement||!this.followUpQuestionsElement||!this.metadataElement||!this.metadataDropdown)return;this.tooltipScrollableContentElement.scrollHeight,this.tooltipScrollableContentElement.scrollTop,this.tooltipScrollableContentElement.clientHeight,J();let t=this.tooltipScrollableContentElement.scrollTop;this.tooltipScrollableContentElement.scrollHeight;let e=this.description||"",o=e.match(/<ANALYSIS>([^<]+)<\/ANALYSIS>/),i=e.match(/<SCORE>([^<]+)<\/SCORE>/),n=e.match(/<FOLLOW_UP_QUESTIONS>([^<]+)<\/FOLLOW_UP_QUESTIONS>/),r="",a="",s="";r=o&&void 0!==o[1]?o[1].trim():i||n?"*Waiting for analysis...*":e,i&&void 0!==i[1]&&(a=i[1].trim()),n&&void 0!==n[1]&&(s=n[1].trim());let l=!1,d=tn(r).description;if(this.descriptionElement.innerHTML!==d&&(this.descriptionElement.innerHTML=d,l=!0),a){let c=a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/SCORE_(\d+)/g,'<span class="score-highlight">SCORE: $1</span>').replace(/\n/g,"<br>");this.scoreTextElement.innerHTML!==c&&(this.scoreTextElement.innerHTML=c,l=!0),this.scoreTextElement.style.display="block"}else"none"!==this.scoreTextElement.style.display&&(this.scoreTextElement.style.display="none",this.scoreTextElement.innerHTML="",l=!0);if(s){let p=s.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");this.followUpQuestionsTextElement.innerHTML!==p&&(this.followUpQuestionsTextElement.innerHTML=p)}else""!==this.followUpQuestionsTextElement.innerHTML&&(this.followUpQuestionsTextElement.innerHTML="");this.followUpQuestionsTextElement.style.display="none";let u=tn("",this.reasoning).reasoning;this.reasoningTextElement.innerHTML!==u&&(this.reasoningTextElement.innerHTML=u,l=!0);let h=!!u;"none"===this.reasoningDropdown.style.display===h&&(this.reasoningDropdown.style.display=h?"block":"none",l=!0);let g=this._renderConversationHistory();this.conversationContainerElement.innerHTML!==g&&(this.conversationContainerElement.innerHTML=g,this.conversationContainerElement.style.display=this.conversationHistory.length>0?"block":"none",l=!0);let m=!1;this.followUpQuestionsElement.children.length!==(this.questions?.length||0)?m=!0:this.questions?.forEach((t,e)=>{let o=this.followUpQuestionsElement.children[e];o&&o.dataset.questionText===t||(m=!0)}),m&&(this.followUpQuestionsElement.innerHTML="",this.questions&&this.questions.length>0?(this.questions.forEach((t,e)=>{let o=document.createElement("button");if(o.className="follow-up-question-button",o.textContent=`ü§î ${t}`,o.dataset.questionIndex=e,o.dataset.questionText=t,J()){let i=!1;o.addEventListener("touchstart",t=>{if(!i){i=!0;let e=this.tooltipScrollableContentElement?.scrollTop||0;requestAnimationFrame(()=>{this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=e)})}},{passive:!0}),o.addEventListener("focus",t=>{t.target.blur()},{passive:!0})}this.followUpQuestionsElement.appendChild(o)}),this.followUpQuestionsElement.style.display="block"):this.followUpQuestionsElement.style.display="none",l=!0);let f="",b=!1,$=this.metadata&&Object.keys(this.metadata).length>1&&this.metadata.model,v=this.metadata&&this.metadata.generationId&&1===Object.keys(this.metadata).length;if($?(this.metadata.providerName&&"N/A"!==this.metadata.providerName&&(f+=`<div class="metadata-line">Provider: ${this.metadata.providerName}</div>`),f+=`<div class="metadata-line">Model: ${this.metadata.model}</div>`,f+=`<div class="metadata-line">Tokens: prompt: ${this.metadata.promptTokens} / completion: ${this.metadata.completionTokens}</div>`,this.metadata.reasoningTokens>0&&(f+=`<div class="metadata-line">Reasoning Tokens: ${this.metadata.reasoningTokens}</div>`),f+=`<div class="metadata-line">Latency: ${this.metadata.latency}</div>`,this.metadata.mediaInputs>0&&(f+=`<div class="metadata-line">Media: ${this.metadata.mediaInputs}</div>`),f+=`<div class="metadata-line">Price: ${this.metadata.price}</div>`,b=!0):v&&(f+=`<div class="metadata-line">Generation ID: ${this.metadata.generationId} (fetching details...)</div>`,b=!0),this.metadataElement.innerHTML!==f&&(this.metadataElement.innerHTML=f,l=!0),this.metadataDropdown){let y=this.metadataDropdown.style.display,w=b?"block":"none";y!==w&&(this.metadataDropdown.style.display=w,l=!0)}let x="streaming"===this.status;if(this.tooltipElement.classList.contains("streaming-tooltip")!==x&&(this.tooltipElement.classList.toggle("streaming-tooltip",x),l=!0),this.rateButton){let E="manual"===this.status,_=this.rateButton.style.display,S=E?"inline-block":"none";_!==S&&(this.rateButton.style.display=S,l=!0)}l?requestAnimationFrame(()=>{this.tooltipScrollableContentElement&&this.isVisible&&(this.autoScroll?this._performAutoScroll():this.tooltipScrollableContentElement.scrollTop=t),this._updateScrollButtonVisibility()}):this._updateScrollButtonVisibility()}_renderConversationHistory(){if(!this.conversationHistory||0===this.conversationHistory.length)return"";let t=new Map;this.conversationContainerElement&&this.conversationContainerElement.querySelectorAll(".conversation-reasoning").forEach((e,o)=>{t.set(o,e.classList.contains("expanded"))});let e="";return this.conversationHistory.forEach((o,i)=>{let n=o.question.replace(/</g,"&lt;").replace(/>/g,"&gt;"),r="";o.uploadedImages&&o.uploadedImages.length>0&&(r=`
                    <div class="conversation-image-container">
                        ${o.uploadedImages.map(t=>t.startsWith("data:application/pdf")?`
                                    <div class="conversation-uploaded-pdf" style="display: inline-block; text-align: center; margin: 4px;">
                                        <span style="font-size: 48px;">üìÑ</span>
                                        <div style="font-size: 12px;">PDF Document</div>
                                    </div>
                                `:`<img src="${t}" alt="User uploaded image" class="conversation-uploaded-image">`).join("")}
                    </div>
                `);let a;a="pending"===o.answer?'<em class="pending-answer">Answering...</em>':o.answer.replace(/```([\s\S]*?)```/g,(t,e)=>`<pre><code>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="ai-generated-link">$1</a>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^\|(.+)\|\r?\n\|([\s\|\-:]+)\|\r?\n(\|(?:.+)\|\r?\n?)+/gm,t=>{let e=t.trim().split("\n"),o=e[0],i=e.slice(2),n='<table class="markdown-table">';return n+="<thead><tr>",o.slice(1,-1).split("|").forEach(t=>{n+=`<th>${t.trim()}</th>`}),n+="</tr></thead>",n+="<tbody>",i.forEach(t=>{t.trim()&&(n+="<tr>",t.slice(1,-1).split("|").forEach(t=>{n+=`<td>${t.trim()}</td>`}),n+="</tr>")}),n+="</tbody></table>"}).replace(/\n/g,"<br>"),i>0&&(e+='<hr class="conversation-separator">');let s="";if(o.reasoning&&""!==o.reasoning.trim()&&"pending"!==o.answer){let l=tn("",o.reasoning).reasoning,d=t.get(i);s=`
                    <div class="reasoning-dropdown conversation-reasoning${d?" expanded":""}" data-index="${i}">
                        <div class="reasoning-toggle" role="button" tabindex="0" aria-expanded="${d?"true":"false"}">
                            <span class="reasoning-arrow">${d?"‚ñº":"‚ñ∂"}</span> Show Reasoning Trace
                        </div>
                        <div class="reasoning-content" ${d?'style="max-height: 200px; padding: 8px;"':'style="max-height: 0; padding: 0 8px;"'}>
                            <p class="reasoning-text">${l}</p>
                        </div>
                    </div>
                `}e+=`
                <div class="conversation-turn">
                    <div class="conversation-question"><strong>You:</strong> ${n}</div>
                    ${r}
                    ${s}
                    <div class="conversation-answer"><strong>AI:</strong> ${a}</div>
                </div>
            `}),this.conversationContainerElement&&(this.conversationContainerElement.innerHTML=e,this._attachConversationReasoningListeners()),e}_attachConversationReasoningListeners(){this.conversationContainerElement&&(this._boundHandlers.handleConversationReasoningToggle&&this.conversationContainerElement.removeEventListener("click",this._boundHandlers.handleConversationReasoningToggle),this._boundHandlers.handleConversationReasoningToggle=t=>{let e=t.target.closest(".conversation-reasoning .reasoning-toggle");if(!e||"click"===t.type&&!t.isTrusted)return;let o=e.closest(".reasoning-dropdown"),i=o?.querySelector(".reasoning-content"),n=o?.querySelector(".reasoning-arrow");if(!o||!i||!n)return;let r=this.tooltipScrollableContentElement?.scrollTop||0,a=o.classList.toggle("expanded");n.textContent=a?"‚ñº":"‚ñ∂",e.setAttribute("aria-expanded",a),i.style.maxHeight=a?"200px":"0",i.style.padding=a?"8px":"0 8px",J()&&this.tooltipScrollableContentElement&&requestAnimationFrame(()=>{this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=r)})},this.conversationContainerElement.addEventListener("click",this._boundHandlers.handleConversationReasoningToggle))}_performAutoScroll(){this.tooltipScrollableContentElement&&this.autoScroll&&this.isVisible&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(this.tooltipScrollableContentElement&&this.autoScroll&&this.isVisible){let t=this.tooltipScrollableContentElement.scrollHeight;this.tooltipScrollableContentElement.scrollTo({top:t,behavior:"instant"})}})})}_setPosition(){if(!this.isVisible||!this.indicatorElement||!this.tooltipElement)return;let t=this.indicatorElement.getBoundingClientRect(),e=this.tooltipElement,o=J(),i=window.innerHeight,n=window.innerWidth,r=i-10,a=n-10;e.style.maxHeight="",e.style.overflowY="",e.style.visibility="hidden",e.style.display="block";let s=window.getComputedStyle(e),l=parseFloat(s.width),d=parseFloat(s.height),c,p,u="",h="";if(o){(c=Math.max(10,(n-l)/2))+l>a&&(c=a-l);let g=.8*i;d>g&&(u=`${g}px`,h="scroll",d=g),(p=Math.max(10,(i-d)/2))+d>r&&(p=r-d)}else c=t.right+10,p=t.top+t.height/2-d/2,c+l>a&&(c=t.left-l-10)<10&&(c=Math.max(10,(n-l)/2),t.bottom+d+10<=r?p=t.bottom+10:t.top-d-10>=10?p=t.top-d-10:(p=10,u=`${r-10}px`,h="scroll",d=r-10)),p<10&&(p=10),p+d>r&&(d>r-10?(p=10,u=`${r-10}px`,h="scroll"):p=r-d);e.style.position="fixed",e.style.left=`${c}px`,e.style.top=`${p}px`,e.style.zIndex="99999999",e.style.maxHeight=u,e.style.overflowY="",e.style.display="flex",e.style.visibility="visible"}_updateScrollButtonVisibility(){if(!this.tooltipScrollableContentElement||!this.scrollButton)return;let t="streaming"===this.status;if(!t){this.scrollButton.style.display="none";return}let e=this.tooltipScrollableContentElement.scrollHeight-this.tooltipScrollableContentElement.scrollTop-this.tooltipScrollableContentElement.clientHeight<(J()?40:55);this.scrollButton.style.display=e?"none":"block"}_handleMouseEnter(t){J()||this.show()}_handleMouseLeave(t){J()||setTimeout(()=>{this.tooltipElement&&!this.tooltipElement.matches(":hover")&&this.indicatorElement&&!this.indicatorElement.matches(":hover")&&this.hide()},100)}_handleIndicatorClick(t){t.stopPropagation(),t.preventDefault(),this.toggle()}_handleTooltipMouseEnter(){this.isPinned||this.show()}_handleTooltipMouseLeave(){setTimeout(()=>{this.isPinned||this.indicatorElement.matches(":hover")||this.tooltipElement.matches(":hover")||this.hide()},100)}_handleTooltipScroll(){if(!this.tooltipScrollableContentElement)return;let t=this.tooltipScrollableContentElement.scrollHeight-this.tooltipScrollableContentElement.scrollTop-this.tooltipScrollableContentElement.clientHeight<(J()?40:55);t?this.userInitiatedScroll&&(this.autoScroll=!0,this.tooltipElement.dataset.autoScroll="true",this.userInitiatedScroll=!1):this.autoScroll&&(this.autoScroll=!1,this.tooltipElement.dataset.autoScroll="false",this.userInitiatedScroll=!0),this._updateScrollButtonVisibility()}_handlePinClick(t){t&&t.stopPropagation(),this.isPinned?this.unpin():this.pin()}_handleCopyClick(t){if(t&&t.stopPropagation(),!this.descriptionElement||!this.reasoningTextElement||!this.copyButton)return;let e=this.descriptionElement.textContent||"",o=this.reasoningTextElement.textContent||"";o&&(e+="\n\nReasoning:\n"+o),navigator.clipboard.writeText(e).then(()=>{let t=this.copyButton.innerHTML;this.copyButton.innerHTML="‚úì",this.copyButton.disabled=!0,setTimeout(()=>{this.copyButton.innerHTML=t,this.copyButton.disabled=!1},1500)}).catch(t=>{console.error("[ScoreIndicator] Failed to copy text: ",t)})}_handleReasoningToggleClick(t){if(t&&t.stopPropagation(),!this.reasoningDropdown||!this.reasoningContent||!this.reasoningArrow)return;let e=this.tooltipScrollableContentElement?.scrollTop||0,o=this.reasoningDropdown.classList.toggle("expanded");this.reasoningArrow.textContent=o?"‚ñº":"‚ñ∂",o?(this.reasoningContent.style.maxHeight="300px",this.reasoningContent.style.padding="10px"):(this.reasoningContent.style.maxHeight="0",this.reasoningContent.style.padding="0 10px"),J()&&this.tooltipScrollableContentElement&&requestAnimationFrame(()=>{this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=e)})}_handleScrollButtonClick(t){t&&t.stopPropagation(),this.tooltipScrollableContentElement&&(this.autoScroll=!0,this.tooltipElement.dataset.autoScroll="true",this._performAutoScroll(),this._updateScrollButtonVisibility())}_handleFollowUpQuestionClick(t){t&&"function"==typeof t.preventDefault&&t.preventDefault();let o=t.target&&t.target.dataset&&t.target.dataset.questionText&&"function"!=typeof t.target.closest,i=o?t.target:t.target.closest(".follow-up-question-button");if(!i)return;t.stopPropagation();let n=i.dataset.questionText,r=e("openrouter-api-key","");this.currentFollowUpSource=o?"custom":"suggested",o?(this.customQuestionInput&&(this.customQuestionInput.disabled=!0),this.customQuestionButton&&(this.customQuestionButton.disabled=!0,this.customQuestionButton.textContent="Asking...")):(i.disabled=!0,i.textContent=`ü§î Asking: ${n}...`,this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!0)),this.conversationHistory.push({question:n,answer:"pending",uploadedImages:[...this.uploadedImageDataUrls],reasoning:""});let a=[{type:"text",text:n}];this.uploadedImageDataUrls&&this.uploadedImageDataUrls.length>0&&this.uploadedImageDataUrls.forEach(t=>{if(t.startsWith("data:application/pdf")){let e=this.followUpImageContainer?.querySelector(`[data-image-data-url="${CSS.escape(t)}"]`),o=e?.querySelector(".follow-up-pdf-preview span:last-child")?.textContent||"document.pdf";a.push({type:"file",file:{filename:o,file_data:t}})}else a.push({type:"image_url",image_url:{url:t}})});let s=[...this.qaConversationHistory,{role:"user",content:a}];if(this._clearFollowUpImage(),this._updateTooltipUI(),this.questions=[],this._updateTooltipUI(),!r){Z("API key missing. Cannot answer question.","error"),this._updateConversationHistory(n,"Error: API Key missing.",""),o||(i.disabled=!1,this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!1)),this.customQuestionInput&&(this.customQuestionInput.disabled=!1),this.customQuestionButton&&(this.customQuestionButton.disabled=!1,this.customQuestionButton.textContent="Ask"),this._clearFollowUpImage();return}if(!n){console.error("Follow-up question text not found on button."),this._updateConversationHistory(n||"Error: Empty Question","Error: Could not identify question.",""),o||(i.disabled=!1,this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!1)),this.customQuestionInput&&(this.customQuestionInput.disabled=!1),this.customQuestionButton&&(this.customQuestionButton.disabled=!1,this.customQuestionButton.textContent="Ask"),this._clearFollowUpImage();return}let l=this.findCurrentArticleElement();t2(this.tweetId,s,r,l,this)}_handleCustomQuestionClick(t){if(t&&(t.preventDefault(),t.stopPropagation()),!this.customQuestionInput||!this.customQuestionButton)return;let e=this.customQuestionInput.value.trim(),o=this.uploadedImageDataUrls&&this.uploadedImageDataUrls.length>0;if(!e&&!o){Z("Please enter a question or attach a file.","warning"),this.customQuestionInput.focus();return}this.followUpQuestionsElement?.querySelectorAll(".follow-up-question-button").forEach(t=>t.disabled=!0),this._handleFollowUpQuestionClick({target:{dataset:{questionText:e||(o?"[file only message]":"")},disabled:!1,textContent:""},stopPropagation(){},preventDefault(){}}),this.customQuestionInput&&(this.customQuestionInput.value="",this.customQuestionInput.style.height="auto",this.customQuestionInput.rows=1)}_handleFollowUpImageSelect(t){t&&t.preventDefault();let e=t.target.files;e&&0!==e.length&&(this.followUpImageContainer&&e.length>0&&(this.followUpImageContainer.style.display="flex"),Array.from(e).forEach(t=>{if(t&&t.type.startsWith("image/")){var e;(e=t,new Promise((t,o)=>{let i=new FileReader;i.onload=e=>{let i=new Image;i.onload=()=>{let{width:e,height:o}=i,n,r;e>o?e>1024?(n=1024,r=o*(1024/e)):(n=e,r=o):o>1024?(r=1024,n=e*(1024/o)):(n=e,r=o);let a=document.createElement("canvas");a.width=n,a.height=r;let s=a.getContext("2d");s.drawImage(i,0,0,n,r);let l=a.toDataURL("image/jpeg",.9);t(l)},i.onerror=t=>{console.error("Error loading image for resizing:",t),o(Error("Could not load image for resizing."))},i.src=e.target.result},i.onerror=t=>{console.error("FileReader error:",t),o(Error("Could not read file."))},i.readAsDataURL(e)})).then(t=>{this.uploadedImageDataUrls.push(t),this._addPreviewToContainer(t,"image")}).catch(e=>{console.error("Error resizing image:",e),Z(`Could not process image ${t.name}: ${e.message}`,"error")})}else if(t&&"application/pdf"===t.type){let o=new FileReader;o.onload=e=>{let o=e.target.result;this.uploadedImageDataUrls.push(o),this._addPreviewToContainer(o,"pdf",t.name)},o.onerror=e=>{console.error("Error reading PDF:",e),Z(`Could not process PDF ${t.name}: ${e.message}`,"error")},o.readAsDataURL(t)}else t&&Z(`Skipping unsupported file type: ${t.name}`,"warning")}),t.target.value=null)}_addPreviewToContainer(t,e="image",o=""){if(!this.followUpImageContainer)return;let i=document.createElement("div");if(i.className="follow-up-image-preview-item",i.dataset.imageDataUrl=t,"pdf"===e){let n=document.createElement("div");n.className="follow-up-pdf-preview",n.innerHTML=`<span style="font-size: 24px;">üìÑ</span><br><span style="font-size: 11px; word-break: break-all;">${o||"PDF"}</span>`,n.style.textAlign="center",n.style.padding="8px",n.style.width="60px",n.style.height="60px",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.alignItems="center",i.appendChild(n)}else{let r=document.createElement("img");r.src=t,r.className="follow-up-image-preview-thumbnail",i.appendChild(r)}let a=document.createElement("button");a.textContent="\xd7",a.className="follow-up-image-remove-btn",a.title="Remove this file",a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this._removeSpecificUploadedImage(t)}),i.appendChild(a),this.followUpImageContainer.appendChild(i)}_removeSpecificUploadedImage(t){if(this.uploadedImageDataUrls=this.uploadedImageDataUrls.filter(e=>e!==t),this.followUpImageContainer){let e=this.followUpImageContainer.querySelector(`div.follow-up-image-preview-item[data-image-data-url="${CSS.escape(t)}"]`);e&&e.remove(),0===this.uploadedImageDataUrls.length&&(this.followUpImageContainer.style.display="none")}}_clearFollowUpImage(){this.uploadedImageDataUrls=[],this.followUpImageContainer&&(this.followUpImageContainer.innerHTML="",this.followUpImageContainer.style.display="none"),this.followUpImageInput&&(this.followUpImageInput.value=null)}_finalizeFollowUpInteraction(){this.followUpQuestionsElement&&this.followUpQuestionsElement.querySelectorAll(".follow-up-question-button").forEach(t=>{t.disabled=!1}),"custom"===this.currentFollowUpSource&&(this.customQuestionInput&&(this.customQuestionInput.disabled=!1),this.customQuestionButton&&(this.customQuestionButton.disabled=!1,this.customQuestionButton.textContent="Ask")),this.currentFollowUpSource=null}_updateConversationHistory(t,e,o=""){let i=this.conversationHistory.findIndex(e=>e.question===t&&"pending"===e.answer);-1!==i?(this.conversationHistory[i].answer=e,this.conversationHistory[i].reasoning=o,this._updateTooltipUI()):console.warn(`[ScoreIndicator ${this.tweetId}] Could not find pending history entry for question: "${t}"`)}_renderStreamingAnswer(t,e=""){if(!this.conversationContainerElement)return;let o=this.conversationContainerElement.querySelectorAll(".conversation-turn"),i=o.length>0?o[o.length-1]:null;if(!i){console.warn(`[ScoreIndicator ${this.tweetId}] Could not find last conversation turn to render streaming answer.`);return}let n=this.conversationHistory.length>0?this.conversationHistory[this.conversationHistory.length-1]:null;if(!(n&&"pending"===n.answer)){console.warn(`[ScoreIndicator ${this.tweetId}] Attempted to render streaming answer, but last history entry is not pending.`);return}let r=i.querySelector(".streaming-reasoning-container"),a=e&&""!==e.trim();if(a&&!r){(r=document.createElement("div")).className="streaming-reasoning-container active",r.style.display="block";let s=document.createElement("div");s.className="streaming-reasoning-text",r.appendChild(s);let l=i.querySelector(".conversation-answer");l?i.insertBefore(r,l):i.appendChild(r)}if(r&&a){let d=r.querySelector(".streaming-reasoning-text");if(d){let c=e;e.length>200&&(c=e.slice(-200)),d.textContent=c}}let p=i.querySelector(".reasoning-dropdown");p&&(p.style.display="none");let u=i.querySelector(".conversation-answer");if(u){let h=t.replace(/```([\s\S]*?)```/g,(t,e)=>`<pre><code>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="ai-generated-link">$1</a>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^\|(.+)\|\r?\n\|([\s\|\-:]+)\|\r?\n(\|(?:.+)\|\r?\n?)+/gm,t=>{let e=t.trim().split("\n"),o=e[0],i=e.slice(2),n='<table class="markdown-table">';return n+="<thead><tr>",o.slice(1,-1).split("|").forEach(t=>{n+=`<th>${t.trim()}</th>`}),n+="</tr></thead>",n+="<tbody>",i.forEach(t=>{t.trim()&&(n+="<tr>",t.slice(1,-1).split("|").forEach(t=>{n+=`<td>${t.trim()}</td>`}),n+="</tr>")}),n+="</tbody></table>"}).replace(/\n/g,"<br>");u.innerHTML=`<strong>AI:</strong> ${h}<em class="pending-cursor">|</em>`}else console.warn(`[ScoreIndicator ${this.tweetId}] Could not find answer element in last conversation turn.`);this.autoScroll&&this._performAutoScroll(),this._performConversationAutoScroll()}update({status:t,score:e=null,description:o="",reasoning:i="",metadata:n=null,questions:r}){let a=void 0!==t&&this.status!==t,s=null!==e&&this.score!==e,l=""!==o&&this.description!==o,d=""!==i&&this.reasoning!==i,c=null!==n&&JSON.stringify(this.metadata)!==JSON.stringify(n),p=void 0!==r&&JSON.stringify(this.questions)!==JSON.stringify(r);if(a||s||l||d||c||p){if(a&&(this.status=t),(s||a)&&(this.score="pending"===this.status||"error"===this.status?e:"streaming"===this.status&&null===e?this.score:e),l&&(this.description=o),d&&(this.reasoning=i),c&&(this.metadata=n),p&&(this.questions=r),a){let u="pending"===this.status||"streaming"===this.status;this.autoScroll!==u&&(this.autoScroll=u,this.tooltipElement&&(this.tooltipElement.dataset.autoScroll=this.autoScroll?"true":"false"))}(a||s)&&this._updateIndicatorUI(),l||d||a||c||p?this._updateTooltipUI():this._updateScrollButtonVisibility()}}show(){this.tooltipElement&&(this.isVisible=!0,this.tooltipElement.style.display="flex",this._setPosition(),this.autoScroll&&("streaming"===this.status||"pending"===this.status)&&this._performAutoScroll(),this._updateScrollButtonVisibility())}hide(){!this.isPinned&&this.tooltipElement?(this.isVisible=!1,this.tooltipElement.style.display="none"):this.isPinned}toggle(){this.isVisible&&!this.isPinned?this.hide():this.show()}pin(){this.tooltipElement&&this.pinButton&&(this.isPinned=!0,this.tooltipElement.classList.add("pinned"),this.pinButton.innerHTML="\uD83D\uDCCD",this.pinButton.title="Unpin tooltip")}unpin(){this.tooltipElement&&this.pinButton&&(this.isPinned=!1,this.tooltipElement.classList.remove("pinned"),this.pinButton.innerHTML="\uD83D\uDCCC",this.pinButton.title="Pin tooltip (prevents auto-closing)",setTimeout(()=>{this.tooltipElement&&!this.tooltipElement.matches(":hover")&&this.indicatorElement&&!this.indicatorElement.matches(":hover")&&this.hide()},0))}_handleCloseClick(t){t&&t.stopPropagation(),this.hide()}destroy(){window.activeStreamingRequests&&window.activeStreamingRequests[this.tweetId]&&(console.log(`Cleaning up active streaming request for tweet ${this.tweetId}`),window.activeStreamingRequests[this.tweetId].abort(),delete window.activeStreamingRequests[this.tweetId]),this.indicatorElement?.removeEventListener("mouseenter",this._handleMouseEnter),this.indicatorElement?.removeEventListener("mouseleave",this._handleMouseLeave),this.indicatorElement?.removeEventListener("click",this._handleIndicatorClick),this.tooltipElement?.removeEventListener("mouseenter",this._handleTooltipMouseEnter),this.tooltipElement?.removeEventListener("mouseleave",this._handleTooltipMouseLeave),this.tooltipScrollableContentElement?.removeEventListener("scroll",this._handleTooltipScroll.bind(this)),this.pinButton?.removeEventListener("click",this._handlePinClick.bind(this)),this.copyButton?.removeEventListener("click",this._handleCopyClick.bind(this)),this.tooltipCloseButton?.removeEventListener("click",this._handleCloseClick.bind(this)),this.reasoningToggle?.removeEventListener("click",this._handleReasoningToggleClick.bind(this)),this.scrollButton?.removeEventListener("click",this._handleScrollButtonClick.bind(this)),this.followUpQuestionsElement?.removeEventListener("click",this._handleFollowUpQuestionClick.bind(this)),this.customQuestionButton?.removeEventListener("click",this._handleCustomQuestionClick.bind(this)),this.customQuestionInput?.removeEventListener("keydown",this._boundHandlers.handleKeyDown),J()&&(this.customQuestionInput&&this._boundHandlers.handleMobileFocus&&(this.customQuestionInput.removeEventListener("focus",this._boundHandlers.handleMobileFocus),this.customQuestionInput.removeEventListener("touchstart",this._boundHandlers.handleMobileTouchStart,{passive:!1})),this.followUpQuestionsElement&&this._boundHandlers.handleFollowUpTouchStart&&(this.followUpQuestionsElement.removeEventListener("touchstart",this._boundHandlers.handleFollowUpTouchStart,{passive:!1}),this.followUpQuestionsElement.removeEventListener("touchend",this._boundHandlers.handleFollowUpTouchEnd,{passive:!1}))),this.metadataToggle?.removeEventListener("click",this._handleMetadataToggleClick.bind(this)),this.refreshButton?.removeEventListener("click",this._handleRefreshClick.bind(this)),this.rateButton?.removeEventListener("click",this._handleRateClick.bind(this)),this.attachImageButton&&this.attachImageButton.removeEventListener("click",this._boundHandlers.handleAttachImageClick),this.followUpImageInput&&this.followUpImageInput.removeEventListener("change",this._handleFollowUpImageSelect.bind(this)),this.conversationContainerElement&&this._boundHandlers.handleConversationReasoningToggle&&this.conversationContainerElement.removeEventListener("click",this._boundHandlers.handleConversationReasoningToggle),this.indicatorElement?.remove(),this.tooltipElement?.remove(),ti.remove(this.tweetId);let t=this.findCurrentArticleElement();t&&delete t.dataset.hasScoreIndicator,this.tweetArticle=null,this.indicatorElement=null,this.tooltipElement=null,this.pinButton=null,this.copyButton=null,this.tooltipCloseButton=null,this.reasoningToggle=null,this.scrollButton=null,this.conversationContainerElement=null,this.followUpQuestionsElement=null,this.customQuestionContainer=null,this.customQuestionInput=null,this.customQuestionButton=null,this.followUpImageContainer=null,this.followUpImageInput=null,this.uploadedImageDataUrls=[],this.refreshButton=null,this.rateButton=null,this.metadataDropdown=null,this.metadataToggle=null,this.metadataArrow=null,this.metadataContent=null,this.tooltipScrollableContentElement=null}ensureIndicatorAttached(){if(!this.indicatorElement)return;let t=this.findCurrentArticleElement();if(t&&this.indicatorElement.parentElement!==t){let e=window.getComputedStyle(t).position;"relative"!==e&&"absolute"!==e&&"fixed"!==e&&"sticky"!==e&&(t.style.position="relative"),t.appendChild(this.indicatorElement)}}findCurrentArticleElement(){let t=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(!t)return null;let e=`a[href*="/status/${this.tweetId}"]`,o=t.querySelector(e),i=o?.closest('article[data-testid="tweet"]');if(i&&Y(i)===this.tweetId)return i;let n=t.querySelectorAll('article[data-testid="tweet"]');for(let r of n)if(Y(r)===this.tweetId)return r;return null}updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:e,apiResponseContent:o,reviewSystemPrompt:i,followUpSystemPrompt:n,userInstructions:r=""}){let a=o.match(/<ANALYSIS>([\s\S]*?)<\/ANALYSIS>/),s=o.match(/<SCORE>\s*SCORE_(\d+)\s*<\/SCORE>/),l=tH(o);this.score=s?parseInt(s[1],10):null,this.description=a?a[1].trim():o,this.questions=l,this.status=null!==this.score?"rated":"error";let d=[{type:"text",text:t}];e.forEach(t=>{d.push({type:"image_url",image_url:{url:t}})});let c=n.replace("{USER_INSTRUCTIONS_PLACEHOLDER}",r||"Rate the tweet on a scale from 1 to 10 based on its clarity, insight, creativity, and overall quality.");this.qaConversationHistory=[{role:"system",content:[{type:"text",text:i}]},{role:"user",content:d},{role:"assistant",content:[{type:"text",text:o}]},{role:"system",content:[{type:"text",text:c}]}],this._updateIndicatorUI(),this._updateTooltipUI()}updateAfterFollowUp({assistantResponseContent:t,updatedQaHistory:e}){this.qaConversationHistory=e;let o=t.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/),i=tH(t),n=o?o[1].trim():t;if(this.questions=i,this.conversationHistory.length>0){let r=this.conversationHistory[this.conversationHistory.length-1];"pending"===r.answer&&(r.answer=n)}this._convertStreamingToDropdown(),this._updateTooltipUI()}_convertStreamingToDropdown(){if(!this.conversationContainerElement)return;let t=this.conversationContainerElement.querySelectorAll(".conversation-turn"),e=t.length>0?t[t.length-1]:null;if(!e)return;let o=e.querySelector(".streaming-reasoning-container");o&&o.remove();let i=this.conversationHistory.length>0?this.conversationHistory[this.conversationHistory.length-1]:null;if(!i||!i.reasoning||""===i.reasoning.trim())return;let n=e.querySelector(".reasoning-dropdown");if(!n){(n=document.createElement("div")).className="reasoning-dropdown conversation-reasoning";let r=document.createElement("div");r.className="reasoning-toggle";let a=document.createElement("span");a.className="reasoning-arrow",a.textContent="‚ñ∂",r.appendChild(a),r.appendChild(document.createTextNode(" Show Reasoning Trace"));let s=document.createElement("div");s.className="reasoning-content";let l=document.createElement("p");l.className="reasoning-text",s.appendChild(l),n.appendChild(r),n.appendChild(s);let d=e.querySelector(".conversation-answer");d?e.insertBefore(n,d):e.appendChild(n),r.addEventListener("click",t=>{t.stopPropagation();let e=t.target.closest(".reasoning-dropdown"),o=e?.querySelector(".reasoning-content"),i=e?.querySelector(".reasoning-arrow");if(!e||!o||!i)return;let n=e.classList.toggle("expanded");i.textContent=n?"‚ñº":"‚ñ∂",o.style.maxHeight=n?"200px":"0",o.style.padding=n?"8px":"0 8px"})}let c=n.querySelector(".reasoning-text");if(c){let p=tn("",i.reasoning).reasoning;c.innerHTML=p}n.style.display="block"}rehydrateFromCache(t){if(this.score=t.score,this.description=t.description,this.reasoning=t.reasoning,this.questions=t.questions||[],this.status=t.status||(null!==t.score?t.fromStorage?"cached":"rated":"error"),this.metadata=t.metadata||null,this.qaConversationHistory=t.qaConversationHistory||[],this.isPinned=t.isPinned||!1,this.conversationHistory=[],this.qaConversationHistory.length>0){let e=null,o=[],i=0;for(let n=0;n<this.qaConversationHistory.length;n++){if("system"===this.qaConversationHistory[n].role&&this.qaConversationHistory[n].content[0].text.includes("FOLLOW_UP_SYSTEM_PROMPT")){i=n+1;break}3===n&&"system"===this.qaConversationHistory[n].role&&(i=n+1)}for(let r=i;r<this.qaConversationHistory.length;r++){let a=this.qaConversationHistory[r];if("user"===a.role){let s=a.content.find(t=>"text"===t.type);e=s?s.text:"[Question not found]",o=a.content.filter(t=>"image_url"===t.type&&t.image_url&&t.image_url.url.startsWith("data:image")).map(t=>t.image_url.url)}else if("assistant"===a.role&&e){let l=a.content.find(t=>"text"===t.type),d=l?l.text:"[Answer not found]",c=d.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/),p=c?c[1].trim():d;this.conversationHistory.push({question:e,answer:p,uploadedImages:o,reasoning:""}),e=null,o=[]}}}this.isPinned?(this.pinButton.innerHTML="\uD83D\uDCCD",this.tooltipElement?.classList.add("pinned")):(this.pinButton.innerHTML="\uD83D\uDCCC",this.tooltipElement?.classList.remove("pinned")),this._updateIndicatorUI(),this._updateTooltipUI()}_handleMetadataToggleClick(t){if(t&&t.stopPropagation(),!this.metadataDropdown||!this.metadataContent||!this.metadataArrow)return;let e=this.tooltipScrollableContentElement?.scrollTop||0,o=this.metadataDropdown.classList.toggle("expanded");this.metadataArrow.textContent=o?"‚ñº":"‚ñ∂",o?(this.metadataContent.style.maxHeight="300px",this.metadataContent.style.padding="10px"):(this.metadataContent.style.maxHeight="0",this.metadataContent.style.padding="0 10px"),J()&&this.tooltipScrollableContentElement&&requestAnimationFrame(()=>{this.tooltipScrollableContentElement&&(this.tooltipScrollableContentElement.scrollTop=e)})}_handleRefreshClick(t){if(t&&t.stopPropagation(),!this.tweetId)return;window.activeStreamingRequests&&window.activeStreamingRequests[this.tweetId]&&(window.activeStreamingRequests[this.tweetId].abort(),delete window.activeStreamingRequests[this.tweetId]),a.has(this.tweetId)&&a.delete(this.tweetId),v.has(this.tweetId)&&v.delete(this.tweetId);let e=this.findCurrentArticleElement();this.destroy(),e&&"function"==typeof t_&&t_(e)}_handleRateClick(t){if(t&&t.stopPropagation(),!this.tweetId)return;this.update({status:"pending",score:null,description:"Rating tweet...",reasoning:"",questions:[]});let e=this.findCurrentArticleElement();e&&"function"==typeof t_&&(v.has(this.tweetId)&&v.delete(this.tweetId),t_(e,!0))}_handleConversationScroll(){if(!this.conversationContainerElement)return;let t=this.conversationContainerElement.scrollHeight-this.conversationContainerElement.scrollTop-this.conversationContainerElement.clientHeight<40;t?this.autoScrollConversation||(this.autoScrollConversation=!0):this.autoScrollConversation&&(this.autoScrollConversation=!1)}_performConversationAutoScroll(){this.conversationContainerElement&&this.autoScrollConversation&&requestAnimationFrame(()=>{this.conversationContainerElement.scrollTo({top:this.conversationContainerElement.scrollHeight,behavior:"instant"})})}}let ti={managers:new Map,get(t,e=null){if(!t)return console.error("[Registry] Attempted to get instance with invalid tweetId:",t),null;if(this.managers.has(t)){let o=this.managers.get(t);return o}if(e)try{let i=e.querySelector(`.score-indicator[data-tweet-id="${t}"]`),n=document.querySelector(`.score-description[data-tweet-id="${t}"]`);return(i||n)&&(console.warn(`[Registry] Found existing indicator/tooltip elements for tweet ${t} outside registry. Removing them before creating new manager.`),i?.remove(),n?.remove()),new to(e)}catch(r){console.error(`[Registry] Error creating ScoreIndicator for ${t}:`,r)}return null},add(t,e){this.managers.has(t)&&console.warn(`[Registry] Overwriting existing manager for tweet ${t}. This may indicate an issue.`),this.managers.set(t,e)},remove(t){this.managers.has(t)&&this.managers.delete(t)},cleanupOrphaned(){let t=0,e=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(!e)return;let o=new Set;for(let[i,n]of(e.querySelectorAll('article[data-testid="tweet"]').forEach(t=>{let e=Y(t);e&&o.add(e)}),this.managers.entries())){let r=n.indicatorElement?.isConnected,a=o.has(i);(!r||!a)&&(n.destroy(),t++)}},destroyAll(){console.log(`[Registry] Destroying all ${this.managers.size} indicators.`),[...this.managers.values()].forEach(t=>t.destroy()),this.managers.clear()}};function tn(t="",e=""){let o="*Waiting for analysis...*"===t?t:(t||"*waiting for content...*").replace(/```([\s\S]*?)```/g,(t,e)=>`<pre><code>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="ai-generated-link">$1</a>').replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^#### (.*$)/gm,"<h4>$1</h4>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/SCORE_(\d+)/g,'<span class="score-highlight">SCORE: $1</span>').replace(/^\|(.+)\|\r?\n\|([\s\|\-:]+)\|\r?\n(\|(?:.+)\|\r?\n?)+/gm,t=>{let e=t.trim().split("\n"),o=e[0];e[1];let i=e.slice(2),n='<table class="markdown-table">';return n+="<thead><tr>",o.slice(1,-1).split("|").forEach(t=>{n+=`<th>${t.trim()}</th>`}),n+="</tr></thead>",n+="<tbody>",i.forEach(t=>{t.trim()&&(n+="<tr>",t.slice(1,-1).split("|").forEach(t=>{n+=`<td>${t.trim()}</td>`}),n+="</tr>")}),n+="</tbody></table>"}).replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>"),i="";return e&&e.trim()&&(i=e.replace(/\\n/g,"\n").replace(/```([\s\S]*?)```/g,(t,e)=>`<pre><code>${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="ai-generated-link">$1</a>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>")),{description:o,reasoning:i}}function tr(t,e,o,i){if(!t||!e)return;let n=t.classList.contains("hidden");if(e.innerHTML=n?o:i,n?(t.style.display="flex",t.offsetHeight,t.classList.remove("hidden")):(t.classList.add("hidden"),setTimeout(()=>{t.classList.contains("hidden")&&(t.style.display="none")},500)),"settings-container"===t.id&&"settings-toggle"===e.id&&(J()&&t.classList.contains("hidden")?e.style.opacity="0.3":e.style.opacity=""),"tweet-filter-container"===t.id){let r=document.getElementById("filter-toggle");r&&(n?r.style.display="none":setTimeout(()=>{r.style.display="block"},500))}}function ta(){(J()||confirm("Are you sure you want to clear all cached tweet ratings?"))&&(a.clear(!0),_=0,window.threadRelationships&&(window.threadRelationships={},o("threadRelationships","{}"),console.log("Cleared thread relationships cache")),Z("All cached ratings and thread relationships cleared!"),console.log("Cleared all tweet ratings and thread relationships"),x&&x.querySelectorAll('article[data-testid="tweet"]').forEach(t=>{t.removeAttribute("data-sloppiness-score"),t.removeAttribute("data-rating-status"),t.removeAttribute("data-rating-description"),t.removeAttribute("data-cached-rating");let e=t.querySelector(".score-indicator");e&&e.remove();let o=Y(t);if(o){v.delete(o);let i=ti.get(o);i&&i.destroy(),t_(t)}}),document.querySelectorAll('div[aria-label="Timeline: Conversation"], div[aria-label^="Timeline: Conversation"]').forEach(t=>{delete t.dataset.threadMapping,delete t.dataset.threadMappedAt,delete t.dataset.threadMappingInProgress,delete t.dataset.threadHist,delete t.dataset.threadMediaUrls}))}function ts(t,e){let i;if(i="checkbox"===t.type?t.checked:t.value,void 0!==window[e]&&(window[e]=i),o(e,i),"enableImageDescriptions"===e){let n=document.getElementById("image-model-container");n&&(n.style.display=i?"block":"none"),Z("Image descriptions "+(i?"enabled":"disabled"))}"enableWebSearch"===e&&Z("Web search for rating model "+(i?"enabled":"disabled")),"enableAutoRating"===e&&Z("Auto-rating "+(i?"enabled":"disabled"))}function tl(){document.querySelectorAll("[data-setting]").forEach(t=>{let o=t.dataset.setting,i=e(o,window[o]);"checkbox"===t.type?(t.checked=i,ts(t,o)):t.value=i}),document.querySelectorAll(".parameter-row[data-param-name]").forEach(t=>{let o=t.dataset.paramName,i=t.querySelector(".parameter-slider"),n=t.querySelector(".parameter-value"),r=e(o,window[o]);i&&(i.value=r),n&&(n.value=r)});let t=document.getElementById("tweet-filter-slider"),o=document.getElementById("tweet-filter-value"),i=e("filterThreshold","5");if(t&&o){t.value=i,o.value=i;let n=parseInt(i,10)/10*100;t.style.setProperty("--slider-percent",`${n}%`)}td(document.getElementById("handle-list")),tc(),document.querySelectorAll(".advanced-content").forEach(t=>{t.classList.contains("expanded")||(t.style.maxHeight="0")}),document.querySelectorAll(".advanced-toggle-icon.expanded").forEach(t=>{t.closest(".advanced-toggle")?.nextElementSibling?.classList.contains("expanded")||t.classList.remove("expanded")}),te()}function td(t){if(t){if(t.innerHTML="",0===q.length){let e=document.createElement("div");e.style.cssText="padding: 8px; opacity: 0.7; font-style: italic;",e.textContent="No handles added yet",t.appendChild(e);return}q.forEach(e=>{let o=document.createElement("div");o.className="handle-item";let i=document.createElement("div");i.className="handle-text",i.textContent="@"+e,o.appendChild(i);let n=document.createElement("button");n.className="remove-handle",n.textContent="\xd7",n.title="Remove from list",o.appendChild(n),t.appendChild(o)})}}function tc(){let t=document.getElementById("model-select-container"),i=document.getElementById("image-model-select-container");C=[...S],T||(C=C.filter(t=>!t.slug.endsWith(":free")));let n=e("sortDirection","default"),r=e("modelSortOrder","throughput-high-to-low"),a=document.getElementById("sort-direction");if(a)switch(r){case"latency-low-to-high":default:a.textContent="default"===n?"High-Low":"Low-High","reverse"===n&&C.reverse();break;case"":a.textContent="default"===n?"New-Old":"Old-New","reverse"===n&&C.reverse();break;case"top-weekly":a.textContent="default"===n?"Most Popular":"Least Popular","reverse"===n&&C.reverse()}if(t&&(t.innerHTML="",tu(t,"model-selector",C.map(t=>({value:t.endpoint?.model_variant_slug||t.id,label:tp(t)})),I,t=>{o("selectedModel",I=t),Z("Rating model updated")},"Search rating models...")),i){let s=C.filter(t=>t.input_modalities?.includes("image")||t.architecture?.input_modalities?.includes("image")||t.architecture?.modality?.includes("image"));i.innerHTML="",tu(i,"image-model-selector",s.map(t=>({value:t.endpoint?.model_variant_slug||t.id,label:tp(t)})),k,t=>{o("selectedImageModel",k=t),Z("Image model updated")},"Search vision models...")}}function tp(t){let e=t.endpoint?.model_variant_slug||t.id||t.name||"Unknown Model",o="",i=t.endpoint?.pricing||t.pricing;if(i){let n=parseFloat(i.prompt),r=parseFloat(i.completion);isNaN(n)?isNaN(r)||(o+=` - $${(1e6*r).toFixed(4)}/mil. tok.-out`):(o+=` - $${(1e6*n).toFixed(4)}/mil. tok.-in`,isNaN(r)||r===n||(o+=` $${(1e6*r).toFixed(4)}/mil. tok.-out`))}let a=t.input_modalities?.includes("image")||t.architecture?.input_modalities?.includes("image")||t.architecture?.modality?.includes("image");return a&&(e="\uD83D\uDDBCÔ∏è "+e),e+o}function tu(t,e,o,i,n,r){let a=i,s=document.createElement("div");s.className="custom-select",s.id=e;let l=document.createElement("div");l.className="select-selected";let d=document.createElement("div");d.className="select-items",d.style.display="none";let c=document.createElement("div");c.className="search-field";let p=document.createElement("input");function u(t=""){for(;d.childNodes.length>1;)d.removeChild(d.lastChild);let e=o.filter(e=>e.label.toLowerCase().includes(t.toLowerCase()));if(0===e.length){let i=document.createElement("div");i.textContent="No matches found",i.style.cssText="opacity: 0.7; font-style: italic; padding: 10px; text-align: center; cursor: default;",d.appendChild(i)}e.forEach(t=>{let e=document.createElement("div");e.textContent=t.label,e.dataset.value=t.value,t.value===a&&e.classList.add("same-as-selected"),e.addEventListener("click",e=>{e.stopPropagation(),a=t.value,l.textContent=t.label,d.style.display="none",l.classList.remove("select-arrow-active"),d.querySelectorAll("div[data-value]").forEach(t=>{t.classList.toggle("same-as-selected",t.dataset.value===a)}),n(a)}),d.appendChild(e)})}p.type="text",p.className="search-input",p.placeholder=r||"Search...",c.appendChild(p),d.appendChild(c);let h=o.find(t=>t.value===a);l.textContent=h?h.label:"Select an option",s.appendChild(l),s.appendChild(d),t.appendChild(s),u(),p.addEventListener("input",()=>u(p.value)),p.addEventListener("click",t=>t.stopPropagation()),l.addEventListener("click",t=>{t.stopPropagation(),th(s);let e="none"===d.style.display;d.style.display=e?"block":"none",l.classList.toggle("select-arrow-active",e),e&&(p.focus(),p.select(),u(p.value))})}function th(t=null){document.querySelectorAll(".custom-select").forEach(e=>{if(e===t)return;let o=e.querySelector(".select-items"),i=e.querySelector(".select-selected");o&&(o.style.display="none"),i&&i.classList.remove("select-arrow-active")})}function tg(t=!1){if(t||confirm("Are you sure you want to reset all settings to their default values? This will not clear your cached ratings, blacklisted handles, or instruction history.")){a.clear();let e={selectedModel:"openai/gpt-4.1-nano",selectedImageModel:"openai/gpt-4.1-nano",enableImageDescriptions:!1,enableStreaming:!0,enableWebSearch:!1,enableAutoRating:!0,modelTemperature:.5,modelTopP:.9,imageModelTemperature:.5,imageModelTopP:.9,maxTokens:0,filterThreshold:5,userDefinedInstructions:"Rate the tweet on a scale from 1 to 10 based on its clarity, insight, creativity, and overall quality.",modelSortOrder:"throughput-high-to-low",sortDirection:"default"};for(let i in e)void 0!==window[i]&&(window[i]=e[i]),o(i,e[i]);tl(),tU(),Z("Settings reset to defaults")}}function tm(t){var o;let i=t.closest('div[data-testid="cellInnerDiv"]');if(!i){console.warn("Couldn't find cellInnerDiv for tweet");return}let n=X(t),r=n.length>0?n[0]:"",s=r&&(o=r,!!o&&(o=o.toLowerCase().trim(),q.some(t=>t.toLowerCase().trim()===o))),l=W(t)||"",d=function t(e){if(!e)return[];let o=new Set,i=`${B}, [data-testid="tweetPhoto"] img, img[src*="pbs.twimg.com/media"]`,n=`${F}, [poster*="pbs.twimg.com"], video`,r=`${i}, ${n}`,a=e.querySelectorAll(r);return 0===a.length&&e.matches(D)&&(a=e.querySelectorAll('img[src*="pbs.twimg.com"], video[poster*="pbs.twimg.com"]')),a.forEach(t=>{if("VIDEO"===t.tagName){let e=t.getAttribute("aria-label");if(e&&e.trim())o.add(`[VIDEO_DESCRIPTION]: ${e.trim()}`);else{let i=t.poster;if(i&&i.includes("pbs.twimg.com/")&&!i.includes("profile_images"))try{let n=new URL(i),r=n.searchParams.get("name"),a=i;r&&"orig"!==r&&(a=i.replace(`name=${r}`,"name=small")),o.add(a)}catch(s){o.add(i)}}}else if("IMG"===t.tagName){let l=t.src;if(!l||!l.includes("pbs.twimg.com/")||l.includes("profile_images"))return;try{let d=new URL(l),c=d.searchParams.get("name"),p=l;c&&"orig"!==c&&(p=l.replace(`name=${c}`,"name=small")),o.add(p)}catch(u){o.add(l)}}}),Array.from(o)}(t),c=Y(t);i.dataset.tweetText=l,i.dataset.authorHandle=r,i.dataset.mediaUrls=JSON.stringify(d),i.dataset.tweetId=c;let p={authorHandle:r,individualTweetText:l,individualMediaUrls:d,timestamp:Date.now()};if(a.set(c,p,!1),r&&y.has(r)){let u=Y(t);u&&ti.get(u)?.destroy(),i.innerHTML="",i.dataset.filtered="true",i.dataset.isAd="true";return}let h=parseInt(t.dataset.slopScore||"9",10),g=Y(t),m=ti.get(g,t);m?.ensureIndicatorAttached();let f=parseInt(e("filterThreshold","1")),b=t.dataset.ratingStatus;if(m&&(m.isAuthorBlacklisted=s),s)delete i.dataset.filtered,i.dataset.authorBlacklisted="true",m&&m._updateIndicatorUI();else if(delete i.dataset.authorBlacklisted,"pending"===b||"streaming"===b)delete i.dataset.filtered;else if(isNaN(h)||h<f){let $=ti.get(g,t);$&&$.destroy(),i.innerHTML="",i.dataset.filtered="true"}else delete i.dataset.filtered,m&&m._updateIndicatorUI()}async function tf(t){let e=Y(t),o=X(t);o.length>0&&o[0];let i=a.get(e);if(i){if(!0===i.streaming&&(void 0===i.score||null===i.score))return!1;if(void 0!==i.score&&null!==i.score){t.dataset.slopScore=i.score.toString(),t.dataset.ratingStatus=i.fromStorage?"cached":"rated",t.dataset.ratingDescription=i.description||"not available",t.dataset.ratingReasoning=i.reasoning||"";let n=ti.get(e,t);return n?(n.rehydrateFromCache(i),tm(t),!0):(console.warn(`[applyTweetCachedRating] Could not get/create ScoreIndicator for ${e} to apply cached rating.`),!1)}i.streaming||(console.warn(`Invalid cache entry for tweet ${e}: missing score`),a.delete(e))}return!1}let tb=["rated","cached","blacklisted","manual"],t$=["pending","streaming"],tv=new Map;function ty(t){return tb.includes(t)}function tw(t){return t$.includes(t)}async function tx(t,o,i){let n=!1;try{let r=e("openrouter-api-key","");if(!r){t.dataset.ratingStatus="error",t.dataset.ratingDescription="No API key",ti.get(o,t)?.update({status:"error",score:9,description:"No API key",questions:[],lastAnswer:""}),tm(t);return}if(i&&y.has(i)){t.dataset.ratingStatus="rated",t.dataset.ratingDescription="Advertisement",t.dataset.slopScore="0",ti.get(o,t)?.update({status:"rated",score:0,description:"Advertisement from known ad author",questions:[],lastAnswer:""}),tm(t),n=!0;return}if(K(t)){i&&y.add(i),t.dataset.ratingStatus="rated",t.dataset.ratingDescription="Advertisement",t.dataset.slopScore="0",ti.get(o,t)?.update({status:"rated",score:0,description:"Advertisement",questions:[],lastAnswer:""}),tm(t),n=!0;return}let s=5,l="",d="",c=[],p="";try{let u=a.get(o);u&&(!0===u.streaming&&(void 0===u.score||null===u.score)?console.log(`Tweet ${o} has incomplete streaming cache entry, continuing with processing`):u.streaming||void 0!==u.score&&null!==u.score||(console.warn(`Invalid cache entry for tweet ${o}, removing from cache`,u),a.delete(o)));let h=await tC(t,o,r);if(!h)throw Error("Failed to get tweet context");let g=[];if(document.querySelector('div[aria-label="Timeline: Conversation"]')){let m=t8(o);m&&m.replyTo&&(a.has(o)||a.set(o,{}),a.get(o).threadContext||(a.get(o).threadContext={replyTo:m.to,replyToId:m.replyTo,isRoot:!1}))}let f=h.matchAll(/(?:\[MEDIA_URLS\]:\s*\n)(.*?)(?:\n|$)/g),b=h.matchAll(/(?:\[QUOTED_TWEET_MEDIA_URLS\]:\s*\n)(.*?)(?:\n|$)/g),$=h.matchAll(/(?:\[VIDEO_DESCRIPTIONS\]:\s*\n)([\s\S]*?)(?:\n\[|$)/g),w=h.matchAll(/(?:\[QUOTED_TWEET_VIDEO_DESCRIPTIONS\]:\s*\n)([\s\S]*?)(?:\n\[|$)/g);for(let x of f)x[1]&&g.push(...x[1].split(", ").filter(t=>t.trim()));for(let E of b)E[1]&&g.push(...E[1].split(", ").filter(t=>t.trim()));for(let _ of $)if(_[1]){let S=_[1].trim().split("\n").filter(t=>t.trim());S.forEach(t=>{if(t.startsWith("[VIDEO ")){let e=t.replace(/^\[VIDEO \d+\]: /,"");g.push(`[VIDEO_DESCRIPTION]: ${e}`)}})}for(let C of w)if(C[1]){let k=C[1].trim().split("\n").filter(t=>t.trim());k.forEach(t=>{if(t.startsWith("[VIDEO ")){let e=t.replace(/^\[VIDEO \d+\]: /,"");g.push(`[VIDEO_DESCRIPTION]: ${e}`)}})}g=[...new Set(g.filter(t=>t.trim()))];let T=t.querySelector('div[data-testid="tweetPhoto"], div[data-testid="videoPlayer"]'),A=e("enableImageDescriptions",!1);if(T&&0===g.length&&(A||z(I))){let q=`Tweet ${o}: Potential media containers found in DOM, but no media content (URLs or video descriptions) was extracted by getFullContext. Forcing error for retry.`;throw console.warn(q),Error("Media content not extracted despite presence of media containers.")}if(h)try{let L=a.get(o),U=L&&!L.streaming&&void 0!==L.score&&null!==L.score;if(U){s=L.score,l=L.description||"",d=L.reasoning||"",c=L.questions||[],p=L.lastAnswer||"";let R=L.mediaUrls||[];n=!0,console.log(`Using valid cache entry found for ${o} before API call.`),ti.get(o,t)?.update({status:L.fromStorage?"cached":"rated",score:s,description:l,reasoning:d,questions:c,lastAnswer:p,metadata:L.metadata||null,mediaUrls:R}),tm(t);return}let O=g.filter(t=>!t.startsWith("[VIDEO_DESCRIPTION]:")),H=await tN(h,o,r,O,3,t,i);s=H.score,l=H.content,d=H.reasoning||"",c=H.questions||[],p="";let N=H.error?"error":"rated";if(!H.error){let M=a.get(o);M&&M.fromStorage?N="cached":H.cached&&(N="cached")}t.dataset.ratingStatus=N,t.dataset.ratingDescription=l||"not available",t.dataset.slopScore=s?.toString()||"",t.dataset.ratingReasoning=d,ti.get(o,t)?.update({status:N,score:s,description:l,reasoning:d,questions:c,lastAnswer:p,metadata:H.data?.id?{generationId:H.data.id}:null,mediaUrls:g}),n=!H.error,tm(t);return}catch(P){console.error(`API error processing tweet ${o}:`,P),s=5,l=`API Error: ${P.message}`,d="",c=[],p="",n=!1,ti.get(o,t)?.update({status:"error",score:s,description:l,questions:[],lastAnswer:""});let D=a.get(o)||{},Q={...D,score:s,description:l,reasoning:d,questions:c,lastAnswer:p,streaming:!1,timestamp:Date.now()};a.set(o,Q,!0),tm(t);return}tm(t)}catch(B){console.error(`Generic error processing tweet ${o}: ${B}`,B.stack),"Media content not extracted despite presence of media containers."===B.message&&a.has(o)&&(a.delete(o),console.log(`[delayedProcessTweet] Deleted cache for ${o} due to media extraction failure.`)),ti.get(o,t)?.update({status:"error",score:5,description:"Error during processing: "+B.message,questions:[],lastAnswer:""}),tm(t),n=!1}finally{n||v.delete(o)}}catch(F){console.error(`Error processing tweet ${o}:`,F);let W=ti.get(o);W&&W.update({status:"error",score:5,description:"Error during processing: "+F.message,questions:[],lastAnswer:""}),tm(t),n=!1}finally{if(!n){v.delete(o);let Y=ti.get(o);Y&&!ty(Y.status)&&(console.log(`Tweet ${o} processing failed, will retry later`),setTimeout(()=>{ty(ti.get(o)?.status)||t_(t)},2))}}}let tE=new Set;async function t_(t,o=!1){let i=Y(t);if(!i)return;if(window.activeStreamingRequests&&window.activeStreamingRequests[i]){console.log(`Tweet ${i} has an active streaming request, skipping processing`);return}let n=X(t),r=n.length>0?n[0]:"";if(r&&y.has(r)){tm(t);return}if(K(t)){r&&y.add(r),tm(t);return}let s=ti.get(i);if(s){if(s.ensureIndicatorAttached(),ty(s.status)||tw(s.status)&&v.has(i)){tm(t);return}v.delete(i)}let l=document.querySelector('div[aria-label="Timeline: Conversation"]')||document.querySelector('div[aria-label^="Timeline: Conversation"]');if(l){if(!l.dataset.threadMapping){console.log(`[scheduleTweetProcessing] Tweet ${i} waiting for thread mapping`),tE.add(i);let d=ti.get(i,t);d&&d.update({status:"pending",score:null,description:"Waiting for thread context...",questions:[],lastAnswer:""});return}try{let c=JSON.parse(l.dataset.threadMapping),p=c.find(t=>t.tweetId===i);if(!p){console.log(`[scheduleTweetProcessing] Tweet ${i} not found in thread mapping, waiting`),tE.add(i);let u=ti.get(i,t);u&&u.update({status:"pending",score:null,description:"Waiting for thread context...",questions:[],lastAnswer:""});return}}catch(h){console.error("Error parsing thread mapping:",h)}}if(a.has(i)){let g=!0===a.get(i).streaming&&(void 0===a.get(i).score||null===a.get(i).score);if(!g){let m=await tf(t);if(m)return}}if(v.has(i)){let f=ti.get(i);if(f&&(f.ensureIndicatorAttached(),"pending"===f.status||"streaming"===f.status)){tm(t);return}v.delete(i)}let b=ti.get(i,t);if(b){if("blacklisted"!==b.status&&"cached"!==b.status&&"rated"!==b.status)b.update({status:"pending",score:null,description:"Rating scheduled...",questions:[],lastAnswer:""});else{b.ensureIndicatorAttached(),tm(t);return}}else console.error(`Failed to get/create indicator instance for tweet ${i} during scheduling.`);v.has(i)||v.add(i),setTimeout(()=>{try{if(!e("enableAutoRating",!0)&&!o){let n=ti.get(i,t);n&&(n.update({status:"manual",score:null,description:"Click the Rate button to rate this tweet",reasoning:"",questions:[],lastAnswer:""}),tm(t));return}tx(t,i,r)}catch(a){console.error(`Error in delayed processing of tweet ${i}:`,a),v.delete(i)}},1)}let t3={},tS=!1;async function t0(t,e=1/0){if(!t||e<=0)return[];let o=[],i=t,n=0;for(;i&&n<e;){let r=t3[i];if(!r||!r.replyTo)break;o.push({fromId:i,toId:r.replyTo,from:r.from,to:r.to}),i=r.replyTo,n++}return o}async function tC(t,o,i){if(tv.has(o))return tv.get(o);let n=(async()=>{try{let n=X(t),r=n.length>0?n[0]:"",s=n.length>1?n[1]:"",l=W(t),d=await V(t),c="",p=[],u=null,h=t.querySelector(D);if(h){let g=h.querySelector('a[href*="/status/"]');if(g){let m=g.getAttribute("href"),f=m.match(/\/status\/(\d+)/);f&&f[1]&&(u=f[1])}c=function t(e){if(!e)return"";let o=e instanceof NodeList?Array.from(e):[e];for(let i of o){let n=i?.textContent?.trim();if(n)return n}return""}(h.querySelector(Q))||"",p=await V(h)}let b=document.querySelector('div[aria-label="Timeline: Conversation"]')||document.querySelector('div[aria-label^="Timeline: Conversation"]'),$=[];if(b&&b.dataset.threadMapping&&a.has(o)&&a.get(o).threadContext?.threadMediaUrls)$=a.get(o).threadContext.threadMediaUrls||[];else if(b&&b.dataset.threadMediaUrls)try{let v=JSON.parse(b.dataset.threadMediaUrls);$=Array.isArray(v)?v:[]}catch(y){console.error("Error parsing thread media URLs:",y)}let w=[...d||[]].filter(t=>!p.includes(t)),x=[],E=[];w.forEach(t=>{t.startsWith("[VIDEO_DESCRIPTION]:")?E.push(t.replace("[VIDEO_DESCRIPTION]: ","")):x.push(t)});let _="",S=t.querySelector('div[role="group"][aria-label$=" views"]');S&&(_=S.getAttribute("aria-label")?.trim()||"");let C=`[TWEET ${o}]
 Author:@${r}:
`+l;if(E.length>0&&(C+=`
[VIDEO_DESCRIPTIONS]:
${E.map((t,e)=>`[VIDEO ${e+1}]: ${t}`).join("\n")}`),x.length>0){if(e("enableImageDescriptions",!1)){let I=await tR(x,i,o,r);C+=`
[MEDIA_DESCRIPTION]:
${I}`}C+=`
[MEDIA_URLS]:
${x.join(", ")}`}if(_&&(C+=`
[ENGAGEMENT_STATS]:
${_}`),!j(t)&&$.length>0){let k=$.filter(t=>!w.includes(t)&&!p.includes(t));k.length>0&&(C+=`
[THREAD_MEDIA_URLS]:
${k.join(", ")}`)}if((c||p.length>0)&&(C+=`
[QUOTED_TWEET${u?" "+u:""}]:
 Author:@${s}:
${c}`,p.length>0)){let T=[],A=[];if(p.forEach(t=>{t.startsWith("[VIDEO_DESCRIPTION]:")?A.push(t.replace("[VIDEO_DESCRIPTION]: ","")):T.push(t)}),A.length>0&&(C+=`
[QUOTED_TWEET_VIDEO_DESCRIPTIONS]:
${A.map((t,e)=>`[VIDEO ${e+1}]: ${t}`).join("\n")}`),T.length>0){if(e("enableImageDescriptions",!1)){let q=await tR(T,i,o,r);C+=`
[QUOTED_TWEET_MEDIA_DESCRIPTION]:
${q}`}C+=`
[QUOTED_TWEET_MEDIA_URLS]:
${T.join(", ")}`}}let L=document.querySelector('div[aria-label="Timeline: Conversation"], div[aria-label^="Timeline: Conversation"]');if(L){let U=await t0(o),R=!1;if(L.dataset.threadHist&&!j(t)&&(C=L.dataset.threadHist+`
[REPLY]
`+C,R=!0),U.length>0&&!R){let O="",H=null;for(let N=U.length-1;N>=0;N--){let M=U[N],B=M.toId,F=M.to||"unknown",z=null,G=a.get(B);if(G&&G.individualTweetText)z=`[TWEET ${B}]
 Author:@${G.authorHandle||F}:
${G.individualTweetText}`,G.individualMediaUrls&&G.individualMediaUrls.length>0&&(z+=`
[MEDIA_URLS]:
${G.individualMediaUrls.join(", ")}`);else{let K=Array.from(document.querySelectorAll(P)).find(t=>Y(t)===B);if(K){let J=t3[B];delete t3[B];try{z=await tC(K,B,i)}finally{J&&(t3[B]=J)}}}if(H&&(O+=`
[REPLY TO @${H}]
`),z){let Z=z.lastIndexOf("[TWEET ");Z>0&&(z=z.substring(Z)),O+=z}else O+=`[CONTEXT UNAVAILABLE FOR TWEET ${B} @${F}]`;H=F}H&&(O+=`
[REPLY TO @${H}]
`),C=O+C}let tt=t8(o);tt&&tt.to&&!R&&0===U.length&&(C=`[REPLY TO @${tt.to}]
`+C)}t.dataset.fullContext=C;let te=a.get(o)||{},to={...te,fullContext:C,timestamp:te.timestamp||Date.now()};return void 0===te.score&&null===to.score&&(to.score=void 0),a.set(o,to,!1),C}finally{tv.delete(o)}})();return tv.set(o,n),n}function tI(){if(!x)return;let t=x.querySelectorAll(P);t.forEach(tm)}async function tk(){try{let t=document.querySelector('div[aria-label="Timeline: Conversation"]');if(t||(t=document.querySelector('div[aria-label^="Timeline: Conversation"]')),!t||tS||"true"===t.dataset.threadMappingInProgress)return;let e=parseInt(t.dataset.threadMappedAt||"0",10);if(Date.now()-e<1e3)return;let o=location.pathname.match(/status\/(\d+)/),i=o?o[1]:null;if(!i)return;let n=i;for(;t3[n]&&t3[n].replyTo;)n=t3[n].replyTo;await tT(t,n)}catch(r){console.error("Error in handleThreads:",r),tS=!1}}async function tT(t,e){if(!tS&&!t.dataset.threadMappingInProgress){t.dataset.threadMappingInProgress="true",tS=!0;try{let i=new Promise((t,e)=>setTimeout(()=>e(Error("Thread mapping timed out")),1e3)),n=async()=>{let e=location.pathname.match(/status\/(\d+)/),i=e?e[1]:null,n=Array.from(t.querySelectorAll('div[data-testid="cellInnerDiv"]'));if(!n.length){console.log("No cell divs found, thread mapping aborted"),delete t.dataset.threadMappingInProgress,tS=!1;return}n.forEach((t,e)=>{t.dataset.tweetId,t.dataset.authorHandle}),n.sort((t,e)=>{let o=parseInt(t.style.transform.match(/translateY\((\d+)/)?.[1]||"0"),i=parseInt(e.style.transform.match(/translateY\((\d+)/)?.[1]||"0");return o-i}),n.forEach((t,e)=>{t.dataset.tweetId,t.dataset.authorHandle});let s=[],l=0,d=-1;for(let c=0;c<n.length;c++){let p=n[c],u,h,g,m=[],f=[],b=p.querySelector('article[data-testid="tweet"]');if(b){if(!(u=Y(b))){let $=b.querySelector('a[href*="/status/"]');if($){let y=$.href.match(/status\/(\d+)/);y&&(u=y[1])}}let w=X(b);h=w.length>0?w[0]:null,g=W(b).replace(/\n+/g," ‚èé "),m=await V(b);let x=b.querySelector(D);x&&(f=await V(x))}if(!u&&p.dataset.tweetId&&(u=p.dataset.tweetId),!h&&p.dataset.authorHandle&&(h=p.dataset.authorHandle),!g&&p.dataset.tweetText&&(g=p.dataset.tweetText||""),(!m||!m.length)&&p.dataset.mediaUrls)try{m=JSON.parse(p.dataset.mediaUrls)}catch(E){m=[]}if(u&&h){let _={type:"tweet",tweetNode:b,username:h,tweetId:u,text:g,mediaLinks:m,quotedMediaLinks:f,cellIndex:c,cellDiv:p,index:l};s.push(_),u===i&&(d=s.length-1),l++,b&&!v.has(u)&&t_(b)}else s.push({type:"separator",cellDiv:p,cellIndex:c})}let S=-1!==d?s[d]:null,C=null;if(S)C={tweetId:S.tweetId,username:S.username};else if(i){let I=a.get(i);I&&I.authorHandle&&(C={tweetId:i,username:I.authorHandle})}let k=s.filter(t=>"tweet"===t.type);if(0===k.length){console.log("No valid tweets found, thread mapping aborted"),delete t.dataset.threadMappingInProgress,tS=!1;return}for(let T=0;T<s.length;++T){let A=s[T];if("separator"!==A.type){if(0===T)A.replyTo=null,A.replyToId=null,A.isRoot=!0;else{let q=s[T-1];"separator"===q.type?C&&A.tweetId!==C.tweetId?(A.replyTo=C.username,A.replyToId=C.tweetId,A.isRoot=!1):(C&&(A.tweetId,C.tweetId),A.replyTo=null,A.replyToId=null,A.isRoot=!0):"tweet"===q.type?(A.replyTo=q.username,A.replyToId=q.tweetId,A.isRoot=!1):(A.replyTo=null,A.replyToId=null,A.isRoot=!0)}}}let L=s.filter(t=>"tweet"===t.type).map(t=>({from:t.username,tweetId:t.tweetId,to:t.replyTo,toId:t.replyToId,isRoot:!0===t.isRoot,text:t.text,mediaLinks:t.mediaLinks||[],quotedMediaLinks:t.quotedMediaLinks||[]}));for(let U of(t.dataset.threadMapping=JSON.stringify(L),tE)){let R=L.find(t=>t.tweetId===U);if(R){let O=s.find(t=>t.tweetId===U)?.tweetNode;O&&(v.delete(U),t_(O))}}tE.clear();let H=Date.now();L.forEach(t=>{t.tweetId&&t.toId?t3[t.tweetId]={replyTo:t.toId,from:t.from,to:t.to,isRoot:!1,timestamp:H}:t.tweetId&&t.isRoot&&(t3[t.tweetId]={replyTo:null,from:t.from,isRoot:!0,timestamp:H})}),function t(){try{let e=Object.keys(t3).length;if(e>1e3){let i=Object.entries(t3);i.sort((t,e)=>(e[1].timestamp||0)-(t[1].timestamp||0));let n=i.slice(0,500);t3=Object.fromEntries(n)}o("threadRelationships",JSON.stringify(t3))}catch(r){console.error("Error saving thread relationships:",r)}}();for(let N=0;N<L.length;N+=10){let M=L.slice(N,N+10);M.forEach(t=>{if(t.tweetId&&a.has(t.tweetId)&&(a.get(t.tweetId).threadContext={replyTo:t.to,replyToId:t.toId,isRoot:t.isRoot,threadMediaUrls:t.isRoot?[]:r(t.tweetId,L)},t.tweetId&&v.has(t.tweetId))){let e=s.find(e=>e.tweetId===t.tweetId);if(e&&e.tweetNode){let o="streaming"===e.tweetNode.dataset.ratingStatus||a.has(t.tweetId)&&!0===a.get(t.tweetId).streaming;o||(v.delete(t.tweetId),t_(e.tweetNode))}}}),N+10<L.length&&await new Promise(t=>setTimeout(t,0))}delete t.dataset.threadMappingInProgress,tS=!1,t.dataset.threadMappedAt=Date.now().toString()};function r(t,e){let o=[],i=e.findIndex(e=>e.tweetId===t);if(i>0)for(let n=0;n<i;n++)e[n].mediaLinks&&e[n].mediaLinks.length&&o.push(...e[n].mediaLinks),e[n].quotedMediaLinks&&e[n].quotedMediaLinks.length&&o.push(...e[n].quotedMediaLinks);return o}await Promise.race([n(),i])}catch(s){console.error("Error in mapThreadStructure:",s),delete t.dataset.threadMappingInProgress,tS=!1}}}function t8(t){return t3[t]?t3[t]:null}async function tA(t,e,o=3e4){return new Promise(i=>{GM_xmlhttpRequest({method:"POST",url:"https://openrouter.ai/api/v1/chat/completions",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},data:JSON.stringify(t),timeout:o,onload:function(t){if(t.status>=200&&t.status<300)try{let e=JSON.parse(t.responseText);""===e.content&&i({error:!0,message:`No content returned${"SAFETY"==e.choices[0].native_finish_reason?" (SAFETY FILTER)":""}`,data:e}),i({error:!1,message:"Request successful",data:e})}catch(o){i({error:!0,message:`Failed to parse response: ${o.message}`,data:null})}else i({error:!0,message:`Request failed with status ${t.status}: ${t.responseText}`,data:null})},onerror:function(t){i({error:!0,message:`Request error: ${t.toString()}`,data:null})},ontimeout:function(){i({error:!0,message:`Request timed out after ${o}ms`,data:null})}})})}function tq(t,e,o,i,n,r=9e4,s=null){let l={...t,stream:!0},d="",c="",p="",u=null,h=!1;console.log(l);let g=GM_xmlhttpRequest({method:"POST",url:"https://openrouter.ai/api/v1/chat/completions",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},data:JSON.stringify(l),timeout:r,responseType:"stream",onloadstart:function(t){let e=t.response.getReader(),r=null,a=!1,l=()=>{r&&clearTimeout(r),r=setTimeout(()=>{console.log("Stream timed out after inactivity"),h||(h=!0,i({content:c,reasoning:p,fullResponse:d,data:u,timedOut:!0}))},3e4)},g=async()=>{try{let t=!1,g=0;for(;!t&&!h;){let{done:m,value:f}=await e.read();if(m){t=!0;break}a||(a=!0,l());let b=new TextDecoder().decode(f);if(clearTimeout(r),l(),""===b.trim()){if(++g>=3){t=!0;break}continue}g=0,d+=b;let $=b.split("\n");for(let v of $)if(v.startsWith("data: ")){let y=v.substring(6);if("[DONE]"===y){t=!0;break}try{let w=JSON.parse(y);if(u=w,w.choices&&w.choices[0]){if(w.choices[0].delta&&void 0!==w.choices[0].delta.content){let x=w.choices[0].delta.content||"";c+=x}if(w.choices[0].delta&&void 0!==w.choices[0].delta.reasoning){let E=w.choices[0].delta.reasoning||"";p+=E}o({chunk:w.choices[0].delta?.content||"",reasoningChunk:w.choices[0].delta?.reasoning||"",content:c,reasoning:p,data:w})}}catch(_){console.error("Error parsing SSE data:",_,y)}}}h||(h=!0,r&&clearTimeout(r),s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],i({content:c,reasoning:p,fullResponse:d,data:u}))}catch(S){console.error("Stream processing error:",S),r&&clearTimeout(r),h||(h=!0,s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Stream processing error: ${S.toString()}`,data:null}))}};g().catch(t=>{console.error("Unhandled stream error:",t),r&&clearTimeout(r),h||(h=!0,s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Unhandled stream error: ${t.toString()}`,data:null}))})},onerror:function(t){s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Request error: ${t.toString()}`,data:null})},ontimeout:function(){s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],n({error:!0,message:`Request timed out after ${r}ms`,data:null})}}),m={abort:function(){h=!0,_--;try{g.abort()}catch(t){console.error("Error aborting request:",t)}if(s&&window.activeStreamingRequests&&delete window.activeStreamingRequests[s],s&&a.has(s)){let e=a.get(s);e.streaming&&(void 0===e.score||null===e.score)&&a.delete(s)}}};return s&&window.activeStreamingRequests&&(window.activeStreamingRequests[s]=m),m}!function t(){try{let o=e("threadRelationships","{}");t3=JSON.parse(o),console.log(`Loaded ${Object.keys(t3).length} thread relationships`)}catch(i){console.error("Error loading thread relationships:",i),t3={}}}(),setInterval(tk,500),setInterval(function t(){if(document.querySelector('div[aria-label="Timeline: Conversation"]')||!e("enableAutoRating",!0)||!x)return;let o=x.querySelectorAll(P);o.length>0&&(console.log(`Checking ${o.length} tweets to ensure all are rated...`),o.forEach(t=>{let e=Y(t);if(!e)return;let o=ti.get(e),i=!o||!o.status||"error"===o.status||!ty(o.status)&&!tw(o.status)||v.has(e)&&!ty(o.status)&&!tw(o.status);i?(v.has(e)&&(console.log(`Tweet ${e} marked as processed but in invalid state: ${o?.status}`),v.delete(e)),t_(t)):o&&!tw(o.status)&&tm(t)}))},500),setInterval(tI,500);let tL=!1;function tU(){let t=e("openrouter-api-key","");if(!t){Z("Please enter your OpenRouter API key");return}Z("Fetching available models...");let o=e("modelSortOrder","throughput-high-to-low");function i(){Z("Back online. Fetching models..."),tU(),window.removeEventListener("online",i),tL=!1}GM_xmlhttpRequest({method:"GET",url:`https://openrouter.ai/api/frontend/models/find?order=${o}`,headers:{Authorization:`Bearer ${t}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532182-twitter-x-ai-tweet-filter","X-Title":"Tweet Rating Tool"},onload:function(t){try{let e=JSON.parse(t.responseText);if(e.data&&e.data.models){let i=e.data.models.filter(t=>t.endpoint&&null!==t.endpoint);i.forEach(t=>{let e=t.endpoint?.model_variant_slug||t.id;t.slug=e}),("latency-low-to-high"===o||"pricing-low-to-high"===o)&&i.reverse(),C=[...S=i||[]],tc(),Z("Models updated!")}}catch(n){console.error("Error parsing model list:",n),Z("Error parsing models list")}},onerror:function(t){console.error("Error fetching models:",t),navigator.onLine?Z("Error fetching models!"):tL?Z("Still offline. Waiting for connection to fetch models."):(Z("Offline. Will attempt to fetch models when connection returns."),window.addEventListener("online",i),tL=!0)}})}async function tR(t,o,i,n){let r=e("enableImageDescriptions",!1);if(!t?.length||!r)return r?"":"[Image descriptions disabled]";let a=[];for(let s of t){let l={model:k,messages:[{role:"user",content:[{type:"text",text:"Describe what you see in this image in a concise way, focusing on the main elements and any text visible. Keep the description under 100 words."},{type:"image_url",image_url:{url:s}}]}],temperature:H,top_p:N,max_tokens:M};k.includes("gemini")&&(l.config={safetySettings:tO}),A&&(l.provider={sort:A,allow_fallbacks:!0});let d=await tA(l,o);!d.error&&d.data?.choices?.[0]?.message?.content?a.push(d.data.choices[0].message.content):a.push("[Error getting image description]")}return a.map((t,e)=>`[IMAGE ${e+1}]: ${t}`).join("\n")}async function t9(t,e,o=1e4){return new Promise(i=>{GM_xmlhttpRequest({method:"GET",url:`https://openrouter.ai/api/v1/generation?id=${t}`,headers:{Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},timeout:o,onload:function(t){if(t.status>=200&&t.status<300)try{let e=JSON.parse(t.responseText);i({error:!1,message:"Metadata fetched successfully",data:e})}catch(o){i({error:!0,message:`Failed to parse metadata response: ${o.message}`,data:null})}else 404===t.status?i({error:!0,status:404,message:`Generation metadata not found (404): ${t.responseText}`,data:null}):i({error:!0,status:t.status,message:`Metadata request failed with status ${t.status}: ${t.responseText}`,data:null})},onerror:function(t){i({error:!0,message:`Metadata request error: ${t.toString()}`,data:null})},ontimeout:function(){i({error:!0,message:`Metadata request timed out after ${o}ms`,data:null})}})})}let tO=[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_CIVIC_INTEGRITY",threshold:"BLOCK_NONE"},];function tH(t){if(!t)return[];let e=[],o="Q_1.",i="Q_2.",n="Q_3.",r=t.indexOf(o),a=t.indexOf(i),s=t.indexOf(n);if(-1!==r&&a>r&&s>a){let l=t.substring(r+o.length,a).trim();e.push(l);let d=t.substring(a+i.length,s).trim();e.push(d);let c=t.substring(s+n.length).trim(),p="</FOLLOW_UP_QUESTIONS>";if(c.endsWith(p)&&(c=c.substring(0,c.length-p.length).trim()),e.push(c),e.every(t=>t.length>0))return e}return console.warn("[extractFollowUpQuestions] Failed to find or parse Q_1/Q_2/Q_3 markers."),[]}async function tN(t,o,i,n,r=3,s=null,l=""){console.log("given tweettext\n",t);let d=()=>{Z(`Rating tweet... (${_=Math.max(0,_-1)} pending)`)},c=ti.get(o,s);if(!c)return console.error(`[API rateTweetWithOpenRouter] Could not get/create ScoreIndicator for ${o}.`),{score:5,content:"Failed to initialize UI components for rating.",reasoning:"",questions:[],lastAnswer:"",error:!0,cached:!1,data:null,qaConversationHistory:[]};if(y.has(l))return c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:[],apiResponseContent:"<ANALYSIS>This tweet is from an ad author.</ANALYSIS><SCORE>SCORE_0</SCORE><FOLLOW_UP_QUESTIONS>Q_1. N/A\\nQ_2. N/A\\nQ_3. N/A</FOLLOW_UP_QUESTIONS>",reviewSystemPrompt:L,followUpSystemPrompt:U,userInstructions:p}),{score:0,content:c.description,reasoning:"",error:!1,cached:!1,questions:c.questions,qaConversationHistory:c.qaConversationHistory};let p=$.getCurrentInstructions(),u=e("enableWebSearch",!1)?`${I}:online`:I,h={model:u,messages:[{role:"system",content:[{type:"text",text:L+`
USER'S CUSTOM INSTRUCTIONS:
${p}`}]},{role:"user",content:[{type:"text",text:`<TARGET_TWEET_ID>[${o}]</TARGET_TWEET_ID>
<TWEET>[${t}]</TWEET>
Follow this expected response format exactly, or you break the UI:
EXPECTED_RESPONSE_FORMAT:

  <ANALYSIS>

    
(Your analysis according to the user instructions. Follow the user instructions EXACTLY.)
  </ANALYSIS>

  <SCORE>

    SCORE_X (Where X is a number between 0 and 10, unless the user requests a different range)

  </SCORE>

  <FOLLOW_UP_QUESTIONS>

    Q_1. ‚Ä¶

    Q_2. ‚Ä¶

    Q_3. ‚Ä¶

  </FOLLOW_UP_QUESTIONS>
`}]}],temperature:R,top_p:O,max_tokens:M};if(I.includes("gemini")&&(h.config={safetySettings:tO}),n?.length>0){let g=[],m=[];n.forEach(t=>{t.startsWith("[VIDEO_DESCRIPTION]:")?m.push(t):g.push(t)}),g.length>0&&z(I)&&g.forEach(t=>{t.startsWith("data:application/pdf")?h.messages[1].content.push({type:"file",file:{filename:"attachment.pdf",file_data:t}}):t.startsWith("http://")||t.startsWith("https://")?h.messages[1].content.push({type:"image_url",image_url:{url:t}}):console.warn(`[API] Skipping invalid URL for image processing: ${t.substring(0,100)}...`)})}A&&(h.provider={sort:A,allow_fallbacks:!0});let f=e("enableStreaming",!1);a.set(o,{streaming:!0,timestamp:Date.now(),tweetContent:t,mediaUrls:n});let b=0;for(;b<r;){b++;let v=Date.now(),w=v-E;w<1&&await new Promise(t=>setTimeout(t,Math.max(0,1-w))),E=v,Z(`Rating tweet... (${++_} pending)`);try{let x;if(x=f?await tP(h,i,o,t,s):await t7(h,i),d(),!x.error&&x.content){c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:n,apiResponseContent:x.content,reviewSystemPrompt:L,followUpSystemPrompt:U,userInstructions:p});let S=c.score,C=c.questions,k=c.description,T=c.qaConversationHistory;return a.set(o,{score:S,description:k,reasoning:x.reasoning||"",questions:C,lastAnswer:"",tweetContent:t,mediaUrls:n,streaming:!1,timestamp:Date.now(),metadata:x.data?.id?{generationId:x.data.id}:null,qaConversationHistory:T}),{score:S,content:x.content,reasoning:x.reasoning||"",questions:C,error:!1,cached:!1,data:x.data,qaConversationHistory:T}}if(b<r&&(x.error||!x.content)){let q=1e3*Math.pow(b,2);await new Promise(t=>setTimeout(t,q))}else if(x.error||!x.content)throw Error(x.content||"Failed to get valid rating content after multiple attempts")}catch(H){if(d(),console.error(`API error during attempt ${b}:`,H),b<r){let N=1e3*Math.pow(b,2);await new Promise(t=>setTimeout(t,N))}else{let P=`Failed to get valid rating after multiple attempts: ${H.message}`;return c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:n,apiResponseContent:`<ANALYSIS>${P}</ANALYSIS><SCORE>SCORE_5</SCORE><FOLLOW_UP_QUESTIONS>Q_1. N/A\\nQ_2. N/A\\nQ_3. N/A</FOLLOW_UP_QUESTIONS>`,reviewSystemPrompt:L,followUpSystemPrompt:U,userInstructions:p}),a.set(o,{score:5,description:P,reasoning:"",questions:[],lastAnswer:"",error:!0,tweetContent:t,mediaUrls:n,streaming:!1,timestamp:Date.now(),qaConversationHistory:c.qaConversationHistory}),{score:5,content:P,reasoning:"",questions:[],lastAnswer:"",error:!0,data:null,qaConversationHistory:c.qaConversationHistory}}}}d();let D="Unexpected failure in rating process.";return c.updateInitialReviewAndBuildHistory({fullContext:t,mediaUrls:n,apiResponseContent:`<ANALYSIS>${D}</ANALYSIS><SCORE>SCORE_5</SCORE><FOLLOW_UP_QUESTIONS>Q_1. N/A\\nQ_2. N/A\\nQ_3. N/A</FOLLOW_UP_QUESTIONS>`,reviewSystemPrompt:L,followUpSystemPrompt:U,userInstructions:p}),{score:5,content:D,reasoning:"",questions:[],lastAnswer:"",error:!0,data:null,qaConversationHistory:c.qaConversationHistory}}async function tM(t){let o={model:"google/gemini-2.5-flash-preview",messages:[{role:"system",content:[{type:"text",text:`
                Please come up with a 5-word summary of the following instructions.
                `}]},{role:"user",content:[{type:"text",text:`Please come up with a 5-word summary of the following instructions:
            ${t}
            `}]}]},i=e("openrouter-api-key"),n=await tA(o,i);if(!n.error&&n.data?.choices?.[0]?.message){let r=n.data.choices[0].message.content||"";return{content:r,error:!1}}return{error:!0,content:n.error||"Unknown error"}}async function t7(t,e){let o=t.tweetId,i=a.get(o)?.score,n=await tA(t,e);if(!n.error&&n.data?.choices?.[0]?.message){let r=n.data.choices[0].message.content||"",s=n.data.choices[0].message.reasoning||"",l=r.match(/SCORE_(\d+)/g),d=i||(l&&l.length>0?parseInt(l[l.length-1].match(/SCORE_(\d+)/)[1],10):null);return a.set(o,{score:d,description:r,tweetContent:t.tweetText,streaming:!1}),{content:r,reasoning:s}}return{error:!0,content:n.error||"Unknown error",reasoning:"",data:null}}async function tP(t,e,o,i,n){window.activeStreamingRequests&&window.activeStreamingRequests[o]&&(console.log(`Aborting existing streaming request for tweet ${o}`),window.activeStreamingRequests[o].abort(),delete window.activeStreamingRequests[o]);let r=a.get(o);return r&&void 0!==r.score&&null!==r.score||a.set(o,{streaming:!0,timestamp:Date.now(),tweetContent:i,description:"",reasoning:"",questions:[],lastAnswer:"",score:null}),new Promise((s,l)=>{let d=ti.get(o,n);if(!d)return console.error(`[API Stream] Could not get/create ScoreIndicator for ${o}. Aborting stream setup.`),a.has(o)&&(a.get(o).streaming=!1,a.get(o).error="Indicator initialization failed"),l(Error(`ScoreIndicator instance could not be initialized for tweet ${o}`));let c=r?.description||"",p=r?.reasoning||"";r?.questions;let u=null,h=r?.score||null;tq(t,e,t=>{c=t.content||c,p=t.reasoning||p;let e=c.match(/SCORE_(\d+)/g);if(e&&e.length>0){let i=e[e.length-1];h=parseInt(i.match(/SCORE_(\d+)/)[1],10)}if(d.update({status:"streaming",score:h,description:c||"Rating in progress...",reasoning:p,questions:[],lastAnswer:""}),a.has(o)){let n=a.get(o);n.description=c,n.reasoning=p,n.score=h,n.streaming=!0}},t=>{console.log(t),c=t.content||c,p=t.reasoning||p,u=t.data;let r=c.match(/SCORE_(\d+)/g);if(r&&r.length>0){let l=r[r.length-1];h=parseInt(l.match(/SCORE_(\d+)/)[1],10)}let g="rated";null==h&&(console.warn(`[API Stream] No score found in final content for tweet ${o}. Content: ${c.substring(0,100)}...`),g="error",h=5,c+="\n[No score detected - Error]");let m={tweetContent:i,score:h,description:c,reasoning:p,streaming:!1,timestamp:Date.now(),error:"error"===g?"No score detected":void 0,metadata:u?.id?{generationId:u.id}:null};a.set(o,m),d.update({status:g,score:h,description:c,reasoning:p,questions:tH(c),lastAnswer:"",metadata:u?.id?{generationId:u.id}:null}),n&&tm(n);let f=u?.id;f&&e&&tD(o,f,e,d),s({score:h,content:c,reasoning:p,error:"error"===g,cached:!1,data:u})},t=>{if(console.error(`[API Stream Error] Tweet ${o}: ${t.message}`),d.update({status:"error",score:5,description:`Stream Error: ${t.message}`,reasoning:"",questions:[],lastAnswer:""}),a.has(o)){let e=a.get(o);e.streaming=!1,e.error=t.message,e.score=5,e.description=`Stream Error: ${t.message}`}l(Error(t.message))},3e4,o)})}async function tD(t,e,o,i,n=0,r=[1e3,500,2e3,4e3,8e3]){if(n>=r.length){console.warn(`[Metadata Fetch ${t}] Max retries reached for generation ${e}.`);return}let s=r[n];await new Promise(t=>setTimeout(t,s));try{let l=await t9(e,o);if(!l.error&&l.data?.data){let d=l.data.data,c={model:d.model||"N/A",promptTokens:d.tokens_prompt||0,completionTokens:d.tokens_completion||0,reasoningTokens:d.native_tokens_reasoning||0,latency:void 0!==d.latency?(d.latency/1e3).toFixed(2)+"s":"N/A",mediaInputs:d.num_media_prompt||0,price:void 0!==d.total_cost?`$${d.total_cost.toFixed(6)}`:"N/A",providerName:d.provider_name||"N/A"},p=a.get(t);p?(p.metadata=c,a.set(t,p),i.update({metadata:c}),console.log(`[Metadata Fetch ${t}] Stored metadata and updated UI for generation ${e}`)):console.warn(`[Metadata Fetch ${t}] Cache entry disappeared before metadata could be stored for generation ${e}.`);return}404===l.status||console.warn(`[Metadata Fetch ${t}] Error fetching metadata (Attempt ${n+1}) for ${e}: ${l.message}`),tD(t,e,o,i,n+1,r)}catch(u){console.error(`[Metadata Fetch ${t}] Unexpected error during fetch (Attempt ${n+1}) for ${e}:`,u),tD(t,e,o,i,n+1,r)}}async function t2(t,o,i,n,r){let s=o.find(t=>"user"===t.role&&t===o[o.length-1])?.content.find(t=>"text"===t.type)?.text||"User's question";console.log(`[FollowUp] Answering question for ${t}: "${s}" using full history.`);let l=e("enableStreaming",!1),d=o.map((t,e)=>{if(e===o.length-1&&"user"===t.role){let i=t.content.find(t=>"text"===t.type)?.text||"",n=`<UserQuestion> ${i} </UserQuestion>
        You MUST match the EXPECTED_RESPONSE_FORMAT
        EXPECTED_RESPONSE_FORMAT:
        <ANSWER>
(Your answer here)
</ANSWER>

            <FOLLOW_UP_QUESTIONS> (Anticipate 3 things the user may ask you next. These questions should not be directed at the user. Only pose a question if you are sure you can answer it, based off your knowledge.)
Q_1. (New Question 1 here)
Q_2. (New Question 2 here)
Q_3. (New Question 3 here)
</FOLLOW_UP_QUESTIONS>
        `,r=[{type:"text",text:n}];return t.content.forEach(t=>{"image_url"===t.type&&r.push(t)}),{...t,content:r}}return t}),c=e("enableWebSearch",!1)?`${I}:online`:I,p={model:c,messages:d,temperature:R,top_p:O,max_tokens:M,stream:l};console.log(`followup request (templated): ${JSON.stringify(p)}`),I.includes("gemini")&&(p.config={safetySettings:tO}),A&&(p.provider={sort:A,allow_fallbacks:!0});try{try{let u="*Processing...*",h=[...o];if(l)await new Promise((e,o)=>{let n="",l="";tq(p,i,t=>{n=t.content||n,l=t.reasoning||l,r._renderStreamingAnswer(n,l)},o=>{u=o.content||n;let i=o.reasoning||l,s={role:"assistant",content:[{type:"text",text:u}]};if(h.push(s),r.conversationHistory.length>0){let d=r.conversationHistory[r.conversationHistory.length-1];"pending"===d.answer&&(d.reasoning=i)}r.updateAfterFollowUp({assistantResponseContent:u,updatedQaHistory:h});let c=a.get(t)||{};c.qaConversationHistory=h;let p=u.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/);c.lastAnswer=p?p[1].trim():u,c.questions=tH(u),c.timestamp=Date.now(),a.set(t,c),e()},e=>{console.error("[FollowUp Stream Error]",e);let i=`Error generating answer: ${e.message}`;r._updateConversationHistory(s,i),r.questions=a.get(t)?.questions||[],r._updateTooltipUI();let n=a.get(t)||{};n.lastAnswer=i,n.timestamp=Date.now(),a.set(t,n),o(Error(e.message))},6e4,`followup-${t}`)});else{let g=await tA(p,i,6e4);if(g.error||!g.data?.choices?.[0]?.message?.content)throw Error(g.message||"Failed to get follow-up answer.");u=g.data.choices[0].message.content;let m={role:"assistant",content:[{type:"text",text:u}]};h.push(m),r.updateAfterFollowUp({assistantResponseContent:u,updatedQaHistory:h});let f=a.get(t)||{};f.qaConversationHistory=h;let b=u.match(/<ANSWER>([\s\S]*?)<\/ANSWER>/);f.lastAnswer=b?b[1].trim():u,f.questions=tH(u),f.timestamp=Date.now(),a.set(t,f)}}catch($){console.error(`[FollowUp] Error answering question for ${t}:`,$);let v=`Error answering question: ${$.message}`;r._updateConversationHistory(s,v),r.questions=a.get(t)?.questions||[],r._updateTooltipUI();let y=a.get(t)||{};y.lastAnswer=v,y.timestamp=Date.now(),a.set(t,y)}}finally{r&&"function"==typeof r._finalizeFollowUpInteraction&&r._finalizeFollowUpInteraction()}}let tQ;console.log("X/Twitter Tweet De-Sloppification Activated (v1.5.4- Enhanced)"),o("menuHTML",GM_getResourceText("MENU_HTML")),tQ=e("firstRun",!0),function n(){let r=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(r){x=r,console.log("X/Twitter Tweet De-Sloppification: Target node found. Observing..."),function n(){let r=function o(){let i;if(!(i=t||e("menuHTML")))return console.error("Failed to load Menu.html resource!"),Z("Error: Could not load UI components."),null;let n="tweetfilter-root-container",r=document.getElementById(n);if(r)return console.warn("UI container already exists. Skipping injection."),r;(r=document.createElement("div")).id=n,r.innerHTML=i,document.body.appendChild(r),console.log("TweetFilter UI Injected from HTML resource.");let a=r.querySelector("#version-info");return a&&(a.textContent="Twitter De-Sloppifier v1.5.5"),r}();r&&(function t(i){if(!i){console.error("UI Container not found for event listeners.");return}console.log("Wiring UI events...");let n=i.querySelector("#settings-container"),r=i.querySelector("#tweet-filter-container"),s=i.querySelector("#settings-toggle"),l=i.querySelector("#filter-toggle");i.addEventListener("click",t=>{let i=t.target,d=i.closest("[data-action]"),c=d?.dataset.action;i.dataset.setting,i.closest(".parameter-row")?.dataset.paramName;let p=i.dataset.tab,u=i.closest("[data-toggle]")?.dataset.toggle;if(c)switch(c){case"close-filter":tr(r,l,"Filter Slider","Filter Slider");break;case"toggle-settings":case"close-settings":tr(n,s,'<span style="font-size: 14px;">‚úï</span> Close','<span style="font-size: 14px;">‚öôÔ∏è</span> Settings');break;case"save-api-key":(function t(){let i=document.getElementById("openrouter-api-key"),n=i.value.trim(),r=e("openrouter-api-key","").length>0;n?(r||tg(!0),o("openrouter-api-key",n),Z("API key saved successfully!"),tU(),location.reload()):Z("Please enter a valid API key")})();break;case"clear-cache":ta();break;case"reset-settings":tg(J());break;case"save-instructions":tt();break;case"add-handle":(function t(){let e=document.getElementById("handle-input"),i=e.value.trim();i&&(function t(e){if(""===(e=e.trim().replace(/^@/,""))||q.includes(e)){Z(""===e?"Handle cannot be empty.":`@${e} is already on the list.`);return}q.push(e),o("blacklistedHandles",q.join("\n")),td(document.getElementById("handle-list")),Z(`Added @${e} to auto-rate list.`)}(i),e.value="")})();break;case"clear-instructions-history":(J()||confirm("Are you sure you want to clear all instruction history?"))&&($.clearHistory(),te(),Z("Instructions history cleared"));break;case"export-cache":(function t(){if(!a){Z("Error: Tweet cache not found.","error");return}try{let e=a.cache;if(!e||0===Object.keys(e).length){Z("Cache is empty. Nothing to export.","warning");return}let o=JSON.stringify(e,null,2),i=new Blob([o],{type:"application/json;charset=utf-8;"}),n=URL.createObjectURL(i),r=document.createElement("a");r.setAttribute("href",n);let s=new Date().toISOString().replace(/[:.]/g,"-");r.setAttribute("download",`tweet-filter-cache-${s}.json`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),Z(`Cache exported successfully (${Object.keys(e).length} items).`)}catch(l){console.error("Error exporting cache:",l),Z("Error exporting cache. Check console for details.","error")}})()}if(i.classList.contains("remove-handle")){let h=i.closest(".handle-item"),g=h?.querySelector(".handle-text");if(g){let m=g.textContent.substring(1);(function t(e){let i=q.indexOf(e);i>-1?(q.splice(i,1),o("blacklistedHandles",q.join("\n")),td(document.getElementById("handle-list")),Z(`Removed @${e} from auto-rate list.`)):console.warn(`Attempted to remove non-existent handle: ${e}`)})(m)}}p&&function t(e){let o=document.querySelector("#settings-container .settings-content");if(!o)return;let i=o.querySelectorAll(".tab-content"),n=o.querySelectorAll(".tab-navigation .tab-button");i.forEach(t=>t.classList.remove("active")),n.forEach(t=>t.classList.remove("active"));let r=o.querySelector(`#${e}-tab`),a=o.querySelector(`.tab-navigation .tab-button[data-tab="${e}"]`);r&&r.classList.add("active"),a&&a.classList.add("active")}(p),u&&function t(e){let o=document.getElementById(e),i=document.querySelector(`[data-toggle="${e}"]`);if(!o||!i)return;let n=i.querySelector(".advanced-toggle-icon"),r=o.classList.toggle("expanded");n&&n.classList.toggle("expanded",r),r?o.style.maxHeight=o.scrollHeight+"px":o.style.maxHeight="0"}(u)}),i.addEventListener("input",t=>{let e=t.target,i=e.dataset.setting,n=e.closest(".parameter-row")?.dataset.paramName;i&&ts(e,i),n&&function t(e,i){let n=e.closest(".parameter-row");if(!n)return;let r=n.querySelector(".parameter-slider"),a=n.querySelector(".parameter-value"),s=parseFloat(r.min),l=parseFloat(r.max),d=parseFloat(e.value);"number"!==e.type||isNaN(d)||(d=Math.max(s,Math.min(l,d))),r&&a&&(r.value=d,a.value=d),void 0!==window[i]&&(window[i]=d),o(i,d)}(e,n),"tweet-filter-slider"===e.id&&function t(e){let i=document.getElementById("tweet-filter-value");w=parseInt(e.value,10),i&&(i.value=w.toString());let n=w/10*100;e.style.setProperty("--slider-percent",`${n}%`),o("filterThreshold",w),tI()}(e),"tweet-filter-value"===e.id&&function t(e){let i=parseInt(e.value,10);i=Math.max(0,Math.min(10,i)),e.value=i.toString();let n=document.getElementById("tweet-filter-slider");if(n){n.value=i.toString();let r=i/10*100;n.style.setProperty("--slider-percent",`${r}%`)}w=i,o("filterThreshold",w),tI()}(e)}),i.addEventListener("change",t=>{let e=t.target,o=e.dataset.setting;"modelSortOrder"===o&&(ts(e,o),tU()),"enableImageDescriptions"===o&&ts(e,o)}),l&&(l.onclick=()=>{r&&(r.style.display="flex",r.offsetHeight,r.classList.remove("hidden")),l.style.display="none"}),document.addEventListener("click",th);let d=i.querySelector("#show-free-models");d&&d.addEventListener("change",function(){o("showFreeModels",T=this.checked),tc()});let c=i.querySelector("#sort-direction");c&&c.addEventListener("click",function(){let t=e("sortDirection","default"),i="default"===t?"reverse":"default";o("sortDirection",i),this.dataset.value=i,tc()});let p=i.querySelector("#model-sort-order");p&&p.addEventListener("change",function(){o("modelSortOrder",this.value),"latency-low-to-high"===this.value?o("sortDirection","default"):""===this.value&&o("sortDirection","default"),tc()});let u=i.querySelector("#provider-sort");u&&u.addEventListener("change",function(){o("providerSort",A=this.value)}),console.log("UI events wired.")}(r),tl(),tU(),function t(){let e=document.getElementById("tweet-filter-stats-badge");if(!e)return;e.title="Click to open settings",e.addEventListener("click",()=>{let t=document.getElementById("settings-toggle");t&&t.click()});let o,n=()=>{clearTimeout(o),e.style.opacity="1",o=setTimeout(()=>{e.style.opacity="0.3"},5e3)};e.addEventListener("mouseenter",()=>{e.style.opacity="1",clearTimeout(o)}),e.addEventListener("mouseleave",n),n(),i()}(),setInterval(i,3e3),window.activeStreamingRequests||(window.activeStreamingRequests={}))}(),tQ&&(tg(!0),o("firstRun",!1));let s=e("openrouter-api-key","");s||alert("No API Key found. Please enter your API Key in Settings > General."),s&&(o("openrouter-api-key",s),Z(`Loaded ${a.size} cached ratings. Starting to rate visible tweets...`),tU()),document.querySelector('[aria-label="Timeline: Conversation"]')?tk():x.querySelectorAll(P).forEach(t_);let l=new MutationObserver(G);l.observe(x,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{l.disconnect();let t=document.getElementById("tweet-filter-container");t&&t.remove();let e=document.getElementById("settings-container");e&&e.remove();let o=document.getElementById("status-indicator");o&&o.remove(),ti.destroyAll(),console.log("X/Twitter Tweet De-Sloppification Deactivated.")})}else setTimeout(n,1)}()}();