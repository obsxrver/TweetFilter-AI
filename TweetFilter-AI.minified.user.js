// ==UserScript==
// @name         TweetFilter AI
// @namespace    http://tampermonkey.net/
// @version      Version 1.4.2
// @description  A highly customizable AI rates tweets 1-10 and removes all the slop, saving your braincells!
// @author       Obsxrver(3than)
// @match        *://twitter.com/*
// @match        *://x.com/*
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        GM_getResourceText
// @connect      openrouter.ai
// @run-at       document-idle
// @license      MIT
// ==/UserScript==
!function(){"use strict";let t=`<div id="tweetfilter-root-container"><button id="filter-toggle" class="toggle-button" style="display: none;">Filter Slider</button><div id="tweet-filter-container"><button class="close-button" data-action="close-filter">\xd7</button><label for="tweet-filter-slider">SlopScore:</label><div class="filter-controls"><input type="range" id="tweet-filter-slider" min="0" max="10" step="1"><input type="number" id="tweet-filter-value" min="0" max="10" step="1" value="5"></div></div><button id="settings-toggle" class="toggle-button" data-action="toggle-settings"><span style="font-size: 14px;">‚öôÔ∏è</span> Settings</button><div id="settings-container" class="hidden"><div class="settings-header"><div class="settings-title">Twitter De-Sloppifier</div><button class="close-button" data-action="toggle-settings">\xd7</button></div><div class="settings-content"><div class="tab-navigation"><button class="tab-button active" data-tab="general">General</button><button class="tab-button" data-tab="models">Models</button><button class="tab-button" data-tab="instructions">Instructions</button></div><div id="general-tab" class="tab-content active"><div class="section-title"><span style="font-size: 14px;">üîë</span> OpenRouter API Key <a href="https://openrouter.ai/settings/keys" target="_blank">Get one here</a></div><input id="openrouter-api-key" placeholder="Enter your OpenRouter API key"><button class="settings-button" data-action="save-api-key">Save API Key</button><div class="section-title" style="margin-top: 20px;"><span style="font-size: 14px;">üóÑÔ∏è</span> Cache Statistics</div><div class="stats-container"><div class="stats-row"><div class="stats-label">Cached Tweet Ratings</div><div class="stats-value" id="cached-ratings-count">0</div></div><div class="stats-row"><div class="stats-label">Whitelisted Handles</div><div class="stats-value" id="whitelisted-handles-count">0</div></div></div><button id="clear-cache" class="settings-button danger" data-action="clear-cache">Clear Rating Cache</button><div class="section-title" style="margin-top: 20px;"><span style="font-size: 14px;">üíæ</span> Backup &amp; Restore</div><div class="section-description">Export your settings and cached ratings to a file for backup, or import previously saved settings.</div><button class="settings-button danger" style="margin-top: 15px;" data-action="reset-settings">Reset to Defaults</button><div id="version-info" style="margin-top: 20px; font-size: 11px; opacity: 0.6; text-align: center;">Twitter De-Sloppifier v?.?</div></div><div id="models-tab" class="tab-content"><div class="section-title"><span style="font-size: 14px;">üß†</span> Tweet Rating Model</div><div class="section-description">The rating model is responsible for reviewing each tweet. <br>It will process images directly if you select an <strong>image-capable (üñºÔ∏è)</strong> model.</div><div class="select-container" id="model-select-container"></div><div class="advanced-options"><div class="advanced-toggle" data-toggle="model-options-content"><div class="advanced-toggle-title">Options</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="model-options-content"><div class="sort-container"><label for="model-sort-order">Sort models by: </label><div class="controls-group"><select id="model-sort-order" data-setting="modelSortOrder"><option value="pricing-low-to-high">Price</option><option value="latency-low-to-high">Latency</option><option value="throughput-high-to-low">Throughput</option><option value="top-weekly">Popularity</option><option value="">Age</option></select><button id="sort-direction" class="sort-toggle" data-setting="sortDirection" data-value="default">High-Low</button></div></div><div class="sort-container"><label for="provider-sort">API Endpoint Priority: </label><select id="provider-sort" data-setting="providerSort"><option value="">Default (load-balanced)</option><option value="throughput">Throughput</option><option value="latency">Latency</option><option value="price">Price</option></select></div><div class="sort-container"><label><input type="checkbox" id="show-free-models" data-setting="showFreeModels" checked>Show Free Models</label></div><div class="parameter-row" data-param-name="modelTemperature"><div class="parameter-label" title="How random the model responses should be (0.0-1.0)">Temperature</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2" step="0.1"><input type="number" class="parameter-value" min="0" max="2" step="0.01" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="modelTopP"><div class="parameter-label" title="Nucleus sampling parameter (0.0-1.0)">Top-p</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="1" step="0.1"><input type="number" class="parameter-value" min="0" max="1" step="0.01" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="maxTokens"><div class="parameter-label" title="Maximum number of tokens for the response (0 means no limit)">Max Tokens</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2000" step="100"><input type="number" class="parameter-value" min="0" max="2000" step="100" style="width: 60px;"></div></div><div class="toggle-row"><div class="toggle-label" title="Stream API responses as they're generated for live updates">Enable Live Streaming</div><label class="toggle-switch"><input type="checkbox" data-setting="enableStreaming"><span class="toggle-slider"></span></label></div></div></div><div class="section-title" style="margin-top: 25px;"><span style="font-size: 14px;">üñºÔ∏è</span> Image Processing Model</div><div class="section-description">This model generates <strong>text descriptions</strong> of images for the rating model.<br> Hint: If you selected an image-capable model (üñºÔ∏è) as your <strong>main rating model</strong>, it will process images directly.</div><div class="toggle-row"><div class="toggle-label">Enable Image Descriptions</div><label class="toggle-switch"><input type="checkbox" data-setting="enableImageDescriptions"><span class="toggle-slider"></span></label></div><div id="image-model-container" style="display: none;"><div class="select-container" id="image-model-select-container"></div><div class="advanced-options" id="image-advanced-options"><div class="advanced-toggle" data-toggle="image-advanced-content"><div class="advanced-toggle-title">Options</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="image-advanced-content"><div class="parameter-row" data-param-name="imageModelTemperature"><div class="parameter-label" title="Randomness for image descriptions (0.0-1.0)">Temperature</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="2" step="0.1"><input type="number" class="parameter-value" min="0" max="2" step="0.1" style="width: 60px;"></div></div><div class="parameter-row" data-param-name="imageModelTopP"><div class="parameter-label" title="Nucleus sampling for image model (0.0-1.0)">Top-p</div><div class="parameter-control"><input type="range" class="parameter-slider" min="0" max="1" step="0.1"><input type="number" class="parameter-value" min="0" max="1" step="0.1" style="width: 60px;"></div></div></div></div></div></div><div id="instructions-tab" class="tab-content"><div class="section-title">Custom Instructions</div><div class="section-description">Add custom instructions for how the model should score tweets:</div><textarea id="user-instructions" placeholder="Examples:- Give high scores to tweets about technology- Penalize clickbait-style tweets- Rate educational content higher" data-setting="userDefinedInstructions" value=""></textarea><button class="settings-button" data-action="save-instructions">Save Instructions</button><div class="advanced-options" id="instructions-history"><div class="advanced-toggle" data-toggle="instructions-history-content"><div class="advanced-toggle-title">Custom Instructions History</div><div class="advanced-toggle-icon">‚ñº</div></div><div class="advanced-content" id="instructions-history-content"><div class="instructions-list" id="instructions-list"><!-- Instructions entries will be added here dynamically --></div><button class="settings-button danger" style="margin-top: 10px;" data-action="clear-instructions-history">Clear All History</button></div></div><div class="section-title" style="margin-top: 20px;">Auto-Rate Handles as 10/10</div><div class="section-description">Add Twitter handles to automatically rate as 10/10:</div><div class="handle-input-container"><input id="handle-input" type="text" placeholder="Twitter handle (without @)"><button class="add-handle-btn" data-action="add-handle">Add</button></div><div class="handle-list" id="handle-list"></div></div></div><div id="status-indicator" class=""></div></div><div id="tweet-filter-stats-badge" class="tweet-filter-stats-badge"></div></div>`;function e(t,e=null){try{return GM_getValue(t,e)}catch(i){return e}}function i(t,e){try{GM_setValue(t,e)}catch(i){}}function o(){let t=document.getElementById("cached-ratings-count"),e=document.getElementById("whitelisted-handles-count"),i=a.size,o=I.length;t&&(t.textContent=i),e&&(e.textContent=o);let r=document.getElementById("tweet-filter-stats-badge");r&&(r.innerHTML=`
            <span style="margin-right: 5px;">üß†</span>
            <span data-cached-count>${i} rated</span>
            <span data-pending-count> | ${x} pending</span>
            ${o>0?`<span style="margin-left: 5px;"> | ${o} whitelisted</span>`:""}
        `)}GM_addStyle('.refreshing {animation: spin 1s infinite linear;}@keyframes spin {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}.score-highlight {display: inline-block;background-color: #1d9bf0;/* Twitter blue */color: white;padding: 3px 10px;border-radius: 9999px;margin: 8px 0;font-weight: bold;font-size: 0.9em;}.mobile-tooltip {/* Add specific mobile tooltip styles if needed */max-width: 90vw;/* Example */}.score-description.streaming-tooltip {scroll-behavior: smooth;border-left: 3px solid #1d9bf0;background-color: rgba(25, 30, 35, 0.98);}.score-description.streaming-tooltip::before {content: \'Live\';position: absolute;top: 10px;right: 10px;background-color: #1d9bf0;color: white;font-size: 11px;padding: 2px 6px;border-radius: 10px;font-weight: bold;}.score-description::-webkit-scrollbar {width: 6px;}.score-description::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);border-radius: 3px;}.score-description::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.score-description::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}.score-description.streaming-tooltip p::after {content: \'|\';display: inline-block;color: #1d9bf0;animation: blink 0.7s infinite;font-weight: bold;margin-left: 2px;}@keyframes blink {0%,100% {opacity: 0;}50% {opacity: 1;}}.streaming-rating {background-color: rgba(33, 150, 243, 0.9) !important;color: white !important;animation: pulse 1.5s infinite alternate;position: relative;}.streaming-rating::after {content: \'\';position: absolute;top: -2px;right: -2px;width: 6px;height: 6px;background-color: #1d9bf0;border-radius: 50%;animation: blink 0.7s infinite;box-shadow: 0 0 4px #1d9bf0;}.cached-rating {background-color: rgba(76, 175, 80, 0.9) !important;color: white !important;}.rated-rating {background-color: rgba(33, 33, 33, 0.9) !important;color: white !important;}.blacklisted-rating {background-color: rgba(255, 193, 7, 0.9) !important;color: black !important;}.pending-rating {background-color: rgba(255, 152, 0, 0.9) !important;color: white !important;}@keyframes pulse {0% {opacity: 0.8;}100% {opacity: 1;}}.error-rating {background-color: rgba(244, 67, 54, 0.9) !important;color: white !important;}#status-indicator {position: fixed;bottom: 20px;right: 20px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 10px 15px;border-radius: 8px;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;z-index: 9999;display: none;border: 1px solid rgba(255, 255, 255, 0.1);box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);transform: translateY(100px);transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);}#status-indicator.active {display: block;transform: translateY(0);}.toggle-switch {position: relative;display: inline-block;width: 36px;height: 20px;}.toggle-switch input {opacity: 0;width: 0;height: 0;}.toggle-slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;background-color: rgba(255, 255, 255, 0.2);transition: .3s;border-radius: 34px;}.toggle-slider:before {position: absolute;content: "";height: 16px;width: 16px;left: 2px;bottom: 2px;background-color: white;transition: .3s;border-radius: 50%;}input:checked+.toggle-slider {background-color: #1d9bf0;}input:checked+.toggle-slider:before {transform: translateX(16px);}.toggle-row {display: flex;align-items: center;justify-content: space-between;padding: 8px 10px;margin-bottom: 12px;background-color: rgba(255, 255, 255, 0.05);border-radius: 8px;transition: background-color 0.2s;}.toggle-row:hover {background-color: rgba(255, 255, 255, 0.08);}.toggle-label {font-size: 13px;color: #e7e9ea;}#tweet-filter-container {position: fixed;top: 70px;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 10px 12px;border-radius: 12px;z-index: 9999;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);display: flex;align-items: center;gap: 10px;border: 1px solid rgba(255, 255, 255, 0.1);transform-origin: top right;transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.5s ease-in-out;opacity: 1;transform: scale(1) translateX(0);visibility: visible;}#tweet-filter-container.hidden {opacity: 0;transform: scale(0.8) translateX(50px);visibility: hidden;}.close-button {background: none;border: none;color: #e7e9ea;font-size: 16px;cursor: pointer;padding: 0;width: 28px;height: 28px;display: flex;align-items: center;justify-content: center;opacity: 0.8;transition: opacity 0.2s;border-radius: 50%;min-width: 28px;min-height: 28px;-webkit-tap-highlight-color: transparent;touch-action: manipulation;user-select: none;z-index: 30;}.close-button:hover {opacity: 1;background-color: rgba(255, 255, 255, 0.1);}.hidden {display: none !important;}/* Only override hidden for our specific containers */#tweet-filter-container.hidden,#settings-container.hidden {display: flex !important;}.toggle-button {position: fixed;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 8px 12px;border-radius: 8px;cursor: pointer;font-size: 12px;z-index: 9999;border: 1px solid rgba(255, 255, 255, 0.1);box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;display: flex;align-items: center;gap: 6px;transition: all 0.2s ease;}.toggle-button:hover {background-color: rgba(29, 155, 240, 0.2);}#filter-toggle {top: 70px;}#settings-toggle {top: 120px;}#tweet-filter-container label {margin: 0;font-weight: bold;}.tweet-filter-stats-badge {position: fixed;bottom: 50px;right: 20px;background-color: rgba(29, 155, 240, 0.9);color: white;padding: 5px 10px;border-radius: 15px;font-size: 12px;z-index: 9999;box-shadow: 0 2px 5px rgba(0,0,0,0.2);transition: opacity 0.3s;cursor: pointer;display: flex;align-items: center;}#tweet-filter-slider {cursor: pointer;width: 120px;vertical-align: middle;-webkit-appearance: none;appearance: none;height: 6px;border-radius: 3px;background: linear-gradient(to right,#FF0000 0%,#FF8800 calc(var(--slider-percent, 50%) * 0.166),#FFFF00 calc(var(--slider-percent, 50%) * 0.333),#00FF00 calc(var(--slider-percent, 50%) * 0.5),#00FFFF calc(var(--slider-percent, 50%) * 0.666),#0000FF calc(var(--slider-percent, 50%) * 0.833),#800080 var(--slider-percent, 50%),#DEE2E6 var(--slider-percent, 50%),#DEE2E6 100%);}#tweet-filter-slider::-webkit-slider-thumb {-webkit-appearance: none;appearance: none;width: 16px;height: 16px;border-radius: 50%;background: #1d9bf0;cursor: pointer;border: 2px solid white;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);transition: transform 0.1s;}#tweet-filter-slider::-webkit-slider-thumb:hover {transform: scale(1.2);}#tweet-filter-slider::-moz-range-thumb {width: 16px;height: 16px;border-radius: 50%;background: #1d9bf0;cursor: pointer;border: 2px solid white;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);transition: transform 0.1s;}#tweet-filter-slider::-moz-range-thumb:hover {transform: scale(1.2);}#tweet-filter-value {min-width: 20px;text-align: center;font-weight: bold;background-color: rgba(255, 255, 255, 0.1);padding: 2px 5px;border-radius: 4px;}#settings-container {position: fixed;top: 70px;right: 15px;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 0;border-radius: 16px;z-index: 9999;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;box-shadow: 0 2px 18px rgba(0, 0, 0, 0.6);display: flex;flex-direction: column;width: 90vw;max-width: 380px;max-height: 85vh;overflow: hidden;border: 1px solid rgba(255, 255, 255, 0.1);line-height: 1.3;transform-origin: top right;transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55),opacity 0.5s ease-in-out;opacity: 1;transform: scale(1) translateX(0);visibility: visible;}#settings-container.hidden {opacity: 0;transform: scale(0.8) translateX(50px);visibility: hidden;}.settings-header {padding: 12px 15px;border-bottom: 1px solid rgba(255, 255, 255, 0.1);display: flex;justify-content: space-between;align-items: center;position: sticky;top: 0;background-color: rgba(22, 24, 28, 0.98);z-index: 20;border-radius: 16px 16px 0 0;}.settings-title {font-weight: bold;font-size: 16px;}.settings-content {overflow-y: auto;max-height: calc(85vh - 110px);padding: 0;}.settings-content::-webkit-scrollbar {width: 6px;}.settings-content::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);border-radius: 3px;}.settings-content::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.settings-content::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}.tab-navigation {display: flex;border-bottom: 1px solid rgba(255, 255, 255, 0.1);position: sticky;top: 0;background-color: rgba(22, 24, 28, 0.98);z-index: 10;padding: 10px 15px;gap: 8px;}.tab-button {padding: 6px 10px;background: none;border: none;color: #e7e9ea;font-weight: bold;cursor: pointer;border-radius: 8px;transition: all 0.2s ease;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;flex: 1;text-align: center;}.tab-button:hover {background-color: rgba(255, 255, 255, 0.1);}.tab-button.active {color: #1d9bf0;background-color: rgba(29, 155, 240, 0.1);border-bottom: 2px solid #1d9bf0;}.tab-content {display: none;animation: fadeIn 0.3s ease;padding: 15px;}@keyframes fadeIn {from {opacity: 0;}to {opacity: 1;}}.tab-content.active {display: block;}.select-container {position: relative;margin-bottom: 15px;}.select-container .search-field {position: sticky;top: 0;background-color: rgba(39, 44, 48, 0.95);padding: 8px;border-bottom: 1px solid rgba(255, 255, 255, 0.1);z-index: 1;}.select-container .search-input {width: 100%;padding: 8px 10px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.9);color: #e7e9ea;font-size: 12px;transition: border-color 0.2s;}.select-container .search-input:focus {border-color: #1d9bf0;outline: none;}.custom-select {position: relative;display: inline-block;width: 100%;}.select-selected {background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;padding: 10px 12px;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 8px;cursor: pointer;user-select: none;display: flex;justify-content: space-between;align-items: center;font-size: 13px;transition: border-color 0.2s;}.select-selected:hover {border-color: rgba(255, 255, 255, 0.4);}.select-selected:after {content: "";width: 8px;height: 8px;border: 2px solid #e7e9ea;border-width: 0 2px 2px 0;display: inline-block;transform: rotate(45deg);margin-left: 10px;transition: transform 0.2s;}.select-selected.select-arrow-active:after {transform: rotate(-135deg);}.select-items {position: absolute;background-color: rgba(39, 44, 48, 0.98);top: 100%;left: 0;right: 0;z-index: 99;max-height: 300px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 8px;margin-top: 5px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);display: none;}.select-items div {color: #e7e9ea;padding: 10px 12px;cursor: pointer;user-select: none;transition: background-color 0.2s;border-bottom: 1px solid rgba(255, 255, 255, 0.05);}.select-items div:hover {background-color: rgba(29, 155, 240, 0.1);}.select-items div.same-as-selected {background-color: rgba(29, 155, 240, 0.2);}.select-items::-webkit-scrollbar {width: 6px;}.select-items::-webkit-scrollbar-track {background: rgba(255, 255, 255, 0.05);}.select-items::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.2);border-radius: 3px;}.select-items::-webkit-scrollbar-thumb:hover {background: rgba(255, 255, 255, 0.3);}#openrouter-api-key,#user-instructions {width: 100%;padding: 10px 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);margin-bottom: 12px;background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 13px;transition: border-color 0.2s;}#openrouter-api-key:focus,#user-instructions:focus {border-color: #1d9bf0;outline: none;}#user-instructions {height: 120px;resize: vertical;}.parameter-row {display: flex;align-items: center;margin-bottom: 12px;gap: 8px;padding: 6px;border-radius: 8px;transition: background-color 0.2s;}.parameter-row:hover {background-color: rgba(255, 255, 255, 0.05);}.parameter-label {flex: 1;font-size: 13px;color: #e7e9ea;}.parameter-control {flex: 1.5;display: flex;align-items: center;gap: 8px;}.parameter-value {min-width: 28px;text-align: center;background-color: rgba(255, 255, 255, 0.1);padding: 3px 5px;border-radius: 4px;font-size: 12px;}.parameter-slider {flex: 1;-webkit-appearance: none;height: 4px;border-radius: 4px;background: rgba(255, 255, 255, 0.2);outline: none;cursor: pointer;}.parameter-slider::-webkit-slider-thumb {-webkit-appearance: none;appearance: none;width: 14px;height: 14px;border-radius: 50%;background: #1d9bf0;cursor: pointer;transition: transform 0.1s;}.parameter-slider::-webkit-slider-thumb:hover {transform: scale(1.2);}.section-title {font-weight: bold;margin-top: 20px;margin-bottom: 8px;color: #e7e9ea;display: flex;align-items: center;gap: 6px;font-size: 14px;}.section-title:first-child {margin-top: 0;}.section-description {font-size: 12px;margin-bottom: 8px;opacity: 0.8;line-height: 1.4;}.section-title a {color: #1d9bf0;text-decoration: none;background-color: rgba(255, 255, 255, 0.1);padding: 3px 6px;border-radius: 6px;transition: all 0.2s ease;}.section-title a:hover {background-color: rgba(29, 155, 240, 0.2);text-decoration: underline;}.advanced-options {margin-top: 5px;margin-bottom: 15px;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 12px;background-color: rgba(255, 255, 255, 0.03);overflow: hidden;}.advanced-toggle {display: flex;justify-content: space-between;align-items: center;cursor: pointer;margin-bottom: 5px;}.advanced-toggle-title {font-weight: bold;font-size: 13px;color: #e7e9ea;}.advanced-toggle-icon {transition: transform 0.3s;}.advanced-toggle-icon.expanded {transform: rotate(180deg);}.advanced-content {max-height: 0;overflow: hidden;transition: max-height 0.3s ease-in-out;}.advanced-content.expanded {max-height: none;}#instructions-history-content.expanded {max-height: none !important;}#instructions-history .instructions-list {max-height: 400px;overflow-y: auto;margin-bottom: 10px;}.handle-list {margin-top: 10px;max-height: 120px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 5px;}.handle-item {display: flex;align-items: center;justify-content: space-between;padding: 6px 10px;border-bottom: 1px solid rgba(255, 255, 255, 0.05);border-radius: 4px;transition: background-color 0.2s;}.handle-item:hover {background-color: rgba(255, 255, 255, 0.05);}.handle-item:last-child {border-bottom: none;}.handle-text {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;}.remove-handle {background: none;border: none;color: #ff5c5c;cursor: pointer;font-size: 14px;padding: 0 3px;opacity: 0.7;transition: opacity 0.2s;}.remove-handle:hover {opacity: 1;}.add-handle-btn {background-color: #1d9bf0;color: white;border: none;border-radius: 6px;padding: 7px 10px;cursor: pointer;font-weight: bold;font-size: 12px;margin-left: 5px;transition: background-color 0.2s;}.add-handle-btn:hover {background-color: #1a8cd8;}.settings-button {background-color: #1d9bf0;color: white;border: none;border-radius: 8px;padding: 10px 14px;cursor: pointer;font-weight: bold;transition: background-color 0.2s;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;margin-top: 8px;width: 100%;font-size: 13px;}.settings-button:hover {background-color: #1a8cd8;}.settings-button.secondary {background-color: rgba(255, 255, 255, 0.1);}.settings-button.secondary:hover {background-color: rgba(255, 255, 255, 0.15);}.settings-button.danger {background-color: #ff5c5c;}.settings-button.danger:hover {background-color: #e53935;}.button-row {display: flex;gap: 8px;margin-top: 10px;}.button-row .settings-button {margin-top: 0;}.stats-container {background-color: rgba(255, 255, 255, 0.05);padding: 10px;border-radius: 8px;margin-bottom: 15px;}.stats-row {display: flex;justify-content: space-between;padding: 5px 0;border-bottom: 1px solid rgba(255, 255, 255, 0.1);}.stats-row:last-child {border-bottom: none;}.stats-label {font-size: 12px;opacity: 0.8;}.stats-value {font-weight: bold;}.score-indicator {position: absolute;top: 10px;right: 10.5%;background-color: rgba(22, 24, 28, 0.9);color: #e7e9ea;padding: 4px 10px;border-radius: 8px;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 14px;font-weight: bold;z-index: 100;cursor: pointer;border: 1px solid rgba(255, 255, 255, 0.1);min-width: 20px;text-align: center;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);transition: transform 0.15s ease;}.score-indicator:hover {transform: scale(1.05);}.score-indicator.mobile-indicator {position: absolute !important;bottom: 3% !important;right: 10px !important;top: auto !important;}.score-description {display: none;background-color: rgba(22, 24, 28, 0.95);color: #e7e9ea;padding: 0 20px 16px 20px;border-radius: 12px;box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 16px;line-height: 1.5;z-index: 99999999;position: absolute;width: 550px !important;max-width: 80vw !important;max-height: 60vh;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);word-wrap: break-word;box-sizing: border-box !important;}.score-description.pinned {border: 2px solid #1d9bf0 !important;}.tooltip-controls {display: flex !important;justify-content: flex-end !important;margin: 0 -20px 15px -20px !important;position: sticky !important;top: 0 !important;background-color: rgba(39, 44, 48, 0.95) !important;padding: 12px 15px !important;z-index: 2 !important;border-top-left-radius: 12px !important;border-top-right-radius: 12px !important;border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;backdrop-filter: blur(5px) !important;}.tooltip-pin-button,.tooltip-copy-button {background: none !important;border: none !important;color: #8899a6 !important;cursor: pointer !important;font-size: 16px !important;padding: 4px 8px !important;margin-left: 8px !important;border-radius: 4px !important;transition: all 0.2s !important;}.tooltip-pin-button:hover,.tooltip-copy-button:hover {background-color: rgba(29, 155, 240, 0.1) !important;color: #1d9bf0 !important;}.tooltip-pin-button:active,.tooltip-copy-button:active {transform: scale(0.95) !important;}.description-text {margin: 0 0 25px 0 !important;font-size: 15px !important;line-height: 1.6 !important;max-width: 100% !important;overflow-wrap: break-word !important;padding: 5px 0 !important;}.tooltip-bottom-spacer {height: 10px;}.reasoning-dropdown {margin-top: 15px !important;border-top: 1px solid rgba(255, 255, 255, 0.1) !important;padding-top: 10px !important;}.reasoning-toggle {display: flex !important;align-items: center !important;color: #1d9bf0 !important;cursor: pointer !important;font-weight: bold !important;padding: 5px !important;user-select: none !important;}.reasoning-toggle:hover {background-color: rgba(29, 155, 240, 0.1) !important;border-radius: 4px !important;}.reasoning-arrow {display: inline-block !important;margin-right: 5px !important;transition: transform 0.2s ease !important;}.reasoning-content {max-height: 0 !important;overflow: hidden !important;transition: max-height 0.3s ease-out, padding 0.3s ease-out !important;background-color: rgba(0, 0, 0, 0.15) !important;border-radius: 5px !important;margin-top: 5px !important;padding: 0 !important;}.reasoning-dropdown.expanded .reasoning-content {max-height: 350px !important;overflow-y: auto !important;padding: 10px !important;}.reasoning-dropdown.expanded .reasoning-arrow {transform: rotate(90deg) !important;}.reasoning-text {font-size: 14px !important;line-height: 1.4 !important;color: #ccc !important;margin: 0 !important;padding: 5px !important;}.scroll-to-bottom-button {position: sticky;bottom: 0;width: 100%;background-color: rgba(29, 155, 240, 0.9);color: white;text-align: center;padding: 8px 0;cursor: pointer;font-weight: bold;border-top: 1px solid rgba(255, 255, 255, 0.2);margin-top: 10px;z-index: 100;transition: background-color 0.2s;}.scroll-to-bottom-button:hover {background-color: rgba(29, 155, 240, 1);}@media (max-width: 600px) {.score-indicator {position: absolute !important;bottom: 3% !important;right: 10px !important;top: auto !important;}.score-description {position: fixed !important;width: 100% !important;max-width: 100% !important;max-height: 80vh !important;left: 0 !important;right: 0 !important;margin: 10vh auto 0 !important;padding: 12px !important;box-sizing: border-box !important;overflow-y: auto !important;overflow-x: hidden !important;-webkit-overflow-scrolling: touch !important;overscroll-behavior: contain !important;transform: translateZ(0) !important;border-radius: 16px 16px 0 0 !important;}.reasoning-dropdown.expanded .reasoning-content {max-height: 200px !important;}.close-button {width: 32px;height: 32px;min-width: 32px;min-height: 32px;font-size: 18px;padding: 8px;margin: -4px;}.settings-header .close-button {position: relative;right: 0;}}.sort-container {margin: 10px 0;display: flex;align-items: center;gap: 10px;justify-content: space-between;}.sort-container label {font-size: 14px;color: var(--text-color);white-space: nowrap;}.sort-container .controls-group {display: flex;gap: 8px;align-items: center;}.sort-container select {padding: 5px 10px;border-radius: 4px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-size: 14px;cursor: pointer;min-width: 120px;}.sort-container select:hover {border-color: #1d9bf0;}.sort-container select:focus {outline: none;border-color: #1d9bf0;box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.2);}.sort-toggle {padding: 5px 10px;border-radius: 4px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-size: 14px;cursor: pointer;transition: all 0.2s ease;}.sort-toggle:hover {border-color: #1d9bf0;background-color: rgba(29, 155, 240, 0.1);}.sort-toggle.active {background-color: rgba(29, 155, 240, 0.2);border-color: #1d9bf0;}.sort-container select option {background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;}@media (min-width: 601px) {#settings-container {width: 480px;max-width: 480px;}}#handle-input {flex: 1;padding: 8px 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, 0.2);background-color: rgba(39, 44, 48, 0.95);color: #e7e9ea;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 14px;transition: border-color 0.2s;min-width: 200px;}#handle-input:focus {outline: none;border-color: #1d9bf0;box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.2);}#handle-input::placeholder {color: rgba(231, 233, 234, 0.5);}.handle-input-container {display: flex;gap: 8px;align-items: center;margin-bottom: 10px;padding: 5px;border-radius: 8px;background-color: rgba(255, 255, 255, 0.03);}.add-handle-btn {background-color: #1d9bf0;color: white;border: none;border-radius: 8px;padding: 8px 16px;cursor: pointer;font-weight: bold;font-size: 14px;transition: background-color 0.2s;white-space: nowrap;}.add-handle-btn:hover {background-color: #1a8cd8;}.instructions-list {margin-top: 10px;max-height: 200px;overflow-y: auto;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 8px;padding: 5px;}.instruction-item {display: flex;align-items: center;justify-content: space-between;padding: 8px 10px;border-bottom: 1px solid rgba(255, 255, 255, 0.05);border-radius: 4px;transition: background-color 0.2s;}.instruction-item:hover {background-color: rgba(255, 255, 255, 0.05);}.instruction-item:last-child {border-bottom: none;}.instruction-text {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 12px;flex: 1;margin-right: 10px;}.instruction-buttons {display: flex;gap: 5px;}.use-instruction {background: none;border: none;color: #1d9bf0;cursor: pointer;font-size: 12px;padding: 3px 8px;border-radius: 4px;transition: all 0.2s;}.use-instruction:hover {background-color: rgba(29, 155, 240, 0.1);}.remove-instruction {background: none;border: none;color: #ff5c5c;cursor: pointer;font-size: 14px;padding: 0 3px;opacity: 0.7;transition: opacity 0.2s;border-radius: 4px;}.remove-instruction:hover {opacity: 1;background-color: rgba(255, 92, 92, 0.1);}.tweet-filtered {display: none !important;visibility: hidden !important;opacity: 0 !important;pointer-events: none !important;/* Ensure it stays hidden even if Twitter tries to show it */position: absolute !important;z-index: -9999 !important;height: 0 !important;width: 0 !important;margin: 0 !important;padding: 0 !important;overflow: hidden !important;}.filter-controls {display: flex;align-items: center;gap: 10px;margin: 5px 0;}.filter-controls input[type="range"] {flex: 1;min-width: 100px;}.filter-controls input[type="number"] {width: 50px;padding: 2px 5px;border: 1px solid #ccc;border-radius: 4px;text-align: center;}/* Hide number input spinners */.filter-controls input[type="number"]::-webkit-inner-spin-button,.filter-controls input[type="number"]::-webkit-outer-spin-button {-webkit-appearance: none;margin: 0;}.filter-controls input[type="number"] {-moz-appearance: textfield;}/* --- Metadata Specific Styling --- */.tooltip-metadata {font-size: 0.8em;opacity: 0.7;margin-top: 8px;padding-top: 8px;border-top: 1px solid rgba(255, 255, 255, 0.2);display: block;line-height: 1.5;}.metadata-line {white-space: nowrap;overflow: hidden;text-overflow: ellipsis;margin-bottom: 2px;}.metadata-separator {display: none;}/* --- Specific Indicator Styles --- */.score-indicator.pending-rating {}'),GM_setValue("menuHTML",t);class r{static DEBOUNCE_DELAY=1500;constructor(){var t,e;this.cache={},this.loadFromStorage();let i;this.debouncedSaveToStorage=(t=this.#a.bind(this),e=r.DEBOUNCE_DELAY,function o(...r){let n=()=>{clearTimeout(i),t.apply(this,r)};clearTimeout(i),i=setTimeout(n,e)})}loadFromStorage(){try{let t=e("tweetRatings","{}");for(let i in this.cache=JSON.parse(t),this.cache)this.cache[i].fromStorage=!0}catch(o){this.cache={}}}#a(){try{i("tweetRatings",JSON.stringify(this.cache)),o()}catch(n){}}get(t){return this.cache[t]||null}set(t,e,i=!0){this.cache[t]={score:e.score,description:e.description||"",reasoning:e.reasoning||"",timestamp:e.timestamp||Date.now(),streaming:e.streaming||!1,blacklisted:e.blacklisted||!1,fromStorage:e.fromStorage||!1,metadata:{model:e.metadata?.model||null,promptTokens:e.metadata?.promptTokens||null,completionTokens:e.metadata?.completionTokens||null,latency:e.metadata?.latency||null,mediaInputs:e.metadata?.mediaInputs||null,price:e.metadata?.price||null}},this.debouncedSaveToStorage()}has(t){return void 0!==this.cache[t]}delete(t,e=!0){this.has(t)&&(delete this.cache[t],this.debouncedSaveToStorage())}clear(t=!1){this.cache={},t?this.#a():this.debouncedSaveToStorage()}get size(){return Object.keys(this.cache).length}cleanup(t=!0){let e=this.size,i=0,o=0,r=0;for(let n in this.cache){let a=this.cache[n];(void 0===a.score||null===a.score)&&(!0===a.streaming?o++:r++,delete this.cache[n],i++)}return i>0&&this.debouncedSaveToStorage(),{beforeCount:e,afterCount:this.size,deletedCount:i,streamingDeletedCount:o,undefinedScoreCount:r}}}let a=new r;class s{constructor(){if(s.instance)return s.instance;s.instance=this,this.history=[],this.maxEntries=10,this.loadFromStorage()}#b(l){let d=0;for(let c=0;c<l.length;c++){let p=l.charCodeAt(c);d=(d<<5)-d+p,d&=d}return d.toString(36)}loadFromStorage(){try{let t=e("instructionsHistory","[]");if(this.history=JSON.parse(t),!Array.isArray(this.history))throw Error("Stored history is not an array");this.history=this.history.map(t=>({...t,hash:t.hash||this.#b(t.instructions)}))}catch(i){this.history=[]}}#c(){try{i("instructionsHistory",JSON.stringify(this.history))}catch(u){throw Error("Failed to save instructions history")}}async add(t,e){try{if(!t?.trim()||!e?.trim())throw Error("Invalid instructions or summary");let i=this.#b(t.trim()),o=this.history.findIndex(t=>t.hash===i);if(-1!==o){this.history[o].timestamp=Date.now(),this.history[o].summary=e;let r=this.history.splice(o,1)[0];this.history.unshift(r)}else this.history.unshift({instructions:t.trim(),summary:e.trim(),timestamp:Date.now(),hash:i}),this.history.length>this.maxEntries&&(this.history=this.history.slice(0,this.maxEntries));return this.#c(),!0}catch(n){return!1}}remove(t){try{if(t<0||t>=this.history.length)throw Error("Invalid history index");return this.history.splice(t,1),this.#c(),!0}catch(e){return!1}}getAll(){return[...this.history]}get(t){try{if(t<0||t>=this.history.length)return null;return{...this.history[t]}}catch(e){return null}}clear(){try{this.history=[],this.#c()}catch(t){throw Error("Failed to clear instructions history")}}get size(){return this.history.length}}class h{constructor(){if(h.instance)return h.instance;h.instance=this,this.history=new s,this.currentInstructions=e("userDefinedInstructions","")}async saveInstructions(t){if(!t?.trim())return{success:!1,message:"Instructions cannot be empty"};t=t.trim(),this.currentInstructions=t,i("userDefinedInstructions",t),void 0!==f&&(f=t);let e=await tI(t);return e.error||await this.history.add(t,e.content),{success:!0,message:"Scoring instructions saved! New tweets will use these instructions.",shouldClearCache:!0}}getCurrentInstructions(){return this.currentInstructions}getHistory(){return this.history.getAll()}removeFromHistory(t){return this.history.remove(t)}clearHistory(){this.history.clear()}}let g=new h,m=new Set,$=new Set,f=g.getCurrentInstructions()||"Rate the tweet on a scale from 1 to 10 based on its clarity, insight, creativity, and overall quality.",b=parseInt(e("filterThreshold","5")),y=null,v=0,x=0,_=[],w=[],E=e("selectedModel","openai/gpt-4.1-nano"),k=e("selectedImageModel","openai/gpt-4.1-nano"),S=e("showFreeModels",!0),T=e("providerSort",""),I=e("blacklistedHandles","").split("\n").filter(t=>""!==t.trim());e("tweetRatings","{}");let C="",A=e("enableImageDescriptions",!1);e("enableStreaming",!0);let R=parseFloat(e("modelTemperature","0.5")),L=parseFloat(e("modelTopP","0.9")),M=parseFloat(e("imageModelTemperature","0.5")),q=parseFloat(e("imageModelTopP","0.9")),H=parseInt(e("maxTokens","0")),B='article[data-testid="tweet"]',N='div[role="link"][tabindex="0"]',P='div[data-testid="tweetText"]';function z(t){if(!t)return"";let e=t instanceof NodeList?Array.from(t):[t];for(let i of e){let o=i?.textContent?.trim();if(o)return o}return""}function O(t){let e=t.querySelector('a[href*="/status/"] time'),i=e?.parentElement?.href;if(i&&i.includes("/status/")){let o=i.match(/\/status\/(\d+)/);return o&&o[1]?o[1]:i.substring(i.indexOf("/status/")+1)}return`tweet-${Math.random().toString(36).substring(2,15)}-${Date.now()}`}function D(t){let e=[],i=t.querySelector('div[data-testid="User-Name"] a[role="link"]');if(i){let o=i.getAttribute("href");o&&o.startsWith("/")&&e.push(o.slice(1))}if(e.length>0){let r=t.querySelector('div[role="link"][tabindex="0"]');if(r){let n=r.querySelector('div[data-testid^="UserAvatar-Container-"]');if(n){let a=n.getAttribute("data-testid"),s=a.lastIndexOf("-");if(s>=0&&s<a.length-1){let l=a.substring(s+1);l&&l!==e[0]&&e.push(l)}let d=r.querySelector('a[href*="/status/"]');if(d){let c=d.getAttribute("href"),p=c.match(/^\/([^/]+)\/status\/\d+/);p&&p[1]&&p[1]!==e[0]&&e.push(p[1])}}}}return e.length>0?e:[""]}async function F(t){if(!t)return[];let e=new Set,i='div[data-testid="tweetPhoto"] img, img[src*="pbs.twimg.com/media"], [data-testid="tweetPhoto"] img, img[src*="pbs.twimg.com/media"]',o='video[poster*="pbs.twimg.com"], video, video[poster*="pbs.twimg.com"], video',r=`${i}, ${o}`,n=t.querySelectorAll(r),a=0;for(;0===n.length&&a<5;)a++,await new Promise(t=>setTimeout(t,100)),n=t.querySelectorAll(r);return 0===n.length&&t.matches(N)&&(n=t.querySelectorAll('img[src*="pbs.twimg.com"], video[poster*="pbs.twimg.com"]')),n.forEach(t=>{let i="IMG"===t.tagName?t.src:t.poster;if(!(!i||!i.includes("pbs.twimg.com/")||i.includes("profile_images")))try{let o=new URL(i),r=o.searchParams.get("name"),n=i;r&&"orig"!==r&&(n=i.replace(`name=${r}`,"name=small")),e.add(n)}catch(a){e.add(i)}}),Array.from(e)}function U(t){let e=t.nextElementSibling;for(;e;){if(e.matches&&e.matches('div[data-testid="inline_reply_offscreen"]'))return!0;e=e.nextElementSibling}return!1}function Y(t){let e=!1,i=!1,o=t=>{if(!t||t.dataset?.filtered==="true"||t.dataset?.isAd==="true")return!0;let e=t.closest('div[data-testid="cellInnerDiv"]');if(e?.dataset?.filtered==="true"||e?.dataset?.isAd==="true")return!0;if(j(t))return e&&(e.dataset.isAd="true",e.classList.add("tweet-filtered")),t.dataset.isAd="true",!0;let i=O(t);if(m.has(i)){let o=Q.get(i);if(o&&"error"!==o.status)return!0}return!1};for(let r of t)"childList"===r.type&&(r.addedNodes.length>0&&r.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){if(t.matches&&t.matches(B))o(t)||(tm(t),e=!0);else if(t.querySelector){let i=t.querySelectorAll(B);i.forEach(t=>{o(t)||(tm(t),e=!0)})}}}),r.removedNodes.length>0&&r.removedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE&&t.dataset?.filtered!=="true"&&t.dataset?.isAd!=="true"){if(t.matches&&t.matches(B)){let e=O(t);e&&(Q.get(e)?.destroy(),i=!0)}else if(t.querySelectorAll){let o=t.querySelectorAll(B);o.forEach(t=>{if(t.dataset?.filtered==="true"||t.dataset?.isAd==="true")return;let e=O(t);e&&(Q.get(e)?.destroy(),i=!0)})}}}));e&&setTimeout(()=>{tv()},100),i&&Q.cleanupOrphaned()}function j(t){if(!t)return!1;let e=t.querySelectorAll('div[dir="ltr"] span');for(let i of e)if("Ad"===i.textContent.trim()&&!i.children.length)return!0;return!1}function G(){return window.innerWidth<=600||/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function W(t){let e=document.getElementById("status-indicator");e&&(e.textContent=t,e.classList.add("active"),setTimeout(()=>{e.classList.remove("active")},3e3))}async function V(){let t=document.getElementById("user-instructions"),e=await g.saveInstructions(t.value);W(e.message),e.success&&e.shouldClearCache&&(G()||confirm("Do you want to clear the rating cache to apply these instructions to all tweets?"))&&J(),e.success&&X()}function X(){let t=document.getElementById("instructions-list");if(!t)return;let e=g.getHistory();if(t.innerHTML="",0===e.length){let i=document.createElement("div");i.style.cssText="padding: 8px; opacity: 0.7; font-style: italic;",i.textContent="No saved instructions yet",t.appendChild(i);return}e.forEach((e,i)=>{let o=function t(e,i){let o=document.createElement("div");o.className="instruction-item",o.dataset.index=i;let r=document.createElement("div");r.className="instruction-text",r.textContent=e.summary,r.title=e.instructions,o.appendChild(r);let n=document.createElement("div");n.className="instruction-buttons";let a=document.createElement("button");a.className="use-instruction",a.textContent="Use",a.title="Use these instructions",a.onclick=()=>(function t(e){let i=document.getElementById("user-instructions");i&&(i.value=e,V())})(e.instructions),n.appendChild(a);let s=document.createElement("button");return s.className="remove-instruction",s.textContent="\xd7",s.title="Remove from history",s.onclick=()=>{var t;return t=i,void(g.removeFromHistory(t)?(X(),W("Instructions removed from history")):W("Error removing instructions"))},n.appendChild(s),o.appendChild(n),o}(e,i);t.appendChild(o)})}class K{constructor(t){if(!t||!t.nodeType||t.nodeType!==Node.ELEMENT_NODE)throw Error("ScoreIndicator requires a valid tweet article DOM element.");this.tweetArticle=t,this.tweetId=O(this.tweetArticle),this.indicatorElement=null,this.tooltipElement=null,this.tooltipControls=null,this.pinButton=null,this.copyButton=null,this.reasoningDropdown=null,this.reasoningToggle=null,this.reasoningArrow=null,this.reasoningContent=null,this.reasoningTextElement=null,this.descriptionElement=null,this.scrollButton=null,this.metadataElement=null,this.status="pending",this.score=null,this.description="",this.reasoning="",this.metadata=null,this.isPinned=!1,this.isVisible=!1,this.autoScroll=!0,this.userInitiatedScroll=!1;try{this._createElements(t),this._addEventListeners(),Q.add(this.tweetId,this),this.updateDatasetAttributes(t)}catch(e){throw this.destroy(),e}}_createElements(t){this.indicatorElement=document.createElement("div"),this.indicatorElement.className="score-indicator",this.indicatorElement.dataset.tweetId=this.tweetId;let e=window.getComputedStyle(t).position;"relative"!==e&&"absolute"!==e&&"fixed"!==e&&"sticky"!==e&&(t.style.position="relative"),t.appendChild(this.indicatorElement),this.tooltipElement=document.createElement("div"),this.tooltipElement.className="score-description",this.tooltipElement.style.display="none",this.tooltipElement.dataset.tweetId=this.tweetId,this.tooltipElement.dataset.autoScroll=this.autoScroll?"true":"false",this.tooltipControls=document.createElement("div"),this.tooltipControls.className="tooltip-controls",this.pinButton=document.createElement("button"),this.pinButton.className="tooltip-pin-button",this.pinButton.innerHTML="\uD83D\uDCCC",this.pinButton.title="Pin tooltip (prevents auto-closing)",this.copyButton=document.createElement("button"),this.copyButton.className="tooltip-copy-button",this.copyButton.innerHTML="\uD83D\uDCCB",this.copyButton.title="Copy content to clipboard",this.tooltipControls.appendChild(this.pinButton),this.tooltipControls.appendChild(this.copyButton),this.tooltipElement.appendChild(this.tooltipControls),this.reasoningDropdown=document.createElement("div"),this.reasoningDropdown.className="reasoning-dropdown",this.reasoningDropdown.style.display="none",this.reasoningToggle=document.createElement("div"),this.reasoningToggle.className="reasoning-toggle",this.reasoningArrow=document.createElement("span"),this.reasoningArrow.className="reasoning-arrow",this.reasoningArrow.textContent="‚ñ∂",this.reasoningToggle.appendChild(this.reasoningArrow),this.reasoningToggle.appendChild(document.createTextNode(" Show Reasoning Trace")),this.reasoningContent=document.createElement("div"),this.reasoningContent.className="reasoning-content",this.reasoningTextElement=document.createElement("p"),this.reasoningTextElement.className="reasoning-text",this.reasoningContent.appendChild(this.reasoningTextElement),this.reasoningDropdown.appendChild(this.reasoningToggle),this.reasoningDropdown.appendChild(this.reasoningContent),this.tooltipElement.appendChild(this.reasoningDropdown),this.descriptionElement=document.createElement("p"),this.descriptionElement.className="description-text",this.tooltipElement.appendChild(this.descriptionElement),this.metadataElement=document.createElement("div"),this.metadataElement.className="tooltip-metadata",this.metadataElement.style.display="none",this.tooltipElement.appendChild(this.metadataElement),this.scrollButton=document.createElement("div"),this.scrollButton.className="scroll-to-bottom-button",this.scrollButton.innerHTML="‚¨á Scroll to bottom",this.scrollButton.style.display="none",this.tooltipElement.appendChild(this.scrollButton);let i=document.createElement("div");i.className="tooltip-bottom-spacer",this.tooltipElement.appendChild(i),document.body.appendChild(this.tooltipElement),G()&&(this.indicatorElement?.classList.add("mobile-indicator"),this.tooltipElement?.classList.add("mobile-tooltip")),this._updateIndicatorUI(),this._updateTooltipUI()}_addEventListeners(){this.indicatorElement&&this.tooltipElement&&(this.indicatorElement.addEventListener("mouseenter",this._handleMouseEnter.bind(this)),this.indicatorElement.addEventListener("mouseleave",this._handleMouseLeave.bind(this)),this.indicatorElement.addEventListener("click",this._handleIndicatorClick.bind(this)),this.tooltipElement.addEventListener("mouseenter",this._handleTooltipMouseEnter.bind(this)),this.tooltipElement.addEventListener("mouseleave",this._handleTooltipMouseLeave.bind(this)),this.tooltipElement.addEventListener("click",this._handleTooltipClick.bind(this)),this.tooltipElement.addEventListener("scroll",this._handleTooltipScroll.bind(this)),this.pinButton?.addEventListener("click",this._handlePinClick.bind(this)),this.copyButton?.addEventListener("click",this._handleCopyClick.bind(this)),this.reasoningToggle?.addEventListener("click",this._handleReasoningToggleClick.bind(this)),this.scrollButton?.addEventListener("click",this._handleScrollButtonClick.bind(this)))}updateDatasetAttributes(t){let e=t||this.findCurrentArticleElement();e&&(e.dataset.ratingStatus=this.status,e.dataset.sloppinessScore=null!==this.score?String(this.score):"",e.dataset.ratingDescription=this.description,e.dataset.ratingReasoning=this.reasoning,e.dataset.blacklisted=String("blacklisted"===this.status),e.dataset.cachedRating=String("cached"===this.status))}_updateIndicatorUI(){if(!this.indicatorElement)return;let t=this.indicatorElement.classList;t.remove("pending-rating","rated-rating","error-rating","cached-rating","blacklisted-rating","streaming-rating");let e="",i="";switch(this.status){case"pending":i="pending-rating",e="‚è≥";break;case"streaming":i="streaming-rating",e=null!==this.score&&void 0!==this.score?String(this.score):"\uD83D\uDD04";break;case"error":i="error-rating",e="‚ö†Ô∏è";break;case"cached":i="cached-rating",e=String(this.score);break;case"blacklisted":i="blacklisted-rating",e=String(this.score);break;default:i="rated-rating",e=String(this.score)}i&&t.add(i),this.indicatorElement.textContent=e}_updateTooltipUI(){if(!this.tooltipElement||!this.descriptionElement||!this.reasoningTextElement||!this.reasoningDropdown)return;let t=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<(G()?40:55),e=this.tooltipElement.scrollTop,i=this.tooltipElement.scrollHeight,o=function t(e="",i=""){e=(e=e||"*waiting for content...*").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^#### (.*$)/gm,"<h4>$1</h4>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/SCORE_(\d+)/g,'<span class="score-highlight">SCORE: $1</span>').replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");let o="";return i&&i.trim()&&(o=i.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>")),{description:e,reasoning:o}}(this.description,this.reasoning),r=this.descriptionElement.innerHTML!==o.description||this.reasoningTextElement.innerHTML!==o.reasoning;if(this.descriptionElement.innerHTML=o.description,this.reasoningTextElement.innerHTML=o.reasoning,this.reasoningDropdown.style.display=o.reasoning?"block":"none",this.metadataElement){if(this.metadata&&Object.keys(this.metadata).length>0&&this.metadata.model){let n='<hr class="metadata-separator">';n+=`<div class="metadata-line">Model: ${this.metadata.model}</div>`,n+=`<div class="metadata-line">Tokens: prompt: ${this.metadata.promptTokens} / completion: ${this.metadata.completionTokens}</div>`,this.metadata.reasoningTokens>0&&(n+=`<div class="metadata-line">Reasoning Tokens: ${this.metadata.reasoningTokens}</div>`),n+=`<div class="metadata-line">Latency: ${this.metadata.latency}</div>`,this.metadata.mediaInputs>0&&(n+=`<div class="metadata-line">Media: ${this.metadata.mediaInputs}</div>`),n+=`<div class="metadata-line">Price: ${this.metadata.price}</div>`,this.metadataElement.innerHTML=n,this.metadataElement.style.display="block"}else this.metadataElement.innerHTML="",this.metadataElement.style.display="none"}this.tooltipElement.classList.toggle("streaming-tooltip","streaming"===this.status),r?requestAnimationFrame(()=>{if(this.autoScroll&&(t||!i))this._performAutoScroll();else if(!this.autoScroll&&i>0){let o=this.tooltipElement.scrollHeight;this.tooltipElement.scrollTop=e+(o-i)}this._updateScrollButtonVisibility()}):this._updateScrollButtonVisibility()}_performAutoScroll(){this.tooltipElement&&this.autoScroll&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(this.tooltipElement&&this.autoScroll&&this.isVisible){let t=this.tooltipElement.scrollHeight;this.tooltipElement.scrollTo({top:t,behavior:"instant"}),setTimeout(()=>{if(this.tooltipElement&&this.autoScroll&&this.isVisible){let t=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<5;t||(this.tooltipElement.scrollTop=this.tooltipElement.scrollHeight)}},50)}})})}_setPosition(){if(!this.isVisible||!this.indicatorElement||!this.tooltipElement)return;let t=this.indicatorElement.getBoundingClientRect(),e=this.tooltipElement,i=G(),o=window.innerHeight,r=window.innerWidth,n=o-10,a=r-10;e.style.maxHeight="",e.style.overflowY="",e.style.visibility="hidden",e.style.display="block";let s=window.getComputedStyle(e),l=parseFloat(s.width),d=parseFloat(s.height),c,p,u="",h="";if(i){(c=Math.max(10,(r-l)/2))+l>a&&(c=a-l);let g=.8*o;d>g&&(u=`${g}px`,h="scroll",d=g),(p=Math.max(10,(o-d)/2))+d>n&&(p=n-d)}else c=t.right+10,p=t.top+t.height/2-d/2,c+l>a&&(c=t.left-l-10)<10&&(c=Math.max(10,(r-l)/2),t.bottom+d+10<=n?p=t.bottom+10:t.top-d-10>=10?p=t.top-d-10:(p=10,u=`${n-10}px`,h="scroll",d=n-10)),p<10&&(p=10),p+d>n&&(d>n-10?(p=10,u=`${n-10}px`,h="scroll"):p=n-d);e.style.position="fixed",e.style.left=`${c}px`,e.style.top=`${p}px`,e.style.zIndex="99999999",e.style.maxHeight=u,e.style.overflowY=h,"scroll"===h&&(e.style.webkitOverflowScrolling="touch"),e.style.visibility="visible"}_updateScrollButtonVisibility(){if(!this.tooltipElement||!this.scrollButton)return;let t="streaming"===this.status;if(!t){this.scrollButton.style.display="none";return}let e=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<(G()?40:55);this.scrollButton.style.display=e?"none":"block"}_handleMouseEnter(t){G()||this.show()}_handleMouseLeave(t){G()||setTimeout(()=>{this.tooltipElement&&!this.tooltipElement.matches(":hover")&&this.indicatorElement&&!this.indicatorElement.matches(":hover")&&this.hide()},100)}_handleIndicatorClick(t){t.stopPropagation(),t.preventDefault(),this.toggle()}_handleTooltipMouseEnter(){this.isPinned||this.show()}_handleTooltipMouseLeave(){this.isPinned||this.hide()}_handleTooltipClick(t){this.isPinned||t.target.closest(".tooltip-controls button")||t.target.closest(".reasoning-toggle")||t.target.closest(".scroll-to-bottom-button")||this.hide()}_handleTooltipScroll(){if(!this.tooltipElement)return;let t=this.tooltipElement.scrollHeight-this.tooltipElement.scrollTop-this.tooltipElement.clientHeight<(G()?40:55);t?this.userInitiatedScroll&&(this.autoScroll=!0,this.tooltipElement.dataset.autoScroll="true",this.userInitiatedScroll=!1):this.autoScroll&&(this.autoScroll=!1,this.tooltipElement.dataset.autoScroll="false",this.userInitiatedScroll=!0),this._updateScrollButtonVisibility()}_handlePinClick(t){t.stopPropagation(),this.isPinned?this.unpin():this.pin()}_handleCopyClick(t){if(t.stopPropagation(),!this.descriptionElement||!this.reasoningTextElement||!this.copyButton)return;let e=this.descriptionElement.textContent||"",i=this.reasoningTextElement.textContent||"";i&&(e+="\n\nReasoning:\n"+i),navigator.clipboard.writeText(e).then(()=>{let t=this.copyButton.innerHTML;this.copyButton.innerHTML="‚úì",this.copyButton.disabled=!0,setTimeout(()=>{this.copyButton.innerHTML=t,this.copyButton.disabled=!1},1500)}).catch(t=>{})}_handleReasoningToggleClick(t){if(t.stopPropagation(),!this.reasoningDropdown||!this.reasoningContent||!this.reasoningArrow)return;let e=this.reasoningDropdown.classList.toggle("expanded");this.reasoningArrow.textContent=e?"‚ñº":"‚ñ∂",e?(this.reasoningContent.style.maxHeight="300px",this.reasoningContent.style.padding="10px"):(this.reasoningContent.style.maxHeight="0",this.reasoningContent.style.padding="0 10px")}_handleScrollButtonClick(t){t.stopPropagation(),this.tooltipElement&&(this.autoScroll=!0,this.tooltipElement.dataset.autoScroll="true",this._performAutoScroll(),this._updateScrollButtonVisibility())}update({status:t,score:e=null,description:i="",reasoning:o="",metadata:r=null}){let n=void 0!==t&&this.status!==t,a=null!==e&&this.score!==e,s=""!==i&&this.description!==i,l=""!==o&&this.reasoning!==o,d=null!==r&&JSON.stringify(this.metadata)!==JSON.stringify(r);if(n||a||s||l||d){if(n&&(this.status=t),(a||n)&&(this.score="pending"===this.status||"error"===this.status?e:"streaming"===this.status&&null===e?this.score:e),s&&(this.description=i),l&&(this.reasoning=o),d&&(this.metadata=r),n){let c="pending"===this.status||"streaming"===this.status;this.autoScroll!==c&&(this.autoScroll=c,this.tooltipElement&&(this.tooltipElement.dataset.autoScroll=this.autoScroll?"true":"false"))}(n||a)&&this._updateIndicatorUI(),s||l||n||d?this._updateTooltipUI():this._updateScrollButtonVisibility(),this.updateDatasetAttributes()}}show(){this.tooltipElement&&(this.isVisible=!0,this.tooltipElement.style.display="block",this._setPosition(),this.autoScroll&&("streaming"===this.status||"pending"===this.status)&&this._performAutoScroll(),this._updateScrollButtonVisibility())}hide(){!this.isPinned&&this.tooltipElement?(this.isVisible=!1,this.tooltipElement.style.display="none"):this.isPinned}toggle(){this.isVisible&&!this.isPinned?this.hide():this.show()}pin(){this.tooltipElement&&this.pinButton&&(this.isPinned=!0,this.tooltipElement.classList.add("pinned"),this.pinButton.innerHTML="\uD83D\uDCCD",this.pinButton.title="Unpin tooltip")}unpin(){this.tooltipElement&&this.pinButton&&(this.isPinned=!1,this.tooltipElement.classList.remove("pinned"),this.pinButton.innerHTML="\uD83D\uDCCC",this.pinButton.title="Pin tooltip (prevents auto-closing)",setTimeout(()=>{this.tooltipElement&&!this.tooltipElement.matches(":hover")&&this.indicatorElement&&!this.indicatorElement.matches(":hover")&&this.hide()},0))}destroy(){window.activeStreamingRequests&&window.activeStreamingRequests[this.tweetId]&&(window.activeStreamingRequests[this.tweetId].abort(),delete window.activeStreamingRequests[this.tweetId]),this.indicatorElement?.removeEventListener("mouseenter",this._handleMouseEnter),this.indicatorElement?.removeEventListener("mouseleave",this._handleMouseLeave),this.indicatorElement?.removeEventListener("click",this._handleIndicatorClick),this.tooltipElement?.removeEventListener("mouseenter",this._handleTooltipMouseEnter),this.tooltipElement?.removeEventListener("mouseleave",this._handleTooltipMouseLeave),this.tooltipElement?.removeEventListener("click",this._handleTooltipClick),this.tooltipElement?.removeEventListener("scroll",this._handleTooltipScroll),this.pinButton?.removeEventListener("click",this._handlePinClick),this.copyButton?.removeEventListener("click",this._handleCopyClick),this.reasoningToggle?.removeEventListener("click",this._handleReasoningToggleClick),this.scrollButton?.removeEventListener("click",this._handleScrollButtonClick),this.indicatorElement?.remove(),this.tooltipElement?.remove(),Q.remove(this.tweetId);let t=this.findCurrentArticleElement();t&&delete t.dataset.hasScoreIndicator,this.tweetArticle=null,this.indicatorElement=null,this.tooltipElement=null,this.pinButton=null,this.copyButton=null,this.reasoningToggle=null,this.scrollButton=null}ensureIndicatorAttached(){if(!this.indicatorElement)return;let t=this.findCurrentArticleElement();if(t){if(this.indicatorElement.parentElement!==t){let e=window.getComputedStyle(t).position;"relative"!==e&&"absolute"!==e&&"fixed"!==e&&"sticky"!==e&&(t.style.position="relative"),t.appendChild(this.indicatorElement)}this.updateDatasetAttributes(t)}}findCurrentArticleElement(){let t=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(!t)return null;let e=`a[href*="/status/${this.tweetId}"]`,i=t.querySelector(e),o=i?.closest('article[data-testid="tweet"]');if(o&&O(o)===this.tweetId)return o;let r=t.querySelectorAll('article[data-testid="tweet"]');for(let n of r)if(O(n)===this.tweetId)return n;return null}}let Q={managers:new Map,get(t,e=null){if(!t)return null;if(this.managers.has(t)){let i=this.managers.get(t);return e&&i.tweetArticle,i}if(e)try{let o=e.querySelector(`.score-indicator[data-tweet-id="${t}"]`),r=document.querySelector(`.score-description[data-tweet-id="${t}"]`);return(o||r)&&(o?.remove(),r?.remove()),new K(e)}catch(n){}return null},add(t,e){this.managers.has(t),this.managers.set(t,e)},remove(t){this.managers.has(t)&&this.managers.delete(t)},cleanupOrphaned(){let t=0,e=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(!e)return;let i=new Set;for(let[o,r]of(e.querySelectorAll('article[data-testid="tweet"]').forEach(t=>{let e=O(t);e&&i.add(e)}),this.managers.entries())){let n=r.indicatorElement?.isConnected,a=i.has(o);(!n||!a)&&(r.destroy(),t++)}},destroyAll(){[...this.managers.values()].forEach(t=>t.destroy()),this.managers.clear()}};function Z(t,e,i,o){if(!t||!e)return;let r=t.classList.contains("hidden");if(e.innerHTML=r?i:o,r?(t.style.display="flex",t.offsetHeight,t.classList.remove("hidden")):(t.classList.add("hidden"),setTimeout(()=>{t.classList.contains("hidden")&&(t.style.display="none")},500)),"tweet-filter-container"===t.id){let n=document.getElementById("filter-toggle");n&&(r?n.style.display="none":setTimeout(()=>{n.style.display="block"},500))}}function J(){(G()||confirm("Are you sure you want to clear all cached tweet ratings?"))&&(a.clear(!0),x=0,window.threadRelationships&&(window.threadRelationships={},i("threadRelationships","{}")),W("All cached ratings and thread relationships cleared!"),y&&y.querySelectorAll('article[data-testid="tweet"]').forEach(t=>{t.removeAttribute("data-sloppiness-score"),t.removeAttribute("data-rating-status"),t.removeAttribute("data-rating-description"),t.removeAttribute("data-cached-rating");let e=t.querySelector(".score-indicator");e&&e.remove();let i=O(t);if(i){m.delete(i);let o=Q.get(i);o&&o.destroy(),tm(t)}}),document.querySelectorAll('div[aria-label="Timeline: Conversation"], div[aria-label^="Timeline: Conversation"]').forEach(t=>{delete t.dataset.threadMapping,delete t.dataset.threadMappedAt,delete t.dataset.threadMappingInProgress,delete t.dataset.threadHist,delete t.dataset.threadMediaUrls}))}function tt(t,e){let o;if(o="checkbox"===t.type?t.checked:t.value,void 0!==window[e]&&(window[e]=o),i(e,o),"enableImageDescriptions"===e){let r=document.getElementById("image-model-container");r&&(r.style.display=o?"block":"none"),W("Image descriptions "+(o?"enabled":"disabled"))}}function te(){document.querySelectorAll("[data-setting]").forEach(t=>{let i=t.dataset.setting,o=e(i,window[i]);"checkbox"===t.type?(t.checked=o,tt(t,i)):t.value=o}),document.querySelectorAll(".parameter-row[data-param-name]").forEach(t=>{let i=t.dataset.paramName,o=t.querySelector(".parameter-slider"),r=t.querySelector(".parameter-value"),n=e(i,window[i]);o&&(o.value=n),r&&(r.value=n)});let t=document.getElementById("tweet-filter-slider"),i=document.getElementById("tweet-filter-value"),o=e("filterThreshold","5");if(t&&i){t.value=o,i.value=o;let r=parseInt(o,10)/10*100;t.style.setProperty("--slider-percent",`${r}%`)}ti(document.getElementById("handle-list")),to(),document.querySelectorAll(".advanced-content").forEach(t=>{t.classList.contains("expanded")||(t.style.maxHeight="0")}),document.querySelectorAll(".advanced-toggle-icon.expanded").forEach(t=>{t.closest(".advanced-toggle")?.nextElementSibling?.classList.contains("expanded")||t.classList.remove("expanded")}),X()}function ti(t){if(t){if(t.innerHTML="",0===I.length){let e=document.createElement("div");e.style.cssText="padding: 8px; opacity: 0.7; font-style: italic;",e.textContent="No handles added yet",t.appendChild(e);return}I.forEach(e=>{let i=document.createElement("div");i.className="handle-item";let o=document.createElement("div");o.className="handle-text",o.textContent="@"+e,i.appendChild(o);let r=document.createElement("button");r.className="remove-handle",r.textContent="\xd7",r.title="Remove from list",i.appendChild(r),t.appendChild(i)})}}function to(){let t=document.getElementById("model-select-container"),o=document.getElementById("image-model-select-container");w=[..._],S||(w=w.filter(t=>!t.slug.endsWith(":free")));let r=e("sortDirection","default"),n=e("modelSortOrder","throughput-high-to-low"),a=document.getElementById("sort-direction");if(a)switch(n){case"latency-low-to-high":default:a.textContent="default"===r?"High-Low":"Low-High","reverse"===r&&w.reverse();break;case"":a.textContent="default"===r?"New-Old":"Old-New","reverse"===r&&w.reverse();break;case"top-weekly":a.textContent="default"===r?"Most Popular":"Least Popular","reverse"===r&&w.reverse()}if(t&&(t.innerHTML="",tn(t,"model-selector",w.map(t=>({value:t.slug||t.id,label:tr(t)})),E,t=>{i("selectedModel",E=t),W("Rating model updated")},"Search rating models...")),o){let s=w.filter(t=>t.input_modalities?.includes("image")||t.architecture?.input_modalities?.includes("image")||t.architecture?.modality?.includes("image"));o.innerHTML="",tn(o,"image-model-selector",s.map(t=>({value:t.slug||t.id,label:tr(t)})),k,t=>{i("selectedImageModel",k=t),W("Image model updated")},"Search vision models...")}}function tr(t){let e=t.slug||t.id||t.name||"Unknown Model",i="",o=t.endpoint?.pricing||t.pricing;if(o){let r=parseFloat(o.prompt),n=parseFloat(o.completion);isNaN(r)?isNaN(n)||(i+=` - $${(1e6*n).toFixed(4)}/mil. tok.-out`):(i+=` - $${(1e6*r).toFixed(4)}/mil. tok.-in`,isNaN(n)||n===r||(i+=` $${(1e6*n).toFixed(4)}/mil. tok.-out`))}let a=t.input_modalities?.includes("image")||t.architecture?.input_modalities?.includes("image")||t.architecture?.modality?.includes("image");return a&&(e="\uD83D\uDDBCÔ∏è "+e),e+i}function tn(t,e,i,o,r,n){let a=o,s=document.createElement("div");s.className="custom-select",s.id=e;let l=document.createElement("div");l.className="select-selected";let d=document.createElement("div");d.className="select-items",d.style.display="none";let c=document.createElement("div");c.className="search-field";let p=document.createElement("input");function u(t=""){for(;d.childNodes.length>1;)d.removeChild(d.lastChild);let e=i.filter(e=>e.label.toLowerCase().includes(t.toLowerCase()));if(0===e.length){let o=document.createElement("div");o.textContent="No matches found",o.style.cssText="opacity: 0.7; font-style: italic; padding: 10px; text-align: center; cursor: default;",d.appendChild(o)}e.forEach(t=>{let e=document.createElement("div");e.textContent=t.label,e.dataset.value=t.value,t.value===a&&e.classList.add("same-as-selected"),e.addEventListener("click",e=>{e.stopPropagation(),a=t.value,l.textContent=t.label,d.style.display="none",l.classList.remove("select-arrow-active"),d.querySelectorAll("div[data-value]").forEach(t=>{t.classList.toggle("same-as-selected",t.dataset.value===a)}),r(a)}),d.appendChild(e)})}p.type="text",p.className="search-input",p.placeholder=n||"Search...",c.appendChild(p),d.appendChild(c);let h=i.find(t=>t.value===a);l.textContent=h?h.label:"Select an option",s.appendChild(l),s.appendChild(d),t.appendChild(s),u(),p.addEventListener("input",()=>u(p.value)),p.addEventListener("click",t=>t.stopPropagation()),l.addEventListener("click",t=>{t.stopPropagation(),ta(s);let e="none"===d.style.display;d.style.display=e?"block":"none",l.classList.toggle("select-arrow-active",e),e&&(p.focus(),p.select(),u())})}function ta(t=null){document.querySelectorAll(".custom-select").forEach(e=>{if(e===t)return;let i=e.querySelector(".select-items"),o=e.querySelector(".select-selected");i&&(i.style.display="none"),o&&o.classList.remove("select-arrow-active")})}function ts(t=!1){if(t||confirm("Are you sure you want to reset all settings to their default values? This will not clear your cached ratings, blacklisted handles, or instruction history.")){a.clear();let e={selectedModel:"openai/gpt-4.1-nano",selectedImageModel:"openai/gpt-4.1-nano",enableImageDescriptions:!1,enableStreaming:!0,modelTemperature:.5,modelTopP:.9,imageModelTemperature:.5,imageModelTopP:.9,maxTokens:0,filterThreshold:5,userDefinedInstructions:"Rate the tweet on a scale from 1 to 10 based on its clarity, insight, creativity, and overall quality.",modelSortOrder:"throughput-high-to-low"};for(let o in e)void 0!==window[o]&&(window[o]=e[o]),i(o,e[o]);te(),t0(),W("Settings reset to defaults")}}function tl(t){let i=t.closest('div[data-testid="cellInnerDiv"]');if(!i)return;let o=D(t),r=o.length>0?o[0]:"";if(r&&$.has(r)){let n=O(t);n&&Q.get(n)?.destroy(),i.innerHTML="",i.dataset.filtered="true",i.dataset.isAd="true";return}let a=parseInt(t.dataset.sloppinessScore||"9",10),s=O(t),l=Q.get(s);l?.ensureIndicatorAttached();let d=parseInt(e("filterThreshold","1")),c=t.dataset.ratingStatus;"pending"===c||"streaming"===c?delete i.dataset.filtered:(isNaN(a)||a<d)&&(s&&Q.get(s)?.destroy(),i.innerHTML="",i.dataset.filtered="true")}function td(t){return!!t&&(t=t.toLowerCase().trim(),I.some(e=>e.toLowerCase().trim()===t))}let tc=["rated","cached","blacklisted"],tp=["pending","streaming"];function tu(t){return tc.includes(t)}function th(t){return tp.includes(t)}async function tg(t,i,o){let r=!1;try{let n=e("openrouter-api-key","");if(!n){t.dataset.ratingStatus="error",t.dataset.ratingDescription="No API key",Q.get(i,t)?.update({status:"error",score:9,description:"No API key"}),tl(t);return}if(o&&$.has(o)){t.dataset.ratingStatus="rated",t.dataset.ratingDescription="Advertisement",t.dataset.sloppinessScore="0",Q.get(i,t)?.update({status:"rated",score:0,description:"Advertisement from known ad author"}),tl(t),r=!0;return}if(j(t)){o&&$.add(o),t.dataset.ratingStatus="rated",t.dataset.ratingDescription="Advertisement",t.dataset.sloppinessScore="0",Q.get(i,t)?.update({status:"rated",score:0,description:"Advertisement"}),tl(t),r=!0;return}let s=5,l="",d="";try{let c=a.get(i);c&&(!0!==c.streaming||void 0!==c.score&&null!==c.score)&&(c.streaming||void 0!==c.score&&null!==c.score||a.delete(i));let p=await ty(t,i,n);if(!p)throw Error("Failed to get tweet context");let u=[];if(document.querySelector('div[aria-label="Timeline: Conversation"]')){let h=tw(i);h&&h.replyTo&&(a.has(i)||a.set(i,{}),a.get(i).threadContext||(a.get(i).threadContext={replyTo:h.to,replyToId:h.replyTo,isRoot:!1}))}let g=p.matchAll(/(?:\[MEDIA_URLS\]:\s*\n)(.*?)(?:\n|$)/g),f=p.matchAll(/(?:\[QUOTED_TWEET_MEDIA_URLS\]:\s*\n)(.*?)(?:\n|$)/g);for(let b of g)b[1]&&u.push(...b[1].split(", ").filter(t=>t.trim()));for(let y of f)y[1]&&u.push(...y[1].split(", ").filter(t=>t.trim()));if(u=[...new Set(u.filter(t=>t.trim()))],p)try{let v=a.get(i),x=v&&!v.streaming&&void 0!==v.score&&null!==v.score;if(x){s=v.score,l=v.description||"",d=v.reasoning||"",r=!0,Q.get(i,t)?.update({status:v.fromStorage?"cached":"rated",score:s,description:l,reasoning:d}),tl(t);return}let _=await tT(p,i,n,u,3,t,o);s=_.score,l=_.content,d=_.reasoning||"";let w=_.error?"error":"rated";if(!_.error){let E=a.get(i);E&&E.fromStorage?w="cached":_.cached&&(w="cached")}if(t.dataset.ratingStatus=w,t.dataset.ratingDescription=l||"not available",t.dataset.sloppinessScore=s?.toString()||"",t.dataset.ratingReasoning=d,Q.get(i,t)?.update({status:w,score:s,description:l,reasoning:d}),r=!_.error,a.has(i)){let k=a.get(i);k.score=s,k.description=l,k.reasoning=d,k.tweetContent=p,k.streaming=!1,_.error&&(k.error=!0)}else _.error||a.set(i,{score:s,description:l,reasoning:d,tweetContent:p,streaming:!1});tl(t);return}catch(S){s=5,l=`API Error: ${S.message}`,d="",r=!1,Q.get(i,t)?.update({status:"error",score:s,description:l}),a.has(i)&&(a.get(i).streaming=!1),tl(t);return}tl(t)}catch(T){let I=Q.get(i);I&&"error"!==I.status&&I.update({status:"error",score:5,description:"Error during processing: "+T.message}),tl(t),r=!1}finally{r||m.delete(i)}}catch(C){let A=Q.get(i);A&&A.update({status:"error",score:5,description:"Error during processing: "+C.message}),tl(t),r=!1}finally{if(!r){m.delete(i);let R=Q.get(i);R&&!tu(R.status)&&setTimeout(()=>{tu(Q.get(i)?.status)||tm(t)},300)}}}function tm(t){let e=O(t);if(!e||window.activeStreamingRequests&&window.activeStreamingRequests[e])return;let i=D(t),o=i.length>0?i[0]:"";if(o&&$.has(o)){tl(t);return}if(j(t)){o&&$.add(o),tl(t);return}let r=Q.get(e);if(r){if(r.ensureIndicatorAttached(),tu(r.status)||th(r.status)&&m.has(e)){tl(t);return}m.delete(e)}if(o&&td(o)){t.dataset.sloppinessScore="10",t.dataset.blacklisted="true",t.dataset.ratingStatus="blacklisted",t.dataset.ratingDescription="Whitelisted user",Q.get(e,t)?.update({status:"blacklisted",score:10,description:"User is whitelisted"}),tl(t);return}if(a.has(e)){let n=!0===a.get(e).streaming&&(void 0===a.get(e).score||null===a.get(e).score);if(!n){let s=function t(e){let i=O(e),o=D(e),r=o.length>0?o[0]:"";if(r&&td(r))return e.dataset.sloppinessScore="10",e.dataset.blacklisted="true",e.dataset.ratingStatus="blacklisted",e.dataset.ratingDescription="Whitelisted user",Q.get(i,e)?.update({status:"blacklisted",score:10,description:"User is whitelisted"}),tl(e),!0;let n=a.get(i);if(n){if(!0===n.streaming&&(void 0===n.score||null===n.score))return!1;if(void 0!==n.score&&null!==n.score){let s=n.score,l=n.description,d=n.reasoning||"";e.dataset.sloppinessScore=s.toString(),e.dataset.cachedRating="true",d&&(e.dataset.ratingReasoning=d);let c="rated";if(!0===n.streaming&&!n.score)return c="streaming",!1;{let p=!0===n.fromStorage;c=p?"cached":"rated"}let u=n.metadata||null;return Q.get(i,e)?.update({status:c,score:s,description:l,reasoning:d,metadata:u}),tl(e),!0}n.streaming||a.delete(i)}return!1}(t);if(s)return}}if(m.has(e)){let l=Q.get(e);if(l&&(l.ensureIndicatorAttached(),"pending"===l.status||"streaming"===l.status)){tl(t);return}m.delete(e)}let d=Q.get(e,t);if(d){if("blacklisted"!==d.status&&"cached"!==d.status&&"rated"!==d.status)d.update({status:"pending",score:null,description:"Rating scheduled..."});else{d.ensureIndicatorAttached(),tl(t);return}}m.has(e)||m.add(e),setTimeout(()=>{try{tg(t,e,o)}catch(i){m.delete(e)}},150)}let t$={},tf=!1;async function tb(t,e=5){if(!t||e<=0)return[];let i=[],o=t,r=0;for(;o&&r<e;){let n=t$[o];if(!n||!n.replyTo)break;i.push({fromId:o,toId:n.replyTo,from:n.from,to:n.to}),o=n.replyTo,r++}return i}async function ty(t,i,o){let r=D(t),n=r.length>0?r[0]:"",s=r.length>1?r[1]:"",l=z(t.querySelector(P)),d=await F(t),c="",p=[],u=null,h=t.querySelector(N);if(h){let g=h.querySelector('a[href*="/status/"]');if(g){let m=g.getAttribute("href"),$=m.match(/\/status\/(\d+)/);$&&$[1]&&(u=$[1])}c=z(h.querySelector(P))||"",p=await F(h)}let f=document.querySelector('div[aria-label="Timeline: Conversation"]')||document.querySelector('div[aria-label^="Timeline: Conversation"]'),b=[];if(f&&f.dataset.threadMapping&&a.has(i)&&a.get(i).threadContext?.threadMediaUrls)b=a.get(i).threadContext.threadMediaUrls||[];else if(f&&f.dataset.threadMediaUrls)try{let y=JSON.parse(f.dataset.threadMediaUrls);b=Array.isArray(y)?y:[]}catch(v){}let x=[...d].filter(t=>!p.includes(t)),_=`[TWEET ${i}]
 Author:@${n}:
`+l;if(x.length>0){if(A=e("enableImageDescriptions",!1)){let w=await tE(x,o,i,n);_+=`
[MEDIA_DESCRIPTION]:
${w}`}_+=`
[MEDIA_URLS]:
${x.join(", ")}`}if(!U(t)&&b.length>0){let E=b.filter(t=>!x.includes(t)&&!p.includes(t));E.length>0&&(_+=`
[THREAD_MEDIA_URLS]:
${E.join(", ")}`)}if((c||p.length>0)&&(_+=`
[QUOTED_TWEET${u?" "+u:""}]:
 Author:@${s}:
${c}`,p.length>0)){if(A){let k=await tE(p,o,i,n);_+=`
[QUOTED_TWEET_MEDIA_DESCRIPTION]:
${k}`}_+=`
[QUOTED_TWEET_MEDIA_URLS]:
${p.join(", ")}`}if(document.querySelector('div[aria-label="Timeline: Conversation"]','div[aria-label^="Timeline: Conversation"]')){let S=await tb(i),T=!1;if(f&&f.dataset.threadHist&&!U(t)&&(_=f.dataset.threadHist+`
[REPLY]
`+_,T=!0),S.length>0&&!T){let I="\n[REPLY CHAIN]\n";for(let C=S.length-1;C>=0;C--){let R=S[C];I+=`Tweet ${R.fromId} by @${R.from||"unknown"} is a reply to tweet ${R.toId} by @${R.to||"unknown"}
`}_=I+_}let L=tw(i);L&&L.replyTo&&!T&&0===S.length&&(_=`[REPLY TO TWEET ${L.replyTo}]
`+_)}return t.dataset.fullContext=_,_}function tv(){if(!y)return;let t=y.querySelectorAll(B);t.forEach(tl)}async function tx(){try{let t=document.querySelector('div[aria-label="Timeline: Conversation"]');if(t||(t=document.querySelector('div[aria-label^="Timeline: Conversation"]')),!t||tf||"pending"===t.dataset.threadHist)return;if(t.dataset.threadMappedAt){let i=parseInt(t.dataset.threadMappedAt,10);if(Date.now()-i<1e4)return}let o=location.pathname.match(/status\/(\d+)/),r=o?o[1]:null;if(!r)return;if(void 0===t.dataset.threadHist){C="";let n=document.querySelector('article[data-testid="tweet"]');if(n){t.dataset.threadHist="pending",tf=!0;try{let s=O(n);if(!s)throw Error("Failed to get tweet ID from first article");let l=e("openrouter-api-key",""),d=await ty(n,s,l);if(!d)throw Error("Failed to get full context for root tweet");C=d,t.dataset.threadHist=C,t.firstChild&&(t.firstChild.dataset.canary="true"),m.has(s)||tm(n),setTimeout(()=>{t_(t,r)},10)}catch(c){tf=!1,delete t.dataset.threadHist}return}}else if("pending"!==t.dataset.threadHist&&t.firstChild&&void 0===t.firstChild.dataset.canary){t.firstChild&&(t.firstChild.dataset.canary="pending"),tf=!0;try{let p=document.querySelector('article[data-testid="tweet"]:has(~ div[data-testid="inline_reply_offscreen"])');if(p){let u=O(p);if(!u)throw Error("Failed to get tweet ID from next article");if(a.has(u)&&a.get(u).tweetContent)C=C+"\n[REPLY]\n"+a.get(u).tweetContent;else{let h=e("openrouter-api-key","");await new Promise(t=>setTimeout(t,10));let g=await ty(p,u,h);if(!g)throw Error("Failed to get context for next article");C=C+"\n[REPLY]\n"+g}t.dataset.threadHist=C}setTimeout(()=>{t_(t,r)},500)}catch($){tf=!1,t.firstChild&&delete t.firstChild.dataset.canary}}else tf||t.dataset.threadMappingInProgress||(tf=!0,setTimeout(()=>{t_(t,r)},250))}catch(f){tf=!1}}async function t_(t,o){t.dataset.threadMappingInProgress="true",t.dataset.threadMappedAt=Date.now().toString(),tf=!0;try{let r=new Promise((t,e)=>setTimeout(()=>e(Error("Thread mapping timed out")),5e3)),n=async()=>{let r=Array.from(document.querySelectorAll('div[data-testid="cellInnerDiv"]'));if(!r.length){delete t.dataset.threadMappingInProgress,tf=!1;return}let n=[],l=0;for(let d=0;d<r.length;d++){let c=r[d],p=c.querySelector('article[data-testid="tweet"]');if(p)try{let u=O(p);if(!u){let h=p.querySelector('a[href*="/status/"]');if(h){let g=h.href.match(/status\/(\d+)/);g&&(u=g[1])}}if(!u)continue;let $=D(p),f=$.length>0?$[0]:null;if(!f)continue;let b=p.querySelector('[data-testid="tweetText"]'),y=b?b.innerText.trim().replace(/\n+/g," ‚èé "):"",v=await F(p),x=[],_=p.querySelector(N);_&&(x=await F(_));let w=r[d-1]||null,E=!1;if(w&&1===w.childElementCount){let k=w.children[0];k&&0===k.children.length&&""===k.innerHTML.trim()&&(E=!0)}n.push({tweetNode:p,username:f,tweetId:u,text:y,mediaLinks:v,quotedMediaLinks:x,cellIndex:d,isReplyToRoot:E,cellDiv:c,index:l++}),m.has(u)||tm(p)}catch(S){continue}}if(0===n.length){delete t.dataset.threadMappingInProgress,tf=!1;return}for(let T=0;T<n.length;++T){let I=n[T];if(I.tweetId===o)I.replyTo=null,I.isRoot=!0;else if(I.isReplyToRoot){let C=n.find(t=>t.tweetId===o);I.replyTo=C?C.username:null,I.replyToId=C?C.tweetId:null,I.isRoot=!1}else T>0&&(I.replyTo=n[T-1].username,I.replyToId=n[T-1].tweetId,I.isRoot=!1)}let A=n.map(t=>({from:t.username,tweetId:t.tweetId,to:t.replyTo,toId:t.replyToId,isRoot:!0===t.isRoot,text:t.text,mediaLinks:t.mediaLinks||[],quotedMediaLinks:t.quotedMediaLinks||[]}));for(let R of n)if(!R.replyToId&&!R.isRoot&&t$[R.tweetId]?.replyTo){R.replyToId=t$[R.tweetId].replyTo,R.replyTo=t$[R.tweetId].to;let L=A.find(t=>t.tweetId===R.tweetId);L&&(L.toId=R.replyToId,L.to=R.replyTo)}t.dataset.threadMapping=JSON.stringify(A);let M=Date.now();A.forEach(t=>{t.tweetId&&t.toId?t$[t.tweetId]={replyTo:t.toId,from:t.from,to:t.to,isRoot:!1,timestamp:M}:t.tweetId&&t.isRoot&&(t$[t.tweetId]={replyTo:null,from:t.from,isRoot:!0,timestamp:M})}),function t(){try{let e=Object.keys(t$).length;if(e>1e3){let o=Object.entries(t$);o.sort((t,e)=>(e[1].timestamp||0)-(t[1].timestamp||0));let r=o.slice(0,500);t$=Object.fromEntries(r)}i("threadRelationships",JSON.stringify(t$))}catch(n){}}();let q="",H=A.find(t=>!0===t.isRoot);if(H&&H.tweetId){let B=n.find(t=>t.tweetId===H.tweetId)?.tweetNode;if(B)try{let P=e("openrouter-api-key",""),z=await ty(B,H.tweetId,P);if(z){q=z,t.dataset.threadHist=q;let U=[];A.forEach(t=>{t.mediaLinks&&t.mediaLinks.length&&U.push(...t.mediaLinks),t.quotedMediaLinks&&t.quotedMediaLinks.length&&U.push(...t.quotedMediaLinks)}),U.length>0&&(t.dataset.threadMediaUrls=JSON.stringify(U))}}catch(Y){}}for(let j=0;j<A.length;j+=10){let G=A.slice(j,j+10);G.forEach(t=>{if(t.tweetId&&a.has(t.tweetId)&&(a.get(t.tweetId).threadContext={replyTo:t.to,replyToId:t.toId,isRoot:t.isRoot,threadMediaUrls:t.isRoot?[]:s(t.tweetId,A)},t.tweetId&&m.has(t.tweetId))){let e=n.find(e=>e.tweetId===t.tweetId);if(e&&e.tweetNode){let i="streaming"===e.tweetNode.dataset.ratingStatus||a.has(t.tweetId)&&!0===a.get(t.tweetId).streaming;i||(m.delete(t.tweetId),tm(e.tweetNode))}}}),j+10<A.length&&await new Promise(t=>setTimeout(t,0))}delete t.dataset.threadMappingInProgress,tf=!1};function s(t,e){let i=[],o=e.findIndex(e=>e.tweetId===t);if(o>0)for(let r=0;r<o;r++)e[r].mediaLinks&&e[r].mediaLinks.length&&i.push(...e[r].mediaLinks),e[r].quotedMediaLinks&&e[r].quotedMediaLinks.length&&i.push(...e[r].quotedMediaLinks);return i}await Promise.race([n(),r])}catch(l){delete t.dataset.threadMappedAt,delete t.dataset.threadMappingInProgress,tf=!1}}function tw(t){return t$[t]?t$[t]:null}async function t3(t,e,i=3e4){return new Promise(o=>{GM_xmlhttpRequest({method:"POST",url:"https://openrouter.ai/api/v1/chat/completions",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},data:JSON.stringify(t),timeout:i,onload:function(t){if(t.status>=200&&t.status<300)try{let e=JSON.parse(t.responseText);""===e.content&&o({error:!0,message:`No content returned${"SAFETY"==e.choices[0].native_finish_reason?" (SAFETY FILTER)":""}`,data:e}),o({error:!1,message:"Request successful",data:e})}catch(i){o({error:!0,message:`Failed to parse response: ${i.message}`,data:null})}else o({error:!0,message:`Request failed with status ${t.status}: ${t.responseText}`,data:null})},onerror:function(t){o({error:!0,message:`Request error: ${t.toString()}`,data:null})},ontimeout:function(){o({error:!0,message:`Request timed out after ${i}ms`,data:null})}})})}function t0(){let t=e("openrouter-api-key","");if(!t){W("Please enter your OpenRouter API key");return}W("Fetching available models...");let i=e("modelSortOrder","throughput-high-to-low");GM_xmlhttpRequest({method:"GET",url:`https://openrouter.ai/api/frontend/models/find?order=${i}`,headers:{Authorization:`Bearer ${t}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532182-twitter-x-ai-tweet-filter","X-Title":"Tweet Rating Tool"},onload:function(t){try{let e=JSON.parse(t.responseText);if(e.data&&e.data.models){let o=e.data.models.filter(t=>t.endpoint&&null!==t.endpoint);("latency-low-to-high"===i||"pricing-low-to-high"===i)&&o.reverse(),w=[..._=o||[]],to(),W("Models updated!")}}catch(r){W("Error parsing models list")}},onerror:function(t){W("Error fetching models!")}})}async function tE(t,e,i,o){if(!t?.length||!A)return A?"":"[Image descriptions disabled]";let r=[];for(let n of t){let a={model:k,messages:[{role:"user",content:[{type:"text",text:"Describe what you see in this image in a concise way, focusing on the main elements and any text visible. Keep the description under 100 words."},{type:"image_url",image_url:{url:n}}]}],temperature:M,top_p:q,max_tokens:H};k.includes("gemini")&&(a.config={safetySettings:tS}),T&&(a.provider={sort:T,allow_fallbacks:!0});let s=await t3(a,e);!s.error&&s.data?.choices?.[0]?.message?.content?r.push(s.data.choices[0].message.content):r.push("[Error getting image description]")}return r.map((t,e)=>`[IMAGE ${e+1}]: ${t}`).join("\n")}async function tk(t,e,i=1e4){return new Promise(o=>{GM_xmlhttpRequest({method:"GET",url:`https://openrouter.ai/api/v1/generation?id=${t}`,headers:{Authorization:`Bearer ${e}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},timeout:i,onload:function(t){if(t.status>=200&&t.status<300)try{let e=JSON.parse(t.responseText);o({error:!1,message:"Metadata fetched successfully",data:e})}catch(i){o({error:!0,message:`Failed to parse metadata response: ${i.message}`,data:null})}else 404===t.status?o({error:!0,status:404,message:`Generation metadata not found (404): ${t.responseText}`,data:null}):o({error:!0,status:t.status,message:`Metadata request failed with status ${t.status}: ${t.responseText}`,data:null})},onerror:function(t){o({error:!0,message:`Metadata request error: ${t.toString()}`,data:null})},ontimeout:function(){o({error:!0,message:`Metadata request timed out after ${i}ms`,data:null})}})})}!function t(){try{let i=e("threadRelationships","{}");t$=JSON.parse(i)}catch(o){t$={}}}(),setInterval(tx,2500),setInterval(function t(){if(!y)return;let e=y.querySelectorAll(B);e.length>0&&e.forEach(t=>{let e=O(t);if(!e)return;let i=Q.get(e),o=!i||!i.status||"error"===i.status||!tu(i.status)&&!th(i.status)||m.has(e)&&!tu(i.status)&&!th(i.status);o?(m.has(e)&&m.delete(e),tm(t)):i&&!th(i.status)&&tl(t)})},1e3),setInterval(tv,1e3);let tS=[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_CIVIC_INTEGRITY",threshold:"BLOCK_NONE"},];async function tT(t,i,o,r,n=3,s=null,l=""){let d=()=>{W(`Rating tweet... (${x=Math.max(0,x-1)} pending)`)};if($.has(l))return{score:0,content:"This tweet is from an ad author.",reasoning:"",error:!1,cached:!1};let c=g.getCurrentInstructions(),p={model:E,messages:[{role:"system",content:[{type:"text",text:`
                You are a tweet filtering AI. Your task is to rate tweets on a scale of 0 to 10 based on user-defined instructions.You will be given a Tweet and user defined instructions to rate the tweet. You are to review and provide a rating for the tweet with the specified tweet ID.Ensure that you consider the user-defined instructions in your analysis and scoring.Follow the user-defined instructions exactly, and do not deviate from them. Then, on a new line, provide a score between 0 and 10.Output your analysis first. Then, on a new line, provide a score between 0 and 10. in this exact format:SCORE_X (where X is a number from 0 (lowest quality) to 10 (highest quality).)for example: SCORE_0, SCORE_1, SCORE_2, SCORE_3, etc.If one of the above is not present, the program will not be able to parse the response and will return an error.`},]},{role:"user",content:[{type:"text",text:`provide your reasoning, and a rating according to the the following instructions for the tweet with tweet ID ${i}.
        ${c}
                _______BEGIN TWEET_______
                ${t}
                _______END TWEET_______
                Make sure your response ends with SCORE_0, SCORE_1, SCORE_2, SCORE_3, SCORE_4, SCORE_5, SCORE_6, SCORE_7, SCORE_8, SCORE_9, or SCORE_10.`}]}]};if(E.includes("gemini")&&(p.config={safetySettings:tS}),r?.length>0&&function t(e){if(!_||0===_.length)return!1;let i=_.find(t=>t.slug===e);return!!i&&i.input_modalities&&i.input_modalities.includes("image")}(E))for(let u of r)p.messages[1].content.push({type:"image_url",image_url:{url:u}});p.temperature=R,p.top_p=L,p.max_tokens=H,T&&(p.provider={sort:T,allow_fallbacks:!0});let h=e("enableStreaming",!1);a.set(i,{streaming:!0,timestamp:Date.now()});let m=0;for(;m<n;){m++;let f=Date.now(),b=f-v;b<25&&await new Promise(t=>setTimeout(t,25-b)),v=f,W(`Rating tweet... (${++x} pending)`);try{let y;if(y=h?await t8(p,o,i,t,s):await tC(p,o),d(),!y.error&&y.content){let w=y.content.match(/SCORE_(\d+)/g);if(w&&w.length>0){let k=w[w.length-1],S=parseInt(k.match(/SCORE_(\d+)/)[1],10);return a.set(i,{score:S,description:y.content,tweetContent:t,streaming:!1}),{score:S,content:y.content,reasoning:y.reasoning,error:!1,cached:!1,data:y.data}}}if(m<n){let I=1e3*Math.pow(m,2);await new Promise(t=>setTimeout(t,I))}}catch(C){if(d(),m<n){let A=1e3*Math.pow(m,2);await new Promise(t=>setTimeout(t,A))}}}return d(),{score:5,content:"Failed to get valid rating after multiple attempts",reasoning:"",error:!0,data:null}}async function tI(t){let i={model:E,messages:[{role:"system",content:[{type:"text",text:`
                Please come up with a 5-word summary of the following instructions:
                ${t}
                `}]},{role:"user",content:[{type:"text",text:`Please come up with a 5-word summary of the following instructions:
            ${t}
            `}]}]},o=e("openrouter-api-key"),r=await t3(i,o);if(!r.error&&r.data?.choices?.[0]?.message){let n=r.data.choices[0].message.content||"";return{content:n,error:!1}}return{error:!0,content:r.error||"Unknown error"}}async function tC(t,e){let i=t.tweetId,o=a.get(i)?.score,r=await t3(t,e);if(!r.error&&r.data?.choices?.[0]?.message){let n=r.data.choices[0].message.content||"",s=r.data.choices[0].message.reasoning||"",l=n.match(/SCORE_(\d+)/g),d=o||(l&&l.length>0?parseInt(l[l.length-1].match(/SCORE_(\d+)/)[1],10):null);return a.set(i,{score:d,description:n,tweetContent:t.tweetText,streaming:!1}),{content:n,reasoning:s}}return{error:!0,content:r.error||"Unknown error",reasoning:"",data:null}}async function t8(t,e,i,o,r){window.activeStreamingRequests&&window.activeStreamingRequests[i]&&(window.activeStreamingRequests[i].abort(),delete window.activeStreamingRequests[i]);let n=a.get(i);return n&&void 0!==n.score&&null!==n.score||a.set(i,{streaming:!0,timestamp:Date.now(),tweetContent:o,description:"",reasoning:"",score:null}),new Promise((s,l)=>{let d=Q.get(i,r);if(!d)return a.has(i)&&(a.get(i).streaming=!1,a.get(i).error="Indicator initialization failed"),l(Error(`ScoreIndicator instance could not be initialized for tweet ${i}`));let c=n?.description||"",p=n?.reasoning||"",u=null,h=n?.score||null;!function t(e,i,o,r,n,s=9e4,l=null){let d={...e,stream:!0},c="",p="",u="",h=null,g=!1,m=GM_xmlhttpRequest({method:"POST",url:"https://openrouter.ai/api/v1/chat/completions",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"HTTP-Referer":"https://greasyfork.org/en/scripts/532459-tweetfilter-ai","X-Title":"TweetFilter-AI"},data:JSON.stringify(d),timeout:s,responseType:"stream",onloadstart:function(t){let e=t.response.getReader(),i=()=>{a&&clearTimeout(a),a=setTimeout(()=>{g||(g=!0,r({content:p,reasoning:u,fullResponse:c,data:h,timedOut:!0}))},3e4)},a=null,s=async()=>{try{i();let t=!1,s=0;for(;!t&&!g;){let{done:d,value:m}=await e.read();if(d){t=!0;break}let $=new TextDecoder().decode(m);if(clearTimeout(a),i(),""===$.trim()){if(++s>=3){t=!0;break}continue}s=0,c+=$;let f=$.split("\n");for(let b of f)if(b.startsWith("data: ")){let y=b.substring(6);if("[DONE]"===y){t=!0;break}try{let v=JSON.parse(y);if(h=v,v.choices&&v.choices[0]){if(v.choices[0].delta&&void 0!==v.choices[0].delta.content){let x=v.choices[0].delta.content||"";p+=x}if(v.choices[0].delta&&void 0!==v.choices[0].delta.reasoning){let _=v.choices[0].delta.reasoning||"";u+=_}o({chunk:v.choices[0].delta?.content||"",reasoningChunk:v.choices[0].delta?.reasoning||"",content:p,reasoning:u,data:v})}}catch(w){}}}g||(g=!0,a&&clearTimeout(a),l&&window.activeStreamingRequests&&delete window.activeStreamingRequests[l],r({content:p,reasoning:u,fullResponse:c,data:h}))}catch(E){a&&clearTimeout(a),g||(g=!0,l&&window.activeStreamingRequests&&delete window.activeStreamingRequests[l],n({error:!0,message:`Stream processing error: ${E.toString()}`,data:null}))}};s().catch(t=>{a&&clearTimeout(a),g||(g=!0,l&&window.activeStreamingRequests&&delete window.activeStreamingRequests[l],n({error:!0,message:`Unhandled stream error: ${t.toString()}`,data:null}))})},onerror:function(t){l&&window.activeStreamingRequests&&delete window.activeStreamingRequests[l],n({error:!0,message:`Request error: ${t.toString()}`,data:null})},ontimeout:function(){l&&window.activeStreamingRequests&&delete window.activeStreamingRequests[l],n({error:!0,message:`Request timed out after ${s}ms`,data:null})}}),$={abort:function(){g=!0,x--;try{m.abort()}catch(t){}if(l&&window.activeStreamingRequests&&delete window.activeStreamingRequests[l],l&&a.has(l)){let e=a.get(l);e.streaming&&(void 0===e.score||null===e.score)&&a.delete(l)}}};return l&&window.activeStreamingRequests&&(window.activeStreamingRequests[l]=$),$}(t,e,t=>{c=t.content||c,p=t.reasoning||p;let e=c.match(/SCORE_(\d+)/g);if(e&&e.length>0){let o=e[e.length-1];h=parseInt(o.match(/SCORE_(\d+)/)[1],10)}if(d.update({status:"streaming",score:h,description:c||"Rating in progress...",reasoning:p}),a.has(i)){let r=a.get(i);r.description=c,r.reasoning=p,r.score=h,r.streaming=!0}},t=>{c=t.content||c,p=t.reasoning||p,u=t.data;let n=c.match(/SCORE_(\d+)/g);if(n&&n.length>0){let l=n[n.length-1];h=parseInt(l.match(/SCORE_(\d+)/)[1],10)}let g="rated";null==h&&(g="error",h=5,c+="\n[No score detected - Error]");let m={tweetContent:o,score:h,description:c,reasoning:p,streaming:!1,timestamp:Date.now(),error:"error"===g?"No score detected":void 0,metadata:null};a.set(i,m),d.update({status:g,score:h,description:c,reasoning:p,metadata:null}),r&&tl(r);let $=u?.id;$&&e&&tA(i,$,e,d),s({score:h,content:c,reasoning:p,error:"error"===g,cached:!1,data:u})},t=>{if(d.update({status:"error",score:5,description:`Stream Error: ${t.message}`,reasoning:""}),a.has(i)){let e=a.get(i);e.streaming=!1,e.error=t.message,e.score=5,e.description=`Stream Error: ${t.message}`}l(Error(t.message))},3e4,i)})}async function tA(t,e,i,o,r=0,n=[1e3,500,2e3,4e3,8e3]){if(r>=n.length)return;let s=n[r];await new Promise(t=>setTimeout(t,s));try{let l=await tk(e,i);if(!l.error&&l.data?.data){let d=l.data.data,c={model:d.model||"N/A",promptTokens:d.tokens_prompt||0,completionTokens:d.tokens_completion||0,reasoningTokens:d.native_tokens_reasoning||0,latency:void 0!==d.latency?(d.latency/1e3).toFixed(2)+"s":"N/A",mediaInputs:d.num_media_prompt||0,price:void 0!==d.total_cost?`$${d.total_cost.toFixed(6)}`:"N/A"},p=a.get(t);p&&(p.metadata=c,a.set(t,p),o.update({metadata:c}));return}l.status,tA(t,e,i,o,r+1,n)}catch(u){tA(t,e,i,o,r+1,n)}}let t7;i("menuHTML",GM_getResourceText("MENU_HTML")),t7=e("firstRun",!0),function r(){let n=document.querySelector("main")||document.querySelector('div[data-testid="primaryColumn"]');if(n){y=n,function r(){let n=function i(){let o;if(!(o=t||e("menuHTML")))return W("Error: Could not load UI components."),null;let r="tweetfilter-root-container",n=document.getElementById(r);if(n)return n;(n=document.createElement("div")).id=r,n.innerHTML=o,document.body.appendChild(n);let a=n.querySelector("#version-info");return a&&(a.textContent="Twitter De-Sloppifier v1.4.2"),n}();n&&(function t(o){if(!o)return;let r=o.querySelector("#settings-container"),n=o.querySelector("#tweet-filter-container"),a=o.querySelector("#settings-toggle"),s=o.querySelector("#filter-toggle");o.addEventListener("click",t=>{let o=t.target,l=o.closest("[data-action]"),d=l?.dataset.action;o.dataset.setting,o.closest(".parameter-row")?.dataset.paramName;let c=o.dataset.tab,p=o.closest("[data-toggle]")?.dataset.toggle;if(d)switch(d){case"close-filter":Z(n,s,"Filter Slider","Filter Slider");break;case"toggle-settings":case"close-settings":Z(r,a,'<span style="font-size: 14px;">‚úï</span> Close','<span style="font-size: 14px;">‚öôÔ∏è</span> Settings');break;case"save-api-key":(function t(){let o=document.getElementById("openrouter-api-key"),r=o.value.trim(),n=e("openrouter-api-key","").length>0;r?(n||ts(!0),i("openrouter-api-key",r),W("API key saved successfully!"),t0(),location.reload()):W("Please enter a valid API key")})();break;case"clear-cache":J();break;case"reset-settings":ts(G());break;case"save-instructions":V();break;case"add-handle":(function t(){let e=document.getElementById("handle-input"),o=e.value.trim();o&&(function t(e){if(""===(e=e.trim().replace(/^@/,""))||I.includes(e)){W(""===e?"Handle cannot be empty.":`@${e} is already on the list.`);return}I.push(e),i("blacklistedHandles",I.join("\n")),ti(document.getElementById("handle-list")),W(`Added @${e} to auto-rate list.`)}(o),e.value="")})();break;case"clear-instructions-history":(G()||confirm("Are you sure you want to clear all instruction history?"))&&(g.clearHistory(),X(),W("Instructions history cleared"))}if(o.classList.contains("remove-handle")){let u=o.closest(".handle-item"),h=u?.querySelector(".handle-text");if(h){let m=h.textContent.substring(1);(function t(e){let o=I.indexOf(e);o>-1?(I.splice(o,1),i("blacklistedHandles",I.join("\n")),ti(document.getElementById("handle-list")),W(`Removed @${e} from auto-rate list.`)):console.warn(`Attempted to remove non-existent handle: ${e}`)})(m)}}c&&function t(e){let i=document.querySelector("#settings-container .settings-content");if(!i)return;let o=i.querySelectorAll(".tab-content"),r=i.querySelectorAll(".tab-navigation .tab-button");o.forEach(t=>t.classList.remove("active")),r.forEach(t=>t.classList.remove("active"));let n=i.querySelector(`#${e}-tab`),a=i.querySelector(`.tab-navigation .tab-button[data-tab="${e}"]`);n&&n.classList.add("active"),a&&a.classList.add("active")}(c),p&&function t(e){let i=document.getElementById(e),o=document.querySelector(`[data-toggle="${e}"]`);if(!i||!o)return;let r=o.querySelector(".advanced-toggle-icon"),n=i.classList.toggle("expanded");r&&r.classList.toggle("expanded",n),n?i.style.maxHeight=i.scrollHeight+"px":i.style.maxHeight="0"}(p)}),o.addEventListener("input",t=>{let e=t.target,o=e.dataset.setting,r=e.closest(".parameter-row")?.dataset.paramName;o&&tt(e,o),r&&function t(e,o){let r=e.closest(".parameter-row");if(!r)return;let n=r.querySelector(".parameter-slider"),a=r.querySelector(".parameter-value"),s=parseFloat(n.min),l=parseFloat(n.max),d=parseFloat(e.value);"number"!==e.type||isNaN(d)||(d=Math.max(s,Math.min(l,d))),n&&a&&(n.value=d,a.value=d),void 0!==window[o]&&(window[o]=d),i(o,d)}(e,r),"tweet-filter-slider"===e.id&&function t(e){let o=document.getElementById("tweet-filter-value");b=parseInt(e.value,10),o&&(o.value=b.toString());let r=b/10*100;e.style.setProperty("--slider-percent",`${r}%`),i("filterThreshold",b),tv()}(e),"tweet-filter-value"===e.id&&function t(e){let o=parseInt(e.value,10);o=Math.max(0,Math.min(10,o)),e.value=o.toString();let r=document.getElementById("tweet-filter-slider");if(r){r.value=o.toString();let n=o/10*100;r.style.setProperty("--slider-percent",`${n}%`)}b=o,i("filterThreshold",b),tv()}(e)}),o.addEventListener("change",t=>{let e=t.target,i=e.dataset.setting;"modelSortOrder"===i&&(tt(e,i),t0()),"enableImageDescriptions"===i&&tt(e,i)}),s&&(s.onclick=()=>{n&&(n.style.display="flex",n.offsetHeight,n.classList.remove("hidden")),s.style.display="none"}),document.addEventListener("click",ta);let l=o.querySelector("#show-free-models");l&&l.addEventListener("change",function(){i("showFreeModels",S=this.checked),to()});let d=o.querySelector("#sort-direction");d&&d.addEventListener("click",function(){let t=e("sortDirection","default"),o="default"===t?"reverse":"default";i("sortDirection",o),this.dataset.value=o,to()});let c=o.querySelector("#model-sort-order");c&&c.addEventListener("change",function(){i("modelSortOrder",this.value),"latency-low-to-high"===this.value?i("sortDirection","default"):""===this.value&&i("sortDirection","default"),to()});let p=o.querySelector("#provider-sort");p&&p.addEventListener("change",function(){i("providerSort",T=this.value)})}(n),te(),t0(),function t(){let e=document.getElementById("tweet-filter-stats-badge");if(!e)return;e.title="Click to open settings",e.addEventListener("click",()=>{let t=document.getElementById("settings-toggle");t&&t.click()});let i,r=()=>{clearTimeout(i),e.style.opacity="1",i=setTimeout(()=>{e.style.opacity="0.3"},5e3)};e.addEventListener("mouseenter",()=>{e.style.opacity="1",clearTimeout(i)}),e.addEventListener("mouseleave",r),r(),o()}(),setInterval(o,3e3),window.activeStreamingRequests||(window.activeStreamingRequests={}))}(),t7&&(ts(!0),i("firstRun",!1));let s=e("openrouter-api-key","");s||alert("No API Key found. Please enter your API Key in Settings > General."),s&&(i("openrouter-api-key",s),W(`Loaded ${a.size} cached ratings. Starting to rate visible tweets...`),t0()),y.querySelectorAll(B).forEach(tm),tv();let l=new MutationObserver(Y);l.observe(y,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{l.disconnect();let t=document.getElementById("tweet-filter-container");t&&t.remove();let e=document.getElementById("settings-container");e&&e.remove();let i=document.getElementById("status-indicator");i&&i.remove(),Q.destroyAll()})}else setTimeout(r,1e3)}()}();